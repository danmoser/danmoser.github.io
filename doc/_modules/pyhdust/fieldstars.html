<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyhdust.fieldstars &mdash; Python tools for the BeACoN group Beta documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     'Beta',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Python tools for the BeACoN group Beta documentation" href="../../index.html" />
    <link rel="up" title="pyhdust" href="../pyhdust.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Python tools for the BeACoN group Beta documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../pyhdust.html" accesskey="U">pyhdust</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pyhdust.fieldstars</h1><div class="highlight"><pre>
<span class="c">##!/usr/bin/env python</span>
<span class="c">#-*- coding:utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Tools for field stars</span>

<span class="sd">:author: D. Bednarski</span>
<span class="sd">:license: GNU GPL v3.0 (https://github.com/danmoser/pyhdust/blob/master/LICENSE)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="kn">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="c">#import matplotlib.cm as mplcm</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">Normalize</span><span class="p">,</span> <span class="n">hsv_to_rgb</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Polygon</span>
<span class="kn">from</span> <span class="nn">matplotlib.collections</span> <span class="kn">import</span> <span class="n">PatchCollection</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">pyhdust</span> <span class="kn">import</span> <span class="n">hdtpath</span>
<span class="kn">import</span> <span class="nn">pyhdust.poltools</span> <span class="kn">as</span> <span class="nn">polt</span>
<span class="kn">import</span> <span class="nn">pyhdust.phc</span> <span class="kn">as</span> <span class="nn">phc</span>


<span class="c">#from glob import glob</span>
<span class="c">#import pyhdust.phc as phc</span>
<span class="c">#import pyhdust.jdcal as jdcal</span>
<span class="c">#import datetime as dt</span>
<span class="c">#from pyhdust import hdtpath</span>
<span class="c">#from itertools import product</span>


<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s">&#39;pdf.fonttype&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">42</span>     <span class="c"># Fix the % Symbol in pdf images</span>
<span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;u&#39;</span><span class="p">,</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="s">&#39;v&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;i&#39;</span><span class="p">]</span> 
<span class="n">fonts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">13</span><span class="p">]</span>          <span class="c"># Font sizes for titles, axes labels, axes values, key label of graphs, subplot labels</span>


<span class="c"># Dictionary for filter colors for the graphs</span>
<span class="n">colrs</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;u&#39;</span> <span class="p">:</span> <span class="s">&#39;Orchid&#39;</span><span class="p">,</span>
          <span class="s">&#39;b&#39;</span> <span class="p">:</span> <span class="s">&#39;MediumBlue&#39;</span><span class="p">,</span>
          <span class="s">&#39;v&#39;</span> <span class="p">:</span> <span class="s">&#39;Green&#39;</span><span class="p">,</span>
          <span class="s">&#39;r&#39;</span> <span class="p">:</span> <span class="s">&#39;Red&#39;</span><span class="p">,</span>
          <span class="s">&#39;i&#39;</span> <span class="p">:</span> <span class="s">&#39;GoldenRod&#39;</span><span class="p">,</span>
        <span class="p">}</span>

<span class="c"># Dictionary for column numbers of csv table infile</span>
<span class="n">idx1</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;be?&#39;</span>   <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>       <span class="c"># line concerning to the Be star?</span>
        <span class="s">&#39;tgt&#39;</span>   <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>       <span class="c"># target name</span>
        <span class="s">&#39;tgtHD&#39;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>       <span class="c"># HD/BD/CD target number</span>
        <span class="s">&#39;be&#39;</span>    <span class="p">:</span> <span class="mi">4</span><span class="p">,</span>       <span class="c"># Be star name</span>
        <span class="s">&#39;sel?&#39;</span>  <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>       <span class="c"># Standard selected? (&#39;Y&#39;/&#39;&#39;)</span>
        <span class="s">&#39;diang&#39;</span> <span class="p">:</span> <span class="mi">7</span><span class="p">,</span>       <span class="c"># angular distance (in degree)</span>
        <span class="s">&#39;r&#39;</span>     <span class="p">:</span> <span class="mi">8</span><span class="p">,</span>       <span class="c"># radial distance (per cent of Be distance)</span>
        <span class="s">&#39;sr&#39;</span>    <span class="p">:</span> <span class="mi">9</span><span class="p">,</span>       <span class="c"># radial distance error (idem)</span>
        <span class="s">&#39;type&#39;</span>  <span class="p">:</span> <span class="mi">10</span><span class="p">,</span>      <span class="c"># target star type</span>
        <span class="s">&#39;stype&#39;</span> <span class="p">:</span> <span class="mi">11</span><span class="p">,</span>      <span class="c"># target star spectral type</span>
        <span class="s">&#39;mplx&#39;</span>  <span class="p">:</span> <span class="mi">13</span><span class="p">,</span>      <span class="c"># target parallax (&quot;)</span>
        <span class="s">&#39;msplx&#39;</span> <span class="p">:</span> <span class="mi">14</span><span class="p">,</span>      <span class="c"># target parallax error (&quot;)</span>
        <span class="s">&#39;plx&#39;</span>   <span class="p">:</span> <span class="mi">15</span><span class="p">,</span>      <span class="c"># target parallax (pc)</span>
        <span class="s">&#39;splx&#39;</span>  <span class="p">:</span> <span class="mi">16</span><span class="p">,</span>      <span class="c"># target parallax error (pc)</span>
        <span class="s">&#39;magu&#39;</span>  <span class="p">:</span> <span class="mi">17</span><span class="p">,</span>      <span class="c"># magnitude filter u</span>
        <span class="s">&#39;magb&#39;</span>  <span class="p">:</span> <span class="mi">18</span><span class="p">,</span>      <span class="c"># magnitude filter b</span>
        <span class="s">&#39;magv&#39;</span>  <span class="p">:</span> <span class="mi">19</span><span class="p">,</span>      <span class="c"># magnitude filter v</span>
        <span class="s">&#39;magr&#39;</span>  <span class="p">:</span> <span class="mi">20</span><span class="p">,</span>      <span class="c"># magnitude filter r</span>
        <span class="s">&#39;magi&#39;</span>  <span class="p">:</span> <span class="mi">21</span><span class="p">,</span>      <span class="c"># magnitude filter i</span>
        <span class="s">&#39;coor&#39;</span>  <span class="p">:</span> <span class="mi">23</span><span class="p">,</span>      <span class="c"># coordinates</span>
        <span class="s">&#39;RA&#39;</span>    <span class="p">:</span> <span class="mi">37</span><span class="p">,</span>      <span class="c"># RA (hours, decimal)</span>
        <span class="s">&#39;DEC&#39;</span>   <span class="p">:</span> <span class="mi">38</span><span class="p">,</span>      <span class="c"># DEC (degree, decimal)</span>
        <span class="p">}</span>

<span class="c"># Dictionary for column numbers of csv table outfile</span>
<span class="n">idx2</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;MJD&#39;</span>   <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>       <span class="c"># MJD</span>
        <span class="s">&#39;date&#39;</span>  <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>       <span class="c"># date</span>
        <span class="s">&#39;ccd&#39;</span>   <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>       <span class="c"># CCD name</span>
        <span class="s">&#39;filt&#39;</span>  <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>       <span class="c"># filter</span>
        <span class="s">&#39;calc&#39;</span>  <span class="p">:</span> <span class="mi">4</span><span class="p">,</span>       <span class="c"># calcite</span>
        <span class="s">&#39;std&#39;</span>   <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>       <span class="c"># standard names</span>
        <span class="s">&#39;dth&#39;</span>   <span class="p">:</span> <span class="mi">6</span><span class="p">,</span>       <span class="c"># delta theta</span>
        <span class="s">&#39;sdth&#39;</span>  <span class="p">:</span> <span class="mi">7</span><span class="p">,</span>       <span class="c"># delta theta error</span>
        <span class="s">&#39;p&#39;</span>     <span class="p">:</span> <span class="mi">8</span><span class="p">,</span>       <span class="c"># pol (%)</span>
        <span class="s">&#39;q&#39;</span>     <span class="p">:</span> <span class="mi">9</span><span class="p">,</span>       <span class="c"># Stokes Q (%)</span>
        <span class="s">&#39;u&#39;</span>     <span class="p">:</span> <span class="mi">10</span><span class="p">,</span>      <span class="c"># Stokes U (%)</span>
        <span class="s">&#39;thet&#39;</span>  <span class="p">:</span> <span class="mi">11</span><span class="p">,</span>      <span class="c"># pol angle</span>
        <span class="s">&#39;s&#39;</span>     <span class="p">:</span> <span class="mi">12</span><span class="p">,</span>      <span class="c"># pol error  (%)</span>
        <span class="s">&#39;sthet&#39;</span> <span class="p">:</span> <span class="mi">13</span><span class="p">,</span>      <span class="c"># pol angle error</span>
        <span class="s">&#39;out&#39;</span>   <span class="p">:</span> <span class="mi">14</span><span class="p">,</span>      <span class="c"># target out file</span>
        <span class="s">&#39;#star&#39;</span> <span class="p">:</span> <span class="mi">15</span><span class="p">,</span>      <span class="c"># star number inside the outfile</span>
        <span class="s">&#39;flag&#39;</span>  <span class="p">:</span> <span class="mi">16</span><span class="p">,</span>      <span class="c"># star flag (&#39;OK&#39;/&#39;W&#39;/&#39;E&#39;)</span>
        <span class="s">&#39;tags&#39;</span>  <span class="p">:</span> <span class="mi">17</span><span class="p">,</span>      <span class="c"># star tags</span>
        <span class="s">&#39;tgt&#39;</span>   <span class="p">:</span> <span class="mi">18</span><span class="p">,</span>      <span class="c"># target name</span>
        <span class="s">&#39;tgtHD&#39;</span> <span class="p">:</span> <span class="mi">19</span><span class="p">,</span>      <span class="c"># HD/BD/CD target number</span>
        <span class="s">&#39;be&#39;</span>    <span class="p">:</span> <span class="mi">20</span><span class="p">,</span>      <span class="c"># Be star name</span>
        <span class="s">&#39;sel?&#39;</span>  <span class="p">:</span> <span class="mi">21</span><span class="p">,</span>      <span class="c"># Field star selected? (&#39;Y&#39;/&#39;&#39;)</span>
        <span class="s">&#39;magu&#39;</span>  <span class="p">:</span> <span class="mi">22</span><span class="p">,</span>      <span class="c"># magnitude filter u</span>
        <span class="s">&#39;magb&#39;</span>  <span class="p">:</span> <span class="mi">23</span><span class="p">,</span>      <span class="c"># magnitude filter b</span>
        <span class="s">&#39;magv&#39;</span>  <span class="p">:</span> <span class="mi">24</span><span class="p">,</span>      <span class="c"># magnitude filter v</span>
        <span class="s">&#39;magr&#39;</span>  <span class="p">:</span> <span class="mi">25</span><span class="p">,</span>      <span class="c"># magnitude filter r</span>
        <span class="s">&#39;magi&#39;</span>  <span class="p">:</span> <span class="mi">26</span><span class="p">,</span>      <span class="c"># magnitude filter i</span>
        <span class="s">&#39;type&#39;</span>  <span class="p">:</span> <span class="mi">27</span><span class="p">,</span>      <span class="c"># target star type</span>
        <span class="s">&#39;stype&#39;</span> <span class="p">:</span> <span class="mi">28</span><span class="p">,</span>      <span class="c"># target star spectral type</span>
        <span class="s">&#39;diang&#39;</span> <span class="p">:</span> <span class="mi">29</span><span class="p">,</span>      <span class="c"># angular distance (in degree)</span>
        <span class="s">&#39;plx&#39;</span>   <span class="p">:</span> <span class="mi">30</span><span class="p">,</span>      <span class="c"># target parallax (pc)</span>
        <span class="s">&#39;splx&#39;</span>  <span class="p">:</span> <span class="mi">31</span><span class="p">,</span>      <span class="c"># target parallax error (pc)</span>
        <span class="s">&#39;plxbe&#39;</span> <span class="p">:</span> <span class="mi">32</span><span class="p">,</span>      <span class="c"># Be parallax (pc)</span>
        <span class="s">&#39;splxbe&#39;</span><span class="p">:</span> <span class="mi">33</span><span class="p">,</span>      <span class="c"># Be parallax error (pc)</span>
        <span class="s">&#39;coor&#39;</span>  <span class="p">:</span> <span class="mi">34</span><span class="p">,</span>      <span class="c"># target coordinates</span>
        <span class="s">&#39;dRA&#39;</span>   <span class="p">:</span> <span class="mi">35</span><span class="p">,</span>      <span class="c"># delta RA (target-Be) (degree, decimal)</span>
        <span class="s">&#39;dDEC&#39;</span>  <span class="p">:</span> <span class="mi">36</span><span class="p">,</span>      <span class="c"># delta DEC (target-Be) (degree, decimal)</span>
        <span class="s">&#39;leff&#39;</span>  <span class="p">:</span> <span class="mi">37</span><span class="p">,</span>      <span class="c"># lambda_eff (Angstrom)</span>
        <span class="s">&#39;sleff&#39;</span> <span class="p">:</span> <span class="mi">38</span><span class="p">,</span>      <span class="c"># lambda_eff error (Angstrom)</span>
        <span class="p">}</span>



<div class="viewcode-block" id="readcsv"><a class="viewcode-back" href="../../fieldstars.html#pyhdust.fieldstars.readcsv">[docs]</a><span class="k">def</span> <span class="nf">readcsv</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">be</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read lines of Be star *be* from *cvsfile* and return a</span>
<span class="sd">    list with all components:</span>

<span class="sd">    [</span>
<span class="sd">     [[star 1, filter 1],</span>
<span class="sd">      [star 1, filter 2]],</span>
<span class="sd">                          [[star 2, filter 1],</span>
<span class="sd">                           [star 2, filter 2]],</span>
<span class="sd">                                               ...</span>
<span class="sd">                                                  ]</span>

<span class="sd">    Ignores the observations with &#39;E&#39; flag.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tgt_curr</span> <span class="o">=</span> <span class="s">&#39;VOID&#39;</span>
    <span class="n">f0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="s">&#39;ro&#39;</span><span class="p">)</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;;&#39;</span><span class="p">)</span>
    <span class="n">sortedcsv</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">idx2</span><span class="p">[</span><span class="s">&#39;be&#39;</span><span class="p">]],</span><span class="n">x</span><span class="p">[</span><span class="n">idx2</span><span class="p">[</span><span class="s">&#39;tgt&#39;</span><span class="p">]],</span><span class="n">x</span><span class="p">[</span><span class="n">idx2</span><span class="p">[</span><span class="s">&#39;filt&#39;</span><span class="p">]]])</span>

    
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">sortedcsv</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="n">idx2</span><span class="p">[</span><span class="s">&#39;be&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">be</span><span class="p">:</span>
            <span class="n">tgt</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">idx2</span><span class="p">[</span><span class="s">&#39;tgt&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">tgt</span> <span class="o">!=</span> <span class="n">tgt_curr</span><span class="p">:</span>
                <span class="n">tgt_curr</span> <span class="o">=</span> <span class="n">tgt</span>
                <span class="n">data</span> <span class="o">+=</span> <span class="p">[[]]</span>
            <span class="c"># Copy only if is correct data</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="n">idx2</span><span class="p">[</span><span class="s">&#39;flag&#39;</span><span class="p">]]</span> <span class="o">!=</span> <span class="s">&#39;E&#39;</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">line</span><span class="p">]</span>
            
    <span class="k">return</span> <span class="n">data</span>


</div>
<div class="viewcode-block" id="gencsv"><a class="viewcode-back" href="../../fieldstars.html#pyhdust.fieldstars.gencsv">[docs]</a><span class="k">def</span> <span class="nf">gencsv</span><span class="p">(</span><span class="n">csvin</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">skipdth</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">epssig</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a csvfile with every observations for the standard stars</span>
<span class="sd">    listed in pyhdust/refs/pol_hip.txt.</span>

<span class="sd">    Compute lambda_eff using color index and an mean airmass X=1.35.</span>
<span class="sd">    The error is the (lambda_eff(X=1.7)-lambda_eff(X=1.))/2</span>

<span class="sd">    INPUT</span>
<span class="sd">        csvin        The csv file with the informations</span>
<span class="sd">                     about the standard stars. The columns are</span>
<span class="sd">                     indentified through idx1[] dictionary.</span>
<span class="sd">        path         The path to the ``red`` directory, inside</span>
<span class="sd">                     which are the nights with the observations</span>
<span class="sd">        skipdth      print all target values anyway, even when</span>
<span class="sd">                     there are no standard star?</span>
<span class="sd">        epssig       sigP/P max for unpolarized target (sigP/P</span>
<span class="sd">                     up to epssig doesn&#39;t need standard star</span>
<span class="sd">                     case skipdth==False)</span>
<span class="sd">        delta        tolerance for the angle between the two beams</span>
<span class="sd">                     of calcite.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/refs/pol_hip.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hdtpath</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: Can</span><span class="se">\&#39;</span><span class="s">t read files pyhdust/refs/pol_hip.txt.&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">fout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;{0}/dados.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">csvout</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">fout</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;;&#39;</span><span class="p">)</span><span class="c">#, quoting=csv.QUOTE_NONE, quotechar=&#39;&#39;)</span>
    
    <span class="c"># Main loop</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>

        <span class="c"># Generate the table file for each field star</span>
        <span class="n">polt</span><span class="o">.</span><span class="n">genTarget</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">skipdth</span><span class="o">=</span><span class="n">skipdth</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span> <span class="n">epssig</span><span class="o">=</span><span class="n">epssig</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">obj</span><span class="p">)):</span>
            <span class="c"># Read informations about the field star and its Be</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csvin</span><span class="p">,</span> <span class="s">&#39;ro&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
                <span class="n">beline</span><span class="p">,</span> <span class="n">tgtline</span><span class="p">,</span> <span class="n">linetmp</span> <span class="o">=</span> <span class="p">[],[],[]</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">fin</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;;&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="p">[]:</span>
                        <span class="k">continue</span>
                    <span class="c"># Case the line is for some Be</span>
                    <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="n">idx1</span><span class="p">[</span><span class="s">&#39;be?&#39;</span><span class="p">]]</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">linetmp</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:]</span>
                    <span class="c"># Case it was matched the field star line</span>
                    <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="n">idx1</span><span class="p">[</span><span class="s">&#39;tgt&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">obj</span><span class="p">:</span>
                        <span class="n">tgtline</span> <span class="o">+=</span> <span class="p">[</span><span class="n">line</span><span class="p">[:]]</span>
                        <span class="n">beline</span> <span class="o">+=</span> <span class="p">[</span><span class="n">linetmp</span><span class="p">[:]]</span>
                <span class="c"># At this point we have two lists: tgtline and beline, which hold the</span>
                <span class="c"># informations about the field star &#39;obj&#39; and the respective Be star.</span>
                <span class="c"># These variables are lists because more the same field star can be associated</span>
                <span class="c"># with more than a single Be.</span>

            <span class="n">semilines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tgtline</span><span class="p">)):</span>
                <span class="n">semilines</span> <span class="o">+=</span> <span class="p">[[]]</span>
                <span class="c"># preparar uma semi-linha para ser copiada para todas as linhas com as informações referentes à estrela de campo e suas relações com a Be de referência. Compilar na linha abaixo apenas as informações que são importantes.</span>
                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;tgt&#39;</span><span class="p">,</span> <span class="s">&#39;tgtHD&#39;</span><span class="p">,</span> <span class="s">&#39;be&#39;</span><span class="p">,</span> <span class="s">&#39;sel?&#39;</span><span class="p">,</span> <span class="s">&#39;magu&#39;</span><span class="p">,</span> <span class="s">&#39;magb&#39;</span><span class="p">,</span> <span class="s">&#39;magv&#39;</span><span class="p">,</span> <span class="s">&#39;magr&#39;</span><span class="p">,</span> <span class="s">&#39;magi&#39;</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">,</span> <span class="s">&#39;stype&#39;</span><span class="p">,</span> <span class="s">&#39;diang&#39;</span><span class="p">,</span> <span class="s">&#39;plx&#39;</span><span class="p">,</span> <span class="s">&#39;splx&#39;</span><span class="p">):</span>
                    <span class="n">semilines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tgtline</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idx1</span><span class="p">[</span><span class="n">tag</span><span class="p">]]]</span>
                <span class="n">semilines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">beline</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idx1</span><span class="p">[</span><span class="s">&#39;plx&#39;</span><span class="p">]],</span> <span class="n">beline</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idx1</span><span class="p">[</span><span class="s">&#39;splx&#39;</span><span class="p">]]]</span>
                <span class="n">semilines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tgtline</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idx1</span><span class="p">[</span><span class="s">&#39;coor&#39;</span><span class="p">]]]</span>
                <span class="n">semilines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;{0:.7f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">tgtline</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idx1</span><span class="p">[</span><span class="s">&#39;RA&#39;</span><span class="p">]])</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">beline</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idx1</span><span class="p">[</span><span class="s">&#39;RA&#39;</span><span class="p">]]))</span><span class="o">*</span><span class="mf">360.</span><span class="o">/</span><span class="mf">24.</span><span class="p">)]</span>
                <span class="n">semilines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;{0:.7f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tgtline</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idx1</span><span class="p">[</span><span class="s">&#39;DEC&#39;</span><span class="p">]])</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">beline</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idx1</span><span class="p">[</span><span class="s">&#39;DEC&#39;</span><span class="p">]]))]</span>
<span class="c">#                print semilines</span>
<span class="c">#                semilines += [tgtline[i]+beline[i]]</span>

<span class="c">#            print &#39;############### AQUI!!!!!!!!!!!!! : &#39; + str(len(tgtline)) + &#39; linhas\n&#39;</span>
<span class="c">#            if len(tgtline) &gt; 1:</span>
<span class="c">#                print &#39;##########################################################&#39;</span>
<span class="c">#                print &#39;################### MAIS QUE 1 LINHA #####################&#39;</span>
<span class="c">#                for i in range(len(tgtline)):</span>
<span class="c">#                    print tgtline[i][idx1[&#39;tgt&#39;]], tgtline[i][idx1[&#39;be&#39;]]</span>
<span class="c">#                    print beline[i][idx1[&#39;be&#39;]]</span>
<span class="c">#                print semilines</span>
<span class="c">#                lixo = raw_input(&#39;Clique qualquer coisa para continuar...&#39;)</span>

            <span class="n">fobj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/{1}.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">obj</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s">&#39;#&#39;</span><span class="p">)</span>
            <span class="c"># Test if is needed to reshape</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fobj</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">fobj</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
                <span class="n">fobj</span> <span class="o">=</span> <span class="n">fobj</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span>
<span class="c">#            print fobj, semilines</span>
            <span class="k">for</span> <span class="n">semiline</span> <span class="ow">in</span> <span class="n">semilines</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fobj</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
                    <span class="c"># Compute the lambda_effective and errors</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;u&#39;</span> <span class="ow">and</span> <span class="n">semiline</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;~&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">semiline</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;~&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">):</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">semiline</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">semiline</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">and</span> <span class="n">semiline</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;~&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">semiline</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;~&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">):</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">semiline</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">semiline</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">color</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">leff</span> <span class="o">=</span> <span class="n">polt</span><span class="o">.</span><span class="n">lbds</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">airmass</span><span class="o">=</span><span class="mf">1.35</span><span class="p">)</span>
                        <span class="n">leff1</span> <span class="o">=</span> <span class="n">polt</span><span class="o">.</span><span class="n">lbds</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">airmass</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
                        <span class="n">leff2</span> <span class="o">=</span> <span class="n">polt</span><span class="o">.</span><span class="n">lbds</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">airmass</span><span class="o">=</span><span class="mf">1.7</span><span class="p">)</span>
                        <span class="n">sleff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">leff2</span><span class="o">-</span><span class="n">leff1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<span class="c">#                        print leff, abs(leff1-leff), abs(leff2-leff)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">leff</span> <span class="o">=</span> <span class="n">phc</span><span class="o">.</span><span class="n">lbds</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
                        <span class="n">sleff</span> <span class="o">=</span> <span class="mf">0.</span>
                    <span class="n">csvout</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">line</span><span class="o">+</span><span class="n">semiline</span><span class="o">+</span><span class="p">[</span><span class="n">leff</span><span class="p">,</span><span class="n">sleff</span><span class="p">])</span>
               
    <span class="c"># Process the found star with the substring &#39;field&#39;</span>
    <span class="n">polt</span><span class="o">.</span><span class="n">genTarget</span><span class="p">(</span><span class="s">&#39;field&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">skipdth</span><span class="o">=</span><span class="n">skipdth</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span> <span class="n">epssig</span><span class="o">=</span><span class="n">epssig</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/field.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
        <span class="n">fobj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/field.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s">&#39;#&#39;</span><span class="p">)</span>
        <span class="c"># Test if is needed to reshape</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fobj</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">fobj</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="n">fobj</span> <span class="o">=</span> <span class="n">fobj</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fobj</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
            <span class="n">leff</span> <span class="o">=</span> <span class="n">phc</span><span class="o">.</span><span class="n">lbds</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
            <span class="n">csvout</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;Y&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">15</span><span class="o">+</span><span class="p">[</span><span class="n">leff</span><span class="p">])</span>

    <span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    
    <span class="k">return</span>



</div>
<div class="viewcode-block" id="getTable"><a class="viewcode-back" href="../../fieldstars.html#pyhdust.fieldstars.getTable">[docs]</a><span class="k">def</span> <span class="nf">getTable</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sx</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sy</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sz</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> \
                        <span class="n">vfilter</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;no-std&#39;</span><span class="p">],</span> <span class="n">bin_data</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">onlyY</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">unbias</span><span class="o">=</span><span class="s">&#39;wk&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Receive the list *data* with many collumns and return</span>
<span class="sd">      the columns concerning to the *x*, *y*, *z* quantities</span>
<span class="sd">      (and their errors *sx*, *sy*, *sz*). Returns also &#39;objarr&#39;,</span>
<span class="sd">      a list with object names, filters and validation status.</span>

<span class="sd">      IMPORTANT: 1) Propagates error of delta theta factor for</span>
<span class="sd">                    &#39;q&#39;, &#39;u&#39;, &#39;p&#39; and &#39;thet&#39; labels</span>
<span class="sd">                 2) Apply unbias correction for P and theta values</span>
<span class="sd">                    when specified through &#39;unbias&#39; variable.</span>
<span class="sd">                 3) Case some label is &#39;q&#39;, &#39;u&#39;, &#39;p&#39; or &#39;thet&#39;,</span>
<span class="sd">                    &#39;no-std&#39; is not in vfilter list and</span>
<span class="sd">                    bin_data==True, don&#39;t bin the data of those</span>
<span class="sd">                    which have &#39;no-std&#39; flag to prevent to compute</span>
<span class="sd">                    values WITH NO MEANING. Return various lines</span>
<span class="sd">                    for every unbinnable data and a line for the</span>
<span class="sd">                    others else binned data.</span>

<span class="sd">    INPUT</span>
<span class="sd">        x,y,z,sx,sy,sz    Label (key) of *idx2* dictionary.</span>
<span class="sd">        bin_data          Bin the data in the observations for</span>
<span class="sd">                          the same object+filter+x variable? Note:</span>
<span class="sd">                          Case y and/or z are &#39;p&#39; or &#39;thet&#39;,</span>
<span class="sd">                          compute the bins *over the Stokes</span>
<span class="sd">                          parameters* and then return the values</span>
<span class="sd">                          to &#39;p&#39; or &#39;thet&#39;!</span>
<span class="sd">        onlyY             True = only selects the list with</span>
<span class="sd">                          a &quot;Y&quot; marked</span>
<span class="sd">        unbias            Estimator to unbias the data when &#39;y&#39; or &#39;z&#39;</span>
<span class="sd">                          is equals to &#39;p&#39; or &#39;thet&#39;. Three options:</span>
<span class="sd">                             a) &#39;ml&#39;: Maximum Likelihood (K=1.41)</span>
<span class="sd">                             b) &#39;wk&#39;: Wardle &amp; Kronberg (K=1.0)</span>
<span class="sd">                             c) &#39;&#39;  : None (K=0.)</span>

<span class="sd">                          where K is the factor to unbias (read the</span>
<span class="sd">                          description of routines &#39;unbiasData&#39; and</span>
<span class="sd">                          &#39;meanAngle&#39;.</span>
<span class="sd">        vfilter           List whose elements are the labels (tags)</span>
<span class="sd">                          to be filtered from the output. It can be</span>
<span class="sd">                          &#39;full&#39;, &#39;prob&#39; or &#39;comp&#39; for these</span>
<span class="sd">                          pre-defined lists in polt.vfil dictionary.</span>

<span class="sd">        To mount your own list vfilter, select the current tags:</span>

<span class="sd">      # General tags for target/standard observation</span>
<span class="sd">      - &#39;bad-mod&#39;         bad modulation</span>
<span class="sd">      - &#39;very-bad-mod&#39;    very bad modulation</span>
<span class="sd">      - &#39;incomp-mods&#39;     some modulations are incompatible</span>
<span class="sd">      - &#39;obs-prob&#39;        some observational problem/error</span>
<span class="sd">      - &#39;iagpol-prob&#39;     polarimeter problem suspected</span>
<span class="sd">      - &#39;other-prob&#39;      another relevant problem</span>
<span class="sd">      - &#39;obs!=pub&#39;        std incompatible with the published</span>

<span class="sd">      # Tags for standard status</span>
<span class="sd">      - &#39;no-std&#39;          no standard in the night</span>
<span class="sd">      - &#39;oth-day-std&#39;     standard from another day</span>
<span class="sd">      - &#39;oth-dth&#39;         delta theta estimated from another filter</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">pro_arr</span> <span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span><span class="n">zz</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">sxx</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">syy</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">szz</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">objarr</span>  <span class="o">=</span> <span class="p">[[],[],[]]</span>
        <span class="n">xarr</span> <span class="o">=</span> <span class="p">[[],[]]</span>
        <span class="n">yarr</span> <span class="o">=</span> <span class="p">[[],[]]</span>
        <span class="n">zarr</span> <span class="o">=</span> <span class="p">[[],[]]</span>

        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">block</span><span class="p">:</span>

                <span class="c"># Skip the line: 1) case the observation has some tag to be filtered;</span>
                <span class="c">#                2) case the xx, yy or zz has not value in line (i.e.,</span>
                <span class="c">#                   if it is equal to &#39;&#39; or &#39;~&#39;);</span>
                <span class="c">#                3) case the observation has not the mark &#39;Y&#39; that indicates</span>
                <span class="c">#                   it was selected for THAT Be star, since onlyY==True.</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">onlyY</span><span class="o">==</span><span class="bp">True</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="n">idx2</span><span class="p">[</span><span class="s">&#39;sel?&#39;</span><span class="p">]]</span><span class="o">!=</span><span class="s">&#39;Y&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                                     <span class="n">line</span><span class="p">[</span><span class="n">idx2</span><span class="p">[</span><span class="n">xx</span><span class="p">]]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;~&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                                        <span class="n">line</span><span class="p">[</span><span class="n">idx2</span><span class="p">[</span><span class="n">yy</span><span class="p">]]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;~&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                                        <span class="p">(</span><span class="n">zz</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="n">idx2</span><span class="p">[</span><span class="n">zz</span><span class="p">]]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;~&#39;</span><span class="p">)):</span>
                    <span class="n">validate</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">validate</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">for</span> <span class="n">vfilt</span> <span class="ow">in</span> <span class="n">vfilter</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">vfilt</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="n">idx2</span><span class="p">[</span><span class="s">&#39;tags&#39;</span><span class="p">]]:</span>
                            <span class="n">validate</span> <span class="o">=</span> <span class="bp">False</span>
<span class="c">#                           print line[idx2[&#39;tgt&#39;]] + &#39;FALSE: sel? = &#39; + line[idx2[&#39;sel?&#39;]]</span>
                            <span class="k">break</span>

                <span class="c"># IF VALIDATE, proceed</span>
                <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
                    <span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span>  <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">idx2</span><span class="p">[</span><span class="s">&#39;tgt&#39;</span><span class="p">]]]</span>
                    <span class="n">objarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">idx2</span><span class="p">[</span><span class="s">&#39;filt&#39;</span><span class="p">]]]</span>
                    <span class="n">objarr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">idx2</span><span class="p">[</span><span class="s">&#39;tags&#39;</span><span class="p">]]]</span>
                    <span class="n">xarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">idx2</span><span class="p">[</span><span class="n">xx</span><span class="p">]]]</span>
                    <span class="n">yarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">idx2</span><span class="p">[</span><span class="n">yy</span><span class="p">]]]</span>
                    <span class="k">if</span> <span class="n">sxx</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">xarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">idx2</span><span class="p">[</span><span class="n">sxx</span><span class="p">]]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">xarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">syy</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">yarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">idx2</span><span class="p">[</span><span class="n">syy</span><span class="p">]]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">yarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">zz</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">zarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">idx2</span><span class="p">[</span><span class="n">zz</span><span class="p">]]]</span>
                    <span class="k">if</span> <span class="n">szz</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">zarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">idx2</span><span class="p">[</span><span class="n">szz</span><span class="p">]]]</span>

        <span class="k">try</span><span class="p">:</span> <span class="n">xarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">xelem</span><span class="p">)</span> <span class="k">for</span> <span class="n">xelem</span> <span class="ow">in</span> <span class="n">xarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">xarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">xelem</span><span class="p">)</span> <span class="k">for</span> <span class="n">xelem</span> <span class="ow">in</span> <span class="n">xarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">yarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">yelem</span><span class="p">)</span> <span class="k">for</span> <span class="n">yelem</span> <span class="ow">in</span> <span class="n">yarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">yarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">yelem</span><span class="p">)</span> <span class="k">for</span> <span class="n">yelem</span> <span class="ow">in</span> <span class="n">yarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">zarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">zelem</span><span class="p">)</span> <span class="k">for</span> <span class="n">zelem</span> <span class="ow">in</span> <span class="n">zarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">zarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">zelem</span><span class="p">)</span> <span class="k">for</span> <span class="n">zelem</span> <span class="ow">in</span> <span class="n">zarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>

        <span class="k">return</span> <span class="n">objarr</span><span class="p">,</span> <span class="n">xarr</span><span class="p">,</span> <span class="n">yarr</span><span class="p">,</span> <span class="n">zarr</span>



    <span class="c"># Verify keys</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">sz</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">param</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idx2</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Error: key {0} not found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">))</span>
            <span class="k">return</span> <span class="mi">1</span>

    <span class="c"># Verify if vfilter is a special filter</span>
    <span class="k">if</span> <span class="n">vfilter</span> <span class="ow">in</span> <span class="n">polt</span><span class="o">.</span><span class="n">vfil</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">vfilter</span> <span class="o">=</span> <span class="n">polt</span><span class="o">.</span><span class="n">vfil</span><span class="p">[</span><span class="n">vfilter</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">bin_data</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;p&#39;</span><span class="p">,</span> <span class="s">&#39;thet&#39;</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Error: key </span><span class="se">\&#39;</span><span class="s">p</span><span class="se">\&#39;</span><span class="s"> or </span><span class="se">\&#39;</span><span class="s">thet</span><span class="se">\&#39;</span><span class="s"> can</span><span class="se">\&#39;</span><span class="s">t be used as x values when bin_data==True. Try to pass the data that must be binned through the y values or set bin_data=False.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">z</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;p&#39;</span><span class="p">,</span> <span class="s">&#39;thet&#39;</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Error: keys </span><span class="se">\&#39;</span><span class="s">p</span><span class="se">\&#39;</span><span class="s"> and/or </span><span class="se">\&#39;</span><span class="s">thet</span><span class="se">\&#39;</span><span class="s"> can</span><span class="se">\&#39;</span><span class="s">t be used as x and/or y values when bin_data==True and z!=None. Try to pass the data that must be binned through the z values or set bin_data=False.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s">&#39;leff&#39;</span><span class="p">:</span> <span class="n">ignx</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">ignx</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="s">&#39;leff&#39;</span><span class="p">:</span> <span class="n">igny</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">igny</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">objarr</span><span class="p">,</span> <span class="n">xarr</span><span class="p">,</span> <span class="n">yarr</span><span class="p">,</span> <span class="n">zarr</span> <span class="o">=</span> <span class="n">pro_arr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">sz</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bin_data</span> <span class="ow">and</span> <span class="n">y</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;p&#39;</span><span class="p">,</span><span class="s">&#39;thet&#39;</span><span class="p">,</span><span class="s">&#39;q&#39;</span><span class="p">,</span><span class="s">&#39;u&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">z</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;p&#39;</span><span class="p">,</span><span class="s">&#39;thet&#39;</span><span class="p">,</span><span class="s">&#39;q&#39;</span><span class="p">,</span><span class="s">&#39;u&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">z</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">binData</span><span class="p">(</span><span class="n">objarr</span><span class="p">,</span> <span class="n">xarr</span><span class="p">,</span> <span class="n">yarr</span><span class="p">,</span> <span class="n">ignx</span><span class="o">=</span><span class="n">ignx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">binData</span><span class="p">(</span><span class="n">objarr</span><span class="p">,</span> <span class="n">xarr</span><span class="p">,</span> <span class="n">yarr</span><span class="p">,</span> <span class="n">zarr</span><span class="o">=</span><span class="n">zarr</span><span class="p">,</span> <span class="n">ignx</span><span class="o">=</span><span class="n">ignx</span><span class="p">,</span> <span class="n">igny</span><span class="o">=</span><span class="n">igny</span><span class="p">)</span>

    <span class="c"># Case y or z is the polarization P, theta, Q or U, bin the data on the *Stokes parameters QU* and</span>
    <span class="c"># compute the new P (or theta, Q, U) values.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;p&#39;</span><span class="p">,</span><span class="s">&#39;thet&#39;</span><span class="p">,</span><span class="s">&#39;q&#39;</span><span class="p">,</span><span class="s">&#39;u&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;p&#39;</span><span class="p">,</span><span class="s">&#39;thet&#39;</span><span class="p">,</span><span class="s">&#39;q&#39;</span><span class="p">,</span><span class="s">&#39;u&#39;</span><span class="p">)):</span>

        <span class="n">objarr</span><span class="p">,</span> <span class="n">parr</span><span class="p">,</span> <span class="n">thetarr</span><span class="p">,</span> <span class="n">dtharr</span> <span class="o">=</span> <span class="n">pro_arr</span><span class="p">(</span><span class="n">xx</span><span class="o">=</span><span class="s">&#39;p&#39;</span><span class="p">,</span> <span class="n">yy</span><span class="o">=</span><span class="s">&#39;thet&#39;</span><span class="p">,</span> <span class="n">sxx</span><span class="o">=</span><span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="n">zz</span><span class="o">=</span><span class="s">&#39;dth&#39;</span><span class="p">,</span> <span class="n">szz</span><span class="o">=</span><span class="s">&#39;sdth&#39;</span><span class="p">)</span>
        <span class="n">objarr_aux</span><span class="p">,</span> <span class="n">qarr</span><span class="p">,</span> <span class="n">uarr</span><span class="p">,</span> <span class="n">lixo</span> <span class="o">=</span> <span class="n">pro_arr</span><span class="p">(</span><span class="n">xx</span><span class="o">=</span><span class="s">&#39;q&#39;</span><span class="p">,</span> <span class="n">yy</span><span class="o">=</span><span class="s">&#39;u&#39;</span><span class="p">,</span> <span class="n">sxx</span><span class="o">=</span><span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="n">syy</span><span class="o">=</span><span class="s">&#39;s&#39;</span><span class="p">)</span>

        <span class="n">thetarr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">qarr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">uarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">polt</span><span class="o">.</span><span class="n">propQU</span><span class="p">(</span><span class="n">parr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">thetarr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtharr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">bin_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">z</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">xarr_aux</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">xarr</span><span class="p">)</span>
                <span class="n">binData</span><span class="p">(</span><span class="n">objarr</span><span class="p">,</span> <span class="n">xarr</span><span class="p">,</span> <span class="n">qarr</span><span class="p">,</span> <span class="n">prevent</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ignx</span><span class="o">=</span><span class="n">ignx</span><span class="p">)</span>
                <span class="n">binData</span><span class="p">(</span><span class="n">objarr_aux</span><span class="p">,</span> <span class="n">xarr_aux</span><span class="p">,</span> <span class="n">uarr</span><span class="p">,</span> <span class="n">prevent</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ignx</span><span class="o">=</span><span class="n">ignx</span><span class="p">,</span> <span class="n">igny</span><span class="o">=</span><span class="n">igny</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xarr_aux</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">xarr</span><span class="p">)</span>
                <span class="n">yarr_aux</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">yarr</span><span class="p">)</span>
                <span class="n">binData</span><span class="p">(</span><span class="n">objarr</span><span class="p">,</span> <span class="n">xarr</span><span class="p">,</span> <span class="n">yarr</span><span class="p">,</span> <span class="n">zarr</span><span class="o">=</span><span class="n">qarr</span><span class="p">,</span> <span class="n">prevent</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ignx</span><span class="o">=</span><span class="n">ignx</span><span class="p">,</span> <span class="n">igny</span><span class="o">=</span><span class="n">igny</span><span class="p">)</span>
                <span class="n">binData</span><span class="p">(</span><span class="n">objarr_aux</span><span class="p">,</span> <span class="n">xarr_aux</span><span class="p">,</span> <span class="n">yarr_aux</span><span class="p">,</span> <span class="n">zarr</span><span class="o">=</span><span class="n">uarr</span><span class="p">,</span> <span class="n">prevent</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ignx</span><span class="o">=</span><span class="n">ignx</span><span class="p">,</span> <span class="n">igny</span><span class="o">=</span><span class="n">igny</span><span class="p">)</span>


        <span class="k">if</span> <span class="s">&#39;thet&#39;</span> <span class="ow">in</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>

            <span class="c"># Call meanAngle over the qarr and uarr lists, one by one element, just to compute theta correctly</span>
            <span class="n">thetarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">meanAngle</span><span class="p">([</span><span class="n">qi</span><span class="p">],[</span><span class="n">ui</span><span class="p">],[</span><span class="n">sqi</span><span class="p">],[</span><span class="n">sui</span><span class="p">],</span> <span class="n">estim</span><span class="o">=</span><span class="n">unbias</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">qi</span><span class="p">,</span><span class="n">ui</span><span class="p">,</span><span class="n">sqi</span><span class="p">,</span><span class="n">sui</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qarr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">uarr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">qarr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">uarr</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">thetarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">meanAngle</span><span class="p">([</span><span class="n">qi</span><span class="p">],[</span><span class="n">ui</span><span class="p">],[</span><span class="n">sqi</span><span class="p">],[</span><span class="n">sui</span><span class="p">],</span> <span class="n">estim</span><span class="o">=</span><span class="n">unbias</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">qi</span><span class="p">,</span><span class="n">ui</span><span class="p">,</span><span class="n">sqi</span><span class="p">,</span><span class="n">sui</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qarr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">uarr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">qarr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">uarr</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

            <span class="k">if</span> <span class="n">y</span><span class="o">==</span><span class="s">&#39;thet&#39;</span><span class="p">:</span> <span class="n">yarr</span> <span class="o">=</span> <span class="n">thetarr</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">zarr</span> <span class="o">=</span> <span class="n">thetarr</span>

        <span class="k">if</span> <span class="s">&#39;p&#39;</span> <span class="ow">in</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>

            <span class="n">parr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">qi</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">ui</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">qi</span><span class="p">,</span><span class="n">ui</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qarr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">uarr</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="n">parr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">qi</span><span class="o">*</span><span class="n">sqi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">ui</span><span class="o">*</span><span class="n">sui</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">pi</span> <span class="k">if</span> <span class="n">pi</span><span class="o">!=</span><span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span> <span class="k">for</span> <span class="n">qi</span><span class="p">,</span><span class="n">ui</span><span class="p">,</span><span class="n">sqi</span><span class="p">,</span><span class="n">sui</span><span class="p">,</span><span class="n">pi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qarr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">uarr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">qarr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">uarr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">parr</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="k">if</span> <span class="n">unbias</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="n">unbiasData</span><span class="p">(</span><span class="n">parr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">estim</span><span class="o">=</span><span class="n">unbias</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">y</span><span class="o">==</span><span class="s">&#39;p&#39;</span><span class="p">:</span> <span class="n">yarr</span> <span class="o">=</span> <span class="n">parr</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">zarr</span> <span class="o">=</span> <span class="n">parr</span>

        <span class="k">if</span> <span class="n">y</span><span class="o">==</span><span class="s">&#39;q&#39;</span><span class="p">:</span> <span class="n">yarr</span> <span class="o">=</span> <span class="n">qarr</span>
        <span class="k">elif</span> <span class="n">z</span><span class="o">==</span><span class="s">&#39;q&#39;</span><span class="p">:</span> <span class="n">zarr</span> <span class="o">=</span> <span class="n">qarr</span>
        <span class="k">if</span> <span class="n">y</span><span class="o">==</span><span class="s">&#39;u&#39;</span><span class="p">:</span> <span class="n">yarr</span> <span class="o">=</span> <span class="n">uarr</span>
        <span class="k">elif</span> <span class="n">z</span><span class="o">==</span><span class="s">&#39;u&#39;</span><span class="p">:</span> <span class="n">zarr</span> <span class="o">=</span> <span class="n">uarr</span>


    <span class="c"># Return the values</span>
    <span class="k">if</span> <span class="n">z</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">objarr</span><span class="p">,</span> <span class="n">xarr</span><span class="p">,</span> <span class="n">yarr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">objarr</span><span class="p">,</span> <span class="n">xarr</span><span class="p">,</span> <span class="n">yarr</span><span class="p">,</span> <span class="n">zarr</span>

   

</div>
<div class="viewcode-block" id="graf_field"><a class="viewcode-back" href="../../fieldstars.html#pyhdust.fieldstars.graf_field">[docs]</a><span class="k">def</span> <span class="nf">graf_field</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">vfilter</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;no-std&#39;</span><span class="p">],</span> <span class="n">squared</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">bin_data</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> \
                                                    <span class="n">onlyY</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">extens</span><span class="o">=</span><span class="s">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">unbias</span><span class="o">=</span><span class="s">&#39;wk&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a field graph with polarization directions for Be star *be*</span>
<span class="sd">    through *csvfile* data table.</span>

<span class="sd">    squared: use the same scale in both x and y axes?</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Subtask to calculate the polarization vector coordinates</span>
    <span class="k">def</span> <span class="nf">gen_polar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">thet</span><span class="p">):</span>

        <span class="n">thet_rad</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">thet</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>

        <span class="n">xmin</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thet_rad</span><span class="p">)</span><span class="o">*</span><span class="n">l</span>
        <span class="n">xmax</span><span class="o">=</span><span class="n">x</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thet_rad</span><span class="p">)</span><span class="o">*</span><span class="n">l</span>
        <span class="n">ymin</span><span class="o">=</span><span class="n">y</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thet_rad</span><span class="p">)</span><span class="o">*</span><span class="n">l</span>
        <span class="n">ymax</span><span class="o">=</span><span class="n">y</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thet_rad</span><span class="p">)</span><span class="o">*</span><span class="n">l</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">],</span> <span class="p">[</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]</span>


    <span class="c"># Subtask to calculate the coordinates of &#39;error shade&#39;</span>
    <span class="k">def</span> <span class="nf">gen_spolar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">thet</span><span class="p">,</span> <span class="n">sthet</span><span class="p">):</span>

        <span class="n">thet_rad</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">thet</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">s_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">sthet</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">l</span>

        <span class="n">x1</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">l</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thet_rad</span><span class="o">-</span><span class="n">s_rad</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">s_rad</span><span class="p">)</span>
        <span class="n">y1</span><span class="o">=</span><span class="n">y</span><span class="o">-</span><span class="n">l</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thet_rad</span><span class="o">-</span><span class="n">s_rad</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">s_rad</span><span class="p">)</span>
        <span class="n">x2</span><span class="o">=</span><span class="n">x</span><span class="o">+</span><span class="n">l</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thet_rad</span><span class="o">-</span><span class="n">s_rad</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">s_rad</span><span class="p">)</span>
        <span class="n">y2</span><span class="o">=</span><span class="n">y</span><span class="o">+</span><span class="n">l</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thet_rad</span><span class="o">-</span><span class="n">s_rad</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">s_rad</span><span class="p">)</span>
        <span class="n">x3</span><span class="o">=</span><span class="n">x</span><span class="o">+</span><span class="n">l</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thet_rad</span><span class="o">+</span><span class="n">s_rad</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">s_rad</span><span class="p">)</span>
        <span class="n">y3</span><span class="o">=</span><span class="n">y</span><span class="o">+</span><span class="n">l</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thet_rad</span><span class="o">+</span><span class="n">s_rad</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">s_rad</span><span class="p">)</span>
        <span class="n">x4</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">l</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thet_rad</span><span class="o">+</span><span class="n">s_rad</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">s_rad</span><span class="p">)</span>
        <span class="n">y4</span><span class="o">=</span><span class="n">y</span><span class="o">-</span><span class="n">l</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thet_rad</span><span class="o">+</span><span class="n">s_rad</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">s_rad</span><span class="p">)</span>

<span class="c">#        return [[x1,y1], [x2,y2], [x3,y3], [x4,y4]]</span>
        <span class="k">return</span> <span class="p">[[</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">],</span> <span class="p">[</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">],</span> <span class="p">[</span><span class="n">x3</span><span class="p">,</span><span class="n">y3</span><span class="p">],</span> <span class="p">[</span><span class="n">x4</span><span class="p">,</span><span class="n">y4</span><span class="p">]]</span>


    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">)</span>
    <span class="c"># Verify if vfilter is a special filter</span>
    <span class="k">if</span> <span class="n">vfilter</span> <span class="ow">in</span> <span class="n">polt</span><span class="o">.</span><span class="n">vfil</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">vfilter</span> <span class="o">=</span> <span class="n">polt</span><span class="o">.</span><span class="n">vfil</span><span class="p">[</span><span class="n">vfilter</span><span class="p">]</span>

    <span class="c"># Read file and generate table</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">readcsv</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">be</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;No {0} data!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">))</span>
        <span class="k">return</span>
    <span class="n">objarr</span><span class="p">,</span> <span class="n">raarr</span><span class="p">,</span> <span class="n">decarr</span><span class="p">,</span> <span class="n">tharr</span> <span class="o">=</span> <span class="n">getTable</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&#39;dRA&#39;</span><span class="p">,</span> <span class="s">&#39;dDEC&#39;</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="s">&#39;thet&#39;</span><span class="p">,</span> <span class="n">sz</span><span class="o">=</span><span class="s">&#39;sthet&#39;</span><span class="p">,</span> \
                                                <span class="n">vfilter</span><span class="o">=</span><span class="n">vfilter</span><span class="p">,</span> <span class="n">bin_data</span><span class="o">=</span><span class="n">bin_data</span><span class="p">,</span> <span class="n">onlyY</span><span class="o">=</span><span class="n">onlyY</span><span class="p">,</span> <span class="n">unbias</span><span class="o">=</span><span class="n">unbias</span><span class="p">)</span>
<span class="c">#    print tharr</span>
    <span class="k">if</span> <span class="n">objarr</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">or</span> <span class="n">objarr</span> <span class="o">==</span> <span class="p">[[],[],[]]:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;No {0} valid data!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;Field Stars - {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">phc</span><span class="o">.</span><span class="n">bes</span><span class="p">[</span><span class="n">be</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&#39;bottom&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;$\Delta$ RA  (degree)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;$\Delta$ DEC  (degree)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">leg</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">veci</span><span class="p">)</span> <span class="k">for</span> <span class="n">veci</span> <span class="ow">in</span> <span class="n">raarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">decarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">lsize</span> <span class="o">=</span> <span class="mf">0.075</span><span class="o">*</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">vec</span><span class="p">))</span>  <span class="c"># Variable for vectors size</span>
    <span class="n">delt</span> <span class="o">=</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">lsize</span>    <span class="c"># Variable for label names displacement</span>

    <span class="k">if</span> <span class="n">squared</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">lsize</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">lsize</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">lsize</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">lsize</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">autoscale</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>


<span class="c">#    lsize = 0.06*(max(ra)-min(ra))  # Variable for vectors size</span>
<span class="c">#    lysize = 0.1*(max(dec)-min(dec))/(max(dec)+min(dec))  # Variable for vectors size</span>
<span class="c">#    lsize = np.sqrt(lxsize**2 + lysize**2)</span>
<span class="c">#    lsize = 0.1</span>
<span class="c">#    ratio = (max(dec)-min(dec)+2*lsize)/(max(ra)-min(ra)+2*lsize)  # Variable for vectors size</span>
<span class="c">#    ratio=0.65</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="mf">100.</span>  <span class="c"># 100. to pass in first iteration</span>
    <span class="c"># Do the subplots</span>
<span class="c">#    vec = np.arange(0,180.,180./len(objarr[0]))</span>
<span class="c">#    tharr[0] = vec.tolist()</span>
<span class="c">#    raarr[0] = [0 for i in range(len(raarr[0]))]</span>
<span class="c">#    decarr[0] = [0 for i in range(len(raarr[0]))]</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">filt</span> <span class="o">=</span> <span class="n">objarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">raarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">decarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="n">thet</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tharr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="n">sthet</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tharr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">colrs</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">ymin</span><span class="p">:</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="n">y</span>
            
        <span class="c"># Plot vectors</span>
        <span class="n">xvert</span><span class="p">,</span> <span class="n">yvert</span> <span class="o">=</span> <span class="n">gen_polar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lsize</span><span class="p">,</span> <span class="n">thet</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvert</span><span class="p">,</span> <span class="n">yvert</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

        <span class="c"># Plot errors</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">gen_spolar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lsize</span><span class="p">,</span> <span class="n">thet</span><span class="p">,</span> <span class="n">sthet</span><span class="p">)</span>
        <span class="n">polygon</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.18</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>

        <span class="c"># Print object names</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ileg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ileg</span> <span class="ow">in</span> <span class="n">leg</span><span class="p">]:</span>
            <span class="n">n</span><span class="o">=</span><span class="mi">0</span>

            <span class="c"># Compute scale to fix the label positions</span>
            <span class="k">if</span> <span class="n">squared</span><span class="p">:</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.035</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.06</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="nb">min</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">idecarr</span><span class="p">)</span> <span class="k">for</span> <span class="n">idecarr</span> <span class="ow">in</span> <span class="n">decarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="o">-</span> \
                            <span class="nb">max</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">idecarr</span><span class="p">)</span> <span class="k">for</span> <span class="n">idecarr</span> <span class="ow">in</span> <span class="n">decarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>

            <span class="c"># Verify if another label shall be closer to the current label</span>
            <span class="k">for</span> <span class="n">ileg</span> <span class="ow">in</span> <span class="n">leg</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">ileg</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">delt</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">ileg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">delt</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">x1</span> <span class="o">=</span> <span class="n">ileg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">y1</span> <span class="o">=</span> <span class="n">ileg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x1</span><span class="o">=</span><span class="n">x</span>
                <span class="n">yleg</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">lsize</span><span class="o">*</span><span class="mf">1.5</span>
                <span class="n">objleg</span> <span class="o">=</span> <span class="n">fixName</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">yleg</span> <span class="o">=</span> <span class="n">y1</span><span class="o">-</span><span class="n">lsize</span><span class="o">*</span><span class="mf">1.5</span><span class="o">-</span><span class="n">n</span><span class="o">*</span><span class="n">scale</span>
                <span class="n">objleg</span> <span class="o">=</span> <span class="s">&#39;+ &#39;</span> <span class="o">+</span> <span class="n">fixName</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">yleg</span><span class="p">,</span> <span class="s">&#39;{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objleg</span><span class="p">),</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&#39;baseline&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">leg</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">obj</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">yleg</span> <span class="o">&lt;</span> <span class="n">ymin</span><span class="p">:</span>
                <span class="n">ymin</span> <span class="o">=</span> <span class="n">yleg</span>

    <span class="c"># Print point for Be star</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

    <span class="c"># Fix y limits if squared==False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">squared</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">ymin</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">lsize</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]])</span>
  
    <span class="c"># Fix limits</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">autoscale</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;k--&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">(),</span> <span class="s">&#39;k--&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>

    <span class="c"># Setting sizes</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
        <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}_field.{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">,</span><span class="n">extens</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>



<span class="c"># bin same object+filter data</span></div>
<div class="viewcode-block" id="binData"><a class="viewcode-back" href="../../fieldstars.html#pyhdust.fieldstars.binData">[docs]</a><span class="k">def</span> <span class="nf">binData</span><span class="p">(</span><span class="n">objarr</span><span class="p">,</span> <span class="n">xarr</span><span class="p">,</span> <span class="n">yarr</span><span class="p">,</span> <span class="n">zarr</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ignx</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">igny</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">prevent</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bin data</span>

<span class="sd">    objarr is a list [[objects], [filters], [flags]]</span>
<span class="sd">      xarr is a list [[x values], [sx values]]  (idem for yarr and zarr)</span>

<span class="sd">    If zarr is void, bin just the y values and calculate error by</span>
<span class="sd">    propagation only (no stddev). Otherwise, bin only the z values.</span>

<span class="sd">    - prevent:   prevent to bin when flags contain &#39;no-std&#39;? If True,</span>
<span class="sd">                 case there are more than one point able to be binned,</span>
<span class="sd">                 bin only the data which don&#39;t have &#39;no-std&#39; flag. The</span>
<span class="sd">                 output lists will have a copy of every line from those</span>
<span class="sd">                 in input lists with &#39;no-std&#39; flag, as like as the</span>
<span class="sd">                 binned lines among those that just don&#39;t have &#39;no-std&#39;</span>
<span class="sd">                 flag.</span>

<span class="sd">    CAUTION: only bins when the contents of objarr AND xarr are the</span>
<span class="sd">    same (AND yarr also, case zarr != None)! Only if ignx or/and igny</span>
<span class="sd">    parameter have value &#39;True&#39; the routine ignores when xarr or/and</span>
<span class="sd">    yarr have not the same values. In this case, the x or/and y value</span>
<span class="sd">    to be returned are taken from the first occurrence.</span>

<span class="sd">    CONSIDERATIONS:</span>

<span class="sd">    - The error of binned data is just the propagated error,</span>
<span class="sd">      sqrt(sum(sigma_i^2))/n, and doesn&#39;t consider the stddev</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Check sizes of lists</span>
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">product</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">lista</span><span class="p">)</span> <span class="k">for</span> <span class="n">lista</span> <span class="ow">in</span> <span class="p">(</span><span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">objarr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> \
                        <span class="n">xarr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xarr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">yarr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yarr</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span><span class="n">repeat</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: Data binning not processed because the lists have distinct sizes&#39;</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="c"># Loop on lines</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">obj</span><span class="o">=</span><span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">fil</span><span class="o">=</span><span class="n">objarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">tags</span><span class="o">=</span><span class="n">objarr</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">x</span><span class="o">=</span><span class="n">xarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">sx</span><span class="o">=</span><span class="n">xarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="c"># If it is to prevent, preserve the line without to bin</span>
        <span class="c"># when &#39;no-std&#39; is in tags</span>
        <span class="k">if</span> <span class="n">prevent</span> <span class="ow">and</span> <span class="s">&#39;no-std&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">zarr</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">yarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">yarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">yarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span><span class="o">=</span><span class="n">yarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">sy</span><span class="o">=</span><span class="n">yarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">zarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">zarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">zarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">n</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">j</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="c"># looking for the same object/filter from i-esim line until the end</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c"># break if another object or end of list</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="n">obj</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c"># If all j-esim components are equal, except the z values (or y values,</span>
            <span class="c">#   case zarr is void), calculate the mean</span>
            <span class="k">elif</span> <span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">obj</span> <span class="ow">and</span> <span class="n">objarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">fil</span> <span class="ow">and</span> \
                       <span class="p">(</span><span class="n">ignx</span> <span class="ow">or</span> <span class="p">(</span><span class="n">xarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span> <span class="ow">and</span> <span class="n">xarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">sx</span><span class="p">))</span> <span class="ow">and</span> \
                       <span class="p">(</span><span class="n">zarr</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">igny</span> <span class="ow">or</span> <span class="p">(</span><span class="n">yarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">y</span> <span class="ow">and</span> <span class="n">yarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">sy</span><span class="p">)):</span>
                <span class="n">n</span><span class="o">+=</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">zarr</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">yarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">yarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">yarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">yarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">zarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">zarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">zarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">zarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">del</span><span class="p">(</span><span class="n">zarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                    <span class="k">del</span><span class="p">(</span><span class="n">zarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                <span class="k">del</span><span class="p">(</span><span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                <span class="k">del</span><span class="p">(</span><span class="n">objarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                <span class="k">del</span><span class="p">(</span><span class="n">xarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                <span class="k">del</span><span class="p">(</span><span class="n">xarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                <span class="k">del</span><span class="p">(</span><span class="n">yarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                <span class="k">del</span><span class="p">(</span><span class="n">yarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
            <span class="c"># skip to next</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c"># Conclude the computation of average and propagated error</span>
        <span class="k">if</span> <span class="n">zarr</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">yarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">yarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">n</span>
            <span class="k">if</span> <span class="n">yarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="n">yarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">yarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="n">n</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">zarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">n</span>
            <span class="k">if</span> <span class="n">zarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="n">zarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">zarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="n">n</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>


</div>
<span class="k">def</span> <span class="nf">graf_theta</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">vfilter</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;no-std&#39;</span><span class="p">],</span> <span class="n">save</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">bin_data</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">onlyY</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> \
                                                                       <span class="n">extens</span><span class="o">=</span><span class="s">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">unbias</span><span class="o">=</span><span class="s">&#39;wk&#39;</span><span class="p">):</span>

    <span class="c"># Verify if vfilter is a special filter</span>
    <span class="k">if</span> <span class="n">vfilter</span> <span class="ow">in</span> <span class="n">polt</span><span class="o">.</span><span class="n">vfil</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">vfilter</span> <span class="o">=</span> <span class="n">polt</span><span class="o">.</span><span class="n">vfil</span><span class="p">[</span><span class="n">vfilter</span><span class="p">]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">readcsv</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">be</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;No {0} data!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="n">objarr</span><span class="p">,</span> <span class="n">filtarr</span><span class="p">,</span> <span class="n">tharr</span> <span class="o">=</span> <span class="n">getTable</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&#39;filt&#39;</span><span class="p">,</span> <span class="s">&#39;thet&#39;</span><span class="p">,</span> <span class="n">sy</span><span class="o">=</span><span class="s">&#39;sthet&#39;</span><span class="p">,</span> \
                                            <span class="n">vfilter</span><span class="o">=</span><span class="n">vfilter</span><span class="p">,</span> <span class="n">bin_data</span><span class="o">=</span><span class="n">bin_data</span><span class="p">,</span> <span class="n">onlyY</span><span class="o">=</span><span class="n">onlyY</span><span class="p">,</span> <span class="n">unbias</span><span class="o">=</span><span class="n">unbias</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">objarr</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">or</span> <span class="n">objarr</span> <span class="o">==</span> <span class="p">[[],[],[]]:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;No {0} valid data!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="c"># Compute the mean angle</span>
    <span class="c"># A new objarr is needed because the bin_data==False can do the objarr below have a larger length</span>
    <span class="n">objarr_qu</span><span class="p">,</span> <span class="n">qarr</span><span class="p">,</span> <span class="n">uarr</span> <span class="o">=</span> <span class="n">getTable</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&#39;q&#39;</span><span class="p">,</span> <span class="s">&#39;u&#39;</span><span class="p">,</span> <span class="n">sx</span><span class="o">=</span><span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="n">sy</span><span class="o">=</span><span class="s">&#39;s&#39;</span><span class="p">,</span> \
                                    <span class="n">vfilter</span><span class="o">=</span><span class="n">vfilter</span><span class="p">,</span> <span class="n">bin_data</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">onlyY</span><span class="o">=</span><span class="n">onlyY</span><span class="p">,</span> <span class="n">unbias</span><span class="o">=</span><span class="n">unbias</span><span class="p">)</span>
    <span class="n">thmean</span> <span class="o">=</span> <span class="n">meanAngle</span><span class="p">(</span><span class="n">qarr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">uarr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qarr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">uarr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">estim</span><span class="o">=</span><span class="n">unbias</span><span class="p">)</span>

        
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;Field Stars - {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">phc</span><span class="o">.</span><span class="n">bes</span><span class="p">[</span><span class="n">be</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&#39;bottom&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;star/filter&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;$\theta$ (degree)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pts</span><span class="o">=</span><span class="p">[[],[],[]]</span>
    <span class="n">longname</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="c"># Do the subplots</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">if</span> <span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">tharr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">if</span> <span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">tharr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">if</span> <span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>

<span class="c">#        pts[0].sort(key=lambda x: x[0])</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">gen_color</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">onlyY</span><span class="o">=</span><span class="n">onlyY</span><span class="p">)</span>
        <span class="n">nome</span> <span class="o">=</span> <span class="n">fixName</span><span class="p">(</span><span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nome</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">13</span><span class="p">:</span>
            <span class="n">longname</span> <span class="o">=</span> <span class="bp">True</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">nome</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">break</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="n">j</span><span class="o">/</span><span class="mi">3</span><span class="p">])</span>
    
    <span class="c"># Setting legend</span>
    <span class="n">leg</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">numpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;size&#39;</span><span class="p">:</span><span class="n">fonts</span><span class="p">[</span><span class="mi">3</span><span class="p">]})</span>
    <span class="n">leg</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),</span> <span class="p">[</span><span class="n">thmean</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">thmean</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s">&#39;k--&#39;</span><span class="p">)</span>

    <span class="c"># Setting sizes</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
        <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}_tht.{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">,</span><span class="n">extens</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>




<div class="viewcode-block" id="meanAngle"><a class="viewcode-back" href="../../fieldstars.html#pyhdust.fieldstars.meanAngle">[docs]</a><span class="k">def</span> <span class="nf">meanAngle</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">sq</span><span class="p">,</span><span class="n">su</span><span class="p">,</span><span class="n">estim</span><span class="o">=</span><span class="s">&#39;wk&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the mean angle and the error propagated</span>

<span class="sd">    The computation is over QU parameters.</span>


<span class="sd">    Unbias theta error using &#39;estim&#39; estimator:</span>

<span class="sd">        if p/sp &lt;= K,   s_theta = psi</span>
<span class="sd">        otherwise,      s_theta = propagated error</span>

<span class="sd">      where K is given by the estimator related to the</span>
<span class="sd">      &#39;estim&#39; variable:</span>

<span class="sd">         a) &#39;ml&#39; : Maximum Likelihood (K=1.41, psi=51.96)</span>
<span class="sd">         b) &#39;wk&#39; : Wardle &amp; Kronberg (K=1.0, psi=51.96)</span>
<span class="sd">         c) &#39;&#39;   : None (K=0, psi=51.96)</span>
<span class="sd">         d) &#39;mts&#39;: Maier, Tenzer &amp; Santangelo (estimates</span>
<span class="sd">                   from Bayesian analysis, psi=61.14)</span>
<span class="sd">             </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">estim</span><span class="o">==</span><span class="s">&#39;wk&#39;</span><span class="p">:</span>
        <span class="n">k</span><span class="o">=</span><span class="mf">1.</span>
    <span class="k">elif</span> <span class="n">estim</span><span class="o">==</span><span class="s">&#39;ml&#39;</span><span class="p">:</span>
        <span class="n">k</span><span class="o">=</span><span class="mf">1.41</span>
    <span class="k">elif</span> <span class="n">estim</span><span class="o">==</span><span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="n">k</span><span class="o">=</span><span class="mf">0.</span>
    <span class="k">elif</span> <span class="n">estim</span><span class="o">!=</span><span class="s">&#39;mts&#39;</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: estimation type `{0}` not valid!.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">estim</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">qq</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">sqq</span><span class="p">,</span> <span class="n">suu</span> <span class="o">=</span> <span class="n">q</span><span class="p">[:],</span> <span class="n">u</span><span class="p">[:],</span> <span class="n">sq</span><span class="p">[:],</span> <span class="n">su</span><span class="p">[:]</span>
    <span class="c"># Use binData to compute the mean Q and U values</span>
    <span class="c"># espn variables are artifices to bin all data from qq and uu lists using binData</span>
    <span class="n">esp1</span> <span class="o">=</span> <span class="p">[[</span><span class="s">&#39;&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">))],</span> <span class="p">[</span><span class="s">&#39;&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">))],</span> <span class="p">[</span><span class="s">&#39;&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">))]]</span>
    <span class="n">esp2</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">esp1</span><span class="p">)</span>
    <span class="n">esp3</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">esp1</span><span class="p">)</span>
    <span class="n">esp4</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">esp1</span><span class="p">)</span>
    <span class="n">binData</span><span class="p">(</span><span class="n">esp1</span><span class="p">,</span> <span class="n">esp2</span><span class="p">,</span> <span class="p">[</span><span class="n">qq</span><span class="p">,</span><span class="n">sqq</span><span class="p">])</span>
    <span class="n">binData</span><span class="p">(</span><span class="n">esp3</span><span class="p">,</span> <span class="n">esp4</span><span class="p">,</span> <span class="p">[</span><span class="n">uu</span><span class="p">,</span><span class="n">suu</span><span class="p">])</span>

    <span class="c"># Prevent division by 0</span>
    <span class="k">if</span> <span class="n">qq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">uu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tht</span> <span class="o">=</span> <span class="mf">45.0</span>
        <span class="k">elif</span> <span class="n">uu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tht</span> <span class="o">=</span> <span class="mf">135.0</span>
    <span class="k">else</span><span class="p">:</span>
<span class="c">#        print qq, uu</span>
<span class="c">#        print sqq, suu</span>
        <span class="n">tht</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">uu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">qq</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">90</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">qq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">uu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">qq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">sqq</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">uu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">suu</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">p</span>
        <span class="n">saux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">qq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">suu</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">uu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">sqq</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">p</span>
        <span class="k">if</span> <span class="n">estim</span><span class="o">!=</span><span class="s">&#39;mts&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sp</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">p</span><span class="o">/</span><span class="n">saux</span> <span class="o">&gt;</span> <span class="n">k</span><span class="p">:</span>
                <span class="n">stht</span> <span class="o">=</span> <span class="mf">28.65</span><span class="o">*</span><span class="n">saux</span><span class="o">/</span><span class="n">p</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stht</span> <span class="o">=</span> <span class="mf">51.96</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># We need to use &#39;saux&#39; below, not &#39;sp&#39;! It is because if U=0, the error that will</span>
            <span class="c"># influence the theta uncertainty is the sigma_U, because sigma_Q will be along the</span>
            <span class="c"># P direction. Comparing the formulas for sp and saux, the one that do it correctly</span>
            <span class="c"># is saux.</span>
            <span class="k">if</span> <span class="n">sp</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">p</span><span class="o">/</span><span class="n">saux</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
                <span class="n">stht</span> <span class="o">=</span> <span class="mf">28.65</span><span class="o">*</span><span class="n">saux</span><span class="o">/</span><span class="n">p</span>
            <span class="k">elif</span> <span class="n">saux</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">a</span><span class="o">=</span><span class="mf">32.50</span>
                <span class="n">b</span><span class="o">=</span><span class="mf">1.350</span>
                <span class="n">c</span><span class="o">=</span><span class="mf">0.739</span>
                <span class="n">d</span><span class="o">=</span><span class="mf">0.801</span>
                <span class="n">e</span><span class="o">=</span><span class="mf">1.154</span>
                <span class="n">stht</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="n">p</span><span class="o">/</span><span class="n">saux</span><span class="p">)))</span> <span class="o">-</span> <span class="n">e</span><span class="o">*</span><span class="n">p</span><span class="o">/</span><span class="n">saux</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stht</span> <span class="o">=</span> <span class="mf">61.14</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tht</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">if</span> <span class="n">estim</span><span class="o">!=</span><span class="s">&#39;mts&#39;</span><span class="p">:</span>
            <span class="n">stht</span> <span class="o">=</span> <span class="mf">51.96</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stht</span> <span class="o">=</span> <span class="mf">61.14</span>

    <span class="c"># Fix the angle to the correct in QU diagram</span>
    <span class="k">if</span> <span class="n">qq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">tht</span> <span class="o">+=</span> <span class="mi">90</span>
    <span class="k">if</span> <span class="n">tht</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">tht</span> <span class="o">+=</span> <span class="mi">180</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">tht</span><span class="p">,</span> <span class="n">stht</span><span class="p">]</span>


</div>
<div class="viewcode-block" id="meanAngle_star"><a class="viewcode-back" href="../../fieldstars.html#pyhdust.fieldstars.meanAngle_star">[docs]</a><span class="k">def</span> <span class="nf">meanAngle_star</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">filts</span><span class="o">=</span><span class="s">&#39;ubvri&#39;</span><span class="p">,</span> <span class="n">vfilter</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;no-std&#39;</span><span class="p">],</span> <span class="n">onlyY</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">estim</span><span class="o">=</span><span class="s">&#39;wk&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the meanAngle for star &#39;obj&#39; in field of Be</span>
<span class="sd">        &#39;be&#39; computed in all filters specified in string</span>
<span class="sd">        format in the variable &#39;filts&#39;.</span>

<span class="sd">        For example, if filts=&#39;ubv&#39;, this routine will</span>
<span class="sd">        compute the mean angle among UBV filters.</span>


<span class="sd">        Unbias theta error using &#39;estim&#39; estimator:</span>

<span class="sd">            if p/sp &lt;= K,   s_theta = psi</span>
<span class="sd">            otherwise,      s_theta = propagated error</span>

<span class="sd">          where K is given by the estimator related to the</span>
<span class="sd">          &#39;estim&#39; variable:</span>

<span class="sd">             a) &#39;ml&#39; : Maximum Likelihood (K=1.41, psi=51.96)</span>
<span class="sd">             b) &#39;wk&#39; : Wardle &amp; Kronberg (K=1.0, psi=51.96)</span>
<span class="sd">             c) &#39;&#39;   : None (K=0, psi=51.96)</span>
<span class="sd">             d) &#39;mts&#39;: Maier, Tenzer &amp; Santangelo (estimates</span>
<span class="sd">                       from Bayesian analysis, psi=61.14)</span>


<span class="sd">        CONSIDERATIONS:</span>

<span class="sd">        - Operations over QU parameters</span>

<span class="sd">        - Error from standard star is propagated</span>

<span class="sd">        - If estim != &#39;&#39; and the final polarization p is</span>
<span class="sd">          smaller than its uncertainty multiplied by the</span>
<span class="sd">          estimator factor K, the error of theta has the</span>
<span class="sd">          value 51.96 or 61.14, depending of the model</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="c"># Verify if vfilter is a special filter</span>
    <span class="k">if</span> <span class="n">vfilter</span> <span class="ow">in</span> <span class="n">polt</span><span class="o">.</span><span class="n">vfil</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">vfilter</span> <span class="o">=</span> <span class="n">polt</span><span class="o">.</span><span class="n">vfil</span><span class="p">[</span><span class="n">vfilter</span><span class="p">]</span>

    <span class="c"># Read tables and unbias data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">readcsv</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">be</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;No {0} data!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="c"># Get tables</span>
    <span class="n">objarr</span><span class="p">,</span> <span class="n">qarr</span><span class="p">,</span> <span class="n">uarr</span> <span class="o">=</span> <span class="n">getTable</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&#39;q&#39;</span><span class="p">,</span> <span class="s">&#39;u&#39;</span><span class="p">,</span> <span class="n">sx</span><span class="o">=</span><span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="n">sy</span><span class="o">=</span><span class="s">&#39;s&#39;</span><span class="p">,</span> \
                                    <span class="n">vfilter</span><span class="o">=</span><span class="n">vfilter</span><span class="p">,</span> <span class="n">bin_data</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">onlyY</span><span class="o">=</span><span class="n">onlyY</span><span class="p">)</span>
    <span class="n">lixo</span><span class="p">,</span> <span class="n">parr</span><span class="p">,</span> <span class="n">arr_aux</span><span class="p">,</span> <span class="o">=</span> <span class="n">getTable</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&#39;p&#39;</span><span class="p">,</span> <span class="s">&#39;thet&#39;</span><span class="p">,</span> <span class="n">sx</span><span class="o">=</span><span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="n">sy</span><span class="o">=</span><span class="s">&#39;sdth&#39;</span><span class="p">,</span> \
                                    <span class="n">vfilter</span><span class="o">=</span><span class="n">vfilter</span><span class="p">,</span> <span class="n">bin_data</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">onlyY</span><span class="o">=</span><span class="n">onlyY</span><span class="p">)</span>

    <span class="c"># Propagate error from standard star</span>
    <span class="n">lixo</span><span class="p">,</span> <span class="n">qarr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">uarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">polt</span><span class="o">.</span><span class="n">propQU</span><span class="p">(</span><span class="n">parr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arr_aux</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">arr_aux</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">qarr_filt</span><span class="p">,</span> <span class="n">uarr_filt</span> <span class="o">=</span> <span class="p">[[],[]],</span> <span class="p">[[],[]]</span>
    <span class="c"># Create new qarr and uarr with the data of star &#39;obj&#39; in filters &#39;filts&#39;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">obji</span><span class="p">,</span> <span class="n">flti</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">objarr</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
        <span class="k">if</span> <span class="n">obji</span> <span class="o">==</span> <span class="n">obj</span> <span class="ow">and</span> <span class="n">flti</span> <span class="ow">in</span> <span class="n">filts</span><span class="p">:</span>
            <span class="n">qarr_filt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">qarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">qarr_filt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">qarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">uarr_filt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">uarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">uarr_filt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">uarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>

    <span class="c"># Compute the thmean</span>
    <span class="k">if</span> <span class="n">qarr_filt</span> <span class="o">!=</span> <span class="p">[[],[]]:</span>
        <span class="n">thmean</span> <span class="o">=</span> <span class="n">meanAngle</span><span class="p">(</span><span class="n">qarr_filt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">uarr_filt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qarr_filt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">uarr_filt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">estim</span><span class="o">=</span><span class="n">estim</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">thmean</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">thmean</span>


    

</div>
<div class="viewcode-block" id="gen_color"><a class="viewcode-back" href="../../fieldstars.html#pyhdust.fieldstars.gen_color">[docs]</a><span class="k">def</span> <span class="nf">gen_color</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">onlyY</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Receives a string &#39;csvfile&#39; pointing to the csvfile,</span>
<span class="sd">    a Be star &#39;be&#39; and the field star named &#39;obj&#39;. </span>
<span class="sd">    Returns a smart computed np array for the color</span>
<span class="sd">    of such field star.</span>

<span class="sd">    Note that if you run this task with distinct values</span>
<span class="sd">    for &#39;onlyY&#39;, the color returned may be distinct also.</span>

<span class="sd">    &#39;be&#39; parameter is necessary because some field stars</span>
<span class="sd">    are used for more than one Be star.</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">data</span> <span class="o">=</span> <span class="n">readcsv</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">be</span><span class="p">)</span>
<span class="c">#    print data</span>

    <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;No {0} data!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="n">stars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
<span class="c">#        print block</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">idx2</span><span class="p">[</span><span class="s">&#39;tgt&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stars</span> <span class="ow">and</span> <span class="p">((</span><span class="n">onlyY</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="n">idx2</span><span class="p">[</span><span class="s">&#39;sel?&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="s">&#39;Y&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">onlyY</span><span class="p">):</span>
            <span class="n">stars</span> <span class="o">+=</span> <span class="p">[</span><span class="n">target</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.04</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">4.775</span><span class="o">/</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">spectral</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span>
<span class="c">#        norm = Normalize(vmin=0., vmax=len(stars))</span>
<span class="c">#        cm = plt.cm.ScalarMappable(norm=norm, cmap=plt.cm.get_cmap(cmap)).to_rgba(norm)</span>

        <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">stars</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">stars</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">fcm</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fcm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">fcm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

    <span class="k">return</span> <span class="n">fcm</span>



</div>
<div class="viewcode-block" id="fixName"><a class="viewcode-back" href="../../fieldstars.html#pyhdust.fieldstars.fixName">[docs]</a><span class="k">def</span> <span class="nf">fixName</span><span class="p">(</span><span class="n">star</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fix the name of star &#39;star&#39;, returning the</span>
<span class="sd">    printable name.</span>

<span class="sd">    &#39;hd&#39;      -&gt;  &#39;HD &#39;</span>
<span class="sd">    &#39;2MASS-&#39;  -&gt;  &#39;&#39;</span>
<span class="sd">    &#39;hip&#39;     -&gt;  &#39;HIP &#39;</span>
<span class="sd">    &#39;TYC-&#39;    -&gt;  &#39;TYC &#39;</span>

<span class="sd">    Return identical &#39;star&#39; name if the name was not</span>
<span class="sd">    identified</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">fixx</span><span class="p">(</span><span class="n">starr</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;^2MASS-J[0-9-+]*$&#39;</span><span class="p">,</span><span class="n">starr</span><span class="p">)):</span>
            <span class="n">nome</span> <span class="o">=</span> <span class="n">starr</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;^(hip|HIP)[0-9]*$&#39;</span><span class="p">,</span><span class="n">starr</span><span class="p">)):</span>
            <span class="n">nome</span> <span class="o">=</span> <span class="s">&#39;HIP &#39;</span><span class="o">+</span> <span class="n">starr</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;^(tyc|TYC)-[0-9-]*$&#39;</span><span class="p">,</span><span class="n">starr</span><span class="p">)):</span>
            <span class="n">nome</span> <span class="o">=</span> <span class="s">&#39;TYC &#39;</span> <span class="o">+</span> <span class="n">starr</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;^(hd|HD)[0-9]*$&#39;</span><span class="p">,</span><span class="n">starr</span><span class="p">)):</span>
            <span class="n">nome</span> <span class="o">=</span> <span class="s">&#39;HD &#39;</span> <span class="o">+</span> <span class="n">starr</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;^h[0-9]*$&#39;</span><span class="p">,</span><span class="n">starr</span><span class="p">)):</span>
            <span class="n">nome</span> <span class="o">=</span> <span class="s">&#39;HD &#39;</span> <span class="o">+</span> <span class="n">starr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;^hr[0-9]*$&#39;</span><span class="p">,</span><span class="n">starr</span><span class="p">)):</span>
            <span class="n">nome</span> <span class="o">=</span> <span class="s">&#39;HR &#39;</span> <span class="o">+</span> <span class="n">starr</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;^bd-[0-9-+]*$&#39;</span><span class="p">,</span><span class="n">starr</span><span class="p">)):</span>
            <span class="n">nome</span> <span class="o">=</span> <span class="s">&#39;BD-&#39;</span> <span class="o">+</span> <span class="n">starr</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">starr</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">starr</span> <span class="ow">in</span> <span class="n">phc</span><span class="o">.</span><span class="n">bes</span><span class="p">:</span>
            <span class="n">nome</span> <span class="o">=</span> <span class="n">phc</span><span class="o">.</span><span class="n">bes</span><span class="p">[</span><span class="n">starr</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nome</span> <span class="o">=</span> <span class="n">starr</span>

        <span class="k">return</span> <span class="n">nome</span>


    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;.*_field&#39;</span><span class="p">,</span><span class="n">star</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">star</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">phc</span><span class="o">.</span><span class="n">bes</span><span class="p">:</span>
            <span class="n">nome</span> <span class="o">=</span> <span class="s">&#39;Star #&#39;</span> <span class="o">+</span> <span class="n">star</span><span class="p">[</span><span class="n">star</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;_field&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">6</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nome</span> <span class="o">=</span> <span class="n">fixx</span><span class="p">(</span><span class="n">star</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s">&#39; (Star #&#39;</span> <span class="o">+</span> <span class="n">star</span><span class="p">[</span><span class="n">star</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;_field&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">6</span><span class="p">:]</span> <span class="o">+</span> <span class="s">&#39;)&#39;</span>
    <span class="k">elif</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;.*_.$&#39;</span><span class="p">,</span><span class="n">star</span><span class="p">)):</span>
            <span class="n">nome</span> <span class="o">=</span> <span class="n">fixx</span><span class="p">(</span><span class="n">star</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">star</span><span class="p">[</span><span class="n">star</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nome</span> <span class="o">=</span> <span class="n">fixx</span><span class="p">(</span><span class="n">star</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">nome</span>


</div>
<div class="viewcode-block" id="unbiasData"><a class="viewcode-back" href="../../fieldstars.html#pyhdust.fieldstars.unbiasData">[docs]</a><span class="k">def</span> <span class="nf">unbiasData</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">estim</span><span class="o">=</span><span class="s">&#39;wk&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unbias P data, appling the operation over input</span>
<span class="sd">    lists/arrays:</span>

<span class="sd">    p^2 -&gt; p^2 - K^2 s^2</span>

<span class="sd">    INPUT</span>

<span class="sd">          p: % polarization</span>
<span class="sd">          s: pol error</span>
<span class="sd">      estim: estimative model:</span>
<span class="sd">             a) &#39;ml&#39;: Maximum Likelihood (K=1.41)</span>
<span class="sd">             b) &#39;wk&#39;: Wardle &amp; Kronberg (K=1.0)</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">estim</span><span class="o">==</span><span class="s">&#39;wk&#39;</span><span class="p">:</span>
        <span class="n">k</span><span class="o">=</span><span class="mf">1.</span>
    <span class="k">elif</span> <span class="n">estim</span><span class="o">==</span><span class="s">&#39;ml&#39;</span><span class="p">:</span>
        <span class="n">k</span><span class="o">=</span><span class="mf">1.41</span>
    <span class="k">elif</span> <span class="n">estim</span><span class="o">==</span><span class="s">&#39;mts&#39;</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Warning: changing estimation type from `mts` to `wk` to the </span><span class="si">% o</span><span class="s">f pol...&#39;</span><span class="p">)</span>
        <span class="n">k</span><span class="o">=</span><span class="mf">1.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: estimation type `{0}` not valid!.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">estim</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;</span><span class="n">k</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span>


</div>
<div class="viewcode-block" id="graf_p"><a class="viewcode-back" href="../../fieldstars.html#pyhdust.fieldstars.graf_p">[docs]</a><span class="k">def</span> <span class="nf">graf_p</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">thetfile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">vfilter</span><span class="o">=</span><span class="p">[],</span> <span class="n">save</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> \
           <span class="n">bin_data</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">onlyY</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">every</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">rotate</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">unbias</span><span class="o">=</span><span class="s">&#39;wk&#39;</span><span class="p">,</span> <span class="n">law</span><span class="o">=</span><span class="s">&#39;w82&#39;</span><span class="p">,</span> <span class="n">extens</span><span class="o">=</span><span class="s">&#39;pdf&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot  P x wavelength for star &#39;be&#39; and operate over a</span>
<span class="sd">    /&#39;be&#39;_is.csv file. The field stars are read from &#39;csvfile&#39;.</span>

<span class="sd">    Fix the polarization bias using Wardle &amp; Kronberg formula.</span>


<span class="sd">    &#39;csvfile&#39; : location of dados.csv (field stars data).</span>

<span class="sd">    &#39;path&#39; : the path where is located the log file for star &#39;be&#39;</span>
<span class="sd">             (out from polt.genTarget). If None, it is supposed</span>
<span class="sd">             inside the current directory (.).</span>

<span class="sd">    &#39;bin_data&#39;: bin data in graphs?</span>
<span class="sd">    </span>
<span class="sd">    &#39;onlyY&#39;   : use only the field stars with &#39;Y&#39; marks (field</span>
<span class="sd">                stars originally selected for Be star &#39;be&#39;)?</span>

<span class="sd">    &#39;thetfile&#39; : file with the intrinsic angles (oufile from</span>
<span class="sd">                 fs.genInt). If &#39;thetfile&#39; != None, plot the</span>
<span class="sd">                 ISP component parallel to the disk of the Be</span>
<span class="sd">                 star. It is done by rotating the data in QU</span>
<span class="sd">                 diagram at the angle corresponding to the disk</span>
<span class="sd">                 inclination.</span>

<span class="sd">    &#39;unbias&#39;   :   Estimator to unbias the data when &#39;y&#39; or &#39;z&#39;</span>
<span class="sd">                   is equals to &#39;p&#39; or &#39;thet&#39;. Three options:</span>
<span class="sd">                       a) &#39;ml&#39;: Maximum Likelihood (K=1.41)</span>
<span class="sd">                       b) &#39;wk&#39;: Wardle &amp; Kronberg (K=1.0)</span>
<span class="sd">                       c) &#39;&#39;  : None (K=0.)</span>

<span class="sd">                   where K is the factor to unbias (read the</span>
<span class="sd">                   description of routines &#39;unbiasData&#39; and</span>
<span class="sd">                   &#39;meanAngle&#39;.</span>

<span class="sd">    &#39;every&#39;    : use one intrinsic angle for each one filter to</span>
<span class="sd">                 obtain the // component? If every=False makes</span>
<span class="sd">                 all data to use a mean value at the -4:-2 collums</span>
<span class="sd">                 (22th to 24th) from &#39;thetfile&#39;</span>

<span class="sd">    &#39;fit&#39;: fit the ISP using MCMC? Case True, generate the</span>
<span class="sd">           graphs and a file ./&#39;be&#39;_is.csv with the best values.</span>
<span class="sd">           Write the mean polarization angles inside this file</span>
<span class="sd">           also. Case fit==True and there exists this file, this</span>
<span class="sd">           routine will ask to the user if he wants to read the</span>
<span class="sd">           previous fitted parameters and plot the Serkowski curves</span>
<span class="sd">           using them, or if he wants to run MCMC again,</span>
<span class="sd">           overwriting this file. If there exists a ./&#39;be&#39;_is.csv</span>
<span class="sd">           file and some standard star was not fitted yet, this</span>
<span class="sd">           routine will do that and append a line to the csv file.</span>

<span class="sd">    &#39;rotate&#39; : DON&#39;T WORKING PROPERLY. Rotate the polarization of</span>
<span class="sd">               field stars in QU diagram by the mean angle? A</span>
<span class="sd">               option to be explored to replace the unbias procedure.</span>


<span class="sd">    CONSIDERATIONS:</span>

<span class="sd">    - Error for parallel component is the combination between</span>
<span class="sd">    the propagated error and stddev.</span>
<span class="sd">    - Error of standard stars is propagated to the field stars</span>
<span class="sd">    - The polarization angles (PA) inside &#39;be&#39;_is.csv are binned</span>
<span class="sd">      over Stokes parameters ALWAYS. The errors are computed by the</span>
<span class="sd">      simple propagation.</span>
<span class="sd">    - The mean PA for each star is computed using QU parameters</span>
<span class="sd">      in all filters, even when p/sigma_p&lt;1 (when the individual</span>
<span class="sd">      PA error is equals to 51.96), because we are actually</span>
<span class="sd">      operating over QU space!</span>
<span class="sd">    - p/sigma_p inside &#39;be&#39;_is.csv is computed by the ratio of</span>
<span class="sd">      28.65 and the PA error.</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">def</span> <span class="nf">copyFit</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">csvwriter</span><span class="p">,</span> <span class="n">secondcol</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy the line of star &#39;star&#39; inside &#39;be&#39;_is.csv file</span>
<span class="sd">        to the writer csvwriter</span>
<span class="sd">        If &#39;secondcol&#39; != None, do the copy only when the 2nd</span>
<span class="sd">        column inside &#39;be&#39;_is.csv has the value &#39;secondcol&#39;.</span>

<span class="sd">        Return pmax, lmax arrays with the values and</span>
<span class="sd">        errors (+ and -).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pmax</span><span class="p">,</span> <span class="n">lmax</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">fr</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;{0}_is.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">csvread</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;;&#39;</span><span class="p">)</span><span class="c">#, quoting=csv.QUOTE_NONE, quotechar=&#39;&#39;)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">csvread</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">star</span> <span class="ow">and</span> <span class="p">(</span><span class="n">secondcol</span><span class="o">==</span><span class="bp">None</span> <span class="ow">or</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">secondcol</span><span class="p">):</span>
                <span class="n">csvwriter</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">pmax</span><span class="p">,</span> <span class="n">lmax</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]),</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
<span class="c">#                break</span>

        <span class="n">fr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">pmax</span><span class="p">,</span> <span class="n">lmax</span>


        

    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>


    <span class="c"># Verify if vfilter is a special filter</span>
    <span class="k">if</span> <span class="n">vfilter</span> <span class="ow">in</span> <span class="n">polt</span><span class="o">.</span><span class="n">vfil</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">vfilter</span> <span class="o">=</span> <span class="n">polt</span><span class="o">.</span><span class="n">vfil</span><span class="p">[</span><span class="n">vfilter</span><span class="p">]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">)</span>


    <span class="c"># Read tables and unbias data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">readcsv</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">be</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;No {0} data!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="n">objarr</span><span class="p">,</span> <span class="n">larr</span><span class="p">,</span> <span class="n">parr</span> <span class="o">=</span> <span class="n">getTable</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&#39;leff&#39;</span><span class="p">,</span> <span class="s">&#39;p&#39;</span><span class="p">,</span> <span class="n">sy</span><span class="o">=</span><span class="s">&#39;s&#39;</span><span class="p">,</span> \
                                    <span class="n">vfilter</span><span class="o">=</span><span class="n">vfilter</span><span class="p">,</span> <span class="n">bin_data</span><span class="o">=</span><span class="n">bin_data</span><span class="p">,</span> <span class="n">onlyY</span><span class="o">=</span><span class="n">onlyY</span><span class="p">,</span> <span class="n">unbias</span><span class="o">=</span><span class="n">unbias</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">objarr</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">or</span> <span class="n">objarr</span> <span class="o">==</span> <span class="p">[[],[],[]]:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;No {0} valid data!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="c"># Done inside getTable routine now</span>
<span class="c">#    if unbias in (&#39;ml&#39;,&#39;wk&#39;):</span>
<span class="c">#        unbiasData(parr[0], parr[1], unbias)</span>


    <span class="c"># Try to find a current &#39;be&#39;_is.csv file, request to the user and initialize</span>
    <span class="c"># the file for the output of the fitted parameters</span>
    <span class="k">if</span> <span class="n">fit</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}_is.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">)):</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">while</span> <span class="n">opt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;2&#39;</span><span class="p">):</span>
                <span class="k">print</span><span class="p">((</span><span class="s">&#39;# File with ISP fits {0}_is.csv already exists. Type the option:</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span>\
                       <span class="s">&#39;  1) Use this saved values to plot the fitted Serkowski curve;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span>\
                       <span class="s">&#39;  2) Run the MCMC to fit all again.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">))</span>
                <span class="n">opt</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;Type the option: &#39;</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">&#39;1&#39;</span><span class="p">:</span>
                <span class="n">usePrevious</span><span class="o">=</span><span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">usePrevious</span><span class="o">=</span><span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">usePrevious</span><span class="o">=</span><span class="bp">False</span>

        <span class="n">fout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;{0}_is_tmp.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">csvout</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">fout</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;;&#39;</span><span class="p">)</span><span class="c">#, quoting=csv.QUOTE_NONE, quotechar=&#39;&#39;)</span>
        <span class="n">csvout</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s">&#39;#obj&#39;</span><span class="p">,</span><span class="s">&#39;#name&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;Pmax&#39;</span><span class="p">,</span><span class="s">&#39;sPmax_+&#39;</span><span class="p">,</span><span class="s">&#39;sPmax_-&#39;</span><span class="p">,</span> <span class="s">&#39;lmax&#39;</span><span class="p">,</span><span class="s">&#39;slmax_+&#39;</span><span class="p">,</span><span class="s">&#39;slmax_-&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;chi&#39;</span><span class="p">,</span><span class="s">&#39;n&#39;</span><span class="p">]</span><span class="o">+</span>\
<span class="c">#        csvout.writerow([&#39;#obj&#39;,&#39;#name&#39;]+\</span>
                        <span class="p">[</span><span class="s">&#39;&lt;th&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;s&lt;th&gt;&#39;</span><span class="p">,</span><span class="s">&#39;&lt;p/sp&gt;&#39;</span><span class="p">]</span><span class="o">+</span>\
                        <span class="p">[</span><span class="s">&#39;plot point?&#39;</span><span class="p">,</span> <span class="s">&#39;use in fit?&#39;</span><span class="p">,</span> <span class="s">&#39;comments&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">]</span><span class="o">+</span>\
                        <span class="p">[</span><span class="s">&#39;th_u&#39;</span><span class="p">,</span> <span class="s">&#39;sth_u&#39;</span><span class="p">,</span><span class="s">&#39;th_b&#39;</span><span class="p">,</span> <span class="s">&#39;sth_b&#39;</span><span class="p">,</span><span class="s">&#39;th_v&#39;</span><span class="p">,</span> <span class="s">&#39;sth_v&#39;</span><span class="p">,</span><span class="s">&#39;th_r&#39;</span><span class="p">,</span> <span class="s">&#39;sth_r&#39;</span><span class="p">,</span><span class="s">&#39;th_i&#39;</span><span class="p">,</span> <span class="s">&#39;sth_i&#39;</span><span class="p">]</span><span class="o">+</span>\
                        <span class="p">[</span><span class="s">&#39;p/sp_u&#39;</span><span class="p">,</span> <span class="s">&#39;p/sp_b&#39;</span><span class="p">,</span> <span class="s">&#39;p/sp_v&#39;</span><span class="p">,</span> <span class="s">&#39;p/sp_r&#39;</span><span class="p">,</span> <span class="s">&#39;p/sp_i&#39;</span><span class="p">])</span>


    <span class="c"># Get the table for theta values, propagating errors from standard and computing the mean angle by filter.</span>
    <span class="c"># IMPORTANT: Allways bin data below to compute the mean angle in all cases! Allways include &#39;no-std&#39; to</span>
    <span class="c"># filter a incorrect theta value without standard calibration, even if vfilter doesn&#39;t contain this flag.</span>
    <span class="k">if</span> <span class="n">rotate</span> <span class="ow">or</span> <span class="n">fit</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;no-std&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vfilter</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: no tag `no-std` in vfilter variable. Adding this tag in computation of theta values...&#39;</span><span class="p">)</span>
            <span class="n">vfilter_thet</span> <span class="o">=</span> <span class="n">vfilter</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;no-std&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vfilter_thet</span> <span class="o">=</span> <span class="n">vfilter</span>
        <span class="n">objarr_tht</span><span class="p">,</span> <span class="n">lixo</span><span class="p">,</span> <span class="n">thtarr</span> <span class="o">=</span> <span class="n">getTable</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&#39;filt&#39;</span><span class="p">,</span> <span class="s">&#39;thet&#39;</span><span class="p">,</span> <span class="n">sy</span><span class="o">=</span><span class="s">&#39;sthet&#39;</span><span class="p">,</span>  \
                                         <span class="n">vfilter</span><span class="o">=</span><span class="n">vfilter_thet</span><span class="p">,</span> <span class="n">bin_data</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">onlyY</span><span class="o">=</span><span class="n">onlyY</span><span class="p">,</span> <span class="n">unbias</span><span class="o">=</span><span class="n">unbias</span><span class="p">)</span>
                            

    <span class="c"># Initialize the graph</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;Field Stars - {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">phc</span><span class="o">.</span><span class="n">bes</span><span class="p">[</span><span class="n">be</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&#39;bottom&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;$\lambda\ (\AA)$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">rotate</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Q` (%)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;P (%)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">2500</span><span class="p">,</span> <span class="mi">8500</span><span class="p">])</span>


    <span class="c"># Initialize Variables</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pts</span><span class="o">=</span><span class="p">[[],[],[]]</span>
    <span class="n">tht</span> <span class="o">=</span> <span class="p">[[],[]]</span>
    <span class="n">longname</span> <span class="o">=</span> <span class="bp">False</span>


    <span class="c">##############################</span>
    <span class="c">####       MAIN LOOP      ####</span>
    <span class="c"># Do the subplots and fits</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">star</span> <span class="o">=</span> <span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">larr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">if</span> <span class="n">star</span> <span class="o">==</span> <span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">parr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">if</span> <span class="n">star</span> <span class="o">==</span> <span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">parr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">if</span> <span class="n">star</span> <span class="o">==</span> <span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>

<span class="c">#        print objarr_qu[0][j:]</span>
<span class="c">#        print objarr_qu[1][j:]</span>

        <span class="c"># Get the mean angles</span>
        <span class="k">if</span> <span class="n">rotate</span> <span class="ow">or</span> <span class="n">fit</span><span class="p">:</span>
            <span class="n">thmean</span><span class="p">,</span> <span class="n">psp</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">ffil</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filters</span><span class="p">):</span>
                <span class="n">ver</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">ni</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c"># thmean is a plain list with the angles and errors.</span>
                <span class="c"># By the bin performed some lines above, the first matched element is</span>
                <span class="c"># the only one, and concerning to the mean angle computed.</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">objarr_tht</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="n">objarr_tht</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">star</span> <span class="ow">and</span> <span class="n">objarr_tht</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">ffil</span><span class="p">:</span>
                        <span class="n">thmean</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;{0:.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">thtarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]))]</span>
                        <span class="n">thmean</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;{0:.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">thtarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]))]</span>
                        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">thtarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">51.96</span><span class="p">,</span> <span class="mf">61.14</span><span class="p">):</span>
                            <span class="n">psp</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">28.65</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">thtarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">psp</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span>
                        <span class="n">ver</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ver</span><span class="p">:</span>
                    <span class="n">thmean</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">]</span>
                    <span class="n">psp</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                # It is needed to compute the mean p/sp because bin_data can be False</span>
<span class="sd">                for i in range(len(objarr[0])):</span>
<span class="sd">                    print objarr[0][i], star</span>
<span class="sd">                    print objarr[1][i], ffil</span>
<span class="sd">                    print parr[0][i], parr[1][i]</span>
<span class="sd">                    print float(parr[0][i])/float(parr[1][i])</span>
<span class="sd">                    if objarr[0][i] == star and objarr[1][i] == ffil and float(parr[1][i]) != 0.:</span>
<span class="sd">                        print &#39;*********ENTROU******************&#39;</span>
<span class="sd">                        psp[k] += float(parr[0][i])/float(parr[1][i])</span>
<span class="sd">                        ni += 1</span>
<span class="sd">                    elif objarr[0][i] == star and objarr[1][i] == ffil:</span>
<span class="sd">                        print &#39;*********NÃOOOOOOO ENTROU******************&#39;</span>
<span class="sd">                    print &#39;&#39;</span>
<span class="sd">                        </span>
<span class="sd">                if ni &gt; 1:</span>
<span class="sd">                    psp[k] = psp[k]/ni</span>
<span class="sd">                &quot;&quot;&quot;</span>
            <span class="n">means</span> <span class="o">=</span> <span class="n">meanAngle_star</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">filts</span><span class="o">=</span><span class="s">&#39;ubvri&#39;</span><span class="p">,</span> <span class="n">vfilter</span><span class="o">=</span><span class="n">vfilter_thet</span><span class="p">,</span> <span class="n">onlyY</span><span class="o">=</span><span class="n">onlyY</span><span class="p">,</span> <span class="n">estim</span><span class="o">=</span><span class="n">unbias</span><span class="p">)</span>
            <span class="n">means</span> <span class="o">+=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="o">!=</span><span class="mi">0</span><span class="p">,</span> <span class="n">psp</span><span class="p">))]</span>

        <span class="c"># Store the new rotated values</span>
        <span class="c"># It is needed TO FIX above because thmean[0] is not the mean theta, but a list with the mean theta and its error for filter u.</span>
        <span class="k">if</span> <span class="n">rotate</span><span class="p">:</span>
            <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotQU</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">thmean</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">thmean</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c"># Sort lists pts[0],pts[1],pts[2] based on values of pts[0]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">:]))</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">tmp0</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">tmp1</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">tmp2</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp0</span>
                <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp1</span>
                <span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp2</span>
                <span class="k">if</span> <span class="n">rotate</span><span class="p">:</span>
                    <span class="n">tmp3</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">tmp4</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">tmp5</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">tmp6</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp3</span>
                    <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp4</span>
                    <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp5</span>
                    <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp6</span>

        <span class="c"># Get the color and the the common name to plot</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">gen_color</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">onlyY</span><span class="o">=</span><span class="n">onlyY</span><span class="p">)</span>
        <span class="n">nome</span> <span class="o">=</span> <span class="n">fixName</span><span class="p">(</span><span class="n">star</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nome</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">13</span><span class="p">:</span>
            <span class="n">longname</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">rotate</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">nome</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

            <span class="c"># Fit data HERE or copy from the previous csv file</span>
            <span class="k">if</span> <span class="n">fit</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">usePrevious</span><span class="p">:</span>
<span class="c">#                    means = map(lambda v: &#39;{0:.2f}&#39;.format(v), means[:2]) + [&#39;{:.1f}&#39;.format(means[2])]</span>
<span class="c">#                    psp = map(lambda v: &#39;{0:.1f}&#39;.format(v), psp)</span>
                    <span class="n">pmax_fit</span><span class="p">,</span> <span class="n">lmax_fit</span> <span class="o">=</span> <span class="n">copyFit</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">csvout</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pmax_fit</span><span class="p">,</span> <span class="n">lmax_fit</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="c">#                print usePrevious</span>
<span class="c">#                print pmax_fit, lmax_fit</span>

                <span class="c"># Run MCMC again if not usePrevious or if there is no &#39;star&#39; inside the</span>
                <span class="c"># current csv file.</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pmax_fit</span><span class="p">,</span> <span class="n">lmax_fit</span><span class="p">)</span> <span class="o">==</span> <span class="p">([],[]):</span>
                    <span class="c"># Convert to microns and fit</span>
                    <span class="n">lb</span> <span class="o">=</span> <span class="p">[</span><span class="n">lbi</span><span class="o">/</span><span class="mi">10000</span> <span class="k">for</span> <span class="n">lbi</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">pmax_fit</span><span class="p">,</span> <span class="n">lmax_fit</span><span class="p">,</span> <span class="n">chi2</span> <span class="o">=</span> <span class="n">fitSerk</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">star</span><span class="o">=</span><span class="n">star</span><span class="p">,</span> <span class="n">extens</span><span class="o">=</span><span class="n">extens</span><span class="p">)</span>

                    <span class="c"># Fix the format to the lists</span>
                    <span class="n">pmax_fit_str</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="s">&#39;{0:.5f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">pmax_fit</span><span class="p">))</span>
                    <span class="n">lmax_fit_str</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="s">&#39;{0:.5f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">lmax_fit</span><span class="p">))</span>
                    <span class="n">means</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="s">&#39;{0:.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">means</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;{:.1f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">means</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
                    <span class="n">psp</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="s">&#39;{0:.1f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">psp</span><span class="p">)</span>
                    <span class="n">chi2</span> <span class="o">=</span> <span class="s">&#39;{0:.3f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span>

                    <span class="n">csvout</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">star</span><span class="p">,</span> <span class="n">nome</span><span class="p">]</span> <span class="o">+</span> <span class="n">pmax_fit_str</span> <span class="o">+</span> <span class="n">lmax_fit_str</span> <span class="o">+</span> <span class="p">[</span><span class="n">chi2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">+</span>\
                                     <span class="n">means</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;---&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">thmean</span> <span class="o">+</span> <span class="n">psp</span><span class="p">)</span>
<span class="c">#                    csvout.writerow([star, nome] + means + [&#39;1&#39;,&#39;1&#39;,&#39;---&#39;,&#39;&#39;] + thmean + psp)</span>

                <span class="n">ll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">3000.</span><span class="p">,</span><span class="mf">8300.</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
                <span class="n">pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                <span class="k">for</span> <span class="n">lli</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">:</span>
                    <span class="n">pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">polt</span><span class="o">.</span><span class="n">serkowski</span><span class="p">(</span><span class="n">pmax_fit</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lmax_fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">10000</span><span class="p">,</span> <span class="n">lli</span><span class="p">,</span> <span class="n">law</span><span class="o">=</span><span class="n">law</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

                <span class="c"># Only plot the graph if there are more than one data, because with an only point</span>
                <span class="c"># the curve is not defined! But the emcee was runned to generate the covariance map</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                     <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">nome</span><span class="o">+</span><span class="s">&#39;_q&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
<span class="c">#            ax.errorbar(pts[0], u[0], yerr=u[1], label=nome+&#39;_u&#39;, linestyle=&#39;-.&#39;, marker=&#39;&#39;, color=color)</span>
<span class="c">#            ax.errorbar(pts[0], pts[1], yerr=pts[2], label=nome+&#39;_p&#39;, linestyle=&#39;--&#39;, marker=&#39;&#39;, color=color)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">nome</span><span class="o">+</span><span class="s">&#39;_p&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;--&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>


        <span class="c"># Refresh the lines to the next iteration</span>
        <span class="n">j</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">break</span>

    <span class="c"># Setting legend</span>
<span class="c">#    fig.subplots_adjust(right=0.8)</span>
<span class="c">#    ax.legend(loc=&#39;center left&#39;, borderaxespad=0., numpoints=1, prop={&#39;size&#39;:fonts[4]}, bbox_to_anchor=(1.02,.5))</span>

    <span class="c"># Plot ISP parallel to the disk direction of Be star</span>
    <span class="k">if</span> <span class="n">thetfile</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>

        <span class="n">lbd</span><span class="p">,</span> <span class="n">pBe</span><span class="p">,</span> <span class="n">sBe</span><span class="p">,</span> <span class="n">devBe</span> <span class="o">=</span> <span class="n">rotQUBe</span><span class="p">(</span><span class="n">be</span><span class="p">,</span> <span class="n">thetfile</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">every</span><span class="o">=</span><span class="n">every</span><span class="p">,</span> <span class="n">vfilter</span><span class="o">=</span><span class="n">vfilter</span><span class="p">)</span>
        <span class="c"># Using combined error for points to // pol to Be star</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sBe</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">devBe</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sBe</span><span class="p">))]</span>

        <span class="k">if</span> <span class="n">lbd</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">lbd</span><span class="p">,</span> <span class="n">pBe</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">r&#39;$//$ comp.&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> \
                                                            <span class="n">marker</span><span class="o">=</span><span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">fit</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">usePrevious</span><span class="p">:</span>
                    <span class="n">pmax_fit</span><span class="p">,</span> <span class="n">lmax_fit</span> <span class="o">=</span> <span class="n">copyFit</span><span class="p">(</span><span class="n">be</span><span class="p">,</span> <span class="n">csvout</span><span class="p">,</span> <span class="n">secondcol</span><span class="o">=</span><span class="n">fixName</span><span class="p">(</span><span class="n">be</span><span class="p">)</span><span class="o">+</span><span class="s">&#39; (//)&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pmax_fit</span><span class="p">,</span> <span class="n">lmax_fit</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">pmax_fit</span><span class="p">,</span><span class="n">lmax_fit</span><span class="p">)</span> <span class="o">==</span> <span class="p">([],[]):</span>
                    <span class="c"># Convert to microns</span>
                    <span class="n">lb</span> <span class="o">=</span> <span class="p">[</span><span class="n">lbi</span><span class="o">/</span><span class="mi">10000</span> <span class="k">for</span> <span class="n">lbi</span> <span class="ow">in</span> <span class="n">lbd</span><span class="p">]</span>
                    <span class="k">print</span> <span class="s">&#39;&#39;</span>
                    <span class="n">pmax_fit</span><span class="p">,</span> <span class="n">lmax_fit</span><span class="p">,</span> <span class="n">chi2</span> <span class="o">=</span> <span class="n">fitSerk</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">pBe</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">star</span><span class="o">=</span><span class="n">be</span><span class="p">,</span> <span class="n">extens</span><span class="o">=</span><span class="n">extens</span><span class="p">)</span>

                    <span class="n">csvout</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">be</span><span class="p">,</span> <span class="n">fixName</span><span class="p">(</span><span class="n">be</span><span class="p">)</span><span class="o">+</span><span class="s">&#39; (//)&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">pmax_fit</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">lmax_fit</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">chi2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pBe</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;0&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;0&#39;</span><span class="p">,</span><span class="s">&#39;0&#39;</span><span class="p">,</span><span class="s">&#39;---&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;0&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">15</span><span class="p">)</span>

                <span class="n">ll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">3000.</span><span class="p">,</span><span class="mf">8300.</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
                <span class="n">pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                <span class="k">for</span> <span class="n">lli</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">:</span>
                    <span class="n">pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">polt</span><span class="o">.</span><span class="n">serkowski</span><span class="p">(</span><span class="n">pmax_fit</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lmax_fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">10000</span><span class="p">,</span> <span class="n">lli</span><span class="p">,</span> <span class="n">law</span><span class="o">=</span><span class="n">law</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
                <span class="c"># Only plot the graph if there are more than one data, because with an only point</span>
                <span class="c"># the curve is not defined! But the emcee was runned to generate the covariance map</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pBe</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">)</span>



    <span class="c"># Copy the dummy lines beginning with the &#39;be&#39; and fixed Be name</span>
    <span class="k">if</span> <span class="n">fit</span> <span class="ow">and</span> <span class="n">usePrevious</span><span class="p">:</span>
        <span class="n">copyFit</span><span class="p">(</span><span class="n">be</span><span class="p">,</span> <span class="n">csvout</span><span class="p">,</span> <span class="n">secondcol</span><span class="o">=</span><span class="n">fixName</span><span class="p">(</span><span class="n">be</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">longname</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">1500</span><span class="p">,</span> <span class="mi">8500</span><span class="p">])</span>

    <span class="n">leg</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">numpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;size&#39;</span><span class="p">:</span><span class="n">fonts</span><span class="p">[</span><span class="mi">4</span><span class="p">]})</span>
    <span class="n">leg</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    
    <span class="c"># Setting sizes</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
        <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}_p.{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">,</span><span class="n">extens</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Done!</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fit</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}_is.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;{0}_is.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s">&#39;{0}_is_tmp.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">),</span><span class="s">&#39;{0}_is.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">))</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
    <span class="k">return</span>



</div>
<div class="viewcode-block" id="graf_pradial"><a class="viewcode-back" href="../../fieldstars.html#pyhdust.fieldstars.graf_pradial">[docs]</a><span class="k">def</span> <span class="nf">graf_pradial</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="s">&#39;pmax&#39;</span><span class="p">,</span> <span class="n">vfilter</span><span class="o">=</span><span class="p">[],</span> <span class="n">isfile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> \
                            <span class="n">bin_data</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">onlyY</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">extens</span><span class="o">=</span><span class="s">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">unbias</span><span class="o">=</span><span class="s">&#39;wk&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a field graph with polarization versus distance.</span>

<span class="sd">    filt : is the filter to plot in y axes - &#39;pmax&#39;,&#39;u&#39;,&#39;b&#39;,</span>
<span class="sd">           &#39;v&#39;,&#39;r&#39;,&#39;i&#39;. If &#39;pmax&#39; use the Pmax values</span>
<span class="sd">           from ./&#39;be&#39;_is.csv file to plot.</span>

<span class="sd">    isfile : &#39;be&#39;_is.csv file location (out from fs.graf_p).</span>
<span class="sd">              If None, it is suposed ./&#39;be&#39;_is.csv</span>

<span class="sd">    fit   : (only for filt==&#39;pmax&#39;) fit a line in graph? This</span>
<span class="sd">            routine will not use in fitting the points whose</span>
<span class="sd">            values in 22th column inside isfile have a &#39;0&#39;</span>
<span class="sd">            character (this column defines the points to be</span>
<span class="sd">            used in the adjust). The points not used will be</span>
<span class="sd">            marked with a &#39;x&#39; in the graph.</span>

<span class="sd">    csvfile : location of dados.csv.</span>



<span class="sd">    Considerations:</span>

<span class="sd">    - If filt==&#39;pmax&#39;, don&#39;t plot the data whose values in 21th</span>
<span class="sd">    column inside isfile have a &#39;0&#39; character.</span>

<span class="sd">    - If filt==&#39;pmax&#39;, don&#39;t use in fitting the points whose</span>
<span class="sd">    values in 22th column inside isfile have a &#39;0&#39; character</span>
<span class="sd">    when fit=True.  The points not used will be marked with a</span>
<span class="sd">    &#39;x&#39; in the graph.</span>

<span class="sd">    - Skip the lines inside isfile commented with a &#39;#&#39;, or with</span>
<span class="sd">    a void first element</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Verify if vfilter is a special filter</span>
    <span class="k">if</span> <span class="n">vfilter</span> <span class="ow">in</span> <span class="n">polt</span><span class="o">.</span><span class="n">vfil</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">vfilter</span> <span class="o">=</span> <span class="n">polt</span><span class="o">.</span><span class="n">vfil</span><span class="p">[</span><span class="n">vfilter</span><span class="p">]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">)</span>

    <span class="c"># Read csvfile and get the table</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">readcsv</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">be</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;No {0} data!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">))</span>
        <span class="k">return</span>
    <span class="n">objarr</span><span class="p">,</span> <span class="n">plxarr</span><span class="p">,</span> <span class="n">bearr</span><span class="p">,</span> <span class="n">parr</span> <span class="o">=</span> <span class="n">getTable</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&#39;plx&#39;</span><span class="p">,</span> <span class="s">&#39;plxbe&#39;</span><span class="p">,</span> <span class="n">sx</span><span class="o">=</span><span class="s">&#39;splx&#39;</span><span class="p">,</span>
                    <span class="n">sy</span><span class="o">=</span><span class="s">&#39;splxbe&#39;</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="s">&#39;p&#39;</span><span class="p">,</span> <span class="n">sz</span><span class="o">=</span><span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="n">vfilter</span><span class="o">=</span><span class="n">vfilter</span><span class="p">,</span> <span class="n">bin_data</span><span class="o">=</span><span class="n">bin_data</span><span class="p">,</span> <span class="n">onlyY</span><span class="o">=</span><span class="n">onlyY</span><span class="p">,</span> <span class="n">unbias</span><span class="o">=</span><span class="n">unbias</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">objarr</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">or</span> <span class="n">objarr</span> <span class="o">==</span> <span class="p">[[],[],[]]:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;No {0} valid data!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="c"># Verify isfile</span>
    <span class="k">if</span> <span class="n">filt</span> <span class="o">==</span> <span class="s">&#39;pmax&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">isfile</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">isfile</span> <span class="o">=</span> <span class="s">&#39;{0}_is.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">isfile</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;No {0} file found!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isfile</span><span class="p">))</span>
            <span class="k">return</span>

    <span class="c"># Initialize graphs</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;Field Stars - {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">phc</span><span class="o">.</span><span class="n">bes</span><span class="p">[</span><span class="n">be</span><span class="p">]),</span> \
                                        <span class="n">fontsize</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&#39;bottom&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;r (pc)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">filt</span><span class="o">==</span><span class="s">&#39;pmax&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;$P_{max}$ (%)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;$P_{0}$ (%)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filt</span><span class="o">.</span><span class="n">upper</span><span class="p">()),</span> <span class="n">size</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c"># Extract data only in filter filt</span>
    <span class="n">obj</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[[],[]],</span> <span class="p">[[],[],[]],</span> <span class="p">[[],[],[]],</span> <span class="p">[]</span>
    <span class="n">obj_filt</span><span class="p">,</span> <span class="n">x_filt</span><span class="p">,</span> <span class="n">y_filt</span><span class="p">,</span> <span class="n">colors_filt</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[[],[]],</span> <span class="p">[[],[],[]],</span> <span class="p">[]</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">bearr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">bearr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span>
    <span class="n">longname</span><span class="p">,</span> <span class="n">useinfit</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span>

    
    <span class="c"># CASE 1)  filt==&#39;pmax&#39;</span>
    <span class="k">if</span> <span class="n">filt</span><span class="o">==</span><span class="s">&#39;pmax&#39;</span><span class="p">:</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">isfile</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fr</span><span class="p">:</span>
            <span class="n">csvread</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;;&#39;</span><span class="p">)</span><span class="c">#, quoting=csv.QUOTE_NONE, quotechar=&#39;&#39;)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">csvread</span><span class="p">):</span>

                <span class="n">plotpointi</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span>
                <span class="n">useinfiti</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;&#39;</span> <span class="ow">or</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;#&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">be</span> <span class="ow">and</span> <span class="n">plotpointi</span><span class="o">==</span><span class="s">&#39;1&#39;</span><span class="p">:</span>
                    <span class="c"># 1) Filtered data (only works when fit==True)</span>
                    <span class="k">if</span> <span class="n">fit</span> <span class="ow">and</span> <span class="n">useinfiti</span> <span class="o">==</span> <span class="s">&#39;0&#39;</span><span class="p">:</span>
                        <span class="c"># read paralaxes from csvfile</span>
                        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">obs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">obs</span><span class="p">:</span>
                                <span class="n">x_filt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">plxarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">])]</span>
                                <span class="n">x_filt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">plxarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">])]</span>
                                <span class="k">break</span>
                        <span class="n">obj_filt</span> <span class="o">+=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                        <span class="n">y_filt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
                        <span class="n">y_filt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span>
                        <span class="n">y_filt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">])]</span>
                        <span class="n">colors_filt</span> <span class="o">+=</span> <span class="p">[</span><span class="n">gen_color</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">onlyY</span><span class="o">=</span><span class="n">onlyY</span><span class="p">)]</span>
                    <span class="c"># b) Main data</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c"># read paralaxes from csvfile</span>
                        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">obs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">obs</span><span class="p">:</span>
                                <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">plxarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">])]</span>
                                <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">plxarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">])]</span>
                                <span class="k">break</span>
                        <span class="n">obj</span> <span class="o">+=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                        <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
                        <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span>
                        <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">])]</span>
                        <span class="n">colors</span> <span class="o">+=</span> <span class="p">[</span><span class="n">gen_color</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">onlyY</span><span class="o">=</span><span class="n">onlyY</span><span class="p">)]</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">13</span><span class="p">:</span>
                        <span class="n">longname</span> <span class="o">=</span> <span class="bp">True</span>

                <span class="c"># Don&#39;t plot Be&#39;s // component, but plot Be entire polarization</span>
                <span class="c"># if it was writen in a line and the line[2] element is just</span>
                <span class="c"># the Be fixed name + there are a &#39;1&#39; character in &#39;plot point&#39;</span>
                <span class="c"># column</span>
                <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">be</span> <span class="ow">and</span> <span class="n">plotpointi</span><span class="o">==</span><span class="s">&#39;1&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">useinfiti</span> <span class="o">==</span> <span class="s">&#39;1&#39;</span><span class="p">:</span>
                        <span class="n">useinfit</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">obj0</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">x0</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">bearr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">bearr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span>
                    <span class="n">y0</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">])]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">13</span><span class="p">:</span>
                        <span class="n">longname</span> <span class="o">=</span> <span class="bp">True</span>


    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="k">if</span> <span class="n">objarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">filt</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c"># Skip if plx is less than 0</span>
                    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">plxarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">plxarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])]</span>
                        <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">plxarr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])]</span>
                        <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">parr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])]</span>
                        <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">parr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])]</span>
                        <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">parr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])]</span>
                        <span class="n">obj</span> <span class="o">+=</span> <span class="p">[</span><span class="n">fixName</span><span class="p">(</span><span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])]</span>
                        <span class="n">colors</span> <span class="o">+=</span> <span class="p">[</span><span class="n">gen_color</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">objarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">onlyY</span><span class="o">=</span><span class="n">onlyY</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">13</span><span class="p">:</span>
                            <span class="n">longname</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">continue</span>


    <span class="c"># Plot data</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">xerr</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="p">[[</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]],[</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]]],</span> <span class="n">label</span><span class="o">=</span><span class="n">obj</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> \
                                            <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;--&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obj_filt</span><span class="p">)):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x_filt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">y_filt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">xerr</span><span class="o">=</span><span class="n">x_filt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="p">[[</span><span class="n">y_filt</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]],[</span><span class="n">y_filt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]]],</span> \
                                     <span class="n">label</span><span class="o">=</span><span class="n">obj_filt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;--&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors_filt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>\
                                     <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">markeredgewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filt</span><span class="o">==</span><span class="s">&#39;pmax&#39;</span> <span class="ow">and</span> <span class="n">y0</span> <span class="o">!=</span> <span class="p">[[],[],[]]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xerr</span><span class="o">=</span><span class="n">x0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="p">[[</span><span class="n">y0</span><span class="p">[</span><span class="mi">2</span><span class="p">]],[</span><span class="n">y0</span><span class="p">[</span><span class="mi">1</span><span class="p">]]],</span> <span class="n">label</span><span class="o">=</span><span class="n">obj0</span><span class="p">,</span> \
                                            <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;--&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">)</span>

    <span class="c"># Fit the line</span>
    <span class="k">if</span> <span class="n">fit</span> <span class="ow">and</span> <span class="n">filt</span><span class="o">==</span><span class="s">&#39;pmax&#39;</span><span class="p">:</span>
        <span class="c"># If it is to use the point of Be data in the ajust:</span>
        <span class="k">if</span> <span class="n">useinfit</span><span class="p">:</span>
            <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">x0</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">y0</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">y0</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">y0</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

        <span class="c"># Fit by the total least squares method (orthogonal distance regression) without clipping</span>
        <span class="n">param</span><span class="p">,</span> <span class="n">sparam</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">niter</span><span class="p">,</span><span class="n">bolfilt</span> <span class="o">=</span> <span class="n">phc</span><span class="o">.</span><span class="n">fit_linear</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]))],</span> <span class="n">clip</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">rchi2</span> <span class="o">=</span> <span class="n">chi2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rchi2</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">pmaxfit</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">spmaxfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">x0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">sparam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sparam</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="k">print</span><span class="p">(</span><span class="mi">55</span><span class="o">*</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;  Total least squares fit  (y = a*x+b):&#39;</span>
        <span class="k">print</span><span class="p">(</span><span class="mi">55</span><span class="o">*</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;             a = {0:.3f} +- {1:.3f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sparam</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">print</span> <span class="s">&#39;             b = {0:.3f} +- {1:.3f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sparam</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">print</span> <span class="s">&#39;&#39;</span>
        <span class="k">print</span> <span class="s">&#39;                 N = {0:d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">print</span> <span class="s">&#39;         red chi^2 = {0:2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rchi2</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;&#39;</span>
        <span class="k">print</span> <span class="s">&#39;&#39;</span>
        <span class="k">print</span> <span class="s">&#39;  Extrapolated Pmax: &#39;</span>
        <span class="k">print</span> <span class="s">&#39;&#39;</span>
        <span class="k">print</span> <span class="s">&#39;          Pmax = {0:.4f} +- {1:.4f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pmaxfit</span><span class="p">,</span> <span class="n">spmaxfit</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="mi">55</span><span class="o">*</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;&#39;</span>

        <span class="n">xadj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">yadj</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xadj</span><span class="o">+</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xadj</span><span class="p">,</span> <span class="n">yadj</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;dimgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>



    <span class="c"># Fix limits</span>
    <span class="k">if</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">x0</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">elif</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">autoscale</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="c"># Plot marks for Be star</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">(),</span> <span class="n">linestyle</span> <span class="o">=</span><span class="s">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x0</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">(),</span> \
                                    <span class="n">linestyle</span> <span class="o">=</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">x0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">x0</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">(),</span> \
                                    <span class="n">linestyle</span> <span class="o">=</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;gray&#39;</span><span class="p">)</span>

    <span class="n">leg</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">numpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;size&#39;</span><span class="p">:</span><span class="n">fonts</span><span class="p">[</span><span class="mi">3</span><span class="p">]})</span>
    <span class="k">if</span> <span class="n">leg</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">leg</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="c"># Setting sizes</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
        <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}_radial_{1}.{2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">,</span><span class="n">filt</span><span class="p">,</span><span class="n">extens</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>




</div>
<div class="viewcode-block" id="graf_inst"><a class="viewcode-back" href="../../fieldstars.html#pyhdust.fieldstars.graf_inst">[docs]</a><span class="k">def</span> <span class="nf">graf_inst</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vfilter</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;no-std&#39;</span><span class="p">],</span> <span class="n">save</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">extens</span><span class="o">=</span><span class="s">&#39;pdf&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a QU diagram for unpolarized standard stars in the</span>
<span class="sd">    logfile .log file (the outfile from polt.genTarget, appended by</span>
<span class="sd">    the name of the object at each line). Propagates error of</span>
<span class="sd">    standard star.</span>

<span class="sd">    mode=1 plot BVRI graphs in the same figure;</span>
<span class="sd">    mode=2 plot UBVRI graphs in separeted figures.</span>

<span class="sd">    Return 3 lists:</span>

<span class="sd">    1) qarr = [[mean Q], [propagated Q error], [Q stddev]]</span>
<span class="sd">    2) uarr = [[mean U], [propagated U error], [U stddev]]</span>
<span class="sd">    3) narr = [n] (the number of data used to compute the averages)</span>

<span class="sd">    Where [mean Q], [propagated Q error], ..., [n] are lists with</span>
<span class="sd">    the values for each filter.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="c"># IMPLEMENTAR PESOS PARA CADA ALVO CONFORME ALGUM CRITÉRIO</span>
    <span class="k">def</span> <span class="nf">meanQU</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">filt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the mean QU lists and the number of lines (n):</span>
<span class="sd">        [mean Q, propagated Q error, Q stddev],</span>
<span class="sd">        [mean U, propagated U error, U stddev],</span>
<span class="sd">        n</span>

<span class="sd">        lines: the lines readed from .logfile to be computed</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">thet</span><span class="p">,</span> <span class="n">sdth</span> <span class="o">=</span> <span class="p">[],[],[],[],[],[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">filt</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">8</span><span class="p">])]</span>
                <span class="n">q</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">9</span><span class="p">])]</span>
                <span class="n">u</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">10</span><span class="p">])]</span>
                <span class="n">thet</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">])]</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">12</span><span class="p">])]</span>
                <span class="n">sdth</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">])]</span>

        <span class="k">if</span> <span class="n">q</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;No {0} data!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filt</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span>

        <span class="c"># Propagate error of delta_theta to Stokes QU</span>
        <span class="n">lixo</span><span class="p">,</span> <span class="n">sq</span><span class="p">,</span> <span class="n">su</span> <span class="o">=</span> <span class="n">polt</span><span class="o">.</span><span class="n">propQU</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">thet</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sdth</span><span class="p">)</span>

        <span class="c"># List with mean QU, the propagated error and the stddev</span>
        <span class="n">meanq</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sq</span><span class="p">,</span><span class="n">sq</span><span class="p">))</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">sq</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">))]</span>
        <span class="n">meanu</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">su</span><span class="p">,</span><span class="n">su</span><span class="p">))</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">su</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">))]</span>

        <span class="k">return</span> <span class="n">meanq</span><span class="p">,</span> <span class="n">meanu</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">plotQU</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Receive figure and axes objects and do the plot for filter</span>
<span class="sd">        filt WITHOUT show or save the image.</span>
<span class="sd">        Return the same than meanQU().</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Factor to fix the font sizes</span>
        <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">factor</span><span class="o">=</span><span class="mf">0.7</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">factor</span><span class="o">=</span><span class="mf">1.</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: Can</span><span class="se">\&#39;</span><span class="s">t read file {0}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logfile</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        
<span class="c">#        ax.set_title(&#39;{0} filter&#39;.format(filt.upper()), fontsize=fonts[0]*factor, verticalalignment=&#39;bottom&#39;)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.98</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="s">&#39;{0} filter&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filt</span><span class="o">.</span><span class="n">upper</span><span class="p">()),</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s">&#39;right&#39;</span><span class="p">,</span> \
                 <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>
    <span class="c">#    ax.set_xlabel(r&#39;RA $-$ RA${}_{Be}$ (degree)&#39;, size=fonts[1])</span>
    <span class="c">#    ax.set_ylabel(r&#39;DEC $-$ DEC${}_{Be}$ (degree)&#39;, size=fonts[1])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;Q (%)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;U (%)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>


        <span class="c"># Do the subplots when flag is not &#39;E&#39;, tag is not in vfilter and filter is equal to filt</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">pts</span><span class="p">,</span> <span class="n">spts</span> <span class="o">=</span> <span class="p">[[],[]],</span> <span class="p">[[],[]]</span>
            <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">lines</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> \
                    <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">filt</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;E&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">sub</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">vfilter</span><span class="p">)]</span>
            <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">lines</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> \
                       <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">filt</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;E&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">sub</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">vfilter</span><span class="p">)]</span>
            <span class="n">ptmp</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">lines</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> \
                    <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">filt</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;E&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">sub</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">vfilter</span><span class="p">)]</span>
            <span class="n">thettmp</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">lines</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> \
                    <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">filt</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;E&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">sub</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">vfilter</span><span class="p">)]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">lines</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> \
                      <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">filt</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;E&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">sub</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">vfilter</span><span class="p">)]</span>
            <span class="n">sdth</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">lines</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> \
                    <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">filt</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;E&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">sub</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">vfilter</span><span class="p">)]</span>

            <span class="n">lixo</span><span class="p">,</span> <span class="n">spts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">polt</span><span class="o">.</span><span class="n">propQU</span><span class="p">(</span><span class="n">ptmp</span><span class="p">,</span> <span class="n">thettmp</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sdth</span><span class="p">)</span>

            <span class="c">#print pts</span>
            <span class="c">#print j, len(lines)</span>
            
            <span class="k">if</span> <span class="n">pts</span> <span class="o">!=</span> <span class="p">[[],[]]:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xerr</span><span class="o">=</span><span class="n">spts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">spts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">lines</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> \
                        <span class="n">elinewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

            <span class="n">nn</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">j</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">lines</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">nn</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="n">nn</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="k">break</span>

        <span class="n">meanq</span><span class="p">,</span> <span class="n">meanu</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">meanQU</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">meanq</span><span class="p">,</span> <span class="n">meanu</span><span class="p">,</span> <span class="n">n</span>

        <span class="k">print</span> <span class="s">&#39;FILTER {0}  -&gt;  N = {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filt</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;FILTER {0}  -&gt;  Q (%): mean, error, stddev  =  {1:.7f}, {2:.7f}, {3:.7f}&#39;</span>\
                                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filt</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">meanq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">meanq</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">meanq</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">print</span> <span class="s">&#39;FILTER {0}  -&gt;  U (%): mean, error, stddev  =  {1:.7f}, {2:.7f}, {3:.7f}&#39;</span>\
                                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filt</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">meanu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">meanu</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">meanu</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="p">[[</span><span class="n">meanq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">meanq</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">meanu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">meanu</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
        <span class="n">coords</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">meanq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">meanq</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">meanu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">meanu</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
        <span class="n">coords</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">meanq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">meanq</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">meanu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">meanu</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
        <span class="n">coords</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">meanq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">meanq</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">meanu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">meanu</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
        <span class="n">polygon</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s">&#39;wheat&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>
    <span class="c">#    ax.errorbar(meanq[0], meanu[0], xerr=meanq[2], yerr=meanu[2], linestyle=&#39;&#39;, marker=&#39;o&#39;, \</span>
    <span class="c">#                  elinewidth=2, fillstyle=&#39;full&#39;, markersize=8, color=&#39;black&#39;)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">meanq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">meanu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xerr</span><span class="o">=</span><span class="n">meanq</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">meanu</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> \
                      <span class="n">elinewidth</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">fillstyle</span><span class="o">=</span><span class="s">&#39;full&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">)</span>

        <span class="c"># Fix limits</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">autoscale</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;k--&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">(),</span> <span class="s">&#39;k--&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),</span> <span class="p">[</span><span class="n">meanu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">meanu</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;grey&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">meanq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">meanq</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">(),</span> <span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;grey&#39;</span><span class="p">)</span>

        <span class="c"># Setting sizes</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
            <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">meanq</span><span class="p">,</span> <span class="n">meanu</span><span class="p">,</span> <span class="n">n</span>



    <span class="c"># Verify if vfilter is a special filter</span>
    <span class="k">if</span> <span class="n">vfilter</span> <span class="ow">in</span> <span class="n">polt</span><span class="o">.</span><span class="n">vfil</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">vfilter</span> <span class="o">=</span> <span class="n">polt</span><span class="o">.</span><span class="n">vfil</span><span class="p">[</span><span class="n">vfilter</span><span class="p">]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">)</span>
    <span class="n">qarr</span><span class="p">,</span> <span class="n">uarr</span><span class="p">,</span> <span class="n">narr</span> <span class="o">=</span> <span class="p">[[],[],[]],</span> <span class="p">[[],[],[]],</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">axs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="n">axs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="n">axs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>

        <span class="n">nax</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="s">&#39;v&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;i&#39;</span><span class="p">):</span>
            <span class="n">meanq</span><span class="p">,</span> <span class="n">meanu</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">plotQU</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="n">nax</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">qarr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">meanq</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="n">uarr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">meanu</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">narr</span> <span class="o">+=</span> <span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">nax</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>

<span class="c">#            axs[0].set_yticks(axs[0].get_yticks()[1:])</span>
<span class="c">#            axs[3].set_xticks(axs[3].get_xticks()[1:])</span>
<span class="c">#            print axs[3].get_xticks()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;qu_inst.{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extens</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s">&#39;tight&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            
    <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">nfig</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;u&#39;</span><span class="p">,</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="s">&#39;v&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;i&#39;</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">nfig</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">meanq</span><span class="p">,</span> <span class="n">meanu</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">plotQU</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">qarr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">meanq</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="n">uarr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">meanu</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">narr</span> <span class="o">+=</span> <span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">nfig</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;qu_inst_{0}.{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span><span class="n">extens</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s">&#39;tight&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">qarr</span><span class="p">,</span> <span class="n">uarr</span><span class="p">,</span> <span class="n">narr</span>



</div>
<span class="k">def</span> <span class="nf">genAll</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">genlogs</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">genint</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">vfilter</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;no-std&#39;</span><span class="p">],</span> <span class="n">vfilter_graf_p</span><span class="o">=</span><span class="p">[],</span> <span class="n">extens</span><span class="o">=</span><span class="s">&#39;pdf&#39;</span><span class="p">):</span>

    <span class="n">bin_data</span><span class="o">=</span><span class="bp">True</span>
    <span class="n">onlyY</span><span class="o">=</span><span class="bp">True</span>
    <span class="n">rotate</span><span class="o">=</span><span class="bp">False</span>  <span class="c"># Here</span>
    <span class="n">every</span><span class="o">=</span><span class="bp">False</span>
    <span class="n">mcmc</span><span class="o">=</span><span class="bp">True</span>    <span class="c"># Here</span>
    <span class="n">odr</span><span class="o">=</span><span class="bp">True</span>
    <span class="n">save</span><span class="o">=</span><span class="bp">True</span>

    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">path</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        
    <span class="k">if</span> <span class="n">extens</span> <span class="o">==</span> <span class="s">&#39;eps&#39;</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: field graphs will lose the transparency at .eps format&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/refs/pol_alvos.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hdtpath</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: Can</span><span class="se">\&#39;</span><span class="s">t read files pyhdust/refs/pol_alvos.txt.&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c"># Generating logfiles for all Be stars</span>
    <span class="k">if</span> <span class="n">genlogs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">star</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Generating logfile for star {0}...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star</span><span class="p">)</span>
            <span class="n">polt</span><span class="o">.</span><span class="n">genTarget</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">ispol</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">skipdth</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">3.5</span><span class="p">)</span>

    <span class="c"># Generating thet_int.csv file and QU graphs</span>
    <span class="k">if</span> <span class="n">genint</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">star</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Generating QU graphs for star {0}...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">))</span>
            <span class="n">genInt</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">vfilter</span><span class="o">=</span><span class="n">vfilter</span><span class="p">,</span> <span class="n">extens</span><span class="o">=</span><span class="n">extens</span><span class="p">)</span>
        
    <span class="k">for</span> <span class="n">star</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span>
        <span class="k">print</span> <span class="s">&#39;Generating graphs for star {0}...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star</span><span class="p">)</span>
        <span class="n">graf_p</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">rotate</span><span class="o">=</span><span class="n">rotate</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">bin_data</span><span class="o">=</span><span class="n">bin_data</span><span class="p">,</span> <span class="n">onlyY</span><span class="o">=</span><span class="n">onlyY</span><span class="p">,</span>
               <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="n">mcmc</span><span class="p">,</span> <span class="n">extens</span><span class="o">=</span><span class="n">extens</span><span class="p">,</span> <span class="n">vfilter</span><span class="o">=</span><span class="n">vfilter_graf_p</span><span class="p">)</span>
        <span class="n">graf_pradial</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="s">&#39;v&#39;</span><span class="p">,</span> <span class="n">bin_data</span><span class="o">=</span><span class="n">bin_data</span><span class="p">,</span> <span class="n">onlyY</span><span class="o">=</span><span class="n">onlyY</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">extens</span><span class="o">=</span><span class="n">extens</span><span class="p">,</span> <span class="n">vfilter</span><span class="o">=</span><span class="n">vfilter</span><span class="p">)</span>
        <span class="n">graf_field</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">bin_data</span><span class="o">=</span><span class="n">bin_data</span><span class="p">,</span> <span class="n">onlyY</span><span class="o">=</span><span class="n">onlyY</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">extens</span><span class="o">=</span><span class="n">extens</span><span class="p">)</span>
        <span class="n">graf_theta</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">bin_data</span><span class="o">=</span><span class="n">bin_data</span><span class="p">,</span> <span class="n">onlyY</span><span class="o">=</span><span class="n">onlyY</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">extens</span><span class="o">=</span><span class="n">extens</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="n">star</span><span class="o">+</span><span class="s">&#39;.log&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">genint</span><span class="p">:</span>
                <span class="n">arr_u</span><span class="p">,</span> <span class="n">arr_b</span><span class="p">,</span> <span class="n">arr_v</span><span class="p">,</span> <span class="n">arr_r</span><span class="p">,</span> <span class="n">arr_i</span> <span class="o">=</span> <span class="n">polt</span><span class="o">.</span><span class="n">graf_qu</span><span class="p">(</span><span class="s">&#39;{0}/{1}.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">star</span><span class="p">),</span>
                                                    <span class="n">mcmc</span><span class="o">=</span><span class="n">mcmc</span><span class="p">,</span> <span class="n">odr</span><span class="o">=</span><span class="n">odr</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">extens</span><span class="o">=</span><span class="n">extens</span><span class="p">)</span>
            <span class="n">polt</span><span class="o">.</span><span class="n">graf_t</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="n">star</span><span class="o">+</span><span class="s">&#39;.log&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">extens</span><span class="o">=</span><span class="n">extens</span><span class="p">,</span> <span class="n">vfilter</span><span class="o">=</span><span class="n">vfilter</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>




<div class="viewcode-block" id="genInt"><a class="viewcode-back" href="../../fieldstars.html#pyhdust.fieldstars.genInt">[docs]</a><span class="k">def</span> <span class="nf">genInt</span><span class="p">(</span><span class="n">be</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">vfilter</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;no-std&#39;</span><span class="p">],</span> <span class="n">extens</span><span class="o">=</span><span class="s">&#39;pdf&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Call polt.graf_qu() for Be star &#39;be&#39; and save the intrinsic</span>
<span class="sd">    angles inside thet_int.csv.</span>

<span class="sd">    path: path inside which the logfile &#39;be&#39;.log (out from</span>
<span class="sd">          polt.genTarget) is located. The code will try to open</span>
<span class="sd">          thet_int.csv inside the current directory (.). If it</span>
<span class="sd">          was not found, it will be created. Otherwise, the</span>
<span class="sd">          routine will append a new line inside it, asking about</span>
<span class="sd">          to overwrite an eventual existing line for star &#39;be&#39;.</span>


<span class="sd">    CONSIDERATIONS:</span>

<span class="sd">    - Propagates errors from standard star.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">path</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">be</span><span class="p">)):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# No {0}/{1}.log file found.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">be</span><span class="p">))</span>
        <span class="k">return</span> 

    <span class="n">fw</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;thet_int_tmp.csv&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">csvwrite</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">fw</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;;&#39;</span><span class="p">)</span><span class="c">#, quoting=csv.QUOTE_NONE, quotechar=&#39;&#39;)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;thet_int.csv&#39;</span><span class="p">):</span>
        <span class="n">fr</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;thet_int.csv&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">csvread</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;;&#39;</span><span class="p">)</span><span class="c">#, quoting=csv.QUOTE_NONE, quotechar=&#39;&#39;)</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">csvread</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">be</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">opt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">,</span><span class="s">&#39;n&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Star {0} is already present inside file thet_int.csv. Run again and overwrite the current values?&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">))</span>
                    <span class="n">opt</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;(y/n): &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;n&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">):</span>
                    <span class="n">fr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;thet_int_tmp.csv&#39;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">csvwrite</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">fr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">csvwrite</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s">&#39;#obj&#39;</span><span class="p">,</span><span class="s">&#39;name&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;th_int&#39;</span><span class="p">,</span> <span class="s">&#39;sth_int_+&#39;</span><span class="p">,</span> <span class="s">&#39;sth_int_-&#39;</span><span class="p">,</span> <span class="s">&#39;n&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span> <span class="o">+</span>\
                          <span class="p">[</span><span class="s">&#39;th_int&#39;</span><span class="p">,</span> <span class="s">&#39;sth_int_+&#39;</span><span class="p">,</span><span class="s">&#39; sth_int_-&#39;</span><span class="p">,</span> <span class="s">&#39;comment&#39;</span><span class="p">]</span> <span class="o">+</span>\
                          <span class="p">[</span><span class="s">&#39;b*costh&#39;</span><span class="p">,</span> <span class="s">&#39;sb*costh_+&#39;</span><span class="p">,</span> <span class="s">&#39;sb*costh_-&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span> <span class="o">+</span>\
                          <span class="p">[</span><span class="s">&#39;Second peaks: &#39;</span><span class="p">,</span> <span class="s">&#39;repeated 7by7&#39;</span><span class="p">,</span> <span class="s">&#39;cells following&#39;</span><span class="p">,</span><span class="s">&#39;these labels in&#39;</span><span class="p">,</span> <span class="s">&#39;subheader below&#39;</span><span class="p">])</span>
        <span class="n">csvwrite</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s">&#39;#&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;u&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;b&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;v&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;r&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;i&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="p">[</span><span class="s">&#39; &#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span>\
                          <span class="p">[</span><span class="s">&#39;u&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;b&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;v&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;r&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;i&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span>\
                          <span class="p">[</span><span class="s">&#39;filter&#39;</span><span class="p">,</span> <span class="s">&#39;th_int&#39;</span><span class="p">,</span> <span class="s">&#39;sth_int_+&#39;</span><span class="p">,</span> <span class="s">&#39;sth_int_-&#39;</span><span class="p">,</span><span class="s">&#39;b*costh&#39;</span><span class="p">,</span> <span class="s">&#39;sb*costh_+&#39;</span><span class="p">,</span> <span class="s">&#39;sb*costh_-&#39;</span><span class="p">])</span><span class="c">#+[&#39;to use&#39;]*4)</span>
                
    <span class="n">arr_u</span><span class="p">,</span> <span class="n">arr_b</span><span class="p">,</span> <span class="n">arr_v</span><span class="p">,</span> <span class="n">arr_r</span><span class="p">,</span> <span class="n">arr_i</span> <span class="o">=</span> <span class="n">polt</span><span class="o">.</span><span class="n">graf_qu</span><span class="p">(</span><span class="s">&#39;{0}/{1}.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">be</span><span class="p">),</span>
                                            <span class="n">mcmc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">odr</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">extens</span><span class="o">=</span><span class="n">extens</span><span class="p">,</span> <span class="n">Vb_ran</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>

<span class="c">#        arr_u[0][0] = np.arctan(arr_u[0][0])*90/np.pi</span>
<span class="c">#        arr_u[1][0] = (90*arr_u[1][0])/(np.pi*(arr_u[1][0]**2+1))</span>
<span class="c">#        arr_u[2][0] = arr_u[1][0]</span>

    <span class="c"># Reshape lists. Copy the second peak informations to &#39;addpeak&#39; plain list</span>
    <span class="c"># and keep only the first peek informations inside arr_u, arr_b, etc.</span>
    <span class="n">addpeak</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">arrs</span> <span class="o">=</span> <span class="p">(</span><span class="n">arr_u</span><span class="p">,</span><span class="n">arr_b</span><span class="p">,</span><span class="n">arr_v</span><span class="p">,</span><span class="n">arr_r</span><span class="p">,</span><span class="n">arr_i</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arrs</span><span class="p">):</span>
        <span class="c"># Case one of filters didn&#39;t have been fitted</span>
        <span class="k">if</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">arrs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="nb">list</span><span class="p">:</span>
            <span class="n">addpeak</span> <span class="o">+=</span> <span class="p">[</span><span class="n">filters</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">addpeak</span> <span class="o">+=</span> <span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">addpeak</span> <span class="o">+=</span> <span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">arrs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">arrs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c"># The operation &#39;/2&#39; below is because the intrinsic angle is the inclination angle of the</span>
    <span class="c"># line in in QU diagram diveded by 2! (because PA = 1/2*arctan(U/Q))</span>
    <span class="n">csvwrite</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">be</span><span class="p">,</span> <span class="n">fixName</span><span class="p">(</span><span class="n">be</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_u</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_u</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_u</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_u</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span><span class="o">+</span>\
                                        <span class="p">[</span><span class="n">arr_b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_b</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_b</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span>\
                                        <span class="p">[</span><span class="n">arr_v</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_v</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_v</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span>\
                                        <span class="p">[</span><span class="n">arr_r</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_r</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_r</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span>\
                                        <span class="p">[</span><span class="n">arr_i</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_i</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span>\
                                        <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;---&#39;</span><span class="p">]</span><span class="o">+</span>\
                                        <span class="p">[</span><span class="n">arr_u</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_u</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_u</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span>\
                                        <span class="p">[</span><span class="n">arr_b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_b</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_b</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span>\
                                        <span class="p">[</span><span class="n">arr_v</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_v</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span>\
                                        <span class="p">[</span><span class="n">arr_r</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_r</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span>\
                                        <span class="p">[</span><span class="n">arr_i</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span><span class="p">[</span><span class="n">arr_i</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span>\
                                        <span class="n">addpeak</span><span class="p">)</span>

    <span class="c"># Refresh the csv file</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Done!</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">fw</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;thet_int.csv&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s">&#39;thet_int_tmp.csv&#39;</span><span class="p">,</span><span class="s">&#39;thet_int.csv&#39;</span><span class="p">)</span>

    <span class="k">return</span>


</div>
<div class="viewcode-block" id="rotQU"><a class="viewcode-back" href="../../fieldstars.html#pyhdust.fieldstars.rotQU">[docs]</a><span class="k">def</span> <span class="nf">rotQU</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">sq</span><span class="p">,</span> <span class="n">su</span><span class="p">,</span> <span class="n">ang</span><span class="p">,</span> <span class="n">sang</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rotates lists/arrays q and u in QU diagram at an angle</span>
<span class="sd">    2*(ang +- sang) (clockwise).</span>

<span class="sd">    Look that if &#39;ang&#39; is the mean polarization angle,</span>
<span class="sd">    this rotation will transpose all polarization to</span>
<span class="sd">    Q parameter. U parameter will have residual variations</span>
<span class="sd">    with respect to the 0.</span>

<span class="sd">    Return q_rot, u_rot, sq_rot, su_rot</span>

<span class="sd">    Todo: sometimes it&#39;s better don&#39;t use any error value</span>
<span class="sd">    for ang?</span>

<span class="sd">    &quot;&quot;&quot;</span>

<span class="c">#    fig = plt.figure(1)</span>
<span class="c">#    ax = plt.subplot(1, 1, 1)</span>

    <span class="c"># Rotates each QU value</span>
    <span class="n">qRot</span><span class="p">,</span> <span class="n">sqRot</span><span class="p">,</span> <span class="n">uRot</span><span class="p">,</span> <span class="n">suRot</span> <span class="o">=</span> <span class="p">[],[],[],[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)):</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ang</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span>
        <span class="n">srad</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">sang</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span>
        <span class="n">qRot</span> <span class="o">+=</span> <span class="p">[</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span><span class="o">+</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rad</span><span class="p">)]</span>
        <span class="n">uRot</span> <span class="o">+=</span> <span class="p">[</span><span class="o">-</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span><span class="o">+</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rad</span><span class="p">)]</span>
        <span class="n">sqRot</span> <span class="o">+=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">uRot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">srad</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">sq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rad</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">su</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rad</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)]</span>
        <span class="n">suRot</span> <span class="o">+=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">qRot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">srad</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">sq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rad</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">su</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rad</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)]</span>

<span class="c">#    ax.errorbar(q,u,xerr=sq,yerr=su)</span>
<span class="c">#    ax.errorbar(qRot,uRot,xerr=sqRot,yerr=suRot)</span>
<span class="c">#    plt.show(fig)</span>

    <span class="k">return</span> <span class="n">qRot</span><span class="p">,</span> <span class="n">uRot</span><span class="p">,</span> <span class="n">sqRot</span><span class="p">,</span> <span class="n">suRot</span>



</div>
<div class="viewcode-block" id="rotQUBe"><a class="viewcode-back" href="../../fieldstars.html#pyhdust.fieldstars.rotQUBe">[docs]</a><span class="k">def</span> <span class="nf">rotQUBe</span><span class="p">(</span><span class="n">be</span><span class="p">,</span> <span class="n">thetfile</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">every</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">vfilter</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;no-std&#39;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rotates the QU values for Be star &#39;be&#39; in the intrinsic</span>
<span class="sd">    angle specified inside thetfile and computes the &lt;Q&#39;&gt;</span>
<span class="sd">    and &lt;U&#39;&gt; of parameters rotated, returning four lists:</span>
<span class="sd">    lbd (the wavelength values), &lt;U&#39;&gt;, sigma U&#39; and stddev U&#39;,</span>
<span class="sd">    with the values in each one of the filters UBVRI.</span>


<span class="sd">    &#39;thetfile&#39; : the location (path+filename) of thet_int.csv</span>
<span class="sd">                 file with the intrinsic angles (out from fs.gen).</span>
<span class="sd">    </span>
<span class="sd">    &#39;path&#39;     : the path where is located the log file for star</span>
<span class="sd">                 &#39;be&#39;. If None, is supposed inside &#39;.&#39;.</span>

<span class="sd">    &#39;every&#39;    : use one intrinsic angle for each one filter to</span>
<span class="sd">                 rotate them? If every=False makes all data to use</span>
<span class="sd">                 a mean value at the -4:-2 collums (22th to 24th)</span>
<span class="sd">                 from &#39;thetfile&#39;.</span>


<span class="sd">    CONSIDERATIONS:</span>

<span class="sd">    - Propagates errors from standard star.</span>
<span class="sd">    </span>

<span class="sd">    The rotated parameters are just the polarization</span>
<span class="sd">    components perpendicular and parallel to the</span>
<span class="sd">    orientation of the disk.</span>

<span class="sd">    If every==True, uses the intrinsic angle of each filter to</span>
<span class="sd">    rotate its QU values (if some angle==0, skip this filter!);</span>
<span class="sd">    otherwise, use the same value specified in last 4 columns</span>
<span class="sd">    for every one of the 5 filters.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">thetfile</span><span class="p">,</span> <span class="s">&#39;ro&#39;</span><span class="p">)</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;;&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: Can</span><span class="se">\&#39;</span><span class="s">t read file {0}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">thetfile</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/{1}.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">be</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: {0}.log file not found inside {1}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[],[],[],[]</span>

<span class="c">#    fig = plt.figure(1)</span>
<span class="c">#    ax = plt.subplot(1, 1, 1)</span>

    <span class="c"># Read the intrinsic angles</span>
    <span class="n">thet</span><span class="p">,</span> <span class="n">sthet</span><span class="p">,</span> <span class="n">comment</span> <span class="o">=</span> <span class="p">[],[],[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">be</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">every</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">thet</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">22</span><span class="p">])]</span><span class="o">*</span><span class="mi">5</span>
                    <span class="n">sthet</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">23</span><span class="p">])</span><span class="o">+</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">24</span><span class="p">]))</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span>
                    <span class="n">comment</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">25</span><span class="p">]]</span><span class="o">*</span><span class="mi">5</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: Components [-4],[-3],[-2] in lines of {0} file seem don</span><span class="se">\&#39;</span><span class="s">t exist or not be float type for Be star {1}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">thetfile</span><span class="p">,</span> <span class="n">be</span><span class="p">))</span>
                    <span class="k">return</span> <span class="p">[],[],[],[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
                        <span class="n">thet</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
                        <span class="n">sthet</span> <span class="o">+=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]))</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">comment</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">thet</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">&#39;# WARNING: No intrinsic angle defined to filter {0}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">4</span><span class="p">]))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: Components in lines of {0} file seem not be float type.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">thetfile</span><span class="p">))</span>
                    <span class="k">return</span> <span class="p">[],[],[],[]</span>

    <span class="k">if</span> <span class="n">thet</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: Star {0} not found in {1} file.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">be</span><span class="p">,</span> <span class="n">thetfile</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[],[],[],[]</span>

    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lbd</span><span class="p">,</span> <span class="n">qqRot</span><span class="p">,</span> <span class="n">uuRot</span><span class="p">,</span> <span class="n">sqqRot</span><span class="p">,</span> <span class="n">suuRot</span> <span class="o">=</span> <span class="p">[],[],[],</span> <span class="p">[[],[]],</span> <span class="p">[[],[]]</span>

    <span class="c"># Getting the values for each filter</span>
    <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">thet</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="n">JD</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">thet</span><span class="p">,</span> <span class="n">sdth</span> <span class="o">=</span> <span class="p">[],[],[],[],[],[],[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">filt</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;E&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">sub</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">vfilter</span><span class="p">):</span>
                <span class="n">JD</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
                <span class="n">p</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">9</span><span class="p">])]</span>
                <span class="n">q</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">9</span><span class="p">])]</span>
                <span class="n">u</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">10</span><span class="p">])]</span>
                <span class="n">thet</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">])]</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">12</span><span class="p">])]</span>
                <span class="n">sdth</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">])]</span>

        <span class="n">lixo</span><span class="p">,</span> <span class="n">sq</span><span class="p">,</span> <span class="n">su</span> <span class="o">=</span> <span class="n">polt</span><span class="o">.</span><span class="n">propQU</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">thet</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sdth</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># Rotates each QU value</span>
            <span class="n">qRot</span><span class="p">,</span> <span class="n">uRot</span><span class="p">,</span> <span class="n">sqRot</span><span class="p">,</span> <span class="n">suRot</span> <span class="o">=</span> <span class="n">rotQU</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">sq</span><span class="p">,</span><span class="n">su</span><span class="p">,</span><span class="n">thet</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">sthet</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

            <span class="c"># Computes the mean of rotated QU parameters, propagates the errors and compute stddev</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lbd</span> <span class="o">+=</span> <span class="p">[</span><span class="n">phc</span><span class="o">.</span><span class="n">lbds</span><span class="p">[</span><span class="n">filt</span><span class="p">]]</span>
                <span class="n">qqRot</span> <span class="o">+=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">qRot</span><span class="p">)]</span>
                <span class="n">uuRot</span> <span class="o">+=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">uRot</span><span class="p">)]</span>
                <span class="n">sqqRot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">el</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">sqRot</span><span class="p">]))</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">sqRot</span><span class="p">)]</span>
                <span class="n">sqqRot</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">qRot</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qRot</span><span class="p">))]</span>
                <span class="n">suuRot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">el</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">suRot</span><span class="p">]))</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">suRot</span><span class="p">)]</span>
                <span class="n">suuRot</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">uRot</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">uRot</span><span class="p">))]</span>

        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c">#    plt.show()</span>

<span class="c">#    fig = plt.figure(1)</span>
<span class="c">#    ax = plt.subplot(1, 1, 1)</span>
<span class="c">#    ax.errorbar(lbd, uuRot,yerr=suuRot[1])</span>
<span class="c">#    plt.show()</span>


    <span class="k">return</span> <span class="n">lbd</span><span class="p">,</span> <span class="n">uuRot</span><span class="p">,</span> <span class="n">suuRot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">suuRot</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>



</div>
<div class="viewcode-block" id="fitSerk"><a class="viewcode-back" href="../../fieldstars.html#pyhdust.fieldstars.fitSerk">[docs]</a><span class="k">def</span> <span class="nf">fitSerk</span><span class="p">(</span><span class="n">larr</span><span class="p">,</span> <span class="n">parr</span><span class="p">,</span> <span class="n">sarr</span><span class="p">,</span> <span class="n">star</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">law</span><span class="o">=</span><span class="s">&#39;w82&#39;</span><span class="p">,</span> <span class="n">n_burnin</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">n_mcmc</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> \
                                                <span class="n">n_walkers</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">extens</span><span class="o">=</span><span class="s">&#39;pdf&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit Serkowski law using Markov Chain Monte Carlo</span>
<span class="sd">        from emcee code.</span>
<span class="sd">        The likelihood function (L) supposes Gaussian</span>
<span class="sd">        errors around the Pmax values:</span>

<span class="sd">        log(L) = -0.5*chi2 -0.5*sum(ln(2*pi*sy^2))</span>


<span class="sd">      INPUT:</span>
<span class="sd">        </span>
<span class="sd">          larr: array/list with lambda values</span>
<span class="sd">          parr: array/list with P values</span>
<span class="sd">          sarr: array/list with the sigma_P values</span>
<span class="sd">          star: star name to be printed in the graph and</span>
<span class="sd">                its filename. If it&#39;s a void str &#39;&#39;, this</span>
<span class="sd">                routine give a random number to prevent</span>
<span class="sd">                overwriting data.</span>
<span class="sd">           law: what K value in Serkowski&#39;s law use?</span>
<span class="sd">                (see polt.serkowski).</span>
<span class="sd">      n_burnin: number of iterations for burning-in</span>
<span class="sd">        n_mcmc: number of iterations to run emcee</span>
<span class="sd">     n_walkers: number of walkers to map the posterior</span>
<span class="sd">                probabilities.</span>
<span class="sd">        extens: extension for the graph file</span>


<span class="sd">      OUTPUT: sorted like &quot;pmax_fit, lmax_fit, chi2&quot;</span>

<span class="sd">        pmax_fit: [Pmax, sPmax_+, sPmax_-], the Pmax value and</span>
<span class="sd">                  its errors (at right and left from it). Pmax</span>
<span class="sd">                  is the median of distribution probability and</span>
<span class="sd">                  sPmax_+, sPmax_- are the range within which</span>
<span class="sd">                  there are 68.3% of the points in such</span>
<span class="sd">                  distribution.</span>
<span class="sd">        lmax_fit: Idem, for lmax.</span>
<span class="sd">            chi2: Reduced chi2.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">emcee</span>
    <span class="kn">import</span> <span class="nn">triangle.nov</span>
    <span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">MaxNLocator</span>


    <span class="k">def</span> <span class="nf">lnprob</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the log of posterior probability (p_pos) in</span>
<span class="sd">        bayesian statistics for the parameters &#39;params&#39;</span>
<span class="sd">        ([Pmax,lmax]) and the data poits x, y and sy</span>
<span class="sd">        (y error values).</span>

<span class="sd">        p_pos = L*p_prior (unless by a normalization constant),</span>
<span class="sd">        where L is the likelihood function and p_prior is the</span>
<span class="sd">        prior probability function.</span>

<span class="sd">        In our case, for gaussian and independent uncertainies,</span>
<span class="sd">        the log of likelihood:</span>

<span class="sd">        log(L) = -0.5*chi2 -0.5*sum(ln(2*pi*sy^2))</span>

<span class="sd">        Now, p_prior = constant for &#39;params&#39; values inside the</span>
<span class="sd">        range defined by &#39;intervalos&#39;; otherwise, it is 0.</span>
<span class="sd">        That is the only determination that we can do.</span>

<span class="sd">        So, p_pos = -0.5*chi2 -0.5*sum(ln(2*pi*sy^2)) or</span>
<span class="sd">        -inf case &#39;params&#39; are out from the allowed range.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">Pmax</span><span class="p">,</span> <span class="n">lmax</span> <span class="o">=</span> <span class="n">params</span>

        <span class="c"># Set prior ln prob</span>
        <span class="k">if</span> <span class="n">Pmax</span> <span class="o">&lt;</span> <span class="n">intervalos</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">Pmax</span> <span class="o">&gt;</span> <span class="n">intervalos</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> \
                     <span class="n">lmax</span> <span class="o">&lt;</span> <span class="n">intervalos</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">lmax</span> <span class="o">&gt;</span> <span class="n">intervalos</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span>
            <span class="n">lnprior</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lnprior</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="c"># Return posterior prob</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lnprior</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">lnprior</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="n">polt</span><span class="o">.</span><span class="n">serkowski</span><span class="p">(</span><span class="n">Pmax</span><span class="p">,</span> <span class="n">lmax</span><span class="o">*</span><span class="mi">10000</span><span class="p">,</span> <span class="n">x</span><span class="o">*</span><span class="mi">10000</span><span class="p">,</span> <span class="n">law</span><span class="o">=</span><span class="n">law</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="n">sy</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">sy</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>



    <span class="k">def</span> <span class="nf">run_emcee</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span> <span class="n">p0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run emcee.</span>

<span class="sd">        p0 is the initial positions for the walkers</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">print</span> <span class="s">&quot;Burning-in ...&quot;</span>
        <span class="n">pos</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">n_burnin</span><span class="p">)</span>
        <span class="n">sampler</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="k">print</span> <span class="s">&quot;Running MCMC ...&quot;</span>
        <span class="n">pos</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">n_mcmc</span><span class="p">,</span> <span class="n">rstate0</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>

        <span class="c">#~ Print out the mean acceptance fraction. </span>
        <span class="n">af</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">acceptance_fraction</span>
        <span class="k">print</span> <span class="s">&quot;Mean acceptance fraction:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">af</span><span class="p">)</span>


        <span class="c"># The lines below were to compute the best fit parameters using the maximum value</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        #~ Get the index with the highest probability</span>
<span class="sd">        maxprob_idx = np.argmax(prob)</span>
<span class="sd">        minprob_idx = np.argmin(prob)</span>

<span class="sd">        #~ Get the best parameters and their respective stddev + chi2</span>
<span class="sd">        params_fit = pos[maxprob_idx]</span>
<span class="sd">        stddev_fit = [sampler.flatchain[:,i].std() for i in xrange(ndim)]</span>
<span class="sd">        samples_aux = map(lambda v: [v[0]-params_fit[0], v[1]-params_fit[1]], samples)</span>
<span class="sd">        if len(larr) == 2:</span>
<span class="sd">            chi1 = 1.</span>
<span class="sd">        else:</span>
<span class="sd">            chi1 = np.sum(((polt.serkowski(params_fit[0], params_fit[1]*10000, larr*10000, law=law, mode=2) - parr)/sarr)**2)/(len(larr)-2)</span>

<span class="sd">        # Computing errors accordind to the distance to the maximum value inside which</span>
<span class="sd">        # there are 68.3% of the data</span>
<span class="sd">        p_fit1 = np.array([], dtype=float)</span>
<span class="sd">        p_fit2 = np.array([], dtype=float)</span>
<span class="sd">        l_fit1 = np.array([], dtype=float)</span>
<span class="sd">        l_fit2 = np.array([], dtype=float)</span>

<span class="sd">        print(&#39;Please wait, computing errors...&#39;)</span>
<span class="sd">        for elem in samples_aux:</span>
<span class="sd">            if elem[0] &gt;= 0:</span>
<span class="sd">                p_fit1 = np.append(p_fit1, [elem[0]])</span>
<span class="sd">            else:</span>
<span class="sd">                p_fit2 = np.append(p_fit2, [elem[0]])</span>
<span class="sd">            if elem[1] &gt;= 0:</span>
<span class="sd">                l_fit1 = np.append(l_fit1, [elem[1]])</span>
<span class="sd">            else:</span>
<span class="sd">                l_fit2 = np.append(l_fit2, [elem[1]])</span>

<span class="sd">        # Caution, 65.85 = 100-34.15 !!!</span>
<span class="sd">        p_error = [np.percentile(p_fit1, 68.3), -np.percentile(p_fit2, 31.7)]</span>
<span class="sd">        l_error = [np.percentile(l_fit1, 68.3), -np.percentile(l_fit2, 31.7)]</span>

<span class="sd">        print(74*&#39;-&#39;)</span>
<span class="sd">        print(&#39;Output&#39;)</span>
<span class="sd">        print(74*&#39;-&#39;)</span>
<span class="sd">        print &#39;  P_max = {0:.4f}  +{1:.4f}  -{2:.4f}&#39;.format(params_fit[0],p_error[0],p_error[1],stddev_fit[0])</span>
<span class="sd">        print &#39;lbd_max = {0:.4f}  +{1:.4f}  -{2:.4f}&#39;.format(params_fit[1],l_error[0],l_error[1],stddev_fit[1])</span>
<span class="sd">        print &#39;reduced chi2 = {0:.4f}&#39;.format(chi1)</span>
<span class="sd">        print(74*&#39;-&#39;)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c">### 1) Compute the results using all interval</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Please wait, computing errors...&#39;</span><span class="p">)</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">chain</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndim</span><span class="p">))</span>
        <span class="n">p_mcmc</span><span class="p">,</span> <span class="n">l_mcmc</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                             <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="p">[</span><span class="mf">16.075</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mf">83.925</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">larr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">chi</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="n">polt</span><span class="o">.</span><span class="n">serkowski</span><span class="p">(</span><span class="n">p_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">10000</span><span class="p">,</span> <span class="n">larr</span><span class="o">*</span><span class="mi">10000</span><span class="p">,</span> <span class="n">law</span><span class="o">=</span><span class="n">law</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">parr</span><span class="p">)</span><span class="o">/</span><span class="n">sarr</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">larr</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>

        <span class="c">#~ Plot the graphs -- histogram, corner and convergence map</span>
<span class="c">#        fighists = plot_samples_hist(sampler)</span>
        <span class="n">plot_conv</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span> <span class="p">[</span><span class="n">p_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">triangle</span><span class="o">.</span><span class="n">nov</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">fixName</span><span class="p">(</span><span class="n">star</span><span class="p">),</span> \
<span class="c">#                            truths=[p_mcmc[0], l_mcmc[0]], \</span>
<span class="c">#                            extents=[(p_range[0],l_range[0]),(p_range[1],l_range[1])], \</span>
                             <span class="n">quantiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.16075</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.83925</span><span class="p">],</span> \
                             <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;$P_{max}\,($%$)$&#39;</span><span class="p">,</span> <span class="s">&#39;$\lambda_{max}\,(\mu m)$&#39;</span><span class="p">],</span> \
                             <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}_correl.{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star</span><span class="p">,</span><span class="n">extens</span><span class="p">))</span>
        <span class="n">fig1</span> <span class="o">=</span> <span class="n">triangle</span><span class="o">.</span><span class="n">nov</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">fixName</span><span class="p">(</span><span class="n">star</span><span class="p">),</span> \
<span class="c">#                            truths=[p_mcmc[0], l_mcmc[0]], \</span>
<span class="c">#                            extents=[(p_range[0],l_range[0]),(p_range[1],l_range[1])], \</span>
                             <span class="n">quantiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.16075</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.83925</span><span class="p">],</span> \
                             <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;$P_{max}\,($%$)$&#39;</span><span class="p">,</span> <span class="s">&#39;$\lambda_{max}\,(\mu m)$&#39;</span><span class="p">],</span> \
                             <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">fig1</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


        <span class="c">#~ Print the output using all interval</span>
        <span class="sd">&quot;&quot;&quot; TBD &quot;&quot;&quot;</span>
        <span class="k">print</span><span class="p">(</span><span class="mi">74</span><span class="o">*</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Output&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="mi">74</span><span class="o">*</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;  P_max = {0:.4f}  +{1:.4f}  -{2:.4f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p_mcmc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">p_mcmc</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">print</span> <span class="s">&#39;lbd_max = {0:.4f}  +{1:.4f}  -{2:.4f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">l_mcmc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">l_mcmc</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">print</span> <span class="s">&#39;reduced chi2 = {0:.4f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="mi">74</span><span class="o">*</span><span class="s">&#39;-&#39;</span><span class="p">)</span>



        <span class="c">### 2) NEW: Requests if the user want to use some specific interval</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">while</span> <span class="n">opt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">,</span><span class="s">&#39;n&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;These values were calculated using all Pmax and lbdmax data.</span><span class="se">\n</span><span class="s">Do you want&#39;</span> <span class="o">+</span>\
                  <span class="s">&#39; to select specific ranges to use to compute the uncertainties?&#39;</span><span class="p">)</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;(y/n): &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">):</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">petr</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;Pmax: specify Pmax in format `Pmax_min,Pmax_max`: &#39;</span><span class="p">)</span>
<span class="c">#                        p_int = [float(ei)-params_fit[0] for ei in petr.split(&#39;,&#39;)]</span>
                        <span class="n">p_range</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">ei</span><span class="p">)</span> <span class="k">for</span> <span class="n">ei</span> <span class="ow">in</span> <span class="n">petr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_range</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">p_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">p_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Error: Pmax_max must be greather than Pmax_min!&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Invalid input!&#39;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Invalid input!&#39;</span><span class="p">)</span>

                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">letr</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;lbdmax: specify lbdmax in format `lbdmax_min,lbdmax_max`: &#39;</span><span class="p">)</span>
<span class="c">#                        l_int = [float(ei)-params_fit[1] for ei in letr.split(&#39;,&#39;)]</span>
                        <span class="n">l_range</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">ei</span><span class="p">)</span> <span class="k">for</span> <span class="n">ei</span> <span class="ow">in</span> <span class="n">letr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_range</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">l_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">l_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Error: lbdmax_max must be grather than lbdmax_min!&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Invalid input!&#39;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Invalid input!&#39;</span><span class="p">)</span>

                <span class="n">opt</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="k">while</span> <span class="n">opt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">,</span><span class="s">&#39;n&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Is it correct?     Pmax_min,Pmax_max = &#39;</span> <span class="o">+</span> <span class="n">petr</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span>\
                            <span class="s">&#39;               lbdmax_min,lbdmax_max = &#39;</span> <span class="o">+</span> <span class="n">letr</span><span class="p">)</span>
                    <span class="n">opt</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;(y/n): &#39;</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">):</span>
                    <span class="k">break</span>

            <span class="c"># The lines below were to compute the best fit parameters using the maximum value</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            p_fit1 = np.array([], dtype=float)</span>
<span class="sd">            p_fit2 = np.array([], dtype=float)</span>
<span class="sd">            l_fit1 = np.array([], dtype=float)</span>
<span class="sd">            l_fit2 = np.array([], dtype=float)</span>
<span class="sd">            print(&#39;Please wait, computing errors...&#39;)</span>

<span class="sd">            # fit1: arrays for the right of the best values</span>
<span class="sd">            # fit2: arrays for the left of the best values</span>
<span class="sd">            for elem in samples_aux:</span>
<span class="sd">                if elem[0] &gt;= 0 and elem[0] &lt; p_int[1]:</span>
<span class="sd">                    p_fit1 = np.append(p_fit1, [elem[0]])</span>
<span class="sd">                elif elem[0] &lt; 0 and elem[0] &gt; p_int[0]:</span>
<span class="sd">                    p_fit2 = np.append(p_fit2, [elem[0]])</span>
<span class="sd">                if elem[1] &gt;= 0 and elem[0] &lt; l_int[1]:</span>
<span class="sd">                    l_fit1 = np.append(l_fit1, [elem[1]])</span>
<span class="sd">                elif elem[1] &lt; 0 and elem[1] &gt; l_int[0]:</span>
<span class="sd">                    l_fit2 = np.append(l_fit2, [elem[1]])</span>

<span class="sd">            # Caution, 100-68.3 = 31.7!</span>
<span class="sd">            p_error = [np.percentile(p_fit1, 68.3), -np.percentile(p_fit2, 31.7)]</span>
<span class="sd">            l_error = [np.percentile(l_fit1, 68.3), -np.percentile(l_fit2, 31.7)]</span>

<span class="sd">            print(74*&#39;-&#39;)</span>
<span class="sd">            print(&#39;Output&#39;)</span>
<span class="sd">            print(74*&#39;-&#39;)</span>
<span class="sd">            print &#39;  P_max = {0:.4f}  +{1:.4f}  -{2:.4f}&#39;.format(params_fit[0],p_error[0],p_error[1],stddev_fit[0])</span>
<span class="sd">            print &#39;lbd_max = {0:.4f}  +{1:.4f}  -{2:.4f}&#39;.format(params_fit[1],l_error[0],l_error[1],stddev_fit[1])</span>
<span class="sd">            print &#39;reduced chi2 = {0:.4f}&#39;.format(chi1)</span>
<span class="sd">            print(74*&#39;-&#39;)</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="c"># Filtering &#39;samples&#39; array</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Please wait, computing errors...&#39;</span><span class="p">)</span>
            <span class="n">samples_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">p_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> \
                   <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">l_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">l_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">samples_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">samples_new</span><span class="p">,</span> <span class="n">elem</span><span class="p">])</span>

            <span class="c"># Computing NEW medians and errors</span>
            <span class="n">p_mcmc</span><span class="p">,</span> <span class="n">l_mcmc</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                 <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">samples_new</span><span class="p">,</span> <span class="p">[</span><span class="mf">16.075</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mf">83.925</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">larr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">chi</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="n">polt</span><span class="o">.</span><span class="n">serkowski</span><span class="p">(</span><span class="n">p_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">10000</span><span class="p">,</span> <span class="n">larr</span><span class="o">*</span><span class="mi">10000</span><span class="p">,</span> <span class="n">law</span><span class="o">=</span><span class="n">law</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">parr</span><span class="p">)</span><span class="o">/</span><span class="n">sarr</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">larr</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>

            
            <span class="c">#~ Print the output using the specific range</span>
            <span class="sd">&quot;&quot;&quot; TBD &quot;&quot;&quot;</span>
            <span class="k">print</span><span class="p">(</span><span class="mi">74</span><span class="o">*</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Output&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="mi">74</span><span class="o">*</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&#39;  P_max = {0:.4f}  +{1:.4f}  -{2:.4f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p_mcmc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">p_mcmc</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">print</span> <span class="s">&#39;lbd_max = {0:.4f}  +{1:.4f}  -{2:.4f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">l_mcmc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">l_mcmc</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">print</span> <span class="s">&#39;reduced chi2 = {0:.4f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="mi">74</span><span class="o">*</span><span class="s">&#39;-&#39;</span><span class="p">)</span>

            <span class="c"># Save the new triangle graph</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">triangle</span><span class="o">.</span><span class="n">nov</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span><span class="n">samples_new</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">fixName</span><span class="p">(</span><span class="n">star</span><span class="p">),</span> \
<span class="c">#                                 truths=[p_mcmc[0], l_mcmc[0]], \</span>
<span class="c">#                                 extents=[(p_range[0],l_range[0]),(p_range[1],l_range[1])], \</span>
                                  <span class="n">quantiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.16075</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.83925</span><span class="p">],</span> \
                                  <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;$P_{max}\,($%$)$&#39;</span><span class="p">,</span> <span class="s">&#39;$\lambda_{max}\,(\mu m)$&#39;</span><span class="p">],</span> \
                                  <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}_correl_cut.{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star</span><span class="p">,</span><span class="n">extens</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;{0}_correl_cut.{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star</span><span class="p">,</span><span class="n">extens</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

<span class="c">#        plt.close(fighists[0])</span>
<span class="c">#        plt.close(fighists[1])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sampler</span><span class="p">,</span> <span class="n">p_mcmc</span><span class="p">,</span> <span class="n">l_mcmc</span><span class="p">,</span> <span class="n">chi</span>



    <span class="k">def</span> <span class="nf">plot_samples_hist</span><span class="p">(</span><span class="n">sampler</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot two figures with the histograms</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">sampler</span><span class="o">.</span><span class="n">flatchain</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">par</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;$P_{max}$&#39;</span><span class="p">,</span> <span class="s">&#39;$\lambda_{max}$&#39;</span><span class="p">]</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">+=</span> <span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Sample of parameter {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">fig</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            
        <span class="k">return</span> <span class="n">fig</span>



    <span class="k">def</span> <span class="nf">plot_conv</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot convergence map. &#39;param&#39; are the values to be highlighted</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">chain</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;#888888&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&quot;$P_{max}$&quot;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">chain</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;#888888&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&quot;$\lambda_{max}$&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&quot;Step number&quot;</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">h_pad</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}_conv.{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star</span><span class="p">,</span><span class="n">extens</span><span class="p">))</span>

        <span class="k">return</span>



    <span class="c"># Setting parameters and limits</span>
    <span class="n">Pmax_max</span> <span class="o">=</span> <span class="mf">9.</span>
    <span class="n">Pmax_min</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">lmax_max</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">lmax_min</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">intervalos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">Pmax_min</span><span class="p">,</span> <span class="n">Pmax_max</span><span class="p">],</span> <span class="p">[</span><span class="n">lmax_min</span><span class="p">,</span> <span class="n">lmax_max</span><span class="p">]])</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c"># Converting lists to np.array</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">parr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">parr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">parr</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">larr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">larr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">larr</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">sarr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">sarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sarr</span><span class="p">)</span>

    <span class="c"># If &#39;star&#39; was not specified, generate a random number to append to the graph name to be saved</span>
    <span class="k">if</span> <span class="n">star</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="n">star</span> <span class="o">=</span> <span class="s">&#39;rand&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">10000</span><span class="p">))</span>

<span class="c">#    larr = np.array([0.3650, 0.4450, 0.5510, 0.6580, 0.8060])</span>
<span class="c">#    parr = np.array([0.26685, 0.34856, 0.36904, 0.33956, 0.29710])</span>
<span class="c">#    sigma = np.array([0.09753, 0.00881, 0.00749, 0.01132, 0.01120])</span>

<span class="c">#    larr = np.array([0.4450, 0.5510, 0.6580, 0.8060])</span>
<span class="c">#    parr = np.array([0.34856, 0.36904, 0.33956, 0.29710])</span>
<span class="c">#    sarr = np.array([0.00881, 0.00749, 0.01132, 0.01120])</span>

    <span class="c"># Define random values to be used as priori numbers within the interval</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n_walkers</span><span class="p">)]</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
        <span class="n">p0</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">intervalos</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">p0</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">intervalos</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">intervalos</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="c"># Initialize the sampler and run mcmc</span>
    <span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span><span class="n">n_walkers</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">lnprob</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">larr</span><span class="p">,</span> <span class="n">parr</span><span class="p">,</span> <span class="n">sarr</span><span class="p">],</span> <span class="n">a</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="c">#, threads=2)</span>
    <span class="n">sampler</span><span class="p">,</span> <span class="n">pmax_fit</span><span class="p">,</span> <span class="n">lmax_fit</span><span class="p">,</span> <span class="n">chi</span> <span class="o">=</span> <span class="n">run_emcee</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span> <span class="n">p0</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">pmax_fit</span><span class="p">,</span> <span class="n">lmax_fit</span><span class="p">,</span> <span class="n">chi</span>
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Python tools for the BeACoN group Beta documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../pyhdust.html" >pyhdust</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015-2016, D. Moser.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyhdust.spectools &mdash; Python tools for the BeACoN group Beta documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     'Beta',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Python tools for the BeACoN group Beta documentation" href="../../index.html" />
    <link rel="up" title="pyhdust" href="../pyhdust.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Python tools for the BeACoN group Beta documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../pyhdust.html" accesskey="U">pyhdust</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pyhdust.spectools</h1><div class="highlight"><pre>
<span class="c"># -*- coding:utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;PyHdust *spectools* module: spectroscopy tools</span>

<span class="sd">Algumas definicoes: para todas as rotinas funcionarem, todos os espectros devem</span>
<span class="sd">estar agrupados num mesmo caminho (`path`), em estrutura de</span>
<span class="sd">noite/estrelas/espec.</span>

<span class="sd">Neste momento, as rotinas somente leem arquivos `*.cal.fits`. Para receber este</span>
<span class="sd">sufixo `.cal`, algumas informacoes no header sao necessarias:</span>

<span class="sd">    * &#39;MJD-OBS&#39; ou &#39;MJD&#39; ou &#39;JD&#39; ou &#39;DATE-OBS&#39;</span>
<span class="sd">    * &#39;CRVAL1&#39; + &#39;CDELT1&#39;</span>

<span class="sd">IMPORTANT NOTE: after the version 0.9.81, the &quot;analline&quot; function returns </span>
<span class="sd">FWHM instead of `depthcent`.</span>

<span class="sd">:license: GNU GPL v3.0 https://github.com/danmoser/pyhdust/blob/master/LICENSE</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span> <span class="kn">as</span> <span class="nn">_os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">_np</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="kn">as</span> <span class="nn">_dt</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="kn">as</span> <span class="nn">_time</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span> <span class="k">as</span> <span class="n">_glob</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span> <span class="k">as</span> <span class="n">_iproduct</span>
<span class="kn">import</span> <span class="nn">pyhdust.phc</span> <span class="kn">as</span> <span class="nn">_phc</span>
<span class="kn">import</span> <span class="nn">pyhdust.jdcal</span> <span class="kn">as</span> <span class="nn">_jdcal</span>
<span class="kn">import</span> <span class="nn">pyhdust</span> <span class="kn">as</span> <span class="nn">_hdt</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pyfits</span> <span class="kn">as</span> <span class="nn">_pyfits</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="kn">as</span> <span class="nn">_mpl</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">_plt</span>
    <span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="kn">as</span> <span class="nn">_mpatches</span>
    <span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">MaxNLocator</span> <span class="k">as</span> <span class="n">_MaxNLocator</span>
    <span class="kn">import</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">as</span> <span class="nn">_gridspec</span>
    <span class="kn">import</span> <span class="nn">scipy.interpolate</span> <span class="kn">as</span> <span class="nn">_interpolate</span> 
    <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span> <span class="k">as</span> <span class="n">_curve_fit</span>
    <span class="kn">import</span> <span class="nn">pyqt_fit.nonparam_regression</span> <span class="kn">as</span> <span class="nn">smooth</span>
    <span class="kn">from</span> <span class="nn">pyqt_fit</span> <span class="kn">import</span> <span class="n">npr_methods</span>
    <span class="c"># from scipy.signal import savgol_filter as _savgol</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Warning! matplotlib, scipy, pyqt_fit and/or pyfits module not&#39;</span> 
        <span class="s">&#39; installed!!!&#39;</span><span class="p">)</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&quot;Daniel Moser&quot;</span>
<span class="n">__email__</span> <span class="o">=</span> <span class="s">&quot;dmfaes@gmail.com&quot;</span>

<span class="n">_outfold</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>


<div class="viewcode-block" id="Spec"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.Spec">[docs]</a><span class="k">class</span> <span class="nc">Spec</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Definicao de classe espectro para conter toda a informacao util</span>
<span class="sd">    para plots e analises.</span>

<span class="sd">    EW in km/s</span>

<span class="sd">    Para configurar uma ou mais linhas:</span>

<span class="sd">    &gt;&gt;&gt; spdtb = Spec()</span>
<span class="sd">    &gt;&gt;&gt; spdtb.lbc == 0</span>
<span class="sd">    &gt;&gt;&gt; #significa que vetor wl eh vetor velocidades, e nao comprimento de </span>
<span class="sd">    &gt;&gt;&gt; # onda.</span>
<span class="sd">    &gt;&gt;&gt; spdtb.lbc = 6564.</span>
<span class="sd">    &gt;&gt;&gt; spdtb2 = Spec()</span>
<span class="sd">    &gt;&gt;&gt; spdtb2.lbc = 4863.</span>

<span class="sd">    Como usar (hard way):</span>

<span class="sd">    &gt;&gt;&gt; spdtb = Spec()</span>
<span class="sd">    &gt;&gt;&gt; #read spec `flux` and `wl` for a given `lbc`</span>
<span class="sd">    &gt;&gt;&gt; (spdtb.EW, spdtb.EC, spdtb.VR, spdtb.peaksep, spdtb.depthcent,\\ </span>
<span class="sd">    &gt;&gt;&gt; spdtb.F0) = analline(wl, flux, lbc)</span>
<span class="sd">    &gt;&gt;&gt; spdtb.MJD = 1</span>
<span class="sd">    &gt;&gt;&gt; spdtb.file = file</span>

<span class="sd">    And then:</span>

<span class="sd">    &gt;&gt;&gt; #to record it to the database:</span>
<span class="sd">    &gt;&gt;&gt; spdtb.addspec()</span>

<span class="sd">    Para carregar uma tabela anterior, faca:</span>

<span class="sd">    &gt;&gt;&gt; spdtb = Spec()</span>
<span class="sd">    &gt;&gt;&gt; #(...) read new specs and then join with previous ones</span>
<span class="sd">    &gt;&gt;&gt; spdtb.data = _np.vstack((spdtb.data, _np.loadtxt(&#39;hdt/datafile.txt&#39;)))</span>
<span class="sd">    &gt;&gt;&gt; spdtb.metadata = _np.vstack(( spdtb.metadata, \\</span>
<span class="sd">    &gt;&gt;&gt; _np.loadtxt(&#39;hdt/metafile.txt&#39;) ))</span>
<span class="sd">    &gt;&gt;&gt; spdtb.updatecount() #to update the counter</span>

<span class="sd">    Ou simplesmente (nome de arquivos default):</span>

<span class="sd">    &gt;&gt;&gt; spdtb.loaddata()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wl</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">lbc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">EW</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span>
        <span class="n">EC</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="n">VR</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="n">peaksep</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="n">depthcent</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="n">F0</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span>
        <span class="n">dateobs</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">MJD</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">datereduc</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">gaussfit</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wl</span> <span class="o">=</span> <span class="n">wl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span> <span class="o">=</span> <span class="n">flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lbc</span> <span class="o">=</span> <span class="n">lbc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hwidth</span> <span class="o">=</span> <span class="n">hwidth</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">EW</span> <span class="o">=</span> <span class="n">EW</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EC</span> <span class="o">=</span> <span class="n">EC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VR</span> <span class="o">=</span> <span class="n">VR</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peaksep</span> <span class="o">=</span> <span class="n">peaksep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depthcent</span> <span class="o">=</span> <span class="n">depthcent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F0</span> <span class="o">=</span> <span class="n">F0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="nb">file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datereduc</span> <span class="o">=</span> <span class="n">datereduc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dateobs</span> <span class="o">=</span> <span class="n">dateobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MJD</span> <span class="o">=</span> <span class="n">MJD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaussfit</span> <span class="o">=</span> <span class="n">gaussfit</span>

<div class="viewcode-block" id="Spec.reset"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.Spec.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset the class parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wl</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EW</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EC</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VR</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peaksep</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depthcent</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F0</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datereduc</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dateobs</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MJD</span> <span class="o">=</span> <span class="mf">0.</span>        
</div>
<div class="viewcode-block" id="Spec.clear"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.Spec.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear the class parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Spec.addspec"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.Spec.addspec">[docs]</a>    <span class="k">def</span> <span class="nf">addspec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record the class parameters into the database</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastinfo</span><span class="p">()</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastmeta</span><span class="p">()</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastinfo</span><span class="p">()</span> <span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastmeta</span><span class="p">()</span> <span class="p">))</span>
        <span class="c"># if self.flux != None and self.wl != None and self.lbc != None:</span>
        <span class="c">#    self.savespec()</span>
</div>
<div class="viewcode-block" id="Spec.lastinfo"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.Spec.lastinfo">[docs]</a>    <span class="k">def</span> <span class="nf">lastinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print the current class parameters (last spec)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">MJD</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">EW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">EC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">peaksep</span><span class="p">,</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">depthcent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">F0</span> 
</div>
<div class="viewcode-block" id="Spec.lastmeta"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.Spec.lastmeta">[docs]</a>    <span class="k">def</span> <span class="nf">lastmeta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print the current class parameters (last spec)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">MJD</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dateobs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">datereduc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span>
</div>
<div class="viewcode-block" id="Spec.savedata"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.Spec.savedata">[docs]</a>    <span class="k">def</span> <span class="nf">savedata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datafile</span><span class="o">=</span><span class="n">_outfold</span> <span class="o">+</span> <span class="s">&#39;/datafile.txt&#39;</span><span class="p">,</span>
        <span class="n">metafile</span><span class="o">=</span><span class="n">_outfold</span> <span class="o">+</span> <span class="s">&#39;/metafile.txt&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save current table</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;MJD&#39;</span><span class="p">,</span> <span class="s">&#39;EW&#39;</span><span class="p">,</span> <span class="s">&#39;EC&#39;</span><span class="p">,</span> <span class="s">&#39;VR&#39;</span><span class="p">,</span> <span class="s">&#39;peaksep&#39;</span><span class="p">,</span> <span class="s">&#39;depthcent&#39;</span><span class="p">,</span> <span class="s">&#39;F0&#39;</span><span class="p">]</span>
        <span class="n">_np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%12.6f</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">*</span> <span class="s">&#39;{:&gt;12s}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">header</span><span class="p">))</span>
        <span class="n">_np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">metafile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="Spec.loaddata"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.Spec.loaddata">[docs]</a>    <span class="k">def</span> <span class="nf">loaddata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datafile</span><span class="o">=</span><span class="n">_outfold</span> <span class="o">+</span> <span class="s">&#39;/datafile.txt&#39;</span><span class="p">,</span>
        <span class="n">metafile</span><span class="o">=</span><span class="n">_outfold</span> <span class="o">+</span> <span class="s">&#39;/metafile.txt&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function to load a previous table</span>
<span class="sd">        Usage:</span>

<span class="sd">        &gt;&gt;&gt; spdtb = Spec()</span>
<span class="sd">        &gt;&gt;&gt; spdtb.loaddata()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">metafile</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">metafile</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;str&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updatecount</span><span class="p">()</span>
        <span class="k">return</span>
</div>
    <span class="k">def</span> <span class="nf">updatecount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">num</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span>

<div class="viewcode-block" id="Spec.loadspec"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.Spec.loadspec">[docs]</a>    <span class="k">def</span> <span class="nf">loadspec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load a fits file (parameters `wl`, `flux`, `MJD`, `dateobs`,</span>
<span class="sd">        `datareduc` and `file`).</span>

<span class="sd">        Currently, only compatible for standard fits.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">file</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;.fit&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;# ERROR! `loadspec` unrecognized format!&quot;</span><span class="p">)</span>
            <span class="k">return</span> 
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MJD</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dateobs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">datereduc</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span> <span class="o">=</span> <span class="n">loadfits</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">EC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">peaksep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depthcent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">F0</span><span class="p">)</span> <span class="o">=</span> \
            <span class="n">analline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lbc</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hwidth</span><span class="p">,</span> 
            <span class="n">verb</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">gaussfit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gaussfit</span><span class="p">)</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="Spec.plotspec"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.Spec.plotspec">[docs]</a>    <span class="k">def</span> <span class="nf">plotspec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Export current spec into a PNG file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wl</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: wrong Spec() parameters! {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">outname</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="n">path</span><span class="p">,</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">trimpathname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
            <span class="n">outname</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">rmext</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
        <span class="c"># Normalization:</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">linfit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span>
        <span class="n">wl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wl</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;norm. flux&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;wavelength (arb. units)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">outname</span><span class="p">)</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}/{1:.2f}_{2}.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_outfold</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MJD</span><span class="p">,</span> <span class="n">outname</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lbc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">vels</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wl</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lbc</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">lbc</span> <span class="o">*</span> <span class="n">_phc</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">cgs</span> <span class="o">*</span> <span class="mf">1e-5</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vels</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hwidth</span><span class="p">)</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">linfit</span><span class="p">(</span><span class="n">vels</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">flux</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="n">vels</span> <span class="o">=</span> <span class="n">vels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">_plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vels</span><span class="p">,</span> <span class="n">flux</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;norm. flux&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;vel. (km/s)&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;{0:.2f} {1} {2:.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MJD</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">lbc</span><span class="p">))</span>
            <span class="n">_plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}/{1:.2f}_{2}_{3:.2f}.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_outfold</span><span class="p">,</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">MJD</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lbc</span><span class="p">))</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span>

</div></div>
<div class="viewcode-block" id="shiftfits"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.shiftfits">[docs]</a><span class="k">def</span> <span class="nf">shiftfits</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">,</span> <span class="n">newsh</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Update FITS spec header for a given shift value. &quot;&quot;&quot;</span>
    <span class="n">imfits</span> <span class="o">=</span> <span class="n">_pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;update&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;WLSHIFT&#39;</span> <span class="ow">in</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# WLSHIFT = {0} for {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;WLSHIFT&#39;</span><span class="p">],</span>
        <span class="n">_phc</span><span class="o">.</span><span class="n">trimpathname</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# No WLSHIFT available for {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">_phc</span><span class="o">.</span><span class="n">trimpathname</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">newsh</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">newsh</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;Type the new shift: &#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">newsh</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;WLSHIFT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">newsh</span><span class="p">)</span>
        <span class="n">imfits</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> 

</div>
<div class="viewcode-block" id="checkshiftfits"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.checkshiftfits">[docs]</a><span class="k">def</span> <span class="nf">checkshiftfits</span><span class="p">(</span><span class="n">fitslist</span><span class="p">,</span> <span class="n">lbc</span><span class="o">=</span><span class="mf">6562.8</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Do *shiftfits* sistematically </span>

<span class="sd">    INPUT: list of files</span>

<span class="sd">    OUTPUT: fits files header updated with WLSHIFT.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fitslist</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">loadfits</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">vel</span><span class="p">,</span> <span class="n">flx</span> <span class="o">=</span> <span class="n">lineProf</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">)</span>
        <span class="n">good</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">imfits</span> <span class="o">=</span> <span class="n">_pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;WLSHIFT&#39;</span> <span class="ow">in</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
            <span class="n">shift0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;WLSHIFT&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shift0</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">good</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;gray&#39;</span><span class="p">)</span>
            <span class="n">veli</span> <span class="o">=</span> <span class="n">vel</span> <span class="o">+</span> <span class="n">shift</span><span class="o">*</span><span class="mf">3e5</span><span class="o">/</span><span class="n">lbc</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">veli</span><span class="p">,</span> <span class="n">flx</span><span class="p">)</span>
            <span class="n">_plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">_plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s"># Is it good?(y/other): &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ri</span> <span class="o">!=</span> <span class="s">&#39;y&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">shift</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;Type shift: &#39;</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">shift</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">good</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">shift</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">shiftfits</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">newsh</span><span class="o">=</span><span class="n">shift</span><span class="o">+</span><span class="n">shift0</span><span class="p">)</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="k">return</span>

</div>
<div class="viewcode-block" id="loadfits"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.loadfits">[docs]</a><span class="k">def</span> <span class="nf">loadfits</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;load FITS spec</span>

<span class="sd">    Out: wl, flux, MJD, dateobs, datereduc, fitsfile</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">imfits</span> <span class="o">=</span> <span class="n">_pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">wl</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flux</span><span class="p">))</span> <span class="o">*</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">+</span>\
        <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;CRVAL1&#39;</span><span class="p">]</span>
    <span class="p">(</span><span class="n">MJD</span><span class="p">,</span> <span class="n">dateobs</span><span class="p">,</span> <span class="n">datereduc</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;MJD-OBS&#39;</span> <span class="ow">in</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
        <span class="n">MJD</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;MJD-OBS&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="s">&#39;MJD&#39;</span> <span class="ow">in</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
        <span class="n">MJD</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;MJD&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="s">&#39;JD&#39;</span> <span class="ow">in</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
        <span class="n">MJD</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;JD&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mf">2400000.5</span>
    <span class="k">elif</span> <span class="s">&#39;DATE-OBS&#39;</span> <span class="ow">in</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
        <span class="n">dtobs</span> <span class="o">=</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;DATE-OBS&#39;</span><span class="p">]</span>
        <span class="n">dtobs</span><span class="p">,</span> <span class="n">tobs</span> <span class="o">=</span> <span class="n">check_dtobs</span><span class="p">(</span><span class="n">dtobs</span><span class="p">)</span>
        <span class="n">MJD</span> <span class="o">=</span> <span class="n">_jdcal</span><span class="o">.</span><span class="n">gcal2jd</span><span class="p">(</span><span class="o">*</span><span class="n">dtobs</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tobs</span>
    <span class="k">elif</span> <span class="s">&#39;FRAME&#39;</span> <span class="ow">in</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
        <span class="n">dtobs</span> <span class="o">=</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;FRAME&#39;</span><span class="p">]</span>
        <span class="n">dtobs</span><span class="p">,</span> <span class="n">tobs</span> <span class="o">=</span> <span class="n">check_dtobs</span><span class="p">(</span><span class="n">dtobs</span><span class="p">)</span>
        <span class="n">MJD</span> <span class="o">=</span> <span class="n">_jdcal</span><span class="o">.</span><span class="n">gcal2jd</span><span class="p">(</span><span class="o">*</span><span class="n">dtobs</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tobs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">MJD</span> <span class="o">=</span> <span class="n">_jdcal</span><span class="o">.</span><span class="n">MJD_JD2000</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Warning! No DATE-OBS information is available! {0}&#39;</span><span class="o">.</span>
            <span class="n">format</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Assuming MJD_JD2000&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;DATE-OBS&#39;</span> <span class="ow">in</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
        <span class="n">dateobs</span> <span class="o">=</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;DATE-OBS&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s">&#39;FRAME&#39;</span> <span class="ow">in</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
        <span class="n">dateobs</span> <span class="o">=</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;FRAME&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&#39;IRAF-TLM&#39;</span> <span class="ow">in</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
        <span class="n">datereduc</span> <span class="o">=</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;IRAF-TLM&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s">&#39;DATE&#39;</span> <span class="ow">in</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
        <span class="n">datereduc</span> <span class="o">=</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;DATE&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&#39;WLSHIFT&#39;</span> <span class="ow">in</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;WLSHIFT&#39;</span><span class="p">])</span>
        <span class="n">wl</span> <span class="o">+=</span> <span class="n">shift</span>
    <span class="n">imfits</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">MJD</span><span class="p">,</span> <span class="n">dateobs</span><span class="p">,</span> <span class="n">datereduc</span><span class="p">,</span> <span class="n">fitsfile</span>

</div>
<div class="viewcode-block" id="vac2air"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.vac2air">[docs]</a><span class="k">def</span> <span class="nf">vac2air</span><span class="p">(</span><span class="n">wl</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The IAU standard for conversion from air to vacuum wavelengths is given</span>
<span class="sd">    in Morton (1991, ApJS, 77, 119). For vacuum wavelengths (VAC) in Angstroms,</span>
<span class="sd">    convert to air wavelength (AIR) via:</span>
<span class="sd">    AIR = VAC / (1.0 + 2.735182E-4 + 131.4182 / VAC^2 + 2.76249E8 / VAC^4 )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">wl</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">2.735182E-4</span> <span class="o">+</span> <span class="mf">131.4182</span> <span class="o">/</span> <span class="n">wl</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">2.76249E8</span> <span class="o">/</span> <span class="n">wl</span><span class="o">**</span><span class="mi">4</span> <span class="p">)</span>

</div>
<div class="viewcode-block" id="air2vac"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.air2vac">[docs]</a><span class="k">def</span> <span class="nf">air2vac</span><span class="p">(</span><span class="n">wl</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The IAU standard for conversion from air to vacuum wavelengths is given</span>
<span class="sd">    in Morton (1991, ApJS, 77, 119). For vacuum wavelengths (VAC) in Angstroms,</span>
<span class="sd">    convert to air wavelength (AIR) via:</span>
<span class="sd">    AIR = VAC / (1.0 + 2.735182E-4 + 131.4182 / VAC^2 + 2.76249E8 / VAC^4 )</span>

<span class="sd">    Fitting the inverse curve:</span>
<span class="sd">    VAC = AIR / (1.0 - 2.73443407E-4 - 1.31275255E2 / AIR^2 - 2.75708212E8 / </span>
<span class="sd">    AIR^4 )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">wl</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">2.73443407e-04</span> <span class="o">-</span> <span class="mf">1.31275255e+02</span> <span class="o">/</span> <span class="n">wl</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> 
        <span class="mf">2.75708212e+08</span> <span class="o">/</span> <span class="n">wl</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="vel2wl"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.vel2wl">[docs]</a><span class="k">def</span> <span class="nf">vel2wl</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">lbc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Vel. to wavelength. Vel must be in km/s and output is in `lbc` units. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wl</span> <span class="o">=</span> <span class="p">(</span><span class="n">vel</span> <span class="o">/</span> <span class="n">_phc</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">cgs</span> <span class="o">*</span> <span class="mf">1e5</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">lbc</span>
    <span class="k">return</span> <span class="n">wl</span>

</div>
<div class="viewcode-block" id="wl2vel"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.wl2vel">[docs]</a><span class="k">def</span> <span class="nf">wl2vel</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">lbc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Wavelength to vel., in km/s. `wl` and `lbc` units must be the same. &quot;&quot;&quot;</span>
    <span class="n">vels</span> <span class="o">=</span> <span class="p">(</span><span class="n">wl</span> <span class="o">-</span> <span class="n">lbc</span><span class="p">)</span> <span class="o">/</span> <span class="n">lbc</span> <span class="o">*</span> <span class="n">_phc</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">cgs</span> <span class="o">*</span> <span class="mf">1e-5</span>
    <span class="k">return</span> <span class="n">vels</span>

</div>
<div class="viewcode-block" id="hydrogenlinewl"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.hydrogenlinewl">[docs]</a><span class="k">def</span> <span class="nf">hydrogenlinewl</span><span class="p">(</span><span class="n">ni</span><span class="p">,</span> <span class="n">nf</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate H line transitions wavelengths in meters for VACUUM</span>

<span class="sd">    Rydberg constant `R` was manually adjusted to fit Halpha and Hbeta lines.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">10967850.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">nf</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">ni</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">**-</span><span class="mf">1.</span>

</div>
<div class="viewcode-block" id="calcres_R"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.calcres_R">[docs]</a><span class="k">def</span> <span class="nf">calcres_R</span><span class="p">(</span><span class="n">hwidth</span><span class="o">=</span><span class="mi">1350</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">108</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    (h)Width in km/s.</span>
<span class="sd">    *WARNING*: `width` in HDUST input is only half.</span>
<span class="sd">    To HDUST effective R, multiple the input width by 2 he_re.</span>

<span class="sd">    # R = lbd/Dlbd = _phc.c/Dv = _phc.c*nbins/width </span>
<span class="sd">    # nbins = R*width/_phc.c</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">cgs</span> <span class="o">*</span> <span class="n">nbins</span> <span class="o">/</span> <span class="n">hwidth</span> <span class="o">/</span> <span class="mf">1e5</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="calcres_nbins"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.calcres_nbins">[docs]</a><span class="k">def</span> <span class="nf">calcres_nbins</span><span class="p">(</span><span class="n">R</span><span class="o">=</span><span class="mi">12000</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="mi">1350</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    (h)Width in km/s.</span>
<span class="sd">    *WARNING*: `width` in HDUST input is only half.</span>
<span class="sd">    To HDUST effective R, multiple the input width by 2 he_re.</span>

<span class="sd">    # R = lbd/Dlbd = _phc.c/Dv = _phc.c*nbins/width </span>
<span class="sd">    # nbins = R*width/_phc.c</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">R</span> <span class="o">*</span> <span class="n">hwidth</span> <span class="o">*</span> <span class="mf">1e5</span> <span class="o">/</span> <span class="n">_phc</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">cgs</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="lineProf"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.lineProf">[docs]</a><span class="k">def</span> <span class="nf">lineProf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">flx</span><span class="p">,</span> <span class="n">lbc</span><span class="p">,</span> <span class="n">flxerr</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">hwidth</span><span class="o">=</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">ssize</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    lineProf() - retorna um array (flx) normalizado e um array x em </span>
<span class="sd">    VELOCIDADES. `lbc` deve fornecido em mesma unidade de x para converso </span>
<span class="sd">    lambda -&gt; vel. Se vetor x jah esta em vel., usar funcao linfit().</span>

<span class="sd">    x eh importante, pois y pode ser nao igualmente amostrado.</span>
<span class="sd">    x e y devem estar em ordem crescente.</span>

<span class="sd">    ssize = % do tamanho de y; numero de pontos usados nas extremidades</span>
<span class="sd">    para a media do contnuo. &#39;ssize&#39; de .5  0 (exclusive).</span>

<span class="sd">    OUTPUT: vel (array), flx (array)</span>
<span class="sd">    &#39;&#39;&#39;</span>    
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">lbc</span><span class="p">)</span> <span class="o">/</span> <span class="n">lbc</span> <span class="o">*</span> <span class="n">_phc</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">cgs</span> <span class="o">*</span> <span class="mf">1e-5</span>  <span class="c"># km/s</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.001</span> <span class="o">*</span> <span class="n">hwidth</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flxerr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">linfit</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">flx</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ssize</span><span class="o">=</span><span class="n">ssize</span><span class="p">)</span>  <span class="c"># yerr=flxerr,</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">flux</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flux</span><span class="p">,</span> <span class="n">flxerr</span> <span class="o">=</span> <span class="n">linfit</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">flx</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">flxerr</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ssize</span><span class="o">=</span><span class="n">ssize</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">flux</span><span class="p">,</span> <span class="n">flxerr</span>

</div>
<div class="viewcode-block" id="linfit"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.linfit">[docs]</a><span class="k">def</span> <span class="nf">linfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ssize</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    linfit() - retorna um array (y) normalizado, em posicoes de x</span>

<span class="sd">    x eh importante, pois y pode ser nao igualmente amostrado.</span>
<span class="sd">    x e y devem estar em ordem crescente.</span>

<span class="sd">    ssize = % do tamanho de y; numero de pontos usados nas extremidades</span>
<span class="sd">    para a media do contnuo. &#39;ssize&#39; de .5  0 (exclusive).</span>

<span class="sd">    OUTPUT: y, yerr (if given)</span>

<span class="sd">    .. code:: python</span>

<span class="sd">        #Example:</span>
<span class="sd">        import numpy as np</span>
<span class="sd">        import matplotlib.pyplot as plt</span>
<span class="sd">        import pyhdust.phc as phc</span>
<span class="sd">        import pyhdust.spectools as spt</span>

<span class="sd">        wv = np.linspace(6500, 6600, 101)</span>
<span class="sd">        flx = (np.arange(101)[::-1])/100.+1+phc.normgauss(4, x=wv, </span>
<span class="sd">        xc=6562.79)*5</span>

<span class="sd">        plt.plot(wv, flx)</span>
<span class="sd">        normflx = linfit(wv, flx)</span>
<span class="sd">        plt.plot(wv, normflx, ls=&#39;--&#39;)</span>

<span class="sd">        plt.xlabel(r&#39;$\lambda$ ($\AA$)&#39;)</span>
<span class="sd">        plt.ylabel(&#39;Flux (arb. unit)&#39;)</span>

<span class="sd">    .. image:: _static/spt_linfit.png</span>
<span class="sd">        :align: center</span>
<span class="sd">        :width: 500</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">ssize</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">ssize</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">5</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Invalid ssize value...&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ssize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ssize</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ssize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ssize</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">medx0</span><span class="p">,</span> <span class="n">medx1</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="n">ssize</span><span class="p">]),</span> <span class="n">_np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="n">ssize</span><span class="p">:])</span>
    <span class="k">if</span> <span class="n">ssize</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">:</span>
        <span class="n">medy0</span><span class="p">,</span> <span class="n">medy1</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">y</span><span class="p">[:</span><span class="n">ssize</span><span class="p">]),</span> <span class="n">_np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="n">ssize</span><span class="p">:])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">medy0</span><span class="p">,</span> <span class="n">medy1</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">y</span><span class="p">[:</span><span class="n">ssize</span><span class="p">]),</span> <span class="n">_np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="n">ssize</span><span class="p">:])</span>
    <span class="n">new_y</span> <span class="o">=</span> <span class="n">medy0</span> <span class="o">+</span> <span class="p">(</span><span class="n">medy1</span> <span class="o">-</span> <span class="n">medy0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">medx0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">medx1</span> <span class="o">-</span> <span class="n">medx0</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">new_y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">/</span> <span class="n">new_y</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="c"># </span>
    <span class="c"># a = (medy1 - medy0)/(medx1 - medx0)</span>
    <span class="c"># b = -a*medx0+medy0</span>
    <span class="c"># </span>
    <span class="c"># if ssize == 1:</span>
        <span class="c"># ssize = 2</span>
    <span class="c"># x0s = x[:ssize]</span>
    <span class="c"># y0s = y[:ssize]</span>
    <span class="c"># dif = [y0s[i]-(a*x0s[i]+b) for i in range(len(x0s))]</span>
    <span class="c"># idx = _np.argsort(_np.abs(dif))[:ssize/2]</span>
    <span class="c"># medx0 = _np.average(x0s[idx])</span>
    <span class="c"># if ssize/2 &gt; 9:</span>
        <span class="c"># medy0 = _np.median(y0s[idx])</span>
    <span class="c"># else:</span>
        <span class="c"># medy0 = _np.average(y0s[idx])   </span>
    <span class="c"># x1s = x[-ssize:]</span>
    <span class="c"># y1s = y[-ssize:]</span>
    <span class="c"># dif = [y1s[i]-(a*x1s[i]+b) for i in range(len(x1s))]</span>
    <span class="c"># idx = _np.argsort(_np.abs(dif))[:ssize/2]</span>
    <span class="c"># medx1 = _np.average(x1s[idx])</span>
    <span class="c"># if ssize/2 &gt; 9:</span>
        <span class="c"># medy1 = _np.median(y1s[idx])</span>
    <span class="c"># else:</span>
        <span class="c"># medy1 = _np.average(y1s[idx])    </span>
    <span class="c"># new_y = medy0 + (medy1 - medy0) * (x - medx0) / (medx1 - medx0)</span>
    <span class="c"># idx = _np.where(new_y != 0)</span>
    <span class="c"># y[idx] = y[idx]/new_y[idx]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">yerr</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">y</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">yerr</span> <span class="o">=</span> <span class="n">yerr</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">new_y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span>

</div>
<div class="viewcode-block" id="EWcalc"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.EWcalc">[docs]</a><span class="k">def</span> <span class="nf">EWcalc</span><span class="p">(</span><span class="n">vels</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">vw</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Supoe que o fluxo jah estah normalizado, e vetores ordenad_os.</span>

<span class="sd">    Devolve o valor EW, alem dos vetores cortados em vw.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vels</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">vw</span><span class="p">)</span>
    <span class="n">outvels</span> <span class="o">=</span> <span class="n">vels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">normflux</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">ew</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outvels</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c"># normflux = _np.ones(len(outvels))</span>
        <span class="k">return</span> <span class="n">ew</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outvels</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">dl</span> <span class="o">=</span> <span class="n">outvels</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">outvels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ew</span> <span class="o">+=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="n">normflux</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">normflux</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">dl</span>
    <span class="k">return</span> <span class="n">ew</span>

</div>
<div class="viewcode-block" id="ECcalc"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.ECcalc">[docs]</a><span class="k">def</span> <span class="nf">ECcalc</span><span class="p">(</span><span class="n">vels</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">ssize</span><span class="o">=.</span><span class="mo">05</span><span class="p">,</span> <span class="n">gaussfit</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">doublegf</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Supoe que o fluxo jah estah normalizado, e vetores ordenad_os.</span>

<span class="sd">    Calcula o topo da emissao da linha, e retorna em que velocidade ela</span>
<span class="sd">    ocorre.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vels</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vels</span><span class="p">)</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
    <span class="c"># if lncore &gt; 0:</span>
    <span class="c">#     idx = _np.where(_np.abs(vels) &lt; lncore)</span>
    <span class="c">#     vels = vels[idx]</span>
    <span class="c">#     flux = flux[idx]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">gaussfit</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span> <span class="o">==</span> <span class="n">flux</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flux</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="mf">0.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">flux</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">vels</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># check if there is a peak</span>
        <span class="n">ssize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ssize</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">vels</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ssize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ssize</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">contmax</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux</span><span class="p">[:</span><span class="n">ssize</span><span class="p">],</span> <span class="n">flux</span><span class="p">[</span><span class="o">-</span><span class="n">ssize</span><span class="p">:]))</span>
        <span class="n">fluxmax</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fluxmax</span> <span class="o">&lt;</span> <span class="mf">1.01</span> <span class="o">*</span> <span class="n">contmax</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="n">vels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c"># Define model function to be used to fit to the data above</span>
        <span class="k">def</span> <span class="nf">gauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">):</span>
            <span class="n">A</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">p</span>
            <span class="k">return</span> <span class="n">A</span> <span class="o">*</span> <span class="n">_np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c"># </span>
        <span class="n">ivc</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vels</span> <span class="o">-</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">doublegf</span><span class="p">:</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">flux</span><span class="p">[:</span><span class="n">ivc</span><span class="p">]</span> <span class="o">-</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flux</span><span class="p">[:</span><span class="n">ivc</span><span class="p">]))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">ivc</span><span class="p">:]</span> <span class="o">-</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">ivc</span><span class="p">:]))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="o">+</span> <span class="n">ivc</span>
            <span class="k">try</span><span class="p">:</span> 
                <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="n">vels</span><span class="p">[</span><span class="n">i0</span><span class="p">],</span> <span class="mf">40.</span><span class="p">]</span>
                <span class="n">coeff0</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">_curve_fit</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span> <span class="n">vels</span><span class="p">[:</span><span class="n">ivc</span><span class="p">],</span> <span class="n">flux</span><span class="p">[:</span><span class="n">ivc</span><span class="p">],</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">)</span>
                <span class="n">p1</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="n">vels</span><span class="p">[</span><span class="n">i1</span><span class="p">],</span> <span class="mf">40.</span><span class="p">]</span>
                <span class="n">coeff1</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">_curve_fit</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span> <span class="n">vels</span><span class="p">[</span><span class="n">ivc</span><span class="p">:],</span> <span class="n">flux</span><span class="p">[</span><span class="n">ivc</span><span class="p">:],</span> <span class="n">p0</span><span class="o">=</span><span class="n">p1</span><span class="p">)</span>
                <span class="n">EC</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">coeff0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">coeff1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">])</span>
                <span class="n">vel</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coeff0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coeff1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">EC</span><span class="p">,</span> <span class="n">vel</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">vels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">40.</span><span class="p">]</span>
                <span class="n">coeff0</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">_curve_fit</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span> <span class="n">vels</span><span class="p">[:</span><span class="n">ivc</span><span class="p">],</span> <span class="n">flux</span><span class="p">[:</span><span class="n">ivc</span><span class="p">],</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">)</span>
                <span class="n">EC</span> <span class="o">=</span> <span class="n">coeff0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.</span>
                <span class="k">return</span> <span class="n">EC</span><span class="p">,</span> <span class="n">coeff0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">vels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="VRcalc"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.VRcalc">[docs]</a><span class="k">def</span> <span class="nf">VRcalc</span><span class="p">(</span><span class="n">vels</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">vw</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">gaussfit</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ssize</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calcula o PICO para os dois lados (azul/vermelho) da linha, ajustando</span>
<span class="sd">    a velocidade de repouso (TBD). </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># calcula e aplica correcao de vel. repousp</span>
    <span class="n">vc</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">vels</span> <span class="o">+=</span> <span class="n">vc</span>
    <span class="c"># corta em vw, e faz o teste de tamanho</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vels</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">vw</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">vw</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vels</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">vw</span><span class="p">)</span>
        <span class="n">outvels</span> <span class="o">=</span> <span class="n">vels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">normflux</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ew0</span><span class="p">,</span> <span class="n">ew1</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">return</span> <span class="n">ew0</span><span class="p">,</span> <span class="n">ew1</span><span class="p">,</span> <span class="n">vc</span>
    <span class="c">#</span>
    <span class="n">ivc</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">outvels</span> <span class="o">-</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">gaussfit</span><span class="p">:</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">normflux</span><span class="p">[:</span><span class="n">ivc</span><span class="p">])</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">normflux</span><span class="p">[</span><span class="n">ivc</span><span class="p">:])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># check if there is a peak</span>
        <span class="n">ssize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ssize</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">vels</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ssize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ssize</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">contmax</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux</span><span class="p">[:</span><span class="n">ssize</span><span class="p">],</span> <span class="n">flux</span><span class="p">[</span><span class="o">-</span><span class="n">ssize</span><span class="p">:]))</span>
        <span class="n">fluxmax</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fluxmax</span> <span class="o">&lt;</span> <span class="mf">1.01</span> <span class="o">*</span> <span class="n">contmax</span><span class="p">:</span>
            <span class="c"># print(&#39;# Bad profile!&#39;)</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vc</span>

        <span class="c"># Define model function to be used to fit to the data above</span>
        <span class="k">def</span> <span class="nf">gauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">):</span>
            <span class="n">A</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">p</span>
            <span class="k">return</span> <span class="n">A</span> <span class="o">*</span> <span class="n">_np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="mf">1.</span>
        <span class="c"># </span>
        <span class="n">ivc</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vels</span> <span class="o">-</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="n">i0</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">flux</span><span class="p">[:</span><span class="n">ivc</span><span class="p">]</span> <span class="o">-</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flux</span><span class="p">[:</span><span class="n">ivc</span><span class="p">]))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">ivc</span><span class="p">:]</span> <span class="o">-</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">ivc</span><span class="p">:]))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="o">+</span> <span class="n">ivc</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="n">vels</span><span class="p">[</span><span class="n">i0</span><span class="p">],</span> <span class="mf">40.</span><span class="p">]</span>
            <span class="n">coeff0</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">_curve_fit</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span> <span class="n">vels</span><span class="p">[:</span><span class="n">ivc</span><span class="p">],</span> <span class="n">flux</span><span class="p">[:</span><span class="n">ivc</span><span class="p">],</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">)</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="n">vels</span><span class="p">[</span><span class="n">i1</span><span class="p">],</span> <span class="mf">40.</span><span class="p">]</span>
            <span class="n">coeff1</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">_curve_fit</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span> <span class="n">vels</span><span class="p">[</span><span class="n">ivc</span><span class="p">:],</span> <span class="n">flux</span><span class="p">[</span><span class="n">ivc</span><span class="p">:],</span> <span class="n">p0</span><span class="o">=</span><span class="n">p1</span><span class="p">)</span>
            <span class="n">V</span> <span class="o">=</span> <span class="n">coeff0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">coeff1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">vc</span>
    <span class="k">return</span> <span class="n">V</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">vc</span>

</div>
<div class="viewcode-block" id="PScalc"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.PScalc">[docs]</a><span class="k">def</span> <span class="nf">PScalc</span><span class="p">(</span><span class="n">vels</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">vc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ssize</span><span class="o">=.</span><span class="mo">05</span><span class="p">,</span> <span class="n">gaussfit</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calcula peak_separation</span>

<span class="sd">    `doublegaussfit` = True, do it before and after zero velocity. False, use</span>
<span class="sd">    maximum (default).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># check if there is a peak</span>
    <span class="n">ssize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ssize</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">vels</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ssize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ssize</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">contmax</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux</span><span class="p">[:</span><span class="n">ssize</span><span class="p">],</span> <span class="n">flux</span><span class="p">[</span><span class="o">-</span><span class="n">ssize</span><span class="p">:]))</span>
    <span class="n">fluxmax</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fluxmax</span> <span class="o">&lt;</span> <span class="mf">1.01</span> <span class="o">*</span> <span class="n">contmax</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">NaN</span>
    <span class="n">vels</span> <span class="o">+=</span> <span class="n">vc</span>
    <span class="n">ivc</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vels</span> <span class="o">-</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
    <span class="n">i0</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">flux</span><span class="p">[:</span><span class="n">ivc</span><span class="p">]</span> <span class="o">-</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flux</span><span class="p">[:</span><span class="n">ivc</span><span class="p">]))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
    <span class="n">i1</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">ivc</span><span class="p">:]</span> <span class="o">-</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">ivc</span><span class="p">:]))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="o">+</span> <span class="n">ivc</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">gaussfit</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">vels</span><span class="p">[</span><span class="n">i0</span><span class="p">],</span> <span class="n">vels</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Define model function to be used to fit to the data above</span>
        <span class="k">def</span> <span class="nf">gauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">):</span>
            <span class="n">A</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">p</span>
            <span class="k">return</span> <span class="n">A</span> <span class="o">*</span> <span class="n">_np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="mf">1.</span>
        <span class="c"># </span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="n">vels</span><span class="p">[</span><span class="n">i0</span><span class="p">],</span> <span class="mf">20.</span><span class="p">]</span>
            <span class="n">coeff0</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">_curve_fit</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span> <span class="n">vels</span><span class="p">[:</span><span class="n">ivc</span><span class="p">],</span> <span class="n">flux</span><span class="p">[:</span><span class="n">ivc</span><span class="p">],</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">)</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="n">vels</span><span class="p">[</span><span class="n">i1</span><span class="p">],</span> <span class="mf">20.</span><span class="p">]</span>
            <span class="n">coeff1</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">_curve_fit</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span> <span class="n">vels</span><span class="p">[</span><span class="n">ivc</span><span class="p">:],</span> <span class="n">flux</span><span class="p">[</span><span class="n">ivc</span><span class="p">:],</span> <span class="n">p0</span><span class="o">=</span><span class="n">p1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">coeff0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coeff1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c"># print vels[i0], flux[i0], vels[i1], flux[i1]</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

</div>
<div class="viewcode-block" id="FWHM"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.FWHM">[docs]</a><span class="k">def</span> <span class="nf">FWHM</span><span class="p">(</span><span class="n">vels</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">halfmax</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">350.</span><span class="p">,</span> <span class="n">flxincr</span><span class="o">=.</span><span class="mo">01</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calc. FWHM (Full-Width at Half Maximum) based on the value of the </span>
<span class="sd">    Half Maximum</span>

<span class="sd">    TODO: Gaussfit&quot;&quot;&quot;</span>
    <span class="n">vels</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vels</span><span class="p">)</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
    <span class="c"># remove vels bigger than maxvel</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vels</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">vmax</span><span class="p">)</span>
    <span class="n">vels</span> <span class="o">=</span> <span class="n">vels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">difflx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">flux</span> <span class="o">-</span> <span class="n">halfmax</span><span class="p">)</span>
    <span class="c"># remove diff bigger than hmf*halfmax</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">difflx</span> <span class="o">&lt;</span> <span class="n">halfmax</span> <span class="o">*</span> <span class="n">flxincr</span><span class="o">*</span><span class="n">i</span><span class="p">)</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">vels</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">difflx</span> <span class="o">&lt;</span> <span class="n">halfmax</span> <span class="o">*</span> <span class="n">flxincr</span><span class="o">*</span><span class="n">i</span><span class="p">)</span>
    <span class="n">vels</span> <span class="o">=</span> <span class="n">vels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">difflx</span> <span class="o">=</span> <span class="n">difflx</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="c">#</span>
    <span class="c"># difvels: ordered vels based on the flux difference</span>
    <span class="c"># idx = _np.argsort(difflx)</span>
    <span class="c"># difvels = vels[idx][:4]</span>
    <span class="c">#</span>
    <span class="c"># difvels: ordered vels closest to the 0 vel.</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vels</span><span class="p">))</span>
    <span class="n">difvels</span> <span class="o">=</span> <span class="n">vels</span><span class="p">[</span><span class="n">idx</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">_np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">difvels</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="DCcalc"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.DCcalc">[docs]</a><span class="k">def</span> <span class="nf">DCcalc</span><span class="p">(</span><span class="n">vels</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">vc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ssize</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculo, na presenca de emissao, da profundidade do reverso central.</span>

<span class="sd">    TODO: gauss fit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vels</span> <span class="o">+=</span> <span class="n">vc</span>
    <span class="n">ivc</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vels</span> <span class="o">-</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
    <span class="c"># check if there is a peak</span>
    <span class="n">ssize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ssize</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">vels</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ssize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ssize</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">contmax</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux</span><span class="p">[:</span><span class="n">ssize</span><span class="p">],</span> <span class="n">flux</span><span class="p">[</span><span class="o">-</span><span class="n">ssize</span><span class="p">:]))</span>
    <span class="n">fluxmax</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fluxmax</span> <span class="o">&lt;</span> <span class="mf">1.01</span> <span class="o">*</span> <span class="n">contmax</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">flux</span><span class="p">[</span><span class="n">ivc</span><span class="p">],</span> <span class="n">flux</span><span class="p">[</span><span class="n">ivc</span><span class="p">]</span>
    <span class="c"># if a vmax is not given...</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vmax</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">flux</span> <span class="o">-</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flux</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">vels</span><span class="p">[</span><span class="n">vmax</span><span class="p">]</span>
    <span class="n">ivmax</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vels</span> <span class="o">-</span> <span class="n">vmax</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">flux</span><span class="p">[</span><span class="n">ivmax</span><span class="p">],</span> <span class="n">flux</span><span class="p">[</span><span class="n">ivc</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="analline"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.analline">[docs]</a><span class="k">def</span> <span class="nf">analline</span><span class="p">(</span><span class="n">lbd</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">lbdc</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">gaussfit</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">doublegf</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the analysis of a line.</span>

<span class="sd">    Both lbd and flux need to be ordered (a normalization IS FORCED).</span>
<span class="sd">    lbd,lbdc must have the same unit, and width in km/s is required.</span>
<span class="sd">    The line will be cutted so that the total DeltaLambda will be 2*width</span>

<span class="sd">    if `lbdc` &lt;= 0, lbd array is assumed to be a velocity array (in km/s)!</span>

<span class="sd">    | EXAMPLE: Using sed2data. lbc = 0.6565 (halpha), obs = 1 (width==1000)</span>
<span class="sd">    |     analline(lbd=sed2data[obs,:,2], flux=sed2data[obs,:,3], lbc=lbc)</span>

<span class="sd">    The EW is the equivalent width in km/s, </span>
<span class="sd">    EC is the Emission over Continuum ratio, </span>
<span class="sd">    VR ratio, </span>
<span class="sd">    peaksep in km/s, </span>
<span class="sd">    FWHM is the Full-Width at Half Maximum (emission as maximum)</span>
<span class="sd">    F0 is the depth of rest wavelength normalized to the continuum </span>

<span class="sd">    OUTPUT: EW, EC, VR, peaksep, FWHM, F0 </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lbdc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">vels</span> <span class="o">=</span> <span class="p">(</span><span class="n">lbd</span> <span class="o">-</span> <span class="n">lbdc</span><span class="p">)</span> <span class="o">/</span> <span class="n">lbdc</span> <span class="o">*</span> <span class="n">_phc</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">cgs</span> <span class="o">*</span> <span class="mf">1e-5</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vels</span> <span class="o">=</span> <span class="n">lbd</span>
    <span class="c"># check if the file have the desired info.</span>
    <span class="k">if</span> <span class="n">vels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">hwidth</span> <span class="o">*</span> <span class="o">.</span><span class="mi">95</span> <span class="ow">or</span> <span class="n">vels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">hwidth</span> <span class="o">*</span> <span class="o">.</span><span class="mi">95</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verb</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: spec out of range (wavelength)! Check hwidth!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">NaN</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vels</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">hwidth</span><span class="p">)</span>
    <span class="n">vels</span> <span class="o">=</span> <span class="n">vels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="c"># Normalization:</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">linfit</span><span class="p">(</span><span class="n">vels</span><span class="p">,</span> <span class="n">flux</span><span class="p">)</span>
    <span class="c"># Output:</span>
    <span class="n">EW</span> <span class="o">=</span> <span class="n">EWcalc</span><span class="p">(</span><span class="n">vels</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">vw</span><span class="o">=</span><span class="n">hwidth</span><span class="p">)</span>
    <span class="n">EC</span><span class="p">,</span> <span class="n">velEC</span> <span class="o">=</span> <span class="n">ECcalc</span><span class="p">(</span><span class="n">vels</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">gaussfit</span><span class="o">=</span><span class="n">gaussfit</span><span class="p">,</span> <span class="n">doublegf</span><span class="o">=</span><span class="n">doublegf</span><span class="p">)</span>
    <span class="n">ew0</span><span class="p">,</span> <span class="n">ew1</span><span class="p">,</span> <span class="n">vc</span> <span class="o">=</span> <span class="n">VRcalc</span><span class="p">(</span><span class="n">vels</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">vw</span><span class="o">=</span><span class="n">hwidth</span><span class="p">,</span> <span class="n">gaussfit</span><span class="o">=</span><span class="n">gaussfit</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ew1</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">EC</span> <span class="ow">is</span> <span class="n">_np</span><span class="o">.</span><span class="n">NaN</span><span class="p">:</span>
        <span class="n">VR</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">VR</span> <span class="o">=</span> <span class="n">ew0</span> <span class="o">/</span> <span class="n">ew1</span>
    <span class="k">if</span> <span class="n">EC</span> <span class="ow">is</span> <span class="n">_np</span><span class="o">.</span><span class="n">NaN</span><span class="p">:</span>
        <span class="n">peaksep</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">NaN</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vel0</span><span class="p">,</span> <span class="n">vel1</span> <span class="o">=</span> <span class="n">PScalc</span><span class="p">(</span><span class="n">vels</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">gaussfit</span><span class="o">=</span><span class="n">gaussfit</span><span class="p">)</span>
        <span class="n">peaksep</span> <span class="o">=</span> <span class="n">vel1</span> <span class="o">-</span> <span class="n">vel0</span>
    <span class="n">EC2</span><span class="p">,</span> <span class="n">F0</span> <span class="o">=</span> <span class="n">DCcalc</span><span class="p">(</span><span class="n">vels</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">velEC</span><span class="p">)</span>
    <span class="n">depthcent</span> <span class="o">=</span> <span class="n">EC2</span> <span class="o">-</span> <span class="n">F0</span>
    <span class="k">if</span> <span class="n">EC2</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">EC2</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">fwhm</span> <span class="o">=</span> <span class="n">FWHM</span><span class="p">(</span><span class="n">vels</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="p">(</span><span class="n">EC2</span> <span class="o">+</span> <span class="n">F0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">velEC</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">EW</span><span class="p">,</span> <span class="n">EC</span><span class="p">,</span> <span class="n">VR</span><span class="p">,</span> <span class="n">peaksep</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">F0</span>

</div>
<div class="viewcode-block" id="kurlog"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.kurlog">[docs]</a><span class="k">def</span> <span class="nf">kurlog</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Generate a list of teff and logg present in a Kurucz file.</span>

<span class="sd">    If output is not specified, it is saved as `file`+.log &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_hdt</span><span class="o">.</span><span class="n">hdtpath</span><span class="p">(),</span> <span class="s">&#39;refs&#39;</span><span class="p">,</span> <span class="s">&#39;fp00k0.pck&#39;</span><span class="p">)</span>
    <span class="n">teffs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">loggs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;TEFF&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">teffs</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">loggs</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">])]</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">teffs</span><span class="p">,</span> <span class="n">loggs</span>

</div>
<div class="viewcode-block" id="kuruczflux"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.kuruczflux">[docs]</a><span class="k">def</span> <span class="nf">kuruczflux</span><span class="p">(</span><span class="n">teff</span><span class="p">,</span> <span class="n">logg</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return fluxes from a Kurucz model.</span>

<span class="sd">    Fluxes are in ergs/cm**2/s/hz/ster and wavelength in nm (range must be in</span>
<span class="sd">    nm).</span>

<span class="sd">    OUTPUT: wv, flux, info&quot;&quot;&quot;</span>
    <span class="n">kurfile</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_hdt</span><span class="o">.</span><span class="n">hdtpath</span><span class="p">(),</span> <span class="s">&#39;refs&#39;</span><span class="p">,</span> <span class="s">&#39;fp00k0.pck&#39;</span><span class="p">)</span>
    <span class="n">kurwvlines</span> <span class="o">=</span> <span class="p">(</span><span class="mi">174</span> <span class="o">-</span> <span class="mi">22</span><span class="p">)</span>
    <span class="n">kurflxcol</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="c"># wave</span>
    <span class="n">read</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">readrange</span><span class="p">(</span><span class="n">kurfile</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">22</span> <span class="o">+</span> <span class="n">kurwvlines</span><span class="p">)</span>
    <span class="n">wave</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">val</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">read</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()],</span> 
        <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="c"># choose best</span>
    <span class="n">bestT</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">bestg</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">kurfile</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;TEFF&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">readT</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">readT</span> <span class="o">-</span> <span class="n">teff</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bestT</span> <span class="o">-</span> <span class="n">teff</span><span class="p">):</span>
                <span class="n">bestT</span> <span class="o">=</span> <span class="n">readT</span>
                <span class="n">readg</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">readg</span> <span class="o">-</span> <span class="n">logg</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bestg</span> <span class="o">-</span> <span class="n">logg</span><span class="p">):</span>
                    <span class="n">bestg</span> <span class="o">=</span> <span class="n">readg</span>
                    <span class="n">i0</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">best</span> <span class="o">=</span> <span class="p">[</span><span class="n">bestT</span><span class="p">,</span> <span class="n">bestg</span><span class="p">]</span>
    <span class="c"># read best flux</span>
    <span class="n">read</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">readrange</span><span class="p">(</span><span class="n">kurfile</span><span class="p">,</span> <span class="n">i0</span><span class="p">,</span> <span class="n">i0</span> <span class="o">+</span> <span class="n">kurwvlines</span><span class="p">)</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">val</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">read</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> 
        <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">kurflxcol</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kurflxcol</span><span class="p">))],</span> 
        <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="c"># cut range</span>
    <span class="k">if</span> <span class="nb">range</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">wave</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">best</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">wave</span> <span class="o">&gt;</span> <span class="nb">range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wave</span> <span class="o">&lt;</span> <span class="nb">range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">wave</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">flux</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">best</span>    

</div>
<div class="viewcode-block" id="plotAll"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.plotAll">[docs]</a><span class="k">def</span> <span class="nf">plotAll</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">boxes</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;s&#39;</span><span class="p">],</span> <span class="nb">range</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">ncol</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
    <span class="n">fmt</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;png&#39;</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; PlotAll routine for fullsed files.</span>

<span class="sd">    | `files` and `obs` are lists that define files and observers. </span>
<span class="sd">    |</span>
<span class="sd">    | The number of boxes is defined by the `boxes` list.</span>
<span class="sd">    | Valid boxes are: &#39;s&#39; for SED, &#39;p&#39; for polarimetry, &#39;l&#39; for line.</span>
<span class="sd">    | </span>
<span class="sd">    | `Range` is a list of lists and defines the interval for &#39;s&#39; and &#39;p&#39;</span>
<span class="sd">    | (in microns). For automatic selection, leave [0,-1] for the respective </span>
<span class="sd">    | box. &#39;l&#39; option must be [hwidht, lbd0] (mandatory).</span>
<span class="sd">    |</span>
<span class="sd">    | `ncol` fix the number of columns of the output file.</span>

<span class="sd">    The standard output name will be `date_time.png`, but it can be change</span>
<span class="sd">    with the variables `out` and `fmt`.</span>

<span class="sd">    TDB: normalize line, yrange and (x,y) log_scale !</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">interv</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">interv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR! Check range variable configuration!!!&#39;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">range</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR! Check input configuration!!!&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="c">#</span>
    <span class="n">nbox</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ncol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">nlin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nbox</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">nlin</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">nbox</span><span class="p">:</span>
            <span class="n">ncol</span> <span class="o">=</span> <span class="n">nlin</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ncol</span> <span class="o">=</span> <span class="n">nlin</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nlin</span> <span class="o">=</span> <span class="n">nbox</span> <span class="o">/</span> <span class="n">ncol</span>
        <span class="k">if</span> <span class="n">nlin</span> <span class="o">*</span> <span class="n">ncol</span> <span class="o">&lt;</span> <span class="n">nbox</span><span class="p">:</span>
            <span class="n">ncol</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c">#</span>
    <span class="n">boxn</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;s&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&#39;p&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s">&#39;l&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nlin</span><span class="p">,</span> <span class="n">ncol</span><span class="p">)</span>  <span class="c"># , sharex=True, sharey=True)</span>
    <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">sed2data</span> <span class="o">=</span> <span class="n">_hdt</span><span class="o">.</span><span class="n">readfullsed2</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ob</span> <span class="ow">in</span> <span class="n">obs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">I</span> <span class="ow">in</span> <span class="n">_iproduct</span><span class="p">(</span><span class="n">nlin</span><span class="p">,</span> <span class="n">ncol</span><span class="p">):</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">I</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="n">boxn</span><span class="p">[</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]]</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">_hdt</span><span class="o">.</span><span class="n">sed2data</span><span class="p">[</span><span class="n">ob</span><span class="p">,</span> <span class="p">:,</span> <span class="nb">type</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">boxes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;l&#39;</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;linha&#39;</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sed2data</span><span class="p">[</span><span class="n">ob</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">I</span> <span class="ow">in</span> <span class="n">_iproduct</span><span class="p">(</span><span class="n">nlin</span><span class="p">,</span> <span class="n">ncol</span><span class="p">):</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">I</span>
        <span class="k">if</span> <span class="n">boxes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;l&#39;</span><span class="p">:</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Norm. flux&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">boxes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;p&#39;</span><span class="p">:</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Q (%)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">boxes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;s&#39;</span><span class="p">:</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Flux (arb. unit)&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;$\lambda$ ($\mu$m)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">))</span> <span class="o">!=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">boxes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;l&#39;</span><span class="p">:</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">))</span>
    <span class="c">#</span>
    <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s">&#39;plotall_{0}{1}{2}_{3}{4}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">_time</span><span class="o">.</span><span class="n">localtime</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">format</span> <span class="ow">in</span> <span class="n">fmt</span><span class="p">:</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}.{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">format</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# File {0}.{1} saved!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">format</span><span class="p">))</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span>

</div>
<div class="viewcode-block" id="splitKurucz"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.splitKurucz">[docs]</a><span class="k">def</span> <span class="nf">splitKurucz</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split atmospheric Kurucz file (e.g., &#39;ap00k0.dat&#39;) into individual models.</span>

<span class="sd">    INPUT: file, path (strings)</span>

<span class="sd">    OUTPUT: *files written</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">allk</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">allk</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;EFF&#39;</span> <span class="ow">in</span> <span class="n">allk</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">iref</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">teff</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">allk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">logg</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">allk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">][:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s">&#39;DECK6 72&#39;</span> <span class="ow">in</span> <span class="n">allk</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">allk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">allk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;DECK6 72&#39;</span><span class="p">,</span> <span class="s">&#39;DECK6 71&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s">&#39;EFF&#39;</span> <span class="ow">in</span> <span class="n">allk</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="n">_np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s">&#39;ap00k0tef</span><span class="si">%05d</span><span class="s">g</span><span class="si">%.1f</span><span class="s">.dat&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">teff</span><span class="p">,</span> <span class="n">logg</span><span class="p">),</span> 
                <span class="n">allk</span><span class="p">[</span><span class="n">iref</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="n">_np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s">&#39;ap00k0tef</span><span class="si">%05d</span><span class="s">g</span><span class="si">%.1f</span><span class="s">.dat&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">teff</span><span class="p">,</span> <span class="n">logg</span><span class="p">),</span> <span class="n">allk</span><span class="p">[</span><span class="n">iref</span><span class="p">:],</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">return</span>

</div>
<div class="viewcode-block" id="writeFits"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.writeFits">[docs]</a><span class="k">def</span> <span class="nf">writeFits</span><span class="p">(</span><span class="n">flx</span><span class="p">,</span> <span class="n">lbd</span><span class="p">,</span> <span class="n">extrahead</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">savename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">lbdc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">externhd</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Write a 1D spectra FITS.</span>

<span class="sd">    | INPUT: flux array, lbd array, extrahead flag+info, save name.</span>
<span class="sd">    | - lbd array: if len(lbd)==2: lbd = [CRVAL1, CDELT1]</span>
<span class="sd">    |              else: CDELT1 = (lbd[-1]-lbd[0])/(len(lbd)-1)</span>
<span class="sd">    |                    CRVAL1 = lbd[0]</span>
<span class="sd">    |   WARNING: lbd must be in ANGSTROMS (FITS default). It can also be </span>
<span class="sd">    |   velocities. In this case, it must be in km/s and lbdc is given in </span>
<span class="sd">    | ANGSTROM.</span>
<span class="sd">    | - extrahead: matrix (n,2). Example: [[&#39;OBJECT&#39;,&#39;Achernar&#39;], [&#39;COMMENT&#39;,</span>
<span class="sd">    | &#39;value&#39;]]</span>

<span class="sd">    `externhd` = copy the header from an external file.</span>

<span class="sd">    OUTPUT: write FITS file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">path</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[</span><span class="s">&#39;/&#39;</span><span class="p">]:</span>
        <span class="n">path</span> <span class="o">+=</span> <span class="s">&#39;/&#39;</span>
    <span class="k">if</span> <span class="n">lbdc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">lbd</span> <span class="o">=</span> <span class="p">(</span><span class="n">lbd</span> <span class="o">/</span> <span class="n">_phc</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">cgs</span> <span class="o">*</span> <span class="mf">1e5</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">lbdc</span>
    <span class="n">hdu</span> <span class="o">=</span> <span class="n">_pyfits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">flx</span><span class="p">)</span>
    <span class="n">hdulist</span> <span class="o">=</span> <span class="n">_pyfits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">hdu</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">externhd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">extf</span> <span class="o">=</span> <span class="n">_pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">externhd</span><span class="p">)</span>
        <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">extf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;BZERO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lbd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lbd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lbd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lbd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lbd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lbd</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">extrahead</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">extrahead</span><span class="p">:</span>
            <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">savename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">savename</span> <span class="o">=</span> <span class="s">&#39;spec_{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">dtflag</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">savename</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;.fit&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">savename</span> <span class="o">+=</span> <span class="s">&#39;.fits&#39;</span>
    <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">savename</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# FITS file {0}{1} saved!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">savename</span><span class="p">))</span>
    <span class="k">return</span>

</div>
<div class="viewcode-block" id="averagespecs"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.averagespecs">[docs]</a><span class="k">def</span> <span class="nf">averagespecs</span><span class="p">(</span><span class="n">speclist</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">999</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">objname</span><span class="o">=</span><span class="s">&#39;OBJECT&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Average specs taken in the same MJD, in groups of approx. `n` </span>
<span class="sd">    elements.</span>

<span class="sd">    OUTPUT: Files written. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">+=</span> <span class="s">&#39;/&#39;</span>
    <span class="n">speclist</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">speclist</span><span class="p">)</span>
    <span class="n">obsdates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">speclist</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">loadfits</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
        <span class="n">obsdates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">obsdates</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obsdates</span><span class="p">)</span>
    <span class="c"># Sorting things</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">obsdates</span><span class="p">)</span>
    <span class="n">speclist</span> <span class="o">=</span> <span class="n">speclist</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">obsdates</span> <span class="o">=</span> <span class="n">obsdates</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="c"># Same day</span>
    <span class="n">iMJD</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">obsdates</span><span class="p">:</span>
        <span class="n">iMJD</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">divmod</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">idxMJD</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">iMJD</span><span class="p">)</span>
    <span class="c"># Do the avgs based on the MJD</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxMJD</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">iMJD</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">speclist</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">_phc</span><span class="o">.</span><span class="n">splitequal</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="n">n</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
            <span class="n">fidx</span> <span class="o">=</span> <span class="n">speclist</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">loadfits</span><span class="p">(</span><span class="n">fidx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">wl</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">newdate</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span> <span class="n">obsdates</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">)</span>
            <span class="n">MJD</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">divmod</span><span class="p">(</span><span class="n">newdate</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">MJDfrac</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">newdate</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">10000</span> <span class="p">))</span>
            <span class="n">fluxes</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wl</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fidx</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">loadfits</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">fluxes</span> <span class="o">+=</span> <span class="n">_np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">flx</span> <span class="o">=</span> <span class="n">fluxes</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">fidx</span><span class="p">)</span>
            <span class="n">outname</span> <span class="o">=</span> <span class="s">&#39;alpEri_PUCHEROS_VIS_{0}_{1:04d}_avg.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">MJD</span><span class="p">,</span> 
                <span class="n">MJDfrac</span><span class="p">)</span>
            <span class="n">writeFits</span><span class="p">(</span> <span class="n">flx</span><span class="p">,</span> <span class="n">wl</span><span class="p">,</span> <span class="n">savename</span><span class="o">=</span><span class="n">outname</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">extrahead</span><span class="o">=</span><span class="p">[</span> 
                <span class="p">[</span><span class="s">&#39;OBJECT&#39;</span><span class="p">,</span> <span class="n">objname</span><span class="p">],</span> <span class="p">[</span><span class="s">&#39;Comment&#39;</span><span class="p">,</span> <span class="s">&#39;Averaged from {0} spectra&#39;</span><span class="o">.</span>
                <span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fidx</span><span class="p">))],</span> <span class="p">[</span><span class="s">&#39;MJD-OBS&#39;</span><span class="p">,</span> <span class="n">newdate</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
    <span class="k">return</span>

</div>
<div class="viewcode-block" id="cardelli"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.cardelli">[docs]</a><span class="k">def</span> <span class="nf">cardelli</span><span class="p">(</span><span class="n">lbd</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">ebv</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">Rv</span><span class="o">=</span><span class="mf">3.1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Milky Way Extinction law from Cardelli et al. 1989</span>

<span class="sd">    `lbd` must be in microns.</span>

<span class="sd">    OUTPUT: Corrected flux.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lbd</span><span class="p">)</span>  <span class="c"># CCM x is 1/microns</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">10</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Some wavelengths outside CCM 89 extinction curve &#39;</span> <span class="o">+</span> 
            <span class="s">&#39;range&#39;</span><span class="p">)</span>

    <span class="n">irs</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.3</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="mf">1.1</span><span class="p">)</span>
    <span class="n">opts</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.1</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="mf">3.3</span><span class="p">)</span>
    <span class="n">nuv1s</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.3</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="mf">5.9</span><span class="p">)</span>
    <span class="n">nuv2s</span> <span class="o">=</span> <span class="p">(</span><span class="mf">5.9</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">fuvs</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span>

    <span class="c"># CCM Infrared</span>
    <span class="n">a</span><span class="p">[</span><span class="n">irs</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="mi">574</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">irs</span><span class="p">]</span><span class="o">**</span><span class="mf">1.61</span>
    <span class="n">b</span><span class="p">[</span><span class="n">irs</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.527</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">irs</span><span class="p">]</span><span class="o">**</span><span class="mf">1.61</span>

    <span class="c"># CCM NIR/optical</span>
    <span class="n">a</span><span class="p">[</span><span class="n">opts</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">polyval</span><span class="p">((</span><span class="o">.</span><span class="mi">32999</span><span class="p">,</span> <span class="o">-.</span><span class="mi">7753</span><span class="p">,</span> <span class="o">.</span><span class="mo">01</span><span class="mi">979</span><span class="p">,</span> <span class="o">.</span><span class="mi">72085</span><span class="p">,</span> <span class="o">-.</span><span class="mo">02427</span><span class="p">,</span> <span class="o">-.</span><span class="mi">50447</span><span class="p">,</span> 
        <span class="o">.</span><span class="mi">17699</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="p">[</span><span class="n">opts</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.82</span><span class="p">)</span>
    <span class="n">b</span><span class="p">[</span><span class="n">opts</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">polyval</span><span class="p">((</span><span class="o">-</span><span class="mf">2.09002</span><span class="p">,</span> <span class="mf">5.3026</span><span class="p">,</span> <span class="o">-.</span><span class="mi">62251</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.38434</span><span class="p">,</span> <span class="mf">1.07233</span><span class="p">,</span> 
        <span class="mf">2.28305</span><span class="p">,</span> <span class="mf">1.41338</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">x</span><span class="p">[</span><span class="n">opts</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.82</span><span class="p">)</span>

    <span class="c"># CCM NUV</span>
    <span class="n">a</span><span class="p">[</span><span class="n">nuv1s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.752</span> <span class="o">-</span> <span class="o">.</span><span class="mi">316</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">nuv1s</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.104</span> <span class="o">/</span> <span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="n">nuv1s</span><span class="p">]</span> <span class="o">-</span> <span class="mf">4.67</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">.</span><span class="mi">341</span><span class="p">)</span>
    <span class="n">b</span><span class="p">[</span><span class="n">nuv1s</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.09</span> <span class="o">+</span> <span class="mf">1.825</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">nuv1s</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.206</span> <span class="o">/</span> <span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="n">nuv1s</span><span class="p">]</span> <span class="o">-</span> <span class="mf">4.62</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">.</span><span class="mi">263</span><span class="p">)</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">nuv2s</span><span class="p">]</span> <span class="o">-</span> <span class="mf">5.9</span>
    <span class="n">Fa</span> <span class="o">=</span> <span class="o">-.</span><span class="mo">04473</span> <span class="o">*</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="o">.</span><span class="mo">00</span><span class="mi">9779</span> <span class="o">*</span> <span class="n">y</span><span class="o">**</span><span class="mi">3</span>
    <span class="n">Fb</span> <span class="o">=</span> <span class="o">-.</span><span class="mi">2130</span> <span class="o">*</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="o">.</span><span class="mi">1207</span> <span class="o">*</span> <span class="n">y</span><span class="o">**</span><span class="mi">3</span>
    <span class="n">a</span><span class="p">[</span><span class="n">nuv2s</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.752</span> <span class="o">-</span> <span class="o">.</span><span class="mi">316</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">nuv2s</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.104</span> <span class="o">/</span> \
        <span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="n">nuv2s</span><span class="p">]</span> <span class="o">-</span> <span class="mf">4.67</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">.</span><span class="mi">341</span><span class="p">)</span> <span class="o">+</span> <span class="n">Fa</span>
    <span class="n">b</span><span class="p">[</span><span class="n">nuv2s</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.09</span> <span class="o">+</span> <span class="mf">1.825</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">nuv2s</span><span class="p">]</span> <span class="o">+</span> \
        <span class="mf">1.206</span> <span class="o">/</span> <span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="n">nuv2s</span><span class="p">]</span> <span class="o">-</span> <span class="mf">4.62</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">.</span><span class="mi">263</span><span class="p">)</span> <span class="o">+</span> <span class="n">Fb</span>

    <span class="c"># CCM FUV</span>
    <span class="n">a</span><span class="p">[</span><span class="n">fuvs</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">polyval</span><span class="p">((</span><span class="o">-.</span><span class="mo">070</span><span class="p">,</span> <span class="o">.</span><span class="mi">137</span><span class="p">,</span> <span class="o">-.</span><span class="mi">628</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.073</span><span class="p">),</span> <span class="n">x</span><span class="p">[</span><span class="n">fuvs</span><span class="p">]</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">b</span><span class="p">[</span><span class="n">fuvs</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">polyval</span><span class="p">((</span><span class="o">.</span><span class="mi">374</span><span class="p">,</span> <span class="o">-.</span><span class="mi">42</span><span class="p">,</span> <span class="mf">4.257</span><span class="p">,</span> <span class="mf">13.67</span><span class="p">),</span> <span class="n">x</span><span class="p">[</span><span class="n">fuvs</span><span class="p">]</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span>

    <span class="n">AlbAv</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">/</span> <span class="n">Rv</span>
    <span class="k">return</span> <span class="n">flux</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">AlbAv</span> <span class="o">*</span> <span class="n">Rv</span> <span class="o">*</span> <span class="n">ebv</span> <span class="o">/</span> <span class="mf">2.5</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="fitzpatrick"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.fitzpatrick">[docs]</a><span class="k">def</span> <span class="nf">fitzpatrick</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">ebv</span><span class="p">,</span> <span class="n">Rv</span><span class="o">=</span><span class="mf">3.1</span><span class="p">,</span> <span class="n">LMC2</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">AVGLMC</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deredden a flux vector using the Fitzpatrick (1999) parameterization</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wave :   array</span>
<span class="sd">             Wavelength in Angstrom</span>
<span class="sd">    flux :   array</span>
<span class="sd">             Calibrated flux vector, same number of elements as wave.</span>
<span class="sd">    ebv  :   float, optional</span>
<span class="sd">             Color excess E(B-V). If a positive ebv is supplied,</span>
<span class="sd">             then fluxes will be dereddened rather than reddened.</span>
<span class="sd">             The default is 3.1.</span>
<span class="sd">    AVGLMC : boolean</span>
<span class="sd">             If True, then the default fit parameters c1,c2,c3,c4,gamma,x0 </span>
<span class="sd">             are set to the average values determined for reddening in the </span>
<span class="sd">             general Large Magellanic Cloud (LMC) field by</span>
<span class="sd">             Misselt et al. (1999, ApJ, 515, 128). The default is</span>
<span class="sd">             False.</span>
<span class="sd">    LMC2 :   boolean</span>
<span class="sd">             If True, the fit parameters are set to the values determined</span>
<span class="sd">             for the LMC2 field (including 30 Dor) by Misselt et al.</span>
<span class="sd">             Note that neither `AVGLMC` nor `LMC2` will alter the default value </span>
<span class="sd">             of Rv, which is poorly known for the LMC.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------             </span>
<span class="sd">    new_flux : array </span>
<span class="sd">               Dereddened flux vector, same units and number of elements</span>
<span class="sd">               as input flux.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    .. note::</span>

<span class="sd">        This function was ported from the IDL Astronomy User&#39;s Library.</span>

<span class="sd">        The following five parameters allow the user to customize</span>
<span class="sd">        the adopted extinction curve.    For example, see Clayton et al. (2003,</span>
<span class="sd">        ApJ, 588, 871) for examples of these parameters in different </span>
<span class="sd">        interstellar environments.</span>

<span class="sd">        x0 - Centroid of 2200 A bump in microns (default = 4.596)</span>
<span class="sd">        gamma - Width of 2200 A bump in microns (default  =0.99)</span>
<span class="sd">        c3 - Strength of the 2200 A bump (default = 3.23)</span>
<span class="sd">        c4 - FUV curvature (default = 0.41)</span>
<span class="sd">        c2 - Slope of the linear UV extinction component </span>
<span class="sd">            (default = -0.824 + 4.717/R)</span>
<span class="sd">        c1 - Intercept of the linear UV extinction component </span>
<span class="sd">            (default = 2.030 - 3.007*c2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># x = 10000./ wave # Convert to inverse microns</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">wave</span>  <span class="c"># microns</span>
    <span class="n">curve</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="mf">0.</span>

    <span class="c"># Set some standard values:</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="mf">4.596</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.99</span>
    <span class="n">c3</span> <span class="o">=</span> <span class="mf">3.23</span>      
    <span class="n">c4</span> <span class="o">=</span> <span class="mf">0.41</span>    
    <span class="n">c2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.824</span> <span class="o">+</span> <span class="mf">4.717</span> <span class="o">/</span> <span class="n">Rv</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="mf">2.030</span> <span class="o">-</span> <span class="mf">3.007</span> <span class="o">*</span> <span class="n">c2</span>

    <span class="k">if</span> <span class="n">LMC2</span><span class="p">:</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="mf">4.626</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.05</span>   
        <span class="n">c4</span> <span class="o">=</span> <span class="mf">0.42</span>   
        <span class="n">c3</span> <span class="o">=</span> <span class="mf">1.92</span>      
        <span class="n">c2</span> <span class="o">=</span> <span class="mf">1.31</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.16</span>
    <span class="k">elif</span> <span class="n">AVGLMC</span><span class="p">:</span>   
        <span class="n">x0</span> <span class="o">=</span> <span class="mf">4.596</span>  
        <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.91</span>
        <span class="n">c4</span> <span class="o">=</span> <span class="mf">0.64</span>  
        <span class="n">c3</span> <span class="o">=</span> <span class="mf">2.73</span>      
        <span class="n">c2</span> <span class="o">=</span> <span class="mf">1.11</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.28</span>

    <span class="c"># Compute UV portion of A(lambda)/E(B-V) curve using FM fitting function  </span>
    <span class="c"># and R-dependent coefficients</span>
    <span class="n">xcutuv</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">10000.0</span> <span class="o">/</span> <span class="mf">2700.0</span><span class="p">])</span>
    <span class="n">xspluv</span> <span class="o">=</span> <span class="mf">10000.0</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2700.0</span><span class="p">,</span> <span class="mf">2600.0</span><span class="p">])</span>

    <span class="n">iuv</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">xcutuv</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">N_UV</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">iuv</span><span class="p">)</span>
    <span class="n">iopir</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">xcutuv</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Nopir</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">iopir</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">N_UV</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span> 
        <span class="n">xuv</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">xspluv</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">iuv</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">xuv</span> <span class="o">=</span> <span class="n">xspluv</span>

    <span class="n">yuv</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">+</span> <span class="n">c2</span> <span class="o">*</span> <span class="n">xuv</span>
    <span class="n">yuv</span> <span class="o">=</span> <span class="n">yuv</span> <span class="o">+</span> <span class="n">c3</span> <span class="o">*</span> <span class="n">xuv</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">((</span><span class="n">xuv</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">x0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">xuv</span> <span class="o">*</span> <span class="n">gamma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">yuv</span> <span class="o">=</span> <span class="n">yuv</span> <span class="o">+</span> <span class="n">c4</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5392</span> <span class="o">*</span> <span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">xuv</span><span class="p">,</span> <span class="mf">5.9</span><span class="p">)</span> <span class="o">-</span> <span class="mf">5.9</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.05644</span> <span class="o">*</span> <span class="p">(</span>
        <span class="n">_np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">xuv</span><span class="p">,</span> <span class="mf">5.9</span><span class="p">)</span> <span class="o">-</span> <span class="mf">5.9</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">yuv</span> <span class="o">=</span> <span class="n">yuv</span> <span class="o">+</span> <span class="n">Rv</span>
    <span class="n">yspluv</span> <span class="o">=</span> <span class="n">yuv</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>  <span class="c"># save spline points</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">N_UV</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span> 
        <span class="n">curve</span><span class="p">[</span><span class="n">iuv</span><span class="p">]</span> <span class="o">=</span> <span class="n">yuv</span><span class="p">[</span><span class="mi">2</span><span class="p">::]</span>  <span class="c"># remove spline points</span>

    <span class="c"># Compute optical portion of A(lambda)/E(B-V) curve</span>
    <span class="c"># using cubic spline anchored in UV, optical, and IR</span>
    <span class="n">xsplopir</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">0</span><span class="p">],</span> <span class="mf">10000.0</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">26500.0</span><span class="p">,</span> <span class="mf">12200.0</span><span class="p">,</span>
        <span class="mf">6000.0</span><span class="p">,</span> <span class="mf">5470.0</span><span class="p">,</span> <span class="mf">4670.0</span><span class="p">,</span> <span class="mf">4110.0</span><span class="p">])))</span>
    <span class="n">ysplir</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.26469</span><span class="p">,</span> <span class="mf">0.82925</span><span class="p">])</span> <span class="o">*</span> <span class="n">Rv</span> <span class="o">/</span> <span class="mf">3.1</span> 
    <span class="n">ysplop</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">_np</span><span class="o">.</span><span class="n">polyval</span><span class="p">([</span><span class="o">-</span><span class="mf">4.22809e-01</span><span class="p">,</span> <span class="mf">1.00270</span><span class="p">,</span> <span class="mf">2.13572e-04</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">Rv</span> <span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">polyval</span><span class="p">([</span><span class="o">-</span><span class="mf">5.13540e-02</span><span class="p">,</span> <span class="mf">1.00216</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.35778e-05</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">Rv</span> <span class="p">),</span> 
        <span class="n">_np</span><span class="o">.</span><span class="n">polyval</span><span class="p">([</span> <span class="mf">7.00127e-01</span><span class="p">,</span> <span class="mf">1.00184</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.32598e-05</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">Rv</span> <span class="p">),</span> 
        <span class="n">_np</span><span class="o">.</span><span class="n">polyval</span><span class="p">([</span> <span class="mf">1.19456</span><span class="p">,</span> <span class="mf">1.01707</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.46959e-03</span><span class="p">,</span> <span class="mf">7.97809e-04</span><span class="p">,</span> 
            <span class="o">-</span><span class="mf">4.45636e-05</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">Rv</span> <span class="p">)</span> <span class="p">))</span>
    <span class="n">ysplopir</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ysplir</span><span class="p">,</span> <span class="n">ysplop</span><span class="p">))</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">Nopir</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span> 
        <span class="n">tck</span> <span class="o">=</span> <span class="n">_interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">xsplopir</span><span class="p">,</span> <span class="n">xspluv</span><span class="p">)),</span>
            <span class="n">_np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ysplopir</span><span class="p">,</span> <span class="n">yspluv</span><span class="p">)),</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">curve</span><span class="p">[</span><span class="n">iopir</span><span class="p">]</span> <span class="o">=</span> <span class="n">_interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">iopir</span><span class="p">],</span> <span class="n">tck</span><span class="p">)</span>

    <span class="c"># Now apply extinction correction to input flux vector</span>
    <span class="n">curve</span> <span class="o">*=</span> <span class="o">-</span><span class="n">ebv</span>

    <span class="k">return</span> <span class="n">flux</span> <span class="o">*</span> <span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="mf">0.4</span> <span class="o">*</span> <span class="n">curve</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="sort_specs"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.sort_specs">[docs]</a><span class="k">def</span> <span class="nf">sort_specs</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Specs in an (N,2) array, where specs[:,0] are the files paths and </span>
<span class="sd">    specs[:,1] the instrument name. </span>

<span class="sd">    Return ordered_specs&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;/&#39;</span><span class="p">:</span> 
            <span class="n">path</span> <span class="o">+=</span> <span class="s">&#39;/&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">nsp</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">specs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">MJDs</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nsp</span><span class="p">)</span>
    <span class="n">specs</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>
    <span class="n">lims</span> <span class="o">=</span> <span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">_np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsp</span><span class="p">):</span>
        <span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">MJD</span><span class="p">,</span> <span class="n">dateobs</span><span class="p">,</span> <span class="n">datereduc</span><span class="p">,</span> <span class="n">fitsfile</span> <span class="o">=</span> <span class="n">loadfits</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> 
            <span class="n">specs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">MJDs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MJD</span>
        <span class="k">if</span> <span class="n">MJDs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MJDs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">MJDs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MJDs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">specs</span><span class="p">[</span><span class="n">MJDs</span><span class="o">.</span><span class="n">argsort</span><span class="p">()],</span> <span class="n">lims</span>

</div>
<div class="viewcode-block" id="convgaussFunc"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.convgaussFunc">[docs]</a><span class="k">def</span> <span class="nf">convgaussFunc</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">flx</span><span class="p">,</span> <span class="n">lbc</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">convgauss</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ssize</span><span class="o">=.</span><span class="mo">05</span><span class="p">,</span> 
    <span class="n">wlout</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Do a Gaussian convolution of a given Line Profile with a Gaussian. </span>

<span class="sd">    `wl`, `flx`, `lbc`: wavelenght and flux of the spectrum containing the </span>
<span class="sd">    line, and its value.</span>

<span class="sd">    `hwidth`, `ssize`: width to be keeped around the line (km/s), and the </span>
<span class="sd">    region (in percentage) where the continuum level will be evaluted around </span>
<span class="sd">    the selected region.</span>

<span class="sd">    `convgauss`: if bigger then 0., do the convolution. Its values is the sigma </span>
<span class="sd">    of the gaussian conv. profile (in km/s).</span>

<span class="sd">    `frac`: controls the intensity of the convolution. `frac`=0 means pure </span>
<span class="sd">    profile output and `frac`=1 a pure gaussian output with the same EW value.</span>

<span class="sd">    `wlout`: returns a wavelength array instead of a velocity array (standar)</span>

<span class="sd">    OUTPUT: vel/wl, flux (arrays)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">yo</span><span class="p">)</span> <span class="o">=</span> <span class="n">lineProf</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">flx</span><span class="p">,</span> <span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="n">hwidth</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">convgauss</span><span class="p">,</span> 
        <span class="n">ssize</span><span class="o">=</span><span class="n">ssize</span><span class="p">)</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">yo</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="n">convgauss</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">frac</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span>
        <span class="n">xn</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">hwidth</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">convgauss</span><span class="p">,</span>
                        <span class="n">hwidth</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">convgauss</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">cf</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">normgauss</span><span class="p">(</span><span class="n">convgauss</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">xn</span><span class="p">)</span>
        <span class="n">yo</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xn</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">yo</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">xn</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">yo</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">frac</span><span class="p">)</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">yo</span> <span class="o">*</span> <span class="n">frac</span><span class="p">,</span> <span class="n">cf</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">cf</span><span class="p">),</span> <span class="s">&#39;same&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">wlout</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">_phc</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">cgs</span> <span class="o">*</span> <span class="mf">1e5</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">lbc</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y1</span> <span class="o">+</span> <span class="n">y2</span>

</div>
<div class="viewcode-block" id="cutpastrefspec"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.cutpastrefspec">[docs]</a><span class="k">def</span> <span class="nf">cutpastrefspec</span><span class="p">(</span><span class="n">ivl</span><span class="p">,</span> <span class="n">iflx</span><span class="p">,</span> <span class="n">irefvl</span><span class="p">,</span> <span class="n">ireflx</span><span class="p">,</span> <span class="n">hwidth</span><span class="p">,</span> <span class="n">ssize</span><span class="o">=.</span><span class="mo">05</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Cut and paste a given line profile into a reference line profile. </span>

<span class="sd">    Both profiles (with any resolution) must be normalized and given in vel. </span>

<span class="sd">    It was designed to solve the problem of Achernar&#39;s Halpha line wings </span>
<span class="sd">    problem and it works like this: given a reference profile (`refvl`, </span>
<span class="sd">    `reflx`), the selected profile will be cutted at the `hwidth` position </span>
<span class="sd">    and them pasted in the corresponding position (and intensity level) of </span>
<span class="sd">    the reference spectrum.</span>

<span class="sd">    OUTPUT: refvl, reflx</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">irefvl</span><span class="p">,</span> <span class="n">ivl</span><span class="p">,</span> <span class="n">iflx</span><span class="p">)</span>
    <span class="n">i0</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">irefvl</span> <span class="o">+</span> <span class="n">hwidth</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
    <span class="n">i1</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">irefvl</span> <span class="o">-</span> <span class="n">hwidth</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
    <span class="n">ssize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ssize</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">flx</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ssize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ssize</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">refav</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span> <span class="n">ireflx</span><span class="p">[</span><span class="n">i0</span> <span class="o">-</span> <span class="n">ssize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span><span class="n">i0</span> <span class="o">+</span> <span class="n">ssize</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">+</span> \
        <span class="n">_np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span> <span class="n">ireflx</span><span class="p">[</span><span class="n">i1</span> <span class="o">-</span> <span class="n">ssize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span><span class="n">i1</span> <span class="o">+</span> <span class="n">ssize</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">av</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span> <span class="n">flx</span><span class="p">[</span><span class="n">i0</span> <span class="o">-</span> <span class="n">ssize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span><span class="n">i0</span> <span class="o">+</span> <span class="n">ssize</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">+</span> \
        <span class="n">_np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span> <span class="n">flx</span><span class="p">[</span><span class="n">i1</span> <span class="o">-</span> <span class="n">ssize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span><span class="n">i1</span> <span class="o">+</span> <span class="n">ssize</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">flx</span> <span class="o">+=</span> <span class="n">refav</span> <span class="o">-</span> <span class="n">av</span>
    <span class="n">reflx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ireflx</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">reflx</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">flx</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">irefvl</span><span class="p">,</span> <span class="n">reflx</span>

</div>
<div class="viewcode-block" id="load_specs_fits"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.load_specs_fits">[docs]</a><span class="k">def</span> <span class="nf">load_specs_fits</span><span class="p">(</span><span class="n">speclist</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">lbc</span><span class="p">,</span> <span class="n">lncore</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
    <span class="n">gaussfit</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">plotcut</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Load a list of specs and do the *line core cut &amp; paste*</span>

<span class="sd">    `lncore`: cut and paste hwidth of the line center. It can be None, and </span>
<span class="sd">    must be &lt; hwidth. If hwidth is None, it is assumed to be 1000 km/s. </span>

<span class="sd">    `speclist` : [ [&#39;path+file.fits&#39;, &#39;INSTRUMENT&#39;], ... ]</span>

<span class="sd">    `ref`: reference spectra to do the cut &amp; paste </span>

<span class="sd">    `plotcut`: if plotcut &gt; 0, save the cutted spectra in steps of this </span>
<span class="sd">    variable.</span>

<span class="sd">    OUTPUT: dtb_obs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">hwidth</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">hwidth</span> <span class="o">=</span> <span class="mf">1000.</span>
    <span class="c"># do core cut?</span>
    <span class="n">docore</span> <span class="o">=</span> <span class="n">lncore</span> <span class="o">&lt;</span> <span class="n">hwidth</span>
    <span class="k">if</span> <span class="n">lncore</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">docore</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c"># load ref</span>
    <span class="n">refwl</span><span class="p">,</span> <span class="n">reflx</span> <span class="o">=</span> <span class="n">loadfits</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">refvl</span><span class="p">,</span> <span class="n">reflx</span> <span class="o">=</span> <span class="n">lineProf</span><span class="p">(</span><span class="n">refwl</span><span class="p">,</span> <span class="n">reflx</span><span class="p">,</span> <span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">)</span>
    <span class="c"># load specs</span>
    <span class="n">dtb_obs</span> <span class="o">=</span> <span class="n">Spec</span><span class="p">(</span><span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="n">hwidth</span><span class="p">,</span> <span class="n">gaussfit</span><span class="o">=</span><span class="n">gaussfit</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">speclist</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">dtb_obs</span><span class="o">.</span><span class="n">loadspec</span><span class="p">(</span><span class="n">speclist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">vl</span><span class="p">,</span> <span class="n">flx</span> <span class="o">=</span> <span class="n">lineProf</span><span class="p">(</span><span class="n">dtb_obs</span><span class="o">.</span><span class="n">wl</span><span class="p">,</span> <span class="n">dtb_obs</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">docore</span><span class="p">:</span>
            <span class="n">cuted</span> <span class="o">=</span> <span class="n">cutpastrefspec</span><span class="p">(</span><span class="n">vl</span><span class="p">,</span> <span class="n">flx</span><span class="p">,</span> <span class="n">refvl</span><span class="p">,</span> <span class="n">reflx</span><span class="p">,</span> <span class="n">lncore</span><span class="p">)</span>
            <span class="n">dtb_obs</span><span class="o">.</span><span class="n">flux</span> <span class="o">=</span> <span class="n">cuted</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dtb_obs</span><span class="o">.</span><span class="n">wl</span> <span class="o">=</span> <span class="p">(</span><span class="n">cuted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">_phc</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">cgs</span><span class="o">*</span><span class="mf">1e5</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">lbc</span>
            <span class="p">(</span><span class="n">dtb_obs</span><span class="o">.</span><span class="n">EW</span><span class="p">,</span> <span class="n">dtb_obs</span><span class="o">.</span><span class="n">EC</span><span class="p">,</span> <span class="n">dtb_obs</span><span class="o">.</span><span class="n">VR</span><span class="p">,</span> <span class="n">dtb_obs</span><span class="o">.</span><span class="n">peaksep</span><span class="p">,</span> 
            <span class="n">dtb_obs</span><span class="o">.</span><span class="n">depthcent</span><span class="p">,</span> <span class="n">dtb_obs</span><span class="o">.</span><span class="n">F0</span><span class="p">)</span> <span class="o">=</span> <span class="n">analline</span><span class="p">(</span><span class="n">dtb_obs</span><span class="o">.</span><span class="n">wl</span><span class="p">,</span> 
            <span class="n">dtb_obs</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">dtb_obs</span><span class="o">.</span><span class="n">lbc</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="n">lncore</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> 
            <span class="n">gaussfit</span><span class="o">=</span><span class="n">dtb_obs</span><span class="o">.</span><span class="n">gaussfit</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">dtb_obs</span><span class="o">.</span><span class="n">EW</span><span class="p">,</span> <span class="n">dtb_obs</span><span class="o">.</span><span class="n">EC</span><span class="p">,</span> <span class="n">dtb_obs</span><span class="o">.</span><span class="n">VR</span><span class="p">,</span> <span class="n">dtb_obs</span><span class="o">.</span><span class="n">peaksep</span><span class="p">,</span> 
            <span class="n">dtb_obs</span><span class="o">.</span><span class="n">depthcent</span><span class="p">,</span> <span class="n">dtb_obs</span><span class="o">.</span><span class="n">F0</span><span class="p">)</span> <span class="o">=</span> <span class="n">analline</span><span class="p">(</span><span class="n">dtb_obs</span><span class="o">.</span><span class="n">wl</span><span class="p">,</span> 
            <span class="n">dtb_obs</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">dtb_obs</span><span class="o">.</span><span class="n">lbc</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="n">hwidth</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> 
            <span class="n">gaussfit</span><span class="o">=</span><span class="n">dtb_obs</span><span class="o">.</span><span class="n">gaussfit</span><span class="p">)</span>
        <span class="n">dtb_obs</span><span class="o">.</span><span class="n">addspec</span><span class="p">()</span>
    <span class="c"># complementary plot</span>
    <span class="k">if</span> <span class="n">plotcut</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">docore</span><span class="p">:</span>
        <span class="n">fig0</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">speclist</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">dtb_obs</span><span class="o">.</span><span class="n">loadspec</span><span class="p">(</span><span class="n">speclist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">vl</span><span class="p">,</span> <span class="n">flx</span> <span class="o">=</span> <span class="n">lineProf</span><span class="p">(</span><span class="n">dtb_obs</span><span class="o">.</span><span class="n">wl</span><span class="p">,</span> <span class="n">dtb_obs</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">)</span>
            <span class="n">cuted</span> <span class="o">=</span> <span class="n">cutpastrefspec</span><span class="p">(</span><span class="n">vl</span><span class="p">,</span> <span class="n">flx</span><span class="p">,</span> <span class="n">refvl</span><span class="p">,</span> <span class="n">reflx</span><span class="p">,</span> <span class="n">lncore</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">plotcut</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cuted</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cuted</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">_phc</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dtb_obs</span>

</div>
<div class="viewcode-block" id="plot_spec_info"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.plot_spec_info">[docs]</a><span class="k">def</span> <span class="nf">plot_spec_info</span><span class="p">(</span><span class="n">speclist</span><span class="p">,</span> <span class="n">dtb_obs</span><span class="p">,</span> <span class="n">mAEW</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">mgray</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Standard plot of the Spec class (EW, E/C, V/R, peak-sep., FWHM, F0) </span>

<span class="sd">    OUTPUT: figure (fig pyplot)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mAEW</span><span class="p">:</span>
        <span class="n">dtb_obs</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">1000</span><span class="o">*</span><span class="n">dtb_obs</span><span class="o">.</span><span class="n">lbc</span><span class="o">/</span><span class="n">_phc</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">cgs</span><span class="o">*</span><span class="mf">1e5</span>
    <span class="c"># Legend, Markers and colors idx...</span>
    <span class="n">instm</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">speclist</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="c"># coridx = [ phc.cycles(instm.index(i)) for i in speclist[:, 1]]</span>
    <span class="n">cores</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">gradColor</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instm</span><span class="p">)),</span> <span class="n">cmapn</span><span class="o">=</span><span class="s">&#39;inferno&#39;</span><span class="p">)</span>
    <span class="n">coridx</span> <span class="o">=</span> <span class="p">[</span> <span class="n">cores</span><span class="p">[</span><span class="n">instm</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">speclist</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="p">]</span>
    <span class="n">coridx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coridx</span><span class="p">)</span>
    <span class="n">mkidx</span> <span class="o">=</span> <span class="p">[</span> <span class="n">_phc</span><span class="o">.</span><span class="n">cycles</span><span class="p">(</span><span class="n">instm</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="s">&#39;mk&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">speclist</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]]</span>
    <span class="n">mkidx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mkidx</span><span class="p">)</span>
    <span class="c"># Plots</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">lins</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">gssteps</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">_gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">lins</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">_plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="p">:])</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gssteps</span><span class="p">]</span>
    <span class="c"># EW</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;Julian date - 2400000.5&#39;</span><span class="p">)</span>

    <span class="n">ylabels</span> <span class="o">=</span> <span class="p">[</span><span class="s">u&#39;EW (m</span><span class="se">\u00c5</span><span class="s">)&#39;</span><span class="p">,</span> <span class="s">&#39;E/C&#39;</span><span class="p">,</span> <span class="s">&#39;V/R&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;pk. sep.&#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="s">&#39;(km/s)&#39;</span><span class="p">),</span> 
        <span class="s">&#39;FWHM&#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="s">&#39;(km/s)&#39;</span><span class="p">,</span> <span class="s">r&#39;F${\lambda 0}$&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axs</span><span class="p">):</span>
        <span class="c"># binned</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">bindata</span><span class="p">(</span><span class="n">dtb_obs</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtb_obs</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
        <span class="c"># yi = _savgol(y, 3, 1)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;gray&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c"># points</span>
        <span class="k">for</span> <span class="n">uniquem</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">mkidx</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mkidx</span> <span class="o">==</span> <span class="n">uniquem</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dtb_obs</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span> <span class="n">dtb_obs</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span> 
                <span class="n">color</span><span class="o">=</span><span class="n">coridx</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="n">uniquem</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="c">#</span>
    <span class="n">xlim</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xlim</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s">&quot;:&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">axs</span><span class="p">)):</span>
        <span class="c"># ax.locator_params(axis=&#39;y&#39;, nbins=4)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">_MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">prune</span><span class="o">=</span><span class="s">&#39;upper&#39;</span><span class="p">))</span> 
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="c"># Legend</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instm</span><span class="p">)):</span>
        <span class="c"># axs[0].plot([np.NaN], [np.NaN], label=instm[i], color=phc.cycles(i), </span>
            <span class="c"># marker=phc.cycles(i, &#39;mk&#39;), ls=&#39;&#39;)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">_np</span><span class="o">.</span><span class="n">NaN</span><span class="p">],</span> <span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">NaN</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">instm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">cores</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
            <span class="n">marker</span><span class="o">=</span><span class="n">_phc</span><span class="o">.</span><span class="n">cycles</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s">&#39;mk&#39;</span><span class="p">),</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">,</span> <span class="n">fancybox</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> 
        <span class="n">labelspacing</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c"># bbox_to_anchor=(1.05, 1), loc=2, borderaxespad=0.</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="c"># Gray</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mgray</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="n">_mpatches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">([</span><span class="n">mgray</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> 
                <span class="n">mgray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">mgray</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ec</span><span class="o">=</span><span class="s">&quot;gray&quot;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s">&#39;gray&#39;</span><span class="p">,</span> 
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mgray</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mgray</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
                <span class="n">rect</span> <span class="o">=</span> <span class="n">_mpatches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">([</span><span class="n">mgray</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> 
                    <span class="n">mgray</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">mgray</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ec</span><span class="o">=</span><span class="s">&quot;gray&quot;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s">&#39;gray&#39;</span><span class="p">,</span> 
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hatch</span><span class="o">=</span><span class="s">&#39;//&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>


<span class="c"># TODO: Check if obsolete</span></div>
<div class="viewcode-block" id="normalize_range"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.normalize_range">[docs]</a><span class="k">def</span> <span class="nf">normalize_range</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function is obsolete and must be removed.</span>

<span class="sd">    Still here for compatibility issues.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">-</span> <span class="n">spec</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">-</span> <span class="n">lb</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">-</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">lb</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">spec</span> <span class="o">/</span> <span class="p">(</span><span class="n">a1</span> <span class="o">+</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">lb</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="normalize_spec"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.normalize_spec">[docs]</a><span class="k">def</span> <span class="nf">normalize_spec</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">flx</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Normalize a spectrum using the non-parametric regression algorithm of</span>
<span class="sd">    Local Polynomial Kernel (order=``q``). </span>

<span class="sd">    For details, see http://pythonhosted.org/PyQt-Fit/NonParam_tut.html .</span>

<span class="sd">    INPUT: lb, flx</span>

<span class="sd">    OUTPUT: norm_flx</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">k1</span> <span class="o">=</span> <span class="n">smooth</span><span class="o">.</span><span class="n">NonParamRegression</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">flx</span><span class="p">,</span> 
        <span class="n">method</span><span class="o">=</span><span class="n">npr_methods</span><span class="o">.</span><span class="n">LocalPolynomialKernel</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">k1</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

    <span class="n">idxi</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">k1</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span><span class="o">/</span><span class="n">flx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.03</span><span class="p">)</span>
    <span class="n">xsi</span> <span class="o">=</span> <span class="n">lb</span><span class="p">[</span><span class="n">idxi</span><span class="p">]</span>
    <span class="n">ysi</span> <span class="o">=</span> <span class="n">flx</span><span class="p">[</span><span class="n">idxi</span><span class="p">]</span>
    <span class="n">k2</span> <span class="o">=</span> <span class="n">smooth</span><span class="o">.</span><span class="n">NonParamRegression</span><span class="p">(</span><span class="n">xsi</span><span class="p">,</span> <span class="n">ysi</span><span class="p">,</span> 
        <span class="n">method</span><span class="o">=</span><span class="n">npr_methods</span><span class="o">.</span><span class="n">LocalPolynomialKernel</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">))</span>
    <span class="n">k2</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">flx</span><span class="o">/</span><span class="n">k2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="renorm"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.renorm">[docs]</a><span class="k">def</span> <span class="nf">renorm</span><span class="p">(</span><span class="n">vl</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Renormalize ``y`` so that the equivalent width is preserved when the </span>
<span class="sd">    continuum is shifted to 1. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">a0</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">vl</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">((</span><span class="n">a0</span><span class="o">-</span><span class="n">_np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vl</span><span class="p">)),</span> <span class="n">vl</span><span class="p">))</span><span class="o">/</span>
        <span class="p">(</span><span class="n">a0</span><span class="o">-</span><span class="n">_np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vl</span><span class="p">)),</span> <span class="n">vl</span><span class="p">)))</span>
    <span class="n">B</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">A</span><span class="o">*</span><span class="n">ext</span>
    <span class="k">return</span> <span class="n">A</span><span class="o">*</span><span class="n">y</span><span class="o">+</span><span class="n">B</span>

</div>
<div class="viewcode-block" id="checksubdirs"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.checksubdirs">[docs]</a><span class="k">def</span> <span class="nf">checksubdirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">lbc</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">showleg</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">plots</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Faz o que tem que fazer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">)):</span>
        <span class="n">_os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;mkdir {0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">))</span>

    <span class="n">nights</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">_os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span>
        <span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">o</span><span class="p">))]</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">spdtb</span> <span class="o">=</span> <span class="n">Spec</span><span class="p">()</span>
    <span class="n">spdtb</span><span class="o">.</span><span class="n">lbc</span> <span class="o">=</span> <span class="n">lbc</span>
    <span class="n">spdtb</span><span class="o">.</span><span class="n">hwidth</span> <span class="o">=</span> <span class="mf">1000.</span>
    <span class="k">for</span> <span class="n">night</span> <span class="ow">in</span> <span class="n">nights</span><span class="p">:</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">_os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">))</span> <span class="k">if</span>
            <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">o</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">star</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">scal</span> <span class="o">=</span> <span class="n">_glob</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/*.cal.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scal</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">cal</span> <span class="ow">in</span> <span class="n">scal</span><span class="p">:</span>
                        <span class="n">spdtb</span><span class="o">.</span><span class="n">loadspec</span><span class="p">(</span><span class="n">cal</span><span class="p">)</span>
                        <span class="n">spdtb</span><span class="o">.</span><span class="n">addspec</span><span class="p">()</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">_np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">spdtb</span><span class="o">.</span><span class="n">EW</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
                                <span class="n">spdtb</span><span class="o">.</span><span class="n">plotspec</span><span class="p">()</span>
                            <span class="n">vels</span> <span class="o">=</span> <span class="p">(</span><span class="n">spdtb</span><span class="o">.</span><span class="n">wl</span> <span class="o">-</span> <span class="n">lbc</span><span class="p">)</span> <span class="o">/</span> <span class="n">lbc</span> <span class="o">*</span> <span class="n">_phc</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">cgs</span> <span class="o">*</span> <span class="mf">1e-5</span>
                            <span class="n">idx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vels</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">hwidth</span><span class="p">)</span>
                            <span class="n">flux</span> <span class="o">=</span> <span class="n">linfit</span><span class="p">(</span><span class="n">vels</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">spdtb</span><span class="o">.</span><span class="n">flux</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                            <span class="n">vels</span> <span class="o">=</span> <span class="n">vels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                            <span class="n">leg</span> <span class="o">=</span> <span class="n">spdtb</span><span class="o">.</span><span class="n">MJD</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vels</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> 
                                <span class="n">color</span><span class="o">=</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">spdtb</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> 
                                <span class="nb">len</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">))])</span>
                <span class="k">else</span><span class="p">:</span>   
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Data not reduced for </span><span class="si">%s</span><span class="s"> at </span><span class="si">%s</span><span class="s">!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">night</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="n">hwidth</span><span class="p">,</span> <span class="n">hwidth</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">showleg</span><span class="p">:</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">.</span><span class="mo">05</span><span class="p">),</span> <span class="n">labelspacing</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">legend</span><span class="o">.</span><span class="n">get_texts</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="s">&#39;small&#39;</span><span class="p">)</span>    
    <span class="n">_plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}/{1}_at_{2}.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_outfold</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">lbc</span><span class="p">))</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">spdtb</span><span class="o">.</span><span class="n">savedata</span><span class="p">(</span><span class="n">datafile</span><span class="o">=</span><span class="s">&#39;{0}/{1}.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_outfold</span><span class="p">,</span> <span class="n">star</span><span class="p">),</span>
        <span class="n">metafile</span><span class="o">=</span><span class="s">&#39;{0}/meta_{1}.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_outfold</span><span class="p">,</span> <span class="n">star</span><span class="p">))</span>
    <span class="k">return</span>

</div>
<div class="viewcode-block" id="VREWcalc"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.VREWcalc">[docs]</a><span class="k">def</span> <span class="nf">VREWcalc</span><span class="p">(</span><span class="n">vels</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">vw</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Supoe que o fluxo jah estah normalizado, e vetores ordenad_os.</span>

<span class="sd">    Calcula o ew para os dois lados (azul/vermelho) da linha, ajustando</span>
<span class="sd">    a velocidade de repouso (TBD).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># calcula e aplica correcao de vel. repousp</span>
    <span class="n">vc</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">vels</span> <span class="o">+=</span> <span class="n">vc</span>
    <span class="c"># corta em vw, e faz o teste de tamanho</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vels</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">vw</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">vw</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vels</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">vw</span><span class="p">)</span>
        <span class="n">outvels</span> <span class="o">=</span> <span class="n">vels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">normflux</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ew0</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">ew1</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">return</span> <span class="n">ew0</span><span class="p">,</span> <span class="n">ew1</span><span class="p">,</span> <span class="n">vc</span>
    <span class="c">#</span>
    <span class="n">ivc</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">outvels</span> <span class="o">-</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
    <span class="n">ew0</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ivc</span><span class="p">):</span>
        <span class="n">dl</span> <span class="o">=</span> <span class="n">outvels</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">outvels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ew0</span> <span class="o">+=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="n">normflux</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">normflux</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">dl</span>
    <span class="n">ew1</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ivc</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">outvels</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">dl</span> <span class="o">=</span> <span class="n">outvels</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">outvels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ew1</span> <span class="o">+=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="n">normflux</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">normflux</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">dl</span>
    <span class="k">return</span> <span class="n">ew0</span><span class="p">,</span> <span class="n">ew1</span><span class="p">,</span> <span class="n">vc</span>

</div>
<div class="viewcode-block" id="plotSpecData"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.plotSpecData">[docs]</a><span class="k">def</span> <span class="nf">plotSpecData</span><span class="p">(</span><span class="n">dtb</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">civcfg</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#39;m&#39;</span><span class="p">,</span> <span class="mi">2013</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">fmt</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;png&#39;</span><span class="p">],</span> <span class="n">ident</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">lims</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">setylim</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">addsuf</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot spec class database `vs` MJD e civil date</span>

<span class="sd">    Plot originally done to London, Canada, 2014.</span>

<span class="sd">    INPUT: civcfg = [step, &#39;d&#39;/&#39;m&#39;/&#39;y&#39;, starting year, month, day]</span>

<span class="sd">    `lims` sequence: &#39;EW&#39;, &#39;E/C&#39;, &#39;V/R&#39;, &#39;Pk. sep. (km/s)&#39;, &#39;E-F0&#39;, &#39;F0&#39;</span>

<span class="sd">    `lims` = [[-2,4+2,2],[1.,1.4+.1,0.1],[.6,1.4+.2,.2],[0,400+100,100],</span>
<span class="sd">    [.30,.45+.05,.05],[0.6,1.20+.2,.2]]</span>

<span class="sd">    If `lims` is defined, `setylim` can be set to True.</span>

<span class="sd">    OUTPUT: Written image.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtb</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Loading dtb {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtb</span><span class="p">))</span>
        <span class="n">dtb</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">dtb</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ident</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">idref</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>

    <span class="n">ylabels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;EW&#39;</span><span class="p">,</span> <span class="s">&#39;E/C&#39;</span><span class="p">,</span> <span class="s">&#39;V/R&#39;</span><span class="p">,</span> <span class="s">&#39;Pk. sep. (km/s)&#39;</span><span class="p">,</span> <span class="s">&#39;E-F0&#39;</span><span class="p">,</span> <span class="s">&#39;F0&#39;</span><span class="p">]</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">9.6</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

    <span class="n">icolor</span> <span class="o">=</span> <span class="s">&#39;blue&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ylabels</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">_phc</span><span class="o">.</span><span class="n">bindata</span><span class="p">(</span><span class="n">dtb</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtb</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="mi">20</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dtb</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])):</span>
            <span class="k">if</span> <span class="n">ident</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ident</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">idref</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">icolor</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dtb</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtb</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">icolor</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabels</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">lims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lims</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">*</span><span class="n">lims</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">setylim</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span> <span class="n">lims</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">lims</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">])</span>

    <span class="k">if</span> <span class="n">ident</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">patch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">idref</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span> <span class="o">==</span> <span class="n">idref</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">icolor</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">icolor</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> 
            <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;size&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># limits = ax[0].get_xlim()</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span><span class="n">dtb</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtb</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">limits</span><span class="p">)</span>
    <span class="n">mjd0</span><span class="p">,</span> <span class="n">mjd1</span> <span class="o">=</span> <span class="n">limits</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;MJD&#39;</span><span class="p">)</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">gentkdates</span><span class="p">(</span><span class="n">mjd0</span><span class="p">,</span> <span class="n">mjd1</span><span class="p">,</span> <span class="n">civcfg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">civcfg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
        <span class="n">dtstart</span><span class="o">=</span><span class="n">_dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">civcfg</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">civcfg</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">civcfg</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
    <span class="n">mjdticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">_jdcal</span><span class="o">.</span><span class="n">gcal2jd</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">day</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> 
        <span class="n">ticks</span><span class="p">]</span>
    <span class="c"># ticks = [dt.datetime(*jdcal.jd2gcal(jdcal.MJD_0, date)[:3]).date() for \</span>
    <span class="c"># date in ax[0].get_xticks()]</span>
    <span class="c"># mjdticks = ax[0].get_xticks()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">twiny</span><span class="p">()</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">limits</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">mjdticks</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s">&#39;&#39;</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;Civil date&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s"> %b %y&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">])</span>
            <span class="n">_plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span> <span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_majorticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span> <span class="p">)</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.13</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.88</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.06</span><span class="p">,</span> 
        <span class="n">hspace</span><span class="o">=.</span><span class="mi">15</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fmt</span><span class="p">:</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">&#39;SpecQ{1}.{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">addsuf</span><span class="p">))</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;SpecQ{1}.{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">addsuf</span><span class="p">),</span> <span class="n">transparent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span>

</div>
<div class="viewcode-block" id="din_spec"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.din_spec">[docs]</a><span class="k">def</span> <span class="nf">din_spec</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">lbc</span><span class="o">=</span><span class="mf">6562.86</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="mf">1500.</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">interv</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">fmt</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;png&#39;</span><span class="p">],</span> <span class="n">outname</span><span class="o">=</span><span class="s">&#39;din_spec&#39;</span><span class="p">,</span> <span class="n">pxsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">avg</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">cmapn</span><span class="o">=</span><span class="s">&#39;inferno&#39;</span><span class="p">,</span> <span class="n">refspec</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot dynamical specs. from metadata table of the Spec class.</span>

<span class="sd">    `interv` controls the interval between specs (in days).</span>

<span class="sd">    `res` is the resolution in km/s.</span>

<span class="sd">    By default (`avg`=True), the average of spectra in that bin is show. If </span>
<span class="sd">    `avg`=False, the nearest bin-centered (in time) spectra will be shown.</span>

<span class="sd">    if `refspec` is not None, them it will be a difference spectra.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Define MJD and bins</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">metadata</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span>
    <span class="n">tf</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">interv</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">interv</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">interv</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">tf</span> <span class="o">+</span> <span class="n">interv</span><span class="p">,</span> <span class="n">interv</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">interv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">interv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c"># Select specs </span>
    <span class="n">wl0</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">hwidth</span><span class="p">,</span> <span class="n">hwidth</span> <span class="o">+</span> <span class="n">res</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
    <span class="c"># Load refspec, if required</span>
    <span class="n">baselevel</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="k">if</span> <span class="n">refspec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">loadfits</span><span class="p">(</span><span class="n">refspec</span><span class="p">)</span>
        <span class="n">wl</span><span class="p">,</span> <span class="n">flux</span> <span class="o">=</span> <span class="n">lineProf</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="n">hwidth</span><span class="p">)</span>
        <span class="n">refflx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">wl0</span><span class="p">,</span> <span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">)</span>
        <span class="n">baselevel</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">fluxes</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span> <span class="nb">len</span><span class="p">(</span><span class="n">wl0</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">interv</span><span class="p">)</span> <span class="p">))</span> <span class="o">+</span> <span class="n">baselevel</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">interv</span><span class="p">)):</span>
        <span class="c"># method 1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">avg</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">find_nearest</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">interv</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">date</span> <span class="o">&lt;</span> <span class="n">interv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">/</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">date</span> <span class="o">&gt;</span> <span class="n">interv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">dt</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
                <span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">loadfits</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
                <span class="n">wl</span><span class="p">,</span> <span class="n">flux</span> <span class="o">=</span> <span class="n">lineProf</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="n">hwidth</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">refspec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">fluxes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">wl0</span><span class="p">,</span> <span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flux</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">wl0</span><span class="p">,</span> <span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">)</span>
                    <span class="n">fluxes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux</span> <span class="o">-</span> <span class="n">refflx</span>
        <span class="c"># method 2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">dates</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">interv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">/</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">dates</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">interv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> \
                    <span class="n">dt</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">loadfits</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
                    <span class="n">wl</span><span class="p">,</span> <span class="n">flux</span> <span class="o">=</span> <span class="n">lineProf</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="n">hwidth</span><span class="p">)</span>
                    <span class="n">fluxes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">wl0</span><span class="p">,</span> <span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">)</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c"># fluxes[:,i]/= k</span>
                <span class="n">wl</span> <span class="o">=</span> <span class="n">vel2wl</span><span class="p">(</span><span class="n">wl0</span><span class="p">,</span> <span class="n">lbc</span><span class="p">)</span>
                <span class="n">tmp</span><span class="p">,</span> <span class="n">fluxes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lineProf</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">fluxes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">,</span> 
                    <span class="n">hwidth</span><span class="o">=</span><span class="n">hwidth</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">refspec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">fluxes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fluxes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">refflx</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">fluxes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">baselevel</span><span class="p">):</span>
            <span class="n">fluxes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">NaN</span>
    <span class="c"># Create image</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">pxsize</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">interv</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">wl0</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">interv</span><span class="p">)):</span>
        <span class="n">img</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">pxsize</span><span class="p">:(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">pxsize</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">fluxes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">pxsize</span><span class="p">)</span><span class="o">.</span>\
            <span class="n">reshape</span><span class="p">(</span><span class="n">pxsize</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wl0</span><span class="p">))</span>
    <span class="c"># Save image</span>
    <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wl0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span> <span class="n">pxsize</span> <span class="o">*</span> 
            <span class="nb">len</span><span class="p">(</span><span class="n">interv</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="c"># _plt.figure(figsize=(len(wl0) / 16, pxsize * len(interv) / 16), dpi=80)</span>
    <span class="c"># print _np.min(img), _np.max(img)</span>
    <span class="n">cmapn</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmapn</span><span class="p">)</span>
    <span class="n">cmapn</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmapn</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;Velocity (km s$^{-1}$)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;Julian Day - 2400000.5&#39;</span><span class="p">)</span>
    <span class="c"># ax.set_xlim([-hwidth, hwidth])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">pxsize</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">interv</span><span class="p">)</span><span class="o">*.</span><span class="mi">1</span><span class="p">,</span> <span class="n">pxsize</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">interv</span><span class="p">)</span><span class="o">*.</span><span class="mi">9</span><span class="p">,</span> 
        <span class="mi">8</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">tf</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">*</span><span class="n">t</span><span class="o">/</span><span class="p">(</span><span class="n">pxsize</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">interv</span><span class="p">))</span><span class="o">+</span><span class="n">t0</span><span class="p">))</span> 
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()],</span> <span class="n">rotation</span><span class="o">=</span><span class="s">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="mf">2.</span><span class="o">*</span><span class="n">hwidth</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wl0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">hwidth</span><span class="p">))</span> <span class="k">for</span> 
        <span class="n">t</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">()])</span>  <span class="c"># , rotation=&#39;vertical&#39;)</span>
    <span class="c"># fig.tight_layout()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;gray&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">1.1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;gray&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">1.1</span><span class="p">)</span>
    <span class="n">_phc</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">,</span> <span class="n">figname</span><span class="o">=</span><span class="n">outname</span><span class="p">)</span>
    <span class="k">return</span>

</div>
<div class="viewcode-block" id="plot_line_str"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.plot_line_str">[docs]</a><span class="k">def</span> <span class="nf">plot_line_str</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">lbc</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dlim</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
    <span class="n">cmapn</span><span class="o">=</span><span class="s">&#39;gnuplot&#39;</span><span class="p">,</span> <span class="n">lfs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Line plotting structure &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lbc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">r&#39;$\lambda_c$ = {0:.1f} $\AA$&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lbc</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xlims</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;Velocity (km s$^{-1}$)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
    <span class="c"># reverse to keep order consistent</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">labels</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">labelspacing</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
        <span class="n">fancybox</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">lfs</span><span class="p">)</span>  <span class="c"># loc=(1.05, .01)</span>

    <span class="n">rect</span> <span class="o">=</span> <span class="n">_mpatches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">([</span><span class="mf">0.835</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.44</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">,</span> 
        <span class="n">fc</span><span class="o">=</span><span class="s">&#39;white&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

    <span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.82</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">])</span>
    <span class="c"># ax3.set_axis_bgcolor(&#39;white&#39;)</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmapn</span><span class="p">)</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">_mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">dlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">dlim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">_mpl</span><span class="o">.</span><span class="n">colorbar</span><span class="o">.</span><span class="n">ColorbarBase</span><span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> 
        <span class="n">orientation</span><span class="o">=</span><span class="s">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s">&#39;MJD&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span> 
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.94</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>  
    <span class="c"># , hspace=0.3, wspace=.3)  </span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>

</div>
<div class="viewcode-block" id="spec_time"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.spec_time">[docs]</a><span class="k">def</span> <span class="nf">spec_time</span><span class="p">(</span><span class="n">speclist</span><span class="p">,</span> <span class="n">lbc</span><span class="o">=</span><span class="mf">6562.8</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;png&#39;</span><span class="p">,</span> <span class="s">&#39;pdf&#39;</span><span class="p">],</span> <span class="n">outname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
    <span class="n">cmapn</span><span class="o">=</span><span class="s">&#39;inferno&#39;</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">outpath</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">ysh</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot specs over time as suggested by Rivi &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">outname</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">outname</span> <span class="ow">is</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
        <span class="n">outname</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">dtflag</span><span class="p">()</span>
    <span class="n">MJDs</span> <span class="o">=</span> <span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">speclist</span><span class="p">:</span>
        <span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">MJD</span><span class="p">,</span> <span class="n">dateobs</span><span class="p">,</span> <span class="n">datereduc</span><span class="p">,</span> <span class="n">fitsfile</span> <span class="o">=</span> <span class="n">loadfits</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">MJD</span> <span class="o">&lt;</span> <span class="n">MJDs</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">MJDs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MJD</span>
        <span class="k">if</span> <span class="n">MJD</span> <span class="o">&gt;</span> <span class="n">MJDs</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">MJDs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MJD</span>
    <span class="n">MJDref</span> <span class="o">=</span> <span class="mi">56245</span>
    <span class="k">if</span> <span class="n">MJDs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">MJDref</span><span class="p">:</span>
        <span class="n">MJDs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MJDref</span>
    <span class="c"># Plot</span>
    <span class="n">extrem</span> <span class="o">=</span> <span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">speclist</span><span class="p">:</span>
        <span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">MJD</span><span class="p">,</span> <span class="n">dateobs</span><span class="p">,</span> <span class="n">datereduc</span><span class="p">,</span> <span class="n">fitsfile</span> <span class="o">=</span> <span class="n">loadfits</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
        <span class="n">vel</span><span class="p">,</span> <span class="n">flux</span> <span class="o">=</span> <span class="n">lineProf</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">lbc</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="n">hwidth</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s">&#39;Wrong lbc in spt.spe&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cmapn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cor</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">gradColor</span><span class="p">([</span><span class="n">MJD</span><span class="p">],</span> <span class="nb">min</span><span class="o">=</span><span class="n">MJDs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="n">MJDs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span>
                <span class="mf">0.1</span><span class="o">*</span><span class="p">(</span><span class="n">MJDs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">MJDs</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">cmapn</span><span class="o">=</span><span class="n">cmapn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cor</span> <span class="o">=</span> <span class="s">&#39;k&#39;</span>
        <span class="k">print</span><span class="p">(</span><span class="n">MJD</span><span class="p">,</span> <span class="n">MJDs</span><span class="p">,</span> <span class="n">extrem</span><span class="p">,</span> <span class="n">ysh</span><span class="p">,</span> <span class="p">(</span><span class="n">MJD</span><span class="o">-</span><span class="n">MJDs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">ysh</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">flux</span><span class="o">+</span><span class="p">(</span><span class="n">MJD</span><span class="o">-</span><span class="n">MJDs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">ysh</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cor</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flux</span><span class="o">+</span><span class="p">(</span><span class="n">MJD</span><span class="o">-</span><span class="n">MJDs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">ysh</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">extrem</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">extrem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flux</span><span class="o">+</span><span class="p">(</span><span class="n">MJD</span><span class="o">-</span><span class="n">MJDs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">ysh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">flux</span><span class="o">+</span><span class="p">(</span><span class="n">MJD</span><span class="o">-</span><span class="n">MJDs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">ysh</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">extrem</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">extrem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">flux</span><span class="o">+</span><span class="p">(</span><span class="n">MJD</span><span class="o">-</span><span class="n">MJDs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">ysh</span><span class="p">)</span>
    <span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">MJD</span><span class="p">,</span> <span class="n">dateobs</span><span class="p">,</span> <span class="n">datereduc</span><span class="p">,</span> <span class="n">fitsfile</span> <span class="o">=</span> <span class="n">loadfits</span><span class="p">(</span><span class="s">&#39;/data/Dropbox/work&#39;</span>
        <span class="s">&#39;/sci_16-15aeri/alpEri_FEROS_2000AVE.mt&#39;</span><span class="p">)</span>
    <span class="n">vel</span><span class="p">,</span> <span class="n">flux</span> <span class="o">=</span> <span class="n">lineProf</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="mf">6561.8</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="n">hwidth</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">650.</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="s">&#39;photospheric ref.&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s">&#39;center&#39;</span><span class="p">,</span> 
        <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&#39;center&#39;</span><span class="p">)</span>  <span class="c"># , transform=ax.transAxes)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">flux</span><span class="o">+</span><span class="p">(</span><span class="n">MJDref</span><span class="o">-</span><span class="n">MJDs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">ysh</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">flux</span><span class="o">+</span><span class="p">(</span><span class="n">MJDref</span><span class="o">-</span><span class="n">MJDs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">ysh</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">extrem</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">extrem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">flux</span><span class="o">+</span><span class="p">(</span><span class="n">MJDref</span><span class="o">-</span><span class="n">MJDs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">ysh</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">extrem</span>
    <span class="n">s2d</span> <span class="o">=</span> <span class="n">_hdt</span><span class="o">.</span><span class="n">readfullsed2</span><span class="p">(</span><span class="s">&#39;/data/Dropbox/work/sci_16-15aeri/&#39;</span>
        <span class="s">&#39;fullsed_mod03_VDDn0_1p4e12_Be_aeri2014.sed2&#39;</span><span class="p">)</span>
    <span class="n">vel</span><span class="p">,</span> <span class="n">flux</span> <span class="o">=</span> <span class="n">lineProf</span><span class="p">(</span><span class="n">s2d</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">s2d</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">],</span> <span class="o">.</span><span class="mi">656461</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="n">hwidth</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">flux</span><span class="o">+</span><span class="p">(</span><span class="mi">56910</span><span class="o">-</span><span class="n">MJDs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">ysh</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mf">1.06</span><span class="o">+</span><span class="p">(</span><span class="mi">56910</span><span class="o">-</span><span class="n">MJDs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">ysh</span><span class="p">,</span> <span class="s">&#39;model&#39;</span><span class="p">,</span> 
        <span class="n">horizontalalignment</span><span class="o">=</span><span class="s">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&#39;center&#39;</span><span class="p">)</span> 
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;Velocity (km s$^{-1}$)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;Julian Day - 2400000.5&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">extrem</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="n">hwidth</span><span class="p">,</span> <span class="n">hwidth</span><span class="p">])</span>
    <span class="c"># ax.set_yticks(_np.arange(56300, 57000+100, 100))</span>
    <span class="n">yref</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">_np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">MJDs</span><span class="p">)</span><span class="o">*</span><span class="n">ysh</span><span class="p">]</span>
    <span class="n">yMJDs</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">56300</span><span class="p">,</span> <span class="mi">57100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">renormvals</span><span class="p">(</span><span class="n">yMJDs</span><span class="p">,</span> <span class="n">MJDs</span><span class="p">,</span> <span class="n">yref</span><span class="p">)))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">yMJDs</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="s">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.94</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
    <span class="n">ax3</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">renormvals</span><span class="p">(</span><span class="n">yMJDs</span><span class="p">,</span> <span class="n">MJDs</span><span class="p">,</span> <span class="n">yref</span><span class="p">)))</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="s">&#39;axes&#39;</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">))</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Civil date&#39;</span><span class="p">)</span>
    <span class="n">dtminticks</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">gentkdates</span><span class="p">(</span><span class="mf">56201.</span><span class="p">,</span> <span class="mf">57023.</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;m&#39;</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">dtticks</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">gentkdates</span><span class="p">(</span><span class="mf">56201.</span><span class="p">,</span> <span class="mf">57023.</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&#39;m&#39;</span><span class="p">)</span>
    <span class="n">mjdticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">_jdcal</span><span class="o">.</span><span class="n">gcal2jd</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">day</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> 
        <span class="n">dtticks</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">dtticks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dtminticks</span><span class="p">:</span>
        <span class="n">dtminticks</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">gentkdates</span><span class="p">(</span><span class="n">yMJDs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">yMJDs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;m&#39;</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">minjdticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">_jdcal</span><span class="o">.</span><span class="n">gcal2jd</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">day</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">date</span> 
        <span class="ow">in</span> <span class="n">dtminticks</span><span class="p">]</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">renormvals</span><span class="p">(</span><span class="n">mjdticks</span><span class="p">,</span> <span class="n">MJDs</span><span class="p">,</span> <span class="n">yref</span><span class="p">)))</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">renormvals</span><span class="p">(</span><span class="n">minjdticks</span><span class="p">,</span> <span class="n">MJDs</span><span class="p">,</span> <span class="n">yref</span><span class="p">)),</span> <span class="n">minor</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">xlabs</span> <span class="o">=</span> <span class="p">[</span><span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dtticks</span><span class="p">]</span>
    <span class="c"># xlabs[1::2] = [&#39;&#39;]*len(xlabs[1::2])</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">xlabs</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="s">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">extrem</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">extrem</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s">&#39;minor&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s">&#39;minor&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s">&#39;minor&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s">&#39;minor&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
        <span class="c"># , fontsize=10)</span>
    <span class="n">_phc</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">figname</span><span class="o">=</span><span class="n">outpath</span><span class="o">+</span><span class="n">outname</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span>
    <span class="k">return</span>

</div>
<div class="viewcode-block" id="extractfromsplot"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.extractfromsplot">[docs]</a><span class="k">def</span> <span class="nf">extractfromsplot</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">splot</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ce = center; Co = core</span>
<span class="sd">    #LcCe, LcCo, lcGW, lcEW, lvCe, lcCo, lvEW, lrCe, LrCo, lrEW</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">NaN</span><span class="p">])</span>
    <span class="n">readflag</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">splot</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;]:&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">readflag</span><span class="p">:</span>
            <span class="n">readflag</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">readflag</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">readflag</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="c"># if _re.match(&quot;^\d+?\.\d+?$&quot;, info[0]) is not None:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">6556</span> <span class="ow">and</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">6556</span> <span class="o">+</span> <span class="mf">4.33</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="n">out</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                        <span class="n">out</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">out</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">6556</span> <span class="o">+</span> <span class="mf">4.33</span> <span class="ow">and</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">6556</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">4.33</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="n">out</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                        <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                        <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">6556</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">4.33</span> <span class="ow">and</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">6556</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="mf">4.33</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="n">out</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                        <span class="n">out</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">out</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">return</span> <span class="n">out</span>

</div>
<div class="viewcode-block" id="check_dtobs"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.check_dtobs">[docs]</a><span class="k">def</span> <span class="nf">check_dtobs</span><span class="p">(</span><span class="n">dtobs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check if the dtobs fits the float format. Required for MJD calc. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">dtobs</span><span class="p">:</span>
        <span class="n">dtobs</span> <span class="o">=</span> <span class="n">dtobs</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">tobs</span><span class="p">,</span> <span class="n">dtobs</span> <span class="o">=</span> <span class="n">dtobs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;T&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tobs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">dtobs</span><span class="p">,</span> <span class="n">tobs</span> <span class="o">=</span> <span class="n">tobs</span><span class="p">,</span> <span class="n">dtobs</span>
        <span class="n">tobs</span> <span class="o">=</span> <span class="n">tobs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
        <span class="n">tobs</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tobs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">tobs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">tobs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">tobs</span> <span class="o">/=</span> <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tobs</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="n">dtobs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">:</span>
        <span class="n">dtobs</span> <span class="o">=</span> <span class="n">dtobs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dtobs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
        <span class="n">dtobs</span> <span class="o">=</span> <span class="n">dtobs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR! Wrong &quot;DATE-OBS&quot; in header! {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtobs</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dtobs</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dtobs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;int32&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dtobs</span><span class="p">,</span> <span class="n">tobs</span>


<span class="c"># TODO: Check if obsolete</span></div>
<div class="viewcode-block" id="overplotsubdirs"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.overplotsubdirs">[docs]</a><span class="k">def</span> <span class="nf">overplotsubdirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mi">6540</span><span class="p">,</span> <span class="mi">6600</span><span class="p">),</span> <span class="n">showleg</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Realiza o plot de espectros da estrela `star` dentre do diretorio `path`.</span>
<span class="sd">    Atualmente, faz o plot entre os valores `limits` (Angstroms).</span>

<span class="sd">    Gera os arquivos `path/star/star.log` e `path/star/star_specs.png`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># path = _os.getcwd()</span>
    <span class="c"># star = raw_input(&#39;Type the star name: &#39;)</span>
    <span class="c"># ref0 = 6540</span>
    <span class="c"># ref1 = 6600</span>

    <span class="n">ref0</span><span class="p">,</span> <span class="n">ref1</span> <span class="o">=</span> <span class="n">limits</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">)):</span>
        <span class="n">_os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;mkdir {0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">))</span>
    <span class="n">f0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;{0}/{1}/{1}.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>

    <span class="n">nights</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">_os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span>
        <span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">o</span><span class="p">))]</span>

    <span class="n">legendl</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">night</span> <span class="ow">in</span> <span class="n">nights</span><span class="p">:</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">_os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">))</span> <span class="k">if</span>
            <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">o</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">star</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">scal</span> <span class="o">=</span> <span class="n">_glob</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/*.cal.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scal</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>            
                    <span class="n">srv</span> <span class="o">=</span> <span class="n">_glob</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/*.rv.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">srv</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scal</span><span class="p">):</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Specs without dopcor at </span><span class="si">%s</span><span class="s">!&#39;</span> <span class="o">%</span> <span class="n">night</span><span class="p">)</span>
                        <span class="n">srv</span> <span class="o">=</span> <span class="n">scal</span>
                    <span class="c"># legendl += (night,)</span>
                    <span class="k">for</span> <span class="n">cal</span> <span class="ow">in</span> <span class="n">scal</span><span class="p">:</span>              
                        <span class="n">imfits</span> <span class="o">=</span> <span class="n">_pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cal</span><span class="p">)</span>
                        <span class="n">spec</span> <span class="o">=</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                        <span class="n">lbda</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span> <span class="o">*</span> \
                            <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">+</span> \
                            <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;CRVAL1&#39;</span><span class="p">]</span>
                        <span class="c"># a = raw_input(&#39;type to continue: &#39;)</span>
                        <span class="k">if</span> <span class="n">lbda</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">6560</span><span class="p">:</span>  <span class="c"># and flag == &#39;1&#39;:</span>
                            <span class="n">min_dif</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lbda</span> <span class="o">-</span> <span class="n">ref0</span><span class="p">))</span>
                            <span class="n">a0</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lbda</span> <span class="o">-</span> <span class="n">ref0</span><span class="p">)</span> <span class="o">==</span> <span class="n">min_dif</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">min_dif</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lbda</span> <span class="o">-</span> <span class="n">ref1</span><span class="p">))</span>
                            <span class="n">a1</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lbda</span> <span class="o">-</span> <span class="n">ref1</span><span class="p">)</span> <span class="o">==</span> <span class="n">min_dif</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">spec</span> <span class="o">=</span> <span class="n">normalize_range</span><span class="p">(</span><span class="n">lbda</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;{0}, {1}, {2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">i</span><span class="p">),</span> <span class="n">night</span><span class="p">,</span> <span class="n">cal</span><span class="p">)</span>
                            <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="n">f0</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">leg</span> <span class="o">=</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;DATE-OBS&#39;</span><span class="p">]</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">leg</span> <span class="o">=</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;FRAME&#39;</span><span class="p">]</span>
                            <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lbda</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                                <span class="n">color</span><span class="o">=</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> 
                                    <span class="nb">len</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">))])</span>
                            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Data not reduced for </span><span class="si">%s</span><span class="s"> at </span><span class="si">%s</span><span class="s">!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">night</span><span class="p">))</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;{0}, {1}, {2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;NC&#39;</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="s">&#39;None&#39;</span><span class="p">)</span>
                    <span class="n">f0</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">showleg</span><span class="p">:</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">.</span><span class="mo">05</span><span class="p">),</span> <span class="n">labelspacing</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">legend</span><span class="o">.</span><span class="n">get_texts</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="s">&#39;small&#39;</span><span class="p">)</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">ref0</span><span class="p">,</span> <span class="n">ref1</span><span class="p">])</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
    <span class="c"># _plt.xlabel(&#39;vel. (km/s)&#39;)</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}/{1}/{1}_specs.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">))</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">f0</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c"># </span>
    <span class="c"># Ha = False # False do HeI 6678</span>
    <span class="c"># </span>
    <span class="c"># for i in range(len(ifits)):</span>
    <span class="c">#     imfits = _pyfits.open(ifits[i])</span>
    <span class="c">#     print imfits[0].header[3]</span>
    <span class="c">#     specs[i][:len(imfits[0].data)] = imfits[0].data</span>
    <span class="c">#     lbds[i] = _np.arange(len(specs[i]))*imfits[0].header[&#39;CDELT1&#39;]+</span>
    <span class="c">#       imfits[0].header[&#39;CRVAL1&#39;]</span>
    <span class="c">#     if Ha:</span>
    <span class="c">#         if i == 0:</span>
    <span class="c">#             lbds[i] = (lbds[i]-6561.5)/6561.5*3e5</span>
    <span class="c">#         else:</span>
    <span class="c">#             lbds[i] = (lbds[i]-6562.8)/6562.8*3e5</span>
    <span class="c">#     else:</span>
    <span class="c">#         if i == 0:</span>
    <span class="c">#             lbds[i] = (lbds[i]-6676.8)/6676.8*3e5</span>
    <span class="c">#         else:        </span>
    <span class="c">#             lbds[i] = (lbds[i]-6678.)/6678.*3e5</span>
    <span class="c">#     </span>
    <span class="c">#     a = _np.where( abs(lbds[i]+1000) ==  min(abs(lbds[i]+1000)) )</span>
    <span class="c">#     b = _np.where( abs(lbds[i]-1000) ==  min(abs(lbds[i]-1000)) )</span>
    <span class="c">#     </span>
    <span class="c">#     specs[i] = normalize_range(lbds[i],specs[i],a,b)</span>
    <span class="c">#     </span>
    <span class="c">#     legendl += [imfits[0].header[&#39;DATE-OBS&#39;]]</span>
    <span class="c"># </span>
    <span class="c"># figure(2)</span>
    <span class="c"># for i in range(len(specs)):</span>
    <span class="c">#     plot(lbds[i], specs[i], label=legendl[i])</span>
    <span class="c"># </span>
    <span class="c"># legend(legendl, &#39;lower right&#39;)</span>
    <span class="c"># legend(bbox_to_anchor=(1.05, 1), loc=2, borderaxespad=0.) #&#39;lower right&#39;</span>
    <span class="c"># xlim([-1000,1000])</span>
    <span class="c"># if Ha:</span>
    <span class="c">#     title(&#39;Halpha profile from LNA-Janot for Achernar&#39;)</span>
    <span class="c">#     ylim([.65,1.1])</span>
    <span class="c"># else:</span>
    <span class="c">#     title(&#39;HeI 6678 profile from LNA-Janot for Achernar&#39;)</span>
    <span class="c">#     ylim([.9,1.05])</span>
    <span class="c"># </span>
    <span class="c"># legend = _plt.legend(legendl, loc=(0.75, .05), labelspacing=0.1)</span>
    <span class="c"># _plt.setp(legend.get_texts(),  fontsize=&#39;small&#39;)</span>
    <span class="c"># </span>
    <span class="c"># xlabel(&#39;vel. (km/s)&#39;)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Plot done!&#39;</span><span class="p">)</span>
    <span class="k">return</span>

</div>
<div class="viewcode-block" id="diffplotsubdirs"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.diffplotsubdirs">[docs]</a><span class="k">def</span> <span class="nf">diffplotsubdirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mi">6540</span><span class="p">,</span> <span class="mi">6600</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Realiza o plot de espectros da estrela `star` dentre do diretorio `path`.</span>
<span class="sd">    Atualmente, faz o plot entre os valores `limits` (Angstroms).</span>

<span class="sd">    Gera os arquivos `path/star/star.log` e `path/star/star_specs_dif.png`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ref0</span><span class="p">,</span> <span class="n">ref1</span> <span class="o">=</span> <span class="n">limits</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">)):</span>
        <span class="n">_os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;mkdir {0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">))</span>
    <span class="n">f0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;{0}/{1}/{1}.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>

    <span class="n">nights</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">_os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span>
        <span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">o</span><span class="p">))]</span>    

    <span class="n">legendl</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">night</span> <span class="ow">in</span> <span class="n">nights</span><span class="p">:</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">_os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">))</span> <span class="k">if</span> 
            <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">o</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">star</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">scal</span> <span class="o">=</span> <span class="n">_glob</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/*.cal.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scal</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>            
                    <span class="n">srv</span> <span class="o">=</span> <span class="n">_glob</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/*.rv.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">srv</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scal</span><span class="p">):</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Specs with dopcor at </span><span class="si">%s</span><span class="s">!&#39;</span> <span class="o">%</span> <span class="n">night</span><span class="p">)</span>
                        <span class="n">srv</span> <span class="o">=</span> <span class="n">scal</span>
                    <span class="c"># legendl += (night,)</span>
                    <span class="k">for</span> <span class="n">cal</span> <span class="ow">in</span> <span class="n">scal</span><span class="p">:</span>              
                        <span class="n">imfits</span> <span class="o">=</span> <span class="n">_pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cal</span><span class="p">)</span>
                        <span class="n">spec</span> <span class="o">=</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                        <span class="n">lbda</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span> <span class="o">*</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span>\
                            <span class="n">header</span><span class="p">[</span><span class="s">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;CRVAL1&#39;</span><span class="p">]</span>
                        <span class="c"># a = raw_input(&#39;type to continue: &#39;)</span>
                        <span class="k">if</span> <span class="n">lbda</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5500</span><span class="p">:</span>  <span class="c"># and flag == &#39;1&#39;:</span>
                            <span class="n">min_dif</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lbda</span> <span class="o">-</span> <span class="n">ref0</span><span class="p">))</span>
                            <span class="n">a0</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lbda</span> <span class="o">-</span> <span class="n">ref0</span><span class="p">)</span> <span class="o">==</span> <span class="n">min_dif</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">min_dif</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lbda</span> <span class="o">-</span> <span class="n">ref1</span><span class="p">))</span>
                            <span class="n">a1</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lbda</span> <span class="o">-</span> <span class="n">ref1</span><span class="p">)</span> <span class="o">==</span> <span class="n">min_dif</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">spec</span> <span class="o">=</span> <span class="n">normalize_range</span><span class="p">(</span><span class="n">lbda</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span> <span class="o">+</span> \
                                <span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
                            <span class="k">print</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">leg</span> <span class="o">=</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;DATE-OBS&#39;</span><span class="p">]</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">leg</span> <span class="o">=</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;FRAME&#39;</span><span class="p">]</span>
                            <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">ref0</span><span class="p">,</span> <span class="n">ref1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">i</span><span class="p">],</span> 
                                <span class="s">&#39;k--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                            <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lbda</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg</span><span class="p">,</span> 
                                <span class="n">color</span><span class="o">=</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Data not reduced for </span><span class="si">%s</span><span class="s"> at </span><span class="si">%s</span><span class="s">!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">night</span><span class="p">))</span>

    <span class="n">legend</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">.</span><span class="mo">05</span><span class="p">),</span> <span class="n">labelspacing</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">legend</span><span class="o">.</span><span class="n">get_texts</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="s">&#39;small&#39;</span><span class="p">)</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">ref0</span><span class="p">,</span> <span class="n">ref1</span><span class="p">])</span>
    <span class="c"># _plt.xlabel(&#39;vel. (km/s)&#39;)</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}/{1}/{1}_specs_dif.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">))</span>

    <span class="c"># </span>
    <span class="c"># Ha = False # False do HeI 6678</span>
    <span class="c"># </span>
    <span class="c"># for i in range(len(ifits)):</span>
    <span class="c">#     imfits = _pyfits.open(ifits[i])</span>
    <span class="c">#     print imfits[0].header[3]</span>
    <span class="c">#     specs[i][:len(imfits[0].data)] = imfits[0].data</span>
    <span class="c">#     lbds[i] = _np.arange(len(specs[i]))*imfits[0].header[&#39;CDELT1&#39;]+</span>
    <span class="c">#       imfits[0].header[&#39;CRVAL1&#39;]</span>
    <span class="c">#     if Ha:</span>
    <span class="c">#         if i == 0:</span>
    <span class="c">#             lbds[i] = (lbds[i]-6561.5)/6561.5*3e5</span>
    <span class="c">#         else:</span>
    <span class="c">#             lbds[i] = (lbds[i]-6562.8)/6562.8*3e5</span>
    <span class="c">#     else:</span>
    <span class="c">#         if i == 0:</span>
    <span class="c">#             lbds[i] = (lbds[i]-6676.8)/6676.8*3e5</span>
    <span class="c">#         else:        </span>
    <span class="c">#             lbds[i] = (lbds[i]-6678.)/6678.*3e5</span>
    <span class="c">#     </span>
    <span class="c">#     a = _np.where( abs(lbds[i]+1000) ==  min(abs(lbds[i]+1000)) )</span>
    <span class="c">#     b = _np.where( abs(lbds[i]-1000) ==  min(abs(lbds[i]-1000)) )</span>
    <span class="c">#     </span>
    <span class="c">#     specs[i] = normalize_range(lbds[i],specs[i],a,b)</span>
    <span class="c">#     </span>
    <span class="c">#     legendl += [imfits[0].header[&#39;DATE-OBS&#39;]]</span>
    <span class="c"># </span>
    <span class="c"># figure(2)</span>
    <span class="c"># for i in range(len(specs)):</span>
    <span class="c">#     plot(lbds[i], specs[i], label=legendl[i])</span>
    <span class="c"># </span>
    <span class="c"># legend(legendl, &#39;lower right&#39;)</span>
    <span class="c"># legend(bbox_to_anchor=(1.05, 1), loc=2, borderaxespad=0.) #&#39;lower right&#39;</span>
    <span class="c"># xlim([-1000,1000])</span>
    <span class="c"># if Ha:</span>
    <span class="c">#     title(&#39;Halpha profile from LNA-Janot for Achernar&#39;)</span>
    <span class="c">#     ylim([.65,1.1])</span>
    <span class="c"># else:</span>
    <span class="c">#     title(&#39;HeI 6678 profile from LNA-Janot for Achernar&#39;)</span>
    <span class="c">#     ylim([.9,1.05])</span>
    <span class="c"># </span>
    <span class="c"># legend = _plt.legend(legendl, loc=(0.75, .05), labelspacing=0.1)</span>
    <span class="c"># _plt.setp(legend.get_texts(),  fontsize=&#39;small&#39;)</span>
    <span class="c"># </span>
    <span class="c"># xlabel(&#39;vel. (km/s)&#39;)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Plot done!&#39;</span><span class="p">)</span>
    <span class="k">return</span>

</div>
<div class="viewcode-block" id="refplotsubdirs"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.refplotsubdirs">[docs]</a><span class="k">def</span> <span class="nf">refplotsubdirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mi">6540</span><span class="p">,</span> <span class="mi">6600</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Realiza o plot de espectros da estrela `star` dentre do diretorio `path`.</span>
<span class="sd">    Atualmente, faz o plot entre os valores `limits` (Angstroms).</span>

<span class="sd">    Gera os arquivos `path/star/star.log` e </span>
<span class="sd">    `path/star/star_specs_REFERENCIA.png`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ref0</span><span class="p">,</span> <span class="n">ref1</span> <span class="o">=</span> <span class="n">limits</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">)):</span>
        <span class="n">_os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;mkdir {0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">))</span>
    <span class="n">f0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;{0}/{1}/{1}.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>

    <span class="n">nights</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">_os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> 
        <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">o</span><span class="p">))]</span>

    <span class="n">legendl</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">night</span> <span class="ow">in</span> <span class="n">nights</span><span class="p">:</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">_os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">))</span> <span class="k">if</span> 
            <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">o</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">star</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">scal</span> <span class="o">=</span> <span class="n">_glob</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/*.cal.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scal</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>            
                    <span class="n">srv</span> <span class="o">=</span> <span class="n">_glob</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/*.rv.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">srv</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scal</span><span class="p">):</span>
                        <span class="n">srv</span> <span class="o">=</span> <span class="n">scal</span>
                    <span class="k">for</span> <span class="n">cal</span> <span class="ow">in</span> <span class="n">scal</span><span class="p">:</span>              
                        <span class="n">imfits</span> <span class="o">=</span> <span class="n">_pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cal</span><span class="p">)</span>
                        <span class="n">spec</span> <span class="o">=</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                        <span class="n">lbda</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span> <span class="o">*</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span>\
                            <span class="n">header</span><span class="p">[</span><span class="s">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;CRVAL1&#39;</span><span class="p">]</span>
                        <span class="c"># a = raw_input(&#39;type to continue: &#39;)</span>
                        <span class="k">if</span> <span class="n">lbda</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5500</span><span class="p">:</span>  <span class="c"># and flag == &#39;1&#39;:</span>
                            <span class="n">min_dif</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lbda</span> <span class="o">-</span> <span class="n">ref0</span><span class="p">))</span>
                            <span class="n">a0</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lbda</span> <span class="o">-</span> <span class="n">ref0</span><span class="p">)</span> <span class="o">==</span> <span class="n">min_dif</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">min_dif</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lbda</span> <span class="o">-</span> <span class="n">ref1</span><span class="p">))</span>
                            <span class="n">a1</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lbda</span> <span class="o">-</span> <span class="n">ref1</span><span class="p">)</span> <span class="o">==</span> <span class="n">min_dif</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">spec</span> <span class="o">=</span> <span class="n">normalize_range</span><span class="p">(</span><span class="n">lbda</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>
                            <span class="k">print</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
                            <span class="n">leg</span> <span class="o">=</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;DATE-OBS&#39;</span><span class="p">]</span>
                            <span class="n">refleg</span> <span class="o">=</span> <span class="s">&#39;2012-11-20T23:51:37.392&#39;</span>
                            <span class="n">refleg</span> <span class="o">=</span> <span class="s">&#39;2008-06-13&#39;</span>
                            <span class="k">if</span> <span class="n">leg</span> <span class="o">==</span> <span class="n">refleg</span><span class="p">:</span>
                                <span class="n">f0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;{0}/{1}/ref.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">),</span>
                                    <span class="s">&#39;w&#39;</span><span class="p">)</span>
                                <span class="n">f0</span><span class="o">.</span><span class="n">writelines</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lbda</span><span class="p">])</span>
                                <span class="n">f0</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                                <span class="n">f0</span><span class="o">.</span><span class="n">writelines</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">])</span>
                                <span class="n">f0</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                                <span class="n">f0</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Data not reduced for </span><span class="si">%s</span><span class="s"> at </span><span class="si">%s</span><span class="s">!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">night</span><span class="p">))</span>

    <span class="n">f0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;{0}/{1}/ref.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">))</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">f0</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">f0</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">specref</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">lbdaref</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">_interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">lbdaref</span><span class="p">,</span> <span class="n">specref</span><span class="p">)</span>  <span class="c"># , kind=&#39;cubic&#39;)</span>
    <span class="n">lbdaref</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ref0</span><span class="p">,</span> <span class="n">ref1</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span>
    <span class="n">specref</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">lbdaref</span><span class="p">)</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">night</span> <span class="ow">in</span> <span class="n">nights</span><span class="p">:</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">_os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">))</span> <span class="k">if</span>
            <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">o</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">star</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">scal</span> <span class="o">=</span> <span class="n">_glob</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/*.cal.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scal</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>            
                    <span class="n">srv</span> <span class="o">=</span> <span class="n">_glob</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/*.rv.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">srv</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scal</span><span class="p">):</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Specs without dopcor at </span><span class="si">%s</span><span class="s">!&#39;</span> <span class="o">%</span> <span class="n">night</span><span class="p">)</span>
                        <span class="n">srv</span> <span class="o">=</span> <span class="n">scal</span>
                    <span class="c"># legendl += (night,)</span>
                    <span class="k">for</span> <span class="n">cal</span> <span class="ow">in</span> <span class="n">scal</span><span class="p">:</span>              
                        <span class="n">imfits</span> <span class="o">=</span> <span class="n">_pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cal</span><span class="p">)</span>
                        <span class="n">spec</span> <span class="o">=</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                        <span class="n">lbda</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span> <span class="o">*</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span>\
                            <span class="n">header</span><span class="p">[</span><span class="s">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;CRVAL1&#39;</span><span class="p">]</span>
                        <span class="c"># a = raw_input(&#39;type to continue: &#39;)</span>
                        <span class="k">if</span> <span class="n">lbda</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5500</span><span class="p">:</span>  <span class="c"># and flag == &#39;1&#39;:</span>
                            <span class="n">min_dif</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lbda</span> <span class="o">-</span> <span class="n">ref0</span><span class="p">))</span>
                            <span class="n">a0</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lbda</span> <span class="o">-</span> <span class="n">ref0</span><span class="p">)</span> <span class="o">==</span> <span class="n">min_dif</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">min_dif</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lbda</span> <span class="o">-</span> <span class="n">ref1</span><span class="p">))</span>
                            <span class="n">a1</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lbda</span> <span class="o">-</span> <span class="n">ref1</span><span class="p">)</span> <span class="o">==</span> <span class="n">min_dif</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">spec</span> <span class="o">=</span> <span class="n">normalize_range</span><span class="p">(</span><span class="n">lbda</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>
                            <span class="n">func</span> <span class="o">=</span> <span class="n">_interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">lbda</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>  
                            <span class="c"># , kind=&#39;cubic&#39;)</span>
                            <span class="c"># Tive problemas de &#39;out-of-bounds&#39;... um espectro </span>
                            <span class="c"># estava desordenado:</span>
                            <span class="c"># print imfits[0].header[&#39;CDELT1&#39;], </span>
                            <span class="c"># imfits[0].header[&#39;CRVAL1&#39;], cal</span>
                            <span class="n">spec</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">lbdaref</span><span class="p">)</span>
                            <span class="k">print</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">leg</span> <span class="o">=</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;DATE-OBS&#39;</span><span class="p">]</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">leg</span> <span class="o">=</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;FRAME&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">130</span><span class="p">:</span>
                                <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lbdaref</span><span class="p">,</span> <span class="n">spec</span> <span class="o">-</span> <span class="n">specref</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg</span><span class="p">,</span> 
                                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Data not reduced for </span><span class="si">%s</span><span class="s"> at </span><span class="si">%s</span><span class="s">!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">night</span><span class="p">))</span>

    <span class="n">legend</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">.</span><span class="mo">05</span><span class="p">),</span> <span class="n">labelspacing</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">legend</span><span class="o">.</span><span class="n">get_texts</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="s">&#39;small&#39;</span><span class="p">)</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">ref0</span><span class="p">,</span> <span class="n">ref1</span><span class="p">])</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Ref.= </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">refleg</span><span class="p">)</span>
    <span class="c"># _plt.xlabel(&#39;vel. (km/s)&#39;)</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}/{1}/{1}_specs_{2}.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">refleg</span><span class="p">[:</span><span class="mi">10</span><span class="p">]))</span>

    <span class="c"># </span>
    <span class="c"># Ha = False # False do HeI 6678</span>
    <span class="c"># </span>
    <span class="c"># for i in range(len(ifits)):</span>
    <span class="c">#     imfits = _pyfits.open(ifits[i])</span>
    <span class="c">#     print imfits[0].header[3]</span>
    <span class="c">#     specs[i][:len(imfits[0].data)] = imfits[0].data</span>
    <span class="c">#     lbds[i] = _np.arange(len(specs[i]))*imfits[0].header[&#39;CDELT1&#39;]+\</span>
    <span class="c">#          imfits[0].header[&#39;CRVAL1&#39;]</span>
    <span class="c">#     if Ha:</span>
    <span class="c">#         if i == 0:</span>
    <span class="c">#             lbds[i] = (lbds[i]-6561.5)/6561.5*3e5</span>
    <span class="c">#         else:</span>
    <span class="c">#             lbds[i] = (lbds[i]-6562.8)/6562.8*3e5</span>
    <span class="c">#     else:</span>
    <span class="c">#         if i == 0:</span>
    <span class="c">#             lbds[i] = (lbds[i]-6676.8)/6676.8*3e5</span>
    <span class="c">#         else:        </span>
    <span class="c">#             lbds[i] = (lbds[i]-6678.)/6678.*3e5</span>
    <span class="c">#     </span>
    <span class="c">#     a = _np.where( abs(lbds[i]+1000) ==  min(abs(lbds[i]+1000)) )</span>
    <span class="c">#     b = _np.where( abs(lbds[i]-1000) ==  min(abs(lbds[i]-1000)) )</span>
    <span class="c">#     </span>
    <span class="c">#     specs[i] = normalize_range(lbds[i],specs[i],a,b)</span>
    <span class="c">#     </span>
    <span class="c">#     legendl += [imfits[0].header[&#39;DATE-OBS&#39;]]</span>
    <span class="c"># </span>
    <span class="c"># figure(2)</span>
    <span class="c"># for i in range(len(specs)):</span>
    <span class="c">#     plot(lbds[i], specs[i], label=legendl[i])</span>
    <span class="c"># </span>
    <span class="c"># legend(legendl, &#39;lower right&#39;)</span>
    <span class="c"># legend(bbox_to_anchor=(1.05, 1), loc=2, borderaxespad=0.) #&#39;lower right&#39;</span>
    <span class="c"># xlim([-1000,1000])</span>
    <span class="c"># if Ha:</span>
    <span class="c">#     title(&#39;Halpha profile from LNA-Janot for Achernar&#39;)</span>
    <span class="c">#     ylim([.65,1.1])</span>
    <span class="c"># else:</span>
    <span class="c">#     title(&#39;HeI 6678 profile from LNA-Janot for Achernar&#39;)</span>
    <span class="c">#     ylim([.9,1.05])</span>
    <span class="c"># </span>
    <span class="c"># legend = _plt.legend(legendl, loc=(0.75, .05), labelspacing=0.1)</span>
    <span class="c"># _plt.setp(legend.get_texts(),  fontsize=&#39;small&#39;)</span>
    <span class="c"># </span>
    <span class="c"># xlabel(&#39;vel. (km/s)&#39;)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Plot done!&#39;</span><span class="p">)</span>
    <span class="k">return</span>

</div>
<div class="viewcode-block" id="overplotsubdirs2"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.overplotsubdirs2">[docs]</a><span class="k">def</span> <span class="nf">overplotsubdirs2</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mi">6540</span><span class="p">,</span> <span class="mi">6600</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Realiza o plot de espectros da estrela `star` dentre do diretorio `path`.</span>
<span class="sd">    Atualmente, faz o plot entre os valores `limits` (Angstroms).</span>

<span class="sd">    Ha&#39; um criterio de escolha de espectros aqui (rudimentar).</span>

<span class="sd">    Gera os arquivos `path/star/star.log` e `path/star/star_specs2.png`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ref0</span><span class="p">,</span> <span class="n">ref1</span> <span class="o">=</span> <span class="n">limits</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">)):</span>
        <span class="n">_os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;mkdir {0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">))</span>
    <span class="n">f0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;{0}/{1}/{1}.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>

    <span class="n">nights</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">_os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span>
        <span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">o</span><span class="p">))]</span>

    <span class="n">legendl</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">night</span> <span class="ow">in</span> <span class="n">nights</span><span class="p">:</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">_os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">))</span> <span class="k">if</span> 
            <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">o</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">star</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">scal</span> <span class="o">=</span> <span class="n">_glob</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/*.cal.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scal</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>            
                    <span class="n">srv</span> <span class="o">=</span> <span class="n">_glob</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/*.rv.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">srv</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scal</span><span class="p">):</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Specs without dopcor at </span><span class="si">%s</span><span class="s">!&#39;</span> <span class="o">%</span> <span class="n">night</span><span class="p">)</span>
                        <span class="n">srv</span> <span class="o">=</span> <span class="n">scal</span>
                    <span class="c"># legendl += (night,)</span>
                    <span class="k">for</span> <span class="n">cal</span> <span class="ow">in</span> <span class="n">scal</span><span class="p">:</span>              
                        <span class="n">imfits</span> <span class="o">=</span> <span class="n">_pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cal</span><span class="p">)</span>
                        <span class="n">spec</span> <span class="o">=</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                        <span class="n">lbda</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span> <span class="o">*</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span>\
                            <span class="n">header</span><span class="p">[</span><span class="s">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;CRVAL1&#39;</span><span class="p">]</span>
                        <span class="c"># a = raw_input(&#39;type to continue: &#39;)</span>
                        <span class="k">if</span> <span class="n">lbda</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5500</span><span class="p">:</span>  <span class="c"># and flag == &#39;1&#39;:</span>
                            <span class="n">min_dif</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lbda</span> <span class="o">-</span> <span class="n">ref0</span><span class="p">))</span>
                            <span class="n">a0</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lbda</span> <span class="o">-</span> <span class="n">ref0</span><span class="p">)</span> <span class="o">==</span> <span class="n">min_dif</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">min_dif</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lbda</span> <span class="o">-</span> <span class="n">ref1</span><span class="p">))</span>
                            <span class="n">a1</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lbda</span> <span class="o">-</span> <span class="n">ref1</span><span class="p">)</span> <span class="o">==</span> <span class="n">min_dif</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">spec</span> <span class="o">=</span> <span class="n">normalize_range</span><span class="p">(</span><span class="n">lbda</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>
                            <span class="k">print</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">i</span><span class="p">),</span> <span class="n">night</span>
                            <span class="n">prtcolor</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">leg</span> <span class="o">=</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;DATE-OBS&#39;</span><span class="p">]</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">leg</span> <span class="o">=</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;FRAME&#39;</span><span class="p">]</span>
                            <span class="n">check</span> <span class="o">=</span> <span class="bp">False</span>
                            <span class="k">if</span> <span class="n">leg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;2012-11-20T23:51:37.392&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                <span class="n">leg</span> <span class="o">=</span> <span class="s">&#39;2012-11-20&#39;</span>
                                <span class="n">prtcolor</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">check</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="k">elif</span> <span class="n">leg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;22/01/2013&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                <span class="n">leg</span> <span class="o">=</span> <span class="s">&#39;2013-01-22&#39;</span>
                                <span class="n">check</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="c"># elif leg.find(&#39;03/07/2013&#39;) != -1:</span>
                            <span class="c">#     leg = &#39;2013-07-03&#39;</span>
                            <span class="c">#     check = True</span>
                            <span class="k">elif</span> <span class="n">leg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;28/07/2013&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                <span class="n">leg</span> <span class="o">=</span> <span class="s">&#39;2013-07-28&#39;</span>
                                <span class="n">check</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="k">elif</span> <span class="n">leg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;2013-11-12T01:30:38.938&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                <span class="n">leg</span> <span class="o">=</span> <span class="s">&#39;2013-11-12&#39;</span>
                                <span class="n">check</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">print</span><span class="p">(</span><span class="n">leg</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
                                <span class="k">print</span><span class="p">(</span><span class="n">cal</span><span class="p">)</span>
                                <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lbda</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> 
                                    <span class="n">color</span><span class="o">=</span><span class="n">prtcolor</span><span class="p">)</span>
                            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;# Data not reduced for </span><span class="si">%s</span><span class="s"> at </span><span class="si">%s</span><span class="s">!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">night</span><span class="p">)</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">f0</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">font</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="p">}</span>

    <span class="n">legend</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">.</span><span class="mo">05</span><span class="p">),</span> <span class="n">labelspacing</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="c"># _plt.setp(legend.get_texts(),  fontsize=&#39;small&#39;)</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">ref0</span><span class="p">,</span> <span class="n">ref1</span><span class="p">])</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">.</span><span class="mi">58</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">])</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">r&#39;wavelength ($\AA$)&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Normalized flux&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
    <span class="c"># _plt.xlabel(&#39;vel. (km/s)&#39;)</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}/{1}/{1}_specs2.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">))</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">f0</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c"># </span>
    <span class="c"># Ha = False # False do HeI 6678</span>
    <span class="c"># </span>
    <span class="c"># for i in range(len(ifits)):</span>
    <span class="c">#     imfits = _pyfits.open(ifits[i])</span>
    <span class="c">#     print imfits[0].header[3]</span>
    <span class="c">#     specs[i][:len(imfits[0].data)] = imfits[0].data</span>
    <span class="c">#     lbds[i] = _np.arange(len(specs[i]))*imfits[0].header[&#39;CDELT1&#39;]+</span>
    <span class="c">#           imfits[0].header[&#39;CRVAL1&#39;]</span>
    <span class="c">#     if Ha:</span>
    <span class="c">#         if i == 0:</span>
    <span class="c">#             lbds[i] = (lbds[i]-6561.5)/6561.5*3e5</span>
    <span class="c">#         else:</span>
    <span class="c">#             lbds[i] = (lbds[i]-6562.8)/6562.8*3e5</span>
    <span class="c">#     else:</span>
    <span class="c">#         if i == 0:</span>
    <span class="c">#             lbds[i] = (lbds[i]-6676.8)/6676.8*3e5</span>
    <span class="c">#         else:        </span>
    <span class="c">#             lbds[i] = (lbds[i]-6678.)/6678.*3e5</span>
    <span class="c">#     </span>
    <span class="c">#     a = _np.where( abs(lbds[i]+1000) ==  min(abs(lbds[i]+1000)) )</span>
    <span class="c">#     b = _np.where( abs(lbds[i]-1000) ==  min(abs(lbds[i]-1000)) )</span>
    <span class="c">#     </span>
    <span class="c">#     specs[i] = normalize_range(lbds[i],specs[i],a,b)</span>
    <span class="c">#     </span>
    <span class="c">#     legendl += [imfits[0].header[&#39;DATE-OBS&#39;]]</span>
    <span class="c"># </span>
    <span class="c"># figure(2)</span>
    <span class="c"># for i in range(len(specs)):</span>
    <span class="c">#     plot(lbds[i], specs[i], label=legendl[i])</span>
    <span class="c"># </span>
    <span class="c"># legend(legendl, &#39;lower right&#39;)</span>
    <span class="c"># legend(bbox_to_anchor=(1.05, 1), loc=2, borderaxespad=0.) #&#39;lower right&#39;</span>
    <span class="c"># xlim([-1000,1000])</span>
    <span class="c"># if Ha:</span>
    <span class="c">#     title(&#39;Halpha profile from LNA-Janot for Achernar&#39;)</span>
    <span class="c">#     ylim([.65,1.1])</span>
    <span class="c"># else:</span>
    <span class="c">#     title(&#39;HeI 6678 profile from LNA-Janot for Achernar&#39;)</span>
    <span class="c">#     ylim([.9,1.05])</span>
    <span class="c"># </span>
    <span class="c"># legend = _plt.legend(legendl, loc=(0.75, .05), labelspacing=0.1)</span>
    <span class="c"># _plt.setp(legend.get_texts(),  fontsize=&#39;small&#39;)</span>
    <span class="c"># </span>
    <span class="c"># xlabel(&#39;vel. (km/s)&#39;)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Plot done!&#39;</span><span class="p">)</span>
    <span class="k">return</span>

</div>
<div class="viewcode-block" id="overPlotLineSeries"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.overPlotLineSeries">[docs]</a><span class="k">def</span> <span class="nf">overPlotLineSeries</span><span class="p">(</span><span class="n">fullseds</span><span class="p">,</span> <span class="n">obsers</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lbc</span><span class="o">=.</span><span class="mi">6564606</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;png&#39;</span><span class="p">],</span>
    <span class="n">convgauss</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">addsuf</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">ssize</span><span class="o">=.</span><span class="mo">05</span><span class="p">,</span>
    <span class="n">outpath</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">7</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">],</span> <span class="n">cmapn</span><span class="o">=</span><span class="s">&#39;gnuplot&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate overplot spec. line from a HDUST mod list, separated by</span>
<span class="sd">    observers.</span>

<span class="sd">    Observers config. must be the same between models in `fullseds` list.</span>

<span class="sd">    If `convgauss` &gt; 0, do a gaussian convolution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">fullseds</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">obsers</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">fig2</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">obsers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">fullseds</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">fullseds</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
            <span class="n">sed2data</span> <span class="o">=</span> <span class="n">_hdt</span><span class="o">.</span><span class="n">readfullsed2</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
            <span class="n">obsdegs</span> <span class="o">=</span> <span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">sed2data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="p">)[</span><span class="n">obsers</span><span class="p">]</span>
            <span class="n">obsdegs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">obsdegs</span><span class="p">)</span>
            <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">yo</span><span class="p">)</span> <span class="o">=</span> <span class="n">lineProf</span><span class="p">(</span><span class="n">sed2data</span><span class="p">[</span><span class="n">obs</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">sed2data</span><span class="p">[</span><span class="n">obs</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">],</span> 
                <span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="n">hwidth</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">convgauss</span><span class="p">,</span> <span class="n">ssize</span><span class="o">=</span><span class="n">ssize</span><span class="p">)</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="n">yo</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">if</span> <span class="n">convgauss</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">step</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span>
                <span class="n">xn</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">hwidth</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">convgauss</span><span class="p">,</span> <span class="n">hwidth</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">convgauss</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span>
                    <span class="n">step</span><span class="p">)</span>
                <span class="n">cf</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">normgauss</span><span class="p">(</span><span class="n">convgauss</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">xn</span><span class="p">)</span>
                <span class="n">yo</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xn</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">yo</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">xn</span>
                <span class="n">y1</span> <span class="o">=</span> <span class="n">yo</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">frac</span><span class="p">)</span>
                <span class="n">y2</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">yo</span> <span class="o">*</span> <span class="n">frac</span><span class="p">,</span> <span class="n">cf</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">cf</span><span class="p">),</span> <span class="s">&#39;same&#39;</span><span class="p">)</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> 
                    <span class="nb">len</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">))])</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> 
                    <span class="nb">len</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">))])</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">+</span> <span class="n">y2</span>
            <span class="c"># y = linfit(x, y1+y2)</span>
            <span class="k">if</span> <span class="nb">file</span> <span class="o">==</span> <span class="n">fullseds</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;{0:02.1f} deg. {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obsdegs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> 
                <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">color</span><span class="o">=</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">))])</span>
                <span class="c"># ew0 = EWcalc(x, y, vw=hwidth)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">))],</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="c"># ewf = EWcalc(x, y, vw=hwidth)</span>

        <span class="n">plot_line_str</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="n">ylim</span><span class="p">,</span> <span class="n">cmapn</span><span class="o">=</span><span class="n">cmapn</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="n">hwidth</span><span class="p">,</span> 
            <span class="n">hwidth</span><span class="p">])</span>
        <span class="n">figname</span> <span class="o">=</span> <span class="n">outpath</span> <span class="o">+</span> <span class="s">&#39;modsover_lbc{1:.4f}_obs{0:02.1f}{2}&#39;</span><span class="o">.</span>\
            <span class="n">format</span><span class="p">(</span><span class="n">obsdegs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">lbc</span><span class="p">,</span> <span class="n">addsuf</span><span class="p">)</span>
        <span class="n">_phc</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">figname</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>

        <span class="n">plot_line_str</span><span class="p">(</span><span class="n">fig2</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="n">ylim</span><span class="p">,</span> <span class="n">cmapn</span><span class="o">=</span><span class="n">cmapn</span><span class="p">,</span> 
            <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="n">hwidth</span><span class="p">,</span> <span class="n">hwidth</span><span class="p">])</span>
        <span class="n">figname</span> <span class="o">=</span> <span class="n">outpath</span> <span class="o">+</span> <span class="s">&#39;modsover_lbc{1:.4f}_obs{0:02.1f}{2}Extra&#39;</span><span class="o">.</span>\
            <span class="n">format</span><span class="p">(</span><span class="n">obsdegs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">lbc</span><span class="p">,</span> <span class="n">addsuf</span><span class="p">)</span>
        <span class="n">_phc</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">figname</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>

    <span class="k">return</span>

</div>
<div class="viewcode-block" id="overPlotLineFits"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.overPlotLineFits">[docs]</a><span class="k">def</span> <span class="nf">overPlotLineFits</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">lbc</span><span class="o">=.</span><span class="mi">6564606</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;png&#39;</span><span class="p">],</span> <span class="n">hwidth</span><span class="o">=</span><span class="mf">1500.</span><span class="p">,</span> 
    <span class="n">ylim</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">yzero</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">addsuf</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">dlim</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cmapn</span><span class="o">=</span><span class="s">&#39;jet&#39;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">outpath</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate overplot spec. line from a FITS file list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">specs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;# Reading {0}...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">trimpathname</span><span class="p">(</span><span class="n">spec</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">MJD</span><span class="p">,</span> <span class="n">dateobs</span><span class="p">,</span> <span class="n">datereduc</span><span class="p">,</span> <span class="n">fitsfile</span> <span class="o">=</span> <span class="n">loadfits</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">lineProf</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="n">hwidth</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dateobs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dateobs</span> <span class="o">=</span> <span class="n">dateobs</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">dateobs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dtobs</span> <span class="o">=</span> <span class="n">dateobs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dateobs</span> <span class="o">=</span> <span class="s">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dtobs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dlim</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cor</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">))]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cor</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">gradColor</span><span class="p">([</span><span class="n">MJD</span><span class="p">],</span> <span class="nb">min</span><span class="o">=</span><span class="n">dlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">dlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                <span class="n">cmapn</span><span class="o">=</span><span class="n">cmapn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dateobs</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">cor</span><span class="p">)</span>

    <span class="n">ylabel</span> <span class="o">=</span> <span class="s">&#39;Overplotted spectra&#39;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_line_str</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">,</span> 
        <span class="n">dlim</span><span class="o">=</span><span class="n">dlim</span><span class="p">,</span> <span class="n">cmapn</span><span class="o">=</span><span class="n">cmapn</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="n">ylim</span><span class="p">)</span>

    <span class="n">figname</span> <span class="o">=</span> <span class="n">outpath</span> <span class="o">+</span> <span class="s">&#39;fitsover_lbc{1:.4f}{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">addsuf</span><span class="p">,</span> <span class="n">lbc</span><span class="p">)</span>
    <span class="n">_phc</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">figname</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
    <span class="k">return</span>

</div>
<div class="viewcode-block" id="incrPlotLineSeries"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.incrPlotLineSeries">[docs]</a><span class="k">def</span> <span class="nf">incrPlotLineSeries</span><span class="p">(</span><span class="n">fullseds</span><span class="p">,</span> <span class="n">obsers</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lbc</span><span class="o">=.</span><span class="mi">6564606</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;png&#39;</span><span class="p">],</span> 
    <span class="n">addsuf</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">outpath</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate incremented spec. line from a HDUST mod list, separated by</span>
<span class="sd">    observers. The increment is 0.1 for each file in fullseds sequence.</span>

<span class="sd">    Observers config. must be the same between models in `fullseds` list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">obsers</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">obsers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">fullseds</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">fullseds</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
            <span class="n">sed2data</span> <span class="o">=</span> <span class="n">_hdt</span><span class="o">.</span><span class="n">readfullsed2</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
            <span class="n">obsdegs</span> <span class="o">=</span> <span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">sed2data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="p">)[</span><span class="n">obsers</span><span class="p">]</span>
            <span class="n">obsdegs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">obsdegs</span><span class="p">)</span>
            <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">lineProf</span><span class="p">(</span><span class="n">sed2data</span><span class="p">[</span><span class="n">obs</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">sed2data</span><span class="p">[</span><span class="n">obs</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">],</span> 
                <span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">file</span> <span class="o">==</span> <span class="n">fullseds</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;{0:02.1f} deg.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obsdegs</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span> 
                    <span class="n">color</span><span class="o">=</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">))])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> 
                    <span class="nb">len</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">))])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">u&#39;lbc = {0:.5f} $\mu$m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lbc</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">,</span> <span class="n">fancybox</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">figname</span> <span class="o">=</span> <span class="n">outpath</span> <span class="o">+</span> <span class="s">&#39;modsincr_lbc{1:.4f}_obs{0:02.1f}{2}&#39;</span><span class="o">.</span>\
            <span class="n">format</span><span class="p">(</span><span class="n">obsdegs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">lbc</span><span class="p">,</span> <span class="n">addsuf</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fmt</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Saved {1}.{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">figname</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figname</span> <span class="o">+</span> <span class="s">&#39;.{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">transparent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span>

</div>
<div class="viewcode-block" id="incrPlotLineFits"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.incrPlotLineFits">[docs]</a><span class="k">def</span> <span class="nf">incrPlotLineFits</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">lbc</span><span class="o">=.</span><span class="mi">6564606</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;png&#39;</span><span class="p">],</span> <span class="n">hwidth</span><span class="o">=</span><span class="mf">1500.</span><span class="p">,</span> 
    <span class="n">yzero</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">addsuf</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">dlim</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cmapn</span><span class="o">=</span><span class="s">&#39;jet&#39;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">outpath</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="n">ylim</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate incremented spec. line from FITS files list.</span>
<span class="sd">    The increment is 0.1 for each file in sequence.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">specs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;# Reading {0}...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">trimpathname</span><span class="p">(</span><span class="n">spec</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">MJD</span><span class="p">,</span> <span class="n">dateobs</span><span class="p">,</span> <span class="n">datereduc</span><span class="p">,</span> <span class="n">fitsfile</span> <span class="o">=</span> <span class="n">loadfits</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">lineProf</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="n">hwidth</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dateobs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dateobs</span> <span class="o">=</span> <span class="n">dateobs</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">dateobs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dtobs</span> <span class="o">=</span> <span class="n">dateobs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dateobs</span> <span class="o">=</span> <span class="s">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dtobs</span><span class="p">)</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">[</span><span class="s">&#39;-.&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;-&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">[</span><span class="s">&#39;-.&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">[</span><span class="s">&#39;-&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dlim</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cor</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">))]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cor</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">gradColor</span><span class="p">([</span><span class="n">MJD</span><span class="p">],</span> <span class="nb">min</span><span class="o">=</span><span class="n">dlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">dlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                <span class="n">cmapn</span><span class="o">=</span><span class="n">cmapn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dateobs</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">cor</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">yzero</span><span class="p">:</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ylim</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;Gray&#39;</span><span class="p">)</span>

    <span class="n">ylabel</span> <span class="o">=</span> <span class="s">&#39;Spaced spectra&#39;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_line_str</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">,</span> 
        <span class="n">dlim</span><span class="o">=</span><span class="n">dlim</span><span class="p">,</span> <span class="n">cmapn</span><span class="o">=</span><span class="n">cmapn</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="n">ylim</span><span class="p">)</span>

    <span class="n">figname</span> <span class="o">=</span> <span class="n">outpath</span> <span class="o">+</span> <span class="s">&#39;fitsincr_lbc{1:.4f}{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">addsuf</span><span class="p">,</span> <span class="n">lbc</span><span class="p">)</span>
    <span class="n">_phc</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">figname</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
    <span class="k">return</span>

</div>
<div class="viewcode-block" id="diffPlotLineSeries"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.diffPlotLineSeries">[docs]</a><span class="k">def</span> <span class="nf">diffPlotLineSeries</span><span class="p">(</span><span class="n">fullseds</span><span class="p">,</span> <span class="n">obsers</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lbc</span><span class="o">=.</span><span class="mi">6564606</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;png&#39;</span><span class="p">],</span> 
    <span class="n">rvel</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rflx</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">outpath</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">addsuf</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate overplot of DIFFERENCE spec. line from a HDUST mod list.</span>
<span class="sd">    The model will be linearly interpolated</span>
<span class="sd">    with the reference spec. If none is given as reference, </span>
<span class="sd">    then it assumes the first of the list.</span>

<span class="sd">    It is recommend to run first (rvel, rflx) =  lineProf(rvel, rflx,</span>
<span class="sd">    lbc=lbc, hwidth=hwidth).</span>

<span class="sd">    Observers config. must be the same between models in</span>
<span class="sd">    `fullseds` list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">obsers</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">obsers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">fullseds</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">fullseds</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
            <span class="n">sed2data</span> <span class="o">=</span> <span class="n">_hdt</span><span class="o">.</span><span class="n">readfullsed2</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
            <span class="n">obsdegs</span> <span class="o">=</span> <span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">sed2data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="p">)[</span><span class="n">obsers</span><span class="p">]</span>
            <span class="n">obsdegs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">obsdegs</span><span class="p">)</span>
            <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">lineProf</span><span class="p">(</span><span class="n">sed2data</span><span class="p">[</span><span class="n">obs</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">sed2data</span><span class="p">[</span><span class="n">obs</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">],</span> 
                <span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">hwidth</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rvel</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">rflx</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">refspec</span> <span class="o">=</span> <span class="n">_hdt</span><span class="o">.</span><span class="n">readfullsed2</span><span class="p">(</span><span class="n">fullseds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">flx</span><span class="p">)</span> <span class="o">=</span> <span class="n">lineProf</span><span class="p">(</span><span class="n">refspec</span><span class="p">[</span><span class="n">obs</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">refspec</span><span class="p">[</span><span class="n">obs</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">],</span> 
                    <span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="n">hwidth</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">rvel</span><span class="p">,</span> <span class="n">rflx</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">file</span> <span class="o">==</span> <span class="n">fullseds</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">flx</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;{0:02.1f} deg.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obsdegs</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span> 
                    <span class="n">color</span><span class="o">=</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">))])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">flx</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> 
                    <span class="nb">len</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">))])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">u&#39;lbc = {0:.5f} $\mu$m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lbc</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Difference spectra (spec - ref.)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">,</span> <span class="n">fancybox</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">figname</span> <span class="o">=</span> <span class="n">outpath</span> <span class="o">+</span> <span class="s">&#39;modsdiff_lbc{1:.4f}_obs{0:02.1f}{2}&#39;</span><span class="o">.</span>\
            <span class="n">format</span><span class="p">(</span><span class="n">obsdegs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">lbc</span><span class="p">,</span> <span class="n">addsuf</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fmt</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Saved {1}.{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">figname</span><span class="p">))</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span>

</div>
<div class="viewcode-block" id="diffPlotLineFits"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.diffPlotLineFits">[docs]</a><span class="k">def</span> <span class="nf">diffPlotLineFits</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">lbc</span><span class="o">=.</span><span class="mi">6564606</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;png&#39;</span><span class="p">],</span> <span class="n">xlim</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">rvel</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rflx</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="mf">1500.</span><span class="p">,</span> <span class="n">addsuf</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">cmapn</span><span class="o">=</span><span class="s">&#39;jet&#39;</span><span class="p">,</span> <span class="n">dlim</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">outpath</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate overplot of DIFFERENCE spec. line from a FITS files list.</span>
<span class="sd">    The observations will be linearly interpolated</span>
<span class="sd">    with the reference spec. If none is given as reference, </span>
<span class="sd">    then it assumes the first of the list.</span>

<span class="sd">    It is recommend to run first (rvel, rflx) =  lineProf(rvel, rflx,</span>
<span class="sd">    lbc=lbc, hwidth=hwidth).</span>

<span class="sd">    If `cmap` is None or empty, the phc.colors vector is read.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">specs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;# Reading {0}...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">trimpathname</span><span class="p">(</span><span class="n">spec</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">MJD</span><span class="p">,</span> <span class="n">dateobs</span><span class="p">,</span> <span class="n">datereduc</span><span class="p">,</span> <span class="n">fitsfile</span> <span class="o">=</span> <span class="n">loadfits</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">lineProf</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="n">hwidth</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rvel</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">rflx</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># wl0, flux0, MJD, dateobs0, datereduc, fitsfile = \</span>
            <span class="c">#   loadfits(specs[0])</span>
            <span class="c"># (rvel,flx) = lineProf(wl0, flux0, lbc=lbc, hwidth=hwidth)</span>
            <span class="c"># flx = _np.interp(x, rvel, rflx)</span>
            <span class="n">rvel</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">rflx</span> <span class="o">=</span> <span class="n">y</span>
            <span class="n">flx</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">rvel</span><span class="p">,</span> <span class="n">rflx</span><span class="p">)</span>
        <span class="c"># if spec == specs[0]:</span>
            <span class="c"># ax.plot(x, y-flx, label=&#39;{0}&#39;.format(dateobs), \</span>
            <span class="c"># color= _phc.colors[_np.mod(i, len(_phc.colors))])</span>
        <span class="c"># else:</span>
            <span class="c"># ax.plot(x, y-flx, color= _phc.colors[_np.mod(i, </span>
                <span class="c"># len(_phc.colors))])</span>
        <span class="k">if</span> <span class="n">dateobs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dateobs</span> <span class="o">=</span> <span class="n">dateobs</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">dateobs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dtobs</span> <span class="o">=</span> <span class="n">dateobs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dateobs</span> <span class="o">=</span> <span class="s">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dtobs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dlim</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cor</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">))]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cor</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">gradColor</span><span class="p">([</span><span class="n">MJD</span><span class="p">],</span> <span class="nb">min</span><span class="o">=</span><span class="n">dlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">dlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                <span class="n">cmapn</span><span class="o">=</span><span class="n">cmapn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">flx</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dateobs</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">cor</span><span class="p">)</span>

    <span class="n">ylabel</span> <span class="o">=</span> <span class="s">&#39;Difference spectra&#39;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_line_str</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">,</span> 
        <span class="n">dlim</span><span class="o">=</span><span class="n">dlim</span><span class="p">,</span> <span class="n">cmapn</span><span class="o">=</span><span class="n">cmapn</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="n">ylim</span><span class="p">)</span>

    <span class="n">figname</span> <span class="o">=</span> <span class="n">outpath</span> <span class="o">+</span> <span class="s">&#39;fitsdiff_lbc{1:.4f}{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">addsuf</span><span class="p">,</span> <span class="n">lbc</span><span class="p">)</span>
    <span class="n">_phc</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">figname</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
    <span class="k">return</span>

</div>
<div class="viewcode-block" id="diffPlotLineObs"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.diffPlotLineObs">[docs]</a><span class="k">def</span> <span class="nf">diffPlotLineObs</span><span class="p">(</span><span class="n">fullseds</span><span class="p">,</span> <span class="n">obsers</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lbc</span><span class="o">=.</span><span class="mi">6564606</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;png&#39;</span><span class="p">],</span> 
    <span class="n">rvel</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rflx</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">addsuf</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">outpath</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate overplot of DIFFERENCE spec. line from a HDUST OBSERVERS list.</span>
<span class="sd">    The model will be linearly interpolated</span>
<span class="sd">    with the reference spec. If none is given as reference, </span>
<span class="sd">    then it assumes the first observer of the list.</span>

<span class="sd">    It is recommend to run first (rvel, rflx) =  lineProf(rvel, rflx,</span>
<span class="sd">    lbc=lbc, hwidth=hwidth).</span>

<span class="sd">    Observers config. must be the same between models in</span>
<span class="sd">    `fullseds` list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">fullseds</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">sed2data</span> <span class="o">=</span> <span class="n">_hdt</span><span class="o">.</span><span class="n">readfullsed2</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
        <span class="n">obsdegs</span> <span class="o">=</span> <span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">sed2data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="p">)[</span><span class="n">obsers</span><span class="p">]</span>
        <span class="n">obsdegs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">obsdegs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">obsers</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">obsers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
            <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">lineProf</span><span class="p">(</span><span class="n">sed2data</span><span class="p">[</span><span class="n">obs</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">sed2data</span><span class="p">[</span><span class="n">obs</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">],</span> 
                <span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="n">hwidth</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rvel</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">rflx</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">flx</span><span class="p">)</span> <span class="o">=</span> <span class="n">lineProf</span><span class="p">(</span><span class="n">sed2data</span><span class="p">[</span><span class="n">obsers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">],</span> 
                <span class="n">sed2data</span><span class="p">[</span><span class="n">obsers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">lbc</span><span class="o">=</span><span class="n">lbc</span><span class="p">,</span> <span class="n">hwidth</span><span class="o">=</span><span class="n">hwidth</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">rvel</span><span class="p">,</span> <span class="n">rflx</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">flx</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;{0:02.1f} deg.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obsdegs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> 
                <span class="n">color</span><span class="o">=</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">colors</span><span class="p">))])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">u&#39;lbc={0:.5f}$\mu$m, {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lbc</span><span class="p">,</span> 
            <span class="n">_phc</span><span class="o">.</span><span class="n">trimpathname</span><span class="p">(</span><span class="nb">file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Difference spectra (spec - ref.)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">,</span> <span class="n">fancybox</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">figname</span> <span class="o">=</span> <span class="n">outpath</span> <span class="o">+</span> <span class="s">&#39;modsdiff_lbc{1:.4f}{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">addsuf</span><span class="p">,</span> <span class="n">lbc</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fmt</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Saved {1}.{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">figname</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figname</span> <span class="o">+</span> <span class="s">&#39;.{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">transparent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span>

</div>
<div class="viewcode-block" id="max_func_pts"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.max_func_pts">[docs]</a><span class="k">def</span> <span class="nf">max_func_pts</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ws</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">avgbox</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; `ws` window size where the maximum will be evaluated. Example: `ws=0.02`</span>
<span class="sd">    corresponds to 2% of the length of the input. &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">splitequal</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">ws</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
    <span class="n">xout</span><span class="p">,</span> <span class="n">yout</span> <span class="o">=</span> <span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
        <span class="n">xout</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="o">-</span><span class="n">avgbox</span><span class="p">:])</span>
        <span class="n">yout</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="o">-</span><span class="n">avgbox</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">xout</span><span class="p">,</span> <span class="n">yout</span>

</div>
<span class="k">def</span> <span class="nf">sum_ec</span><span class="p">(</span><span class="n">fwl</span><span class="p">,</span> <span class="n">fflx</span><span class="p">):</span>
    <span class="n">dmin</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">wlmin</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">wlmax</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fwl</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">dmin</span><span class="p">:</span>
            <span class="n">dmin</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">wlmin</span><span class="p">:</span>
            <span class="n">wlmin</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">wlmax</span><span class="p">:</span>
            <span class="n">wlmax</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">swl</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">wlmin</span><span class="p">,</span> <span class="n">wlmax</span><span class="p">,</span> <span class="n">dmin</span><span class="p">)</span>
    <span class="n">sflx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">swl</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fwl</span><span class="p">)):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span><span class="n">swl</span> <span class="o">&gt;</span> <span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">fwl</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">swl</span> <span class="o">&lt;</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fwl</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">)</span>
        <span class="n">sflx</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">swl</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">fwl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fflx</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">swl</span><span class="p">,</span> <span class="n">sflx</span>


<div class="viewcode-block" id="lbdc2range"><a class="viewcode-back" href="../../spectools.html#pyhdust.spectools.lbdc2range">[docs]</a><span class="k">def</span> <span class="nf">lbdc2range</span><span class="p">(</span><span class="n">lbdc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function doc</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dl</span> <span class="o">=</span> <span class="n">lbdc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lbdc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lbdc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dl</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">lbdc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dl</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lbdc</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="c"># MAIN ###</span></div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Python tools for the BeACoN group Beta documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../pyhdust.html" >pyhdust</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015-2016, D. Moser.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>
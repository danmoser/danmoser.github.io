<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyhdust.poltools &mdash; Python tools for the BeACoN group Beta documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     'Beta',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Python tools for the BeACoN group Beta documentation" href="../../index.html" />
    <link rel="up" title="pyhdust" href="../pyhdust.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Python tools for the BeACoN group Beta documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../pyhdust.html" accesskey="U">pyhdust</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pyhdust.poltools</h1><div class="highlight"><pre>
<span class="c"># -*- coding:utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;PyHdust *poltools* module: polarimetry tools</span>

<span class="sd">History:</span>
<span class="sd">-grafpol working for *_WP1110....log files!</span>
<span class="sd">-grafpol working for log/out files with more than a single star</span>

<span class="sd">:co-author: Daniel Bednarski</span>
<span class="sd">:license: GNU GPL v3.0 https://github.com/danmoser/pyhdust/blob/master/LICENSE </span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span> <span class="kn">as</span> <span class="nn">_os</span>
<span class="kn">import</span> <span class="nn">re</span> <span class="kn">as</span> <span class="nn">_re</span>
<span class="kn">import</span> <span class="nn">pwd</span> <span class="kn">as</span> <span class="nn">_pwd</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="kn">as</span> <span class="nn">_time</span>
<span class="kn">import</span> <span class="nn">glob</span> <span class="kn">as</span> <span class="nn">_glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">_np</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="kn">as</span> <span class="nn">_dt</span>
<span class="kn">import</span> <span class="nn">shutil</span> <span class="kn">as</span> <span class="nn">_shutil</span>
<span class="c"># from itertools import product as _product</span>
<span class="c"># from glob import glob as _glob</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">getouterframes</span> <span class="k">as</span> <span class="n">_getouterframes</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">currentframe</span> <span class="k">as</span> <span class="n">_currentframe</span>
<span class="kn">import</span> <span class="nn">pyhdust.phc</span> <span class="kn">as</span> <span class="nn">_phc</span>
<span class="kn">import</span> <span class="nn">pyhdust.jdcal</span> <span class="kn">as</span> <span class="nn">_jdcal</span>
<span class="kn">from</span> <span class="nn">pyhdust</span> <span class="kn">import</span> <span class="n">hdtpath</span> <span class="k">as</span> <span class="n">_hdtpath</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span> <span class="k">as</span> <span class="n">_curve_fit</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">simps</span> <span class="k">as</span> <span class="n">_simps</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span> <span class="k">as</span> <span class="n">_interp1d</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="kn">as</span> <span class="nn">_mpl</span>

<span class="c"># from sys import _argv</span>
<span class="c"># from matplotlib import rc as _rc</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">_plt</span>
    <span class="kn">from</span> <span class="nn">matplotlib.transforms</span> <span class="kn">import</span> <span class="n">offset_copy</span> <span class="k">as</span> <span class="n">_offset_copy</span>
    <span class="kn">import</span> <span class="nn">pyfits</span> <span class="kn">as</span> <span class="nn">_pyfits</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Warning! matplotlib and/or pyfits module not installed!!!&#39;</span><span class="p">)</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&quot;Daniel Moser&quot;</span>
<span class="n">__email__</span> <span class="o">=</span> <span class="s">&quot;dmfaes@gmail.com&quot;</span>


<span class="n">_mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s">&#39;pdf.fonttype&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">42</span>
<span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;u&#39;</span><span class="p">,</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="s">&#39;v&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;i&#39;</span><span class="p">]</span>
<span class="n">fonts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">13</span><span class="p">]</span>  <span class="c"># Font sizes for titles, axes labels, axes values, key label of graphs, subplot labels</span>

<span class="c"># Setting an &quot;initial value&quot; for ccd</span>
<span class="n">ccd</span> <span class="o">=</span> <span class="s">&#39;---&#39;</span>

<span class="c"># Dictionary for the tags entered by the user</span>
<span class="n">dictags</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;bad modulation&#39;</span><span class="p">,</span><span class="s">&#39;bad-mod&#39;</span><span class="p">],</span>
           <span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;very bad modulation&#39;</span><span class="p">,</span><span class="s">&#39;very-bad-mod&#39;</span><span class="p">],</span>
           <span class="mi">2</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;the pol values have values incompatible from each other&#39;</span><span class="p">,</span><span class="s">&#39;incomp-mods&#39;</span><span class="p">],</span>
           <span class="mi">3</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;some observational problem/error&#39;</span><span class="p">,</span><span class="s">&#39;obs-prob&#39;</span><span class="p">],</span>
           <span class="mi">4</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;polarimeter problem suspected&#39;</span><span class="p">,</span><span class="s">&#39;iagpol-prob&#39;</span><span class="p">],</span>
           <span class="mi">5</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;another relevant problem&#39;</span><span class="p">,</span><span class="s">&#39;other-prob&#39;</span><span class="p">],</span>
          <span class="p">}</span>

<span class="c"># Dictionary for the tags assigned automatically</span>
<span class="c"># If you want to add another value, add inside verout routin also.</span>
<span class="n">dictests</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;std incompatible with the published&#39;</span><span class="p">,</span><span class="s">&#39;obs!=pub&#39;</span><span class="p">,</span> <span class="s">&#39;W&#39;</span><span class="p">],</span>
            <span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;sig &gt;&gt; theorical_sig&#39;</span><span class="p">,</span><span class="s">&#39;s&gt;&gt;theor_s&#39;</span><span class="p">,</span> <span class="s">&#39;OK&#39;</span><span class="p">],</span>
            <span class="mi">2</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;no standard in the night&#39;</span><span class="p">,</span><span class="s">&#39;no-std&#39;</span><span class="p">,</span> <span class="s">&#39;W&#39;</span><span class="p">],</span>
            <span class="mi">3</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;standard from another day&#39;</span><span class="p">,</span><span class="s">&#39;oth-day-std&#39;</span><span class="p">,</span> <span class="s">&#39;W&#39;</span><span class="p">],</span>
            <span class="mi">4</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;delta theta estimated from another filter&#39;</span><span class="p">,</span><span class="s">&#39;oth-dth&#39;</span><span class="p">,</span> <span class="s">&#39;W&#39;</span><span class="p">],</span>
           <span class="p">}</span>

<span class="c"># Dictionary for pre-defined vfilters</span>
<span class="n">vfil</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;comp&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s">&#39;no-std&#39;</span><span class="p">,</span><span class="s">&#39;iagpol-prob&#39;</span><span class="p">,</span><span class="s">&#39;oth-day-std&#39;</span><span class="p">],</span>
         <span class="s">&#39;prob&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s">&#39;no-std&#39;</span><span class="p">,</span><span class="s">&#39;iagpol-prob&#39;</span><span class="p">,</span><span class="s">&#39;incomp-mods&#39;</span><span class="p">,</span><span class="s">&#39;obs-prob&#39;</span><span class="p">,</span><span class="s">&#39;other-prob&#39;</span><span class="p">,</span><span class="s">&#39;oth-day-std&#39;</span><span class="p">],</span>
         <span class="s">&#39;full&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s">&#39;no-std&#39;</span><span class="p">,</span><span class="s">&#39;iagpol-prob&#39;</span><span class="p">,</span><span class="s">&#39;incomp-mods&#39;</span><span class="p">,</span><span class="s">&#39;obs-prob&#39;</span><span class="p">,</span><span class="s">&#39;other-prob&#39;</span><span class="p">,</span><span class="s">&#39;oth-day-std&#39;</span><span class="p">,</span><span class="s">&#39;bad-mod&#39;</span><span class="p">,</span><span class="s">&#39;very-bad-mod&#39;</span><span class="p">],</span>
       <span class="p">}</span>


<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span>
<div class="viewcode-block" id="stdchk"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.stdchk">[docs]</a><span class="k">def</span> <span class="nf">stdchk</span><span class="p">(</span><span class="n">stdname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the standard star name contains a known name, and return</span>
<span class="sd">    its position in `padroes.txt`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lstds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/refs/pol_padroes.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>\
    <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">chk</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">std</span> <span class="ow">in</span> <span class="n">lstds</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">stdname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">std</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">chk</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">lstds</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chk</span><span class="p">,</span> <span class="n">i</span>



<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="countStars"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.countStars">[docs]</a><span class="k">def</span> <span class="nf">countStars</span><span class="p">(</span><span class="n">objdir</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Count how many stars there are inside outfiles in &#39;objdir&#39;</span>
<span class="sd">    and filter f. Return 0 if there are no outfiles</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">louts</span> <span class="o">=</span> <span class="n">_glob</span><span class="p">(</span><span class="s">&#39;{0}/*_{1}_*.out&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objdir</span><span class="p">,</span><span class="n">f</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">louts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file0</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">louts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">file0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>    <span class="c"># -1 because the header line</span>

    <span class="k">return</span> <span class="n">counts</span>



<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="thtFactor"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.thtFactor">[docs]</a><span class="k">def</span> <span class="nf">thtFactor</span><span class="p">(</span><span class="n">MJD</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the factor for polarization angle &#39;theta&#39;. This factor</span>
<span class="sd">    indicates when theta must be taken as 180-theta (factor==-1)</span>
<span class="sd">    or +theta (factor==+1).</span>

<span class="sd">    It&#39;s based on engine of IAGPOL polarimeter.</span>
<span class="sd">    If MJD &lt; 57082.5, return -1 (including MJD=-1, for no assigned</span>
<span class="sd">    value); otherwise, return +1.</span>

<span class="sd">    Theta out from polrap is correct for a WP rotating in</span>
<span class="sd">    &#39;counter-clockwise&#39; direction, then:</span>
<span class="sd">    </span>
<span class="sd">    factor = -1 when WP rotating in clockwise</span>
<span class="sd">    factor = +1 when WP rotating in counter-clockwise</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">MJD</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">57082.5</span><span class="p">:</span> <span class="c"># before 2015, March 1st</span>
        <span class="n">factor</span><span class="o">=-</span><span class="mf">1.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">factor</span><span class="o">=</span><span class="mf">1.</span>

    <span class="k">return</span> <span class="n">factor</span>



<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="readout"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.readout">[docs]</a><span class="k">def</span> <span class="nf">readout</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">nstar</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read the *.out file from IRAF reduction and return a float array</span>

<span class="sd">    Q   U        SIGMA   P       THETA  SIGMAtheor.  APERTURE  STAR</span>

<span class="sd">    &#39;nstar&#39; == star number inside &#39;out&#39; file (usefull when there are</span>
<span class="sd">               more than a single star inside .out)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">f0</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">f0</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">nstar</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>



<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="readoutMJD"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.readoutMJD">[docs]</a><span class="k">def</span> <span class="nf">readoutMJD</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">nstar</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read the &#39;out&#39; file from IRAF reduction in a float array (fout),</span>
<span class="sd">    appending the MJD date and the angle of the beams from</span>
<span class="sd">    calcite.</span>

<span class="sd">    &#39;nstar&#39; == star number inside &#39;out&#39; file. PS: calcice angle</span>
<span class="sd">            is allways evaluated using the first star coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">trimpathname</span><span class="p">(</span><span class="n">out</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">outn</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">trimpathname</span><span class="p">(</span><span class="n">out</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">readout</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">nstar</span><span class="o">=</span><span class="n">nstar</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: Can</span><span class="se">\&#39;</span><span class="s">t open/read file {0}. Verify and run again.</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="n">WP</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="s">&#39;_WP&#39;</span> <span class="ow">in</span> <span class="n">outn</span><span class="p">:</span>
        <span class="n">outn</span> <span class="o">=</span> <span class="n">outn</span><span class="p">[:</span><span class="n">outn</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)]</span>
        <span class="n">WP</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">outn</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">seq</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">outn</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">npos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">outn</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">])</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">outn</span><span class="p">[</span><span class="n">outn</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">outn</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)]</span>
    <span class="n">JD</span> <span class="o">=</span> <span class="n">_glob</span><span class="p">(</span><span class="s">&#39;{0}/JD_*_{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">f</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">JD</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">f0</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">f0</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">datei</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">date</span><span class="p">[</span><span class="n">npos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mf">2400000.5</span>
        <span class="n">datef</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">date</span><span class="p">[</span><span class="n">npos</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">seq</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mf">2400000.5</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">((</span><span class="s">&#39;# ERROR: Found *_{0}_*.out files, but none JD file found as {1}/JD_*_{2}. &#39;</span><span class="o">+</span>\
                            <span class="s">&#39;Verify and run again.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">f</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">WP</span><span class="p">:</span>
        <span class="n">ver</span> <span class="o">=</span> <span class="n">outn</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">outn</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">ver</span> <span class="o">=</span> <span class="n">outn</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">coords</span> <span class="o">=</span> <span class="n">_glob</span><span class="p">(</span><span class="s">&#39;{0}/coord_*_{1}.{2}.ord&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">ver</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ccd</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;301&#39;</span><span class="p">,</span><span class="s">&#39;654&#39;</span><span class="p">):</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">_glob</span><span class="p">(</span><span class="s">&#39;{0}/coord_*_{1}.ord&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">f</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">_glob</span><span class="p">(</span><span class="s">&#39;{0}/coord_*_{1}_[0-9]*.ord&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">f</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">((</span><span class="s">&#39;# ERROR: Found *_{0}_*.out files, but none COORD file found as &#39;</span><span class="o">+</span>\
                        <span class="s">&#39;{1}/coord_*_{2}_*.ord. Verify and run again.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">f</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ccd</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;301&#39;</span><span class="p">,</span><span class="s">&#39;654&#39;</span><span class="p">):</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ang</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span> <span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">],[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">]])</span>
            <span class="n">ang</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">while</span> <span class="n">ang</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ang</span> <span class="o">+=</span> <span class="mf">180.</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: Can</span><span class="se">\&#39;</span><span class="s">t open coords file {0}/coord_*_{1}_*.ord. Verify and run again.</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">f</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">date</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">datei</span> <span class="o">==</span> <span class="n">datef</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Strange JD file for &#39;</span><span class="o">+</span><span class="n">out</span><span class="p">)</span>
        <span class="n">date</span> <span class="o">=</span> <span class="p">(</span><span class="n">datef</span><span class="o">+</span><span class="n">datei</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>


    <span class="k">return</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">ang</span><span class="p">]</span>



<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="chooseout"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.chooseout">[docs]</a><span class="k">def</span> <span class="nf">chooseout</span><span class="p">(</span><span class="n">objdir</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">nstar</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigtol</span><span class="o">=</span><span class="k">lambda</span> <span class="n">sig</span><span class="p">:</span> <span class="mf">1.4</span><span class="o">*</span><span class="n">sig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Olha na noite, qual(is) *.OUT(s) de um filtro que tem o menor erro.</span>

<span class="sd">    Retorna um mais valores para toda a sequencia (i.e., pasta).</span>
<span class="sd">    Criterios definidos no anexo de polarimetria.</span>

<span class="sd">    minerror == True: recebe o out de menor erro em qualquer caso.</span>

<span class="sd">    sigtol: condicao de tolerancia para pegar o agrupamento de menor erro.</span>
<span class="sd">    Se o sigma do agrupamento com todas N posicoes for menor que a funcao</span>
<span class="sd">    sigtol sobre o sigma do agrupamento de menor erro, entao usa o agrupamento</span>
<span class="sd">    com as N posicoes; do contrario usa o de menor erro.</span>
<span class="sd">    Exemplo com 16 posicoes: erro do grupo de 16 posicoes == 0.000230;</span>
<span class="sd">        menor erro == 0.000200. Se sigtol(sig) = 1.4*sig, como</span>
<span class="sd">        sigtol(0.000200) == 0.000240 &gt; 0.000230, usa o agrupamento de 16 posicoes.</span>

<span class="sd">    O numero de posicoes eh baseado no numero de arquivos *.fits daquele</span>
<span class="sd">    filtro.</span>

<span class="sd">    &#39;nstar&#39; == star number inside &#39;out&#39; file (usefull when there are</span>
<span class="sd">               more than a single star inside .out)</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">def</span> <span class="nf">minErrBlk16</span><span class="p">(</span><span class="n">serie</span><span class="o">=</span><span class="s">&#39;16001&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the out with best error out of type *_f_*serie.?.out</span>
<span class="sd">        for star number &#39;nstar&#39; (where &#39;f&#39; is the filter, &#39;serie&#39; is</span>
<span class="sd">        the five-numbers concerning to the WP positions (like 16001)</span>
<span class="sd">        and ? is some char.</span>

<span class="sd">        Return err, out. If not found, return 1000.,&#39;&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">err</span> <span class="o">=</span> <span class="mf">1000.</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="n">objdir</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="n">fl</span> <span class="k">for</span> <span class="n">fl</span> <span class="ow">in</span> <span class="n">_os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s">&#39;{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objdir</span><span class="p">))</span> <span class="k">if</span> <span class="n">_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;_{0}&#39;</span><span class="o">.</span> \
                    <span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">+</span> <span class="s">r&#39;_.*_?{0}\..\.out&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">serie</span><span class="p">),</span> <span class="n">fl</span><span class="p">)]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">readout</span><span class="p">(</span><span class="n">ls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nstar</span><span class="o">=</span><span class="n">nstar</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">ls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">outi</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">readout</span><span class="p">(</span><span class="n">outi</span><span class="p">,</span><span class="n">nstar</span><span class="o">=</span><span class="n">nstar</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">err</span><span class="p">:</span>
    <span class="c">#                print float(readout(outi,nstar=nstar)[2])</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">readout</span><span class="p">(</span><span class="n">outi</span><span class="p">,</span><span class="n">nstar</span><span class="o">=</span><span class="n">nstar</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">outi</span>

        <span class="k">return</span> <span class="n">err</span><span class="p">,</span> <span class="n">out</span>


    <span class="n">npos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_glob</span><span class="p">(</span><span class="s">&#39;{0}/*_{1}_*.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objdir</span><span class="p">,</span><span class="n">f</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">npos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">npos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_glob</span><span class="p">(</span><span class="s">&#39;{0}/{1}/p??0&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objdir</span><span class="p">,</span><span class="n">f</span><span class="p">)))</span>

    <span class="n">louts</span> <span class="o">=</span> <span class="n">_glob</span><span class="p">(</span><span class="s">&#39;{0}/*_{1}_*.out&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objdir</span><span class="p">,</span><span class="n">f</span><span class="p">))</span>

    <span class="c"># Check reduction</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">louts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">npos</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">((</span><span class="s">&#39;# ERROR: There are observations not reduced for {0}/{1}_{2}_*.fits. &#39;</span> <span class="o">+</span>\
                            <span class="s">&#39;Verify and run again.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objdir</span><span class="p">,</span><span class="n">obj</span><span class="p">,</span><span class="n">f</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c"># Calculate the number of outfiles to be returned.</span>
    <span class="n">n</span><span class="o">=</span><span class="n">npos</span><span class="o">/</span><span class="mi">16</span>   <span class="c"># operacao em formato int!</span>
    <span class="n">rest</span> <span class="o">=</span> <span class="n">npos</span><span class="o">%</span><span class="mi">16</span>
    <span class="k">if</span> <span class="n">n</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rest</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nlast</span> <span class="o">=</span> <span class="mi">16</span>
        <span class="k">elif</span> <span class="n">rest</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">nlast</span> <span class="o">=</span> <span class="n">rest</span>
        <span class="k">elif</span> <span class="n">rest</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">nlast</span> <span class="o">=</span> <span class="mi">16</span><span class="o">+</span><span class="n">rest</span>
    <span class="k">elif</span> <span class="n">rest</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">nlast</span> <span class="o">=</span> <span class="n">rest</span>

<span class="c">#    print n, rest, nlast</span>
    <span class="n">err</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1000.</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="n">outs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="c"># n contem o numero de outs que serao obtidos</span>
    <span class="c"># nlast contem o numero de posicoes para o ultimo out</span>

    <span class="c"># Loop to get the n outfiles</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>

        <span class="c"># Get the best outfile with all WP positions.</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">or</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">==</span><span class="n">n</span> <span class="ow">and</span> <span class="n">nlast</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">):</span>
            <span class="n">serie</span><span class="o">=</span><span class="s">&#39;{0:02d}{1:03d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="n">i</span><span class="o">*</span><span class="mi">16</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">serie</span><span class="o">=</span><span class="s">&#39;{0:02d}{1:03d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nlast</span><span class="p">,</span><span class="n">i</span><span class="o">*</span><span class="mi">16</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">err</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">outs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">minErrBlk16</span><span class="p">(</span><span class="n">serie</span><span class="p">)</span>
        <span class="n">errtmp</span> <span class="o">=</span> <span class="n">err</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>   <span class="c"># errtmp==1000 if no outfiles were found by minErrBlk16</span>

        <span class="c"># Tests if there is some better group, with smaller error</span>
        <span class="k">for</span> <span class="n">outi</span> <span class="ow">in</span> <span class="n">louts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">outi</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;_WP&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">indx</span> <span class="o">=</span> <span class="n">outi</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">indx</span> <span class="o">=</span> <span class="n">outi</span><span class="p">[:</span><span class="n">outi</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;_WP&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">combi</span> <span class="o">=</span> <span class="n">outi</span><span class="p">[</span><span class="n">indx</span><span class="p">:</span><span class="n">indx</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span>
            <span class="n">n1</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">combi</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="c"># First part of &#39;16001&#39;, etc </span>
            <span class="n">n2</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">combi</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="c"># Last part of &#39;16001&#39;, etc </span>
<span class="c">#            if i+1==n:</span>
<span class="c">#                print n1, n2</span>
            <span class="c"># Default case</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">n</span> <span class="ow">or</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">nlast</span> <span class="o">==</span> <span class="mi">16</span><span class="p">):</span>
                <span class="c"># Get only the groups with independent data</span>
                <span class="k">if</span> <span class="n">n2</span>  <span class="o">&gt;=</span> <span class="mi">16</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">n2</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span><span class="o">-</span><span class="n">n1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">readout</span><span class="p">(</span><span class="n">outi</span><span class="p">,</span><span class="n">nstar</span><span class="o">=</span><span class="n">nstar</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">errtmp</span><span class="p">:</span>
                        <span class="n">errtmp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">readout</span><span class="p">(</span><span class="n">outi</span><span class="p">,</span><span class="n">nstar</span><span class="o">=</span><span class="n">nstar</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">outtmp</span> <span class="o">=</span> <span class="n">outi</span>
            <span class="c"># Case i==n (and nlast!=16)</span>
            <span class="k">else</span><span class="p">:</span>
<span class="c">#                print &#39;entrou1&#39;</span>
<span class="c">#                print n1,n2,16*i+1</span>
                <span class="k">if</span> <span class="n">n2</span>  <span class="o">&gt;=</span> <span class="mi">16</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">readout</span><span class="p">(</span><span class="n">outi</span><span class="p">,</span><span class="n">nstar</span><span class="o">=</span><span class="n">nstar</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">errtmp</span><span class="p">:</span>
                        <span class="n">errtmp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">readout</span><span class="p">(</span><span class="n">outi</span><span class="p">,</span><span class="n">nstar</span><span class="o">=</span><span class="n">nstar</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">outtmp</span> <span class="o">=</span> <span class="n">outi</span>

        <span class="k">if</span> <span class="n">errtmp</span> <span class="o">!=</span> <span class="n">err</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">err</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sigtol</span><span class="p">(</span><span class="n">errtmp</span><span class="p">):</span>
            <span class="n">outs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">outtmp</span>

    <span class="c"># if some element of outs is &#39;&#39;, chooseout has failed to find the best out in such 16-position serie.</span>
    <span class="c"># But don&#39;t panic. It can happen due some espurious .fits file</span>
<span class="c">#    print [out for out in outs if out != &#39;&#39;]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">out</span> <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">outs</span> <span class="k">if</span> <span class="n">out</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">]</span>



<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="verout"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.verout">[docs]</a><span class="k">def</span> <span class="nf">verout</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">nstar</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">3.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to do tests on outfile &#39;out&#39; concerning to</span>
<span class="sd">    star number &#39;nstar&#39;, object name &#39;obj&#39; in filter &#39;f&#39;.</span>
<span class="sd">    Tests: (1) test if P_pub for standards is compatible with</span>
<span class="sd">               P_obs value within 10 sigmas (10 because</span>
<span class="sd">               std pol can changes with the time).</span>
<span class="sd">           (2) test if sig &lt; 3*sig_theorical.</span>
<span class="sd">           (3) test if there are some standard star (only if</span>
<span class="sd">                &#39;obj&#39; is a target star)</span>

<span class="sd">    - If verbose==True, show warnings in screen</span>
<span class="sd">    - In objdir==None, outfile is supposed in current dir</span>

<span class="sd">    Return a boolean list with three components concerning</span>
<span class="sd">    to the tests (1)-(3) above + log string. If some test has failed,</span>
<span class="sd">    the concerning value is assigned as \&quot;True\&quot;; otherwise,</span>
<span class="sd">    \&quot;False\&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tests</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">dictests</span><span class="p">)</span>
    <span class="n">loglines</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="c"># The complex lines below is to extract &#39;path&#39; from &#39;out&#39; (considering) fixing consecutives &#39;//&#39;</span>
    <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="p">][:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="p">][:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>

    <span class="p">[</span><span class="n">Q</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">th</span><span class="p">,</span><span class="n">sigT</span><span class="p">,</span><span class="n">ap</span><span class="p">,</span><span class="n">star</span><span class="p">,</span><span class="n">MJD</span><span class="p">,</span><span class="n">calc</span><span class="p">]</span> <span class="o">=</span> <span class="n">readoutMJD</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">nstar</span><span class="o">=</span><span class="n">nstar</span><span class="p">)</span>
    <span class="n">sig_ratio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">sigT</span><span class="p">)</span>
    <span class="n">ztest</span> <span class="o">=</span> <span class="n">verStdPol</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">P</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">sig</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
    
    <span class="c"># Some tests.</span>
    <span class="k">if</span> <span class="n">ztest</span> <span class="o">&gt;</span> <span class="mf">10.0</span><span class="p">:</span>     <span class="c"># Case the object is not a standard, ztest==-1 and tests[0] remains False.</span>
        <span class="n">tests</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">sig_ratio</span> <span class="o">&gt;</span> <span class="mf">6.</span><span class="p">:</span>
        <span class="n">tests</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">stdchk</span><span class="p">(</span><span class="n">obj</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c"># Only if object is not a standard star, tests if there exists some standard star for it</span>
        <span class="n">tests</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">chkStdLog</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">calc</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    
    <span class="c"># Print tests</span>
    <span class="k">if</span> <span class="n">tests</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">loglines</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&#39;# WARNING: {0}_{1}: The standard has polarization only compatible &#39;</span><span class="o">+</span>\
                                  <span class="s">&#39;within {2:.1f} sigma with the published value.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ztest</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tests</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">loglines</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&#39;# WARNING: {0}_{1}: Polarization has sig &gt;&gt; theorical_sig &#39;</span> <span class="o">+</span>\
                        <span class="s">&#39;({2:.4f} &gt;&gt; {3:.4f}).</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">sig</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">sigT</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tests</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
        <span class="n">loglines</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&#39;# WARNING: {0}_{1}: Standard star not found yet &#39;</span><span class="o">+</span>\
                                             <span class="s">&#39;(calc. {2:.1f})</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">calc</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">loglines</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="n">loglines</span><span class="p">)</span>

    
    <span class="k">return</span> <span class="n">tests</span><span class="p">,</span> <span class="n">loglines</span>



<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="queryout"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.queryout">[docs]</a><span class="k">def</span> <span class="nf">queryout</span><span class="p">(</span><span class="n">objdir</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">nstar</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigtol</span><span class="o">=</span><span class="k">lambda</span> <span class="n">sig</span><span class="p">:</span> <span class="mf">1.4</span><span class="o">*</span><span class="n">sig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Call chooseout for &#39;obj&#39; at filter &#39;f&#39; (in &#39;objdir&#39;),</span>
<span class="sd">    print the graphs and query to the user if he wants</span>
<span class="sd">    to use the selected outs. If not, he musts answer</span>
<span class="sd">    what to use.</span>

<span class="sd">    &#39;nstar&#39; == star number inside &#39;out&#39; file (usefull when there are</span>
<span class="sd">               more than a single star inside .out)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">)</span>
    <span class="n">outs</span> <span class="o">=</span> <span class="n">chooseout</span><span class="p">(</span><span class="n">objdir</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">nstar</span><span class="o">=</span><span class="n">nstar</span><span class="p">,</span> <span class="n">sigtol</span><span class="o">=</span><span class="n">sigtol</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outs</span> <span class="o">==</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">outs</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

    <span class="c"># Initialize the components for each outfile</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="p">[[]]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">outs</span><span class="p">)</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">outs</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outs</span><span class="p">)):</span>

        <span class="n">sortout</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>

            <span class="n">_plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">)</span>
            <span class="c"># Only in the first iteration stack the values in sortout</span>
            <span class="k">if</span> <span class="n">sortout</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="n">sortout</span> <span class="o">=</span> <span class="n">grafall</span><span class="p">(</span><span class="n">objdir</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="p">,</span><span class="n">nstar</span><span class="o">=</span><span class="n">nstar</span><span class="p">,</span> <span class="n">bestouts</span><span class="o">=</span><span class="p">[</span><span class="n">outs</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">shortmode</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">lixo</span> <span class="o">=</span> <span class="n">grafall</span><span class="p">(</span><span class="n">objdir</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="p">,</span><span class="n">nstar</span><span class="o">=</span><span class="n">nstar</span><span class="p">,</span> <span class="n">bestouts</span><span class="o">=</span><span class="p">[</span><span class="n">outs</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">shortmode</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="s">&#39;_&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39; {0:&lt;10s} {1:&lt;5s} {2:&lt;6s}  {3:&lt;7s} {4:&lt;10s} {5:&lt;7s} {6:&lt;s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;Obj&#39;</span><span class="p">,</span> <span class="s">&#39;Filt&#39;</span><span class="p">,</span> \
                    <span class="s">&#39;Pol (%)&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;sig/ThSig&#39;</span><span class="p">,</span> <span class="s">&#39;ztest&#39;</span><span class="p">,</span> <span class="s">&#39;out/num&#39;</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="p">[</span><span class="n">Q</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">th</span><span class="p">,</span><span class="n">sigT</span><span class="p">,</span><span class="n">ap</span><span class="p">,</span><span class="n">star</span><span class="p">,</span><span class="n">MJD</span><span class="p">,</span><span class="n">calc</span><span class="p">]</span> <span class="o">=</span> <span class="n">readoutMJD</span><span class="p">(</span><span class="n">outs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nstar</span><span class="o">=</span><span class="n">nstar</span><span class="p">)</span>
                <span class="n">sig_ratio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">sigT</span><span class="p">)</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">verStdPol</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">P</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">sig</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
                <span class="n">numout</span> <span class="o">=</span> <span class="s">&#39;(#{0})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sortout</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">outs</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: It shouldn</span><span class="se">\&#39;</span><span class="s">t enter here in queryout!</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c"># Reassigns ztest value for printing</span>
            <span class="k">if</span> <span class="n">z</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">zstr</span> <span class="o">=</span> <span class="s">&#39;-----&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">zstr</span> <span class="o">=</span> <span class="s">&#39;{0:.1f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

            <span class="c"># Prints the values</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39; {0:&lt;10s} {1:&lt;5s} {2:&lt;6.4f}+-{3:&lt;7.4f} {4:&lt;10.1f} {5:&lt;7s} {6:&lt;s} {7:&lt;s}&#39;</span><span class="o">.</span>\
                     <span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">f</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="nb">float</span><span class="p">(</span><span class="n">P</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> \
                            <span class="n">sig_ratio</span><span class="p">,</span> <span class="n">zstr</span><span class="p">,</span> <span class="n">_phc</span><span class="o">.</span><span class="n">trimpathname</span><span class="p">(</span><span class="n">outs</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">1</span><span class="p">],</span> <span class="n">numout</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="o">*</span><span class="mi">80</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

            <span class="c"># Test the out file to print tests</span>
            <span class="n">testout</span><span class="p">,</span> <span class="n">logout</span> <span class="o">=</span> <span class="n">verout</span><span class="p">(</span><span class="n">outs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">nstar</span><span class="o">=</span><span class="n">nstar</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">verif</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;Use this out? (y/n): &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verif</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">,</span><span class="s">&#39;n&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Invalid choise!&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">verif</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="s">&#39;Y&#39;</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">verif</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;n&#39;</span><span class="p">,</span> <span class="s">&#39;N&#39;</span><span class="p">):</span>
                <span class="n">opt</span><span class="o">=</span><span class="s">&#39;&#39;</span>  <span class="c"># for the first iteration</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">opt</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;Type the out number: &#39;</span><span class="p">)</span>
                    <span class="c"># If opt is a valid value, assign the input number with the concerning out file</span>
                    <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">sortout</span><span class="p">))</span> <span class="k">if</span> <span class="n">sortout</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">]:</span>
                        <span class="n">outs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sortout</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">opt</span><span class="p">)]</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Wrong value!&#39;</span><span class="p">)</span>
                        <span class="n">opt</span><span class="o">=</span><span class="s">&#39;&#39;</span>

        <span class="c"># Request what tags to assign (flexible through the dictags global dictionary)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s"># TAGS LIST</span><span class="se">\n</span><span class="s">  0: none&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">dictags</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;  {0}: {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dictags</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">verif</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">tags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">dictags</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="n">strin</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;Select all tags that apply separated by commas (</span><span class="se">\&#39;</span><span class="s">0</span><span class="se">\&#39;</span><span class="s"> for none): &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">strin</span> <span class="o">==</span> <span class="s">&#39;0&#39;</span><span class="p">:</span>
                <span class="n">flag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="s">&#39;OK&#39;</span>
                <span class="k">break</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="n">strin</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">dictags</span><span class="o">.</span><span class="n">keys</span><span class="p">()]:</span>
                    <span class="n">opt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
                    <span class="n">tags</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">opt</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Invalid choise!&#39;</span><span class="p">)</span>
                    <span class="n">verif</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">break</span>

            <span class="c"># If some tag was selected, request a flag below</span>
            <span class="k">if</span> <span class="n">verif</span><span class="p">:</span>
                <span class="n">verif2</span><span class="o">=</span><span class="s">&#39;&#39;</span>
                <span class="k">while</span> <span class="n">verif2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">,</span><span class="s">&#39;n&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">):</span>
                    <span class="n">verif2</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;For you, this data should appear as usable? (y/n): &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verif2</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">):</span>
                    <span class="n">flag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;W&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;E&#39;</span>
                <span class="k">break</span>

    <span class="n">_plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">outs</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">flag</span>



<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c"># Falta alterar para novos ndices das colunas dos arquivos std.dat e obj.dat</span>
<span class="c"># das mudanas que fiz. Bednarski.</span></div>
<div class="viewcode-block" id="plotfrompollog"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.plotfrompollog">[docs]</a><span class="k">def</span> <span class="nf">plotfrompollog</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot default including civil dates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tab</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="s">&#39;{0}/{1}.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">star</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">autostrip</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">MJD</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">nights</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">filt</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">ang_ref</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">dth</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[:,</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[:,</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">th</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[:,</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">sigP</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[:,</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">sigth</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[:,</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">colors</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">colors</span>
    <span class="k">if</span> <span class="n">filters</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="s">&#39;v&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;i&#39;</span><span class="p">]</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;brown&#39;</span><span class="p">]</span>
    <span class="n">leg</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">f</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">leg</span> <span class="o">+=</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">+</span><span class="s">&#39; band&#39;</span><span class="p">,)</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">filt</span> <span class="o">==</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">MJD</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">yerr</span> <span class="o">=</span> <span class="n">sigP</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">leg</span><span class="p">,</span><span class="s">&#39;upper left&#39;</span><span class="p">)</span><span class="c">#, fontsize=&#39;small&#39;)    </span>
    <span class="c">#ax.legend(leg,&#39;lower left&#39;, fontsize=&#39;small&#39;)  </span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Polarization (%)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;k--&#39;</span><span class="p">)</span>
    <span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;MJD&#39;</span><span class="p">)</span>
    <span class="n">xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">gentkdates</span><span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&#39;m&#39;</span><span class="p">,</span>\
    <span class="n">dtstart</span><span class="o">=</span><span class="n">_dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
    <span class="n">mjdticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">_jdcal</span><span class="o">.</span><span class="n">gcal2jd</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span><span class="n">date</span><span class="o">.</span><span class="n">day</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> \
    <span class="n">ticks</span><span class="p">]</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twiny</span><span class="p">()</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;Civil date&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">mjdticks</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s"> %b %y&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">])</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span> <span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_majorticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span> <span class="p">)</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.84</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}/{1}.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">star</span><span class="p">))</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}/{1}.eps&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">star</span><span class="p">))</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="n">bres</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">leg</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">filt</span> <span class="o">==</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">bindata</span><span class="p">(</span><span class="n">MJD</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">P</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">sigP</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">bres</span><span class="p">)</span>
        <span class="n">leg</span> <span class="o">+=</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">+</span><span class="s">&#39; band&#39;</span><span class="p">,)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">filters</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">f</span><span class="p">)],</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">leg</span><span class="p">,</span><span class="s">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s">&#39;small&#39;</span><span class="p">)</span>            
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Polarization (%) (binned)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;k--&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;MJD&#39;</span><span class="p">)</span>
    <span class="n">xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">gentkdates</span><span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&#39;m&#39;</span><span class="p">,</span>\
    <span class="n">dtstart</span><span class="o">=</span><span class="n">_dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
    <span class="n">mjdticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">_jdcal</span><span class="o">.</span><span class="n">gcal2jd</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span><span class="n">date</span><span class="o">.</span><span class="n">day</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> \
    <span class="n">ticks</span><span class="p">]</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twiny</span><span class="p">()</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;Civil date&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">mjdticks</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s"> %b %y&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">])</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span> <span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_majorticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span> <span class="p">)</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.84</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}/{1}_binned.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">star</span><span class="p">))</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}/{1}_binned.eps&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">star</span><span class="p">))</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>       
    
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">filt</span> <span class="o">==</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">avg</span><span class="p">,</span><span class="n">sigm</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">wg_avg_and_std</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">sigP</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Averaged {} band is {:.3f} +/- {:.3f} %&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span><span class="n">avg</span><span class="p">,</span>\
        <span class="n">sigm</span><span class="p">))</span>
    <span class="k">return</span>



<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c"># Bednarski: This function generates the graphs for all filter &quot;filt&quot; logfiles found inside &quot;objdir&quot;</span></div>
<div class="viewcode-block" id="grafall"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.grafall">[docs]</a><span class="k">def</span> <span class="nf">grafall</span><span class="p">(</span><span class="n">objdir</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">nstar</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bestouts</span><span class="o">=</span><span class="p">[],</span> <span class="n">shortmode</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Multiple plot modulations for the object inside &#39;objdir&#39;</span>
<span class="sd">    in filter &#39;filt&#39;.</span>
<span class="sd">    Return a list &#39;sortout&#39; with the log files sorted by plot</span>
<span class="sd">    number. Allways sortout[0]==&#39;&#39; and sortout[i] is the plot #i.</span>

<span class="sd">    Optional:</span>
<span class="sd">        bestouts - list of outs which have smaller error to</span>
<span class="sd">                   highlight in figures</span>
<span class="sd">        shortmode - case True, plot only the groups 16001, 08001,</span>
<span class="sd">                    08009 (ver .1 and .2) and an eventual 7th group.</span>
<span class="sd">        n - is concerning to the n-esim 16-sequence to use.</span>
<span class="sd">            Exemple, if there are 40 WP positions, n=1 is to plot</span>
<span class="sd">            the graphs for positions 1-16; n=2 is for 17-32;</span>
<span class="sd">            n=3 is for 33-40.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Receive a list of logfiles and return lists for each group of WP/version:</span>
    <span class="c"># sublogs == list of sorted logfiles.</span>
    <span class="c"># groups == list with informations about lamina groups.</span>
    <span class="c"># ver == list with the reduction versions of files in sublogs.</span>
    <span class="c">#</span>
    <span class="c"># Ex, sublogs == [[*16001.1.log], [*16001.2.log], [*0800[1-9].1.log], [*0800[1-9].2.log]]</span>
    <span class="c">#      groups == [   [16, 1, .1],    [16, 1, .2],         [8, 9, .1],         [8, 9, .2]]</span>
    <span class="c">#         ver == [          [.1],         [best],           [.1 ...],          [.2, ...]]</span>
    <span class="k">def</span> <span class="nf">combineout</span><span class="p">(</span><span class="n">logs</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>

        <span class="n">logsplit</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">sublogs</span><span class="p">,</span> <span class="n">ver</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[[]],</span> <span class="p">[[]]</span>
        
        <span class="c"># Split the name files at last &quot;_&quot; character in each .log name. Working for _WP1111110110 ... files</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">direc</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">trimpathname</span><span class="p">(</span><span class="n">logs</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;ERROR: no log files found to plot.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_phc</span><span class="o">.</span><span class="n">trimpathname</span><span class="p">(</span><span class="n">li</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="n">logs</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;_WP&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">indx</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">indx</span> <span class="o">=</span> <span class="n">log</span><span class="p">[:</span><span class="n">log</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;_WP&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">combi</span> <span class="o">=</span> <span class="n">log</span><span class="p">[</span><span class="n">indx</span><span class="p">:</span><span class="n">indx</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span>
            <span class="n">n1</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">combi</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">n2</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">combi</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>

            <span class="k">if</span> <span class="n">n2</span>  <span class="o">&gt;=</span> <span class="mi">16</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">n2</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span><span class="o">-</span><span class="n">n1</span><span class="p">):</span>
                <span class="n">logsplit</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">log</span><span class="p">[:</span><span class="n">indx</span><span class="p">],</span> <span class="n">log</span><span class="p">[</span><span class="n">indx</span><span class="p">:]]]</span>

        <span class="c"># Sort by lamina (high to low) -&gt; version (including versions with _WP111100 ...)</span>
        <span class="n">logsplit</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][:]])</span>
        <span class="n">logsplit</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
        <span class="c"># Separate the lamina groups</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">logsplit</span><span class="p">)):</span>
            <span class="n">sublogs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">direc</span><span class="o">+</span><span class="n">logsplit</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">logsplit</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">sublogs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;.out&#39;</span> <span class="ow">in</span> <span class="n">bestouts</span><span class="p">:</span>
                <span class="n">ver</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;best&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ver</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">logsplit</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]]</span>
                      
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">logsplit</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">logsplit</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">logsplit</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">or</span> \
                        <span class="n">logsplit</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="o">!=</span> <span class="n">logsplit</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]))</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">logsplit</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">groups</span> <span class="o">+=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">logsplit</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">sublogs</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span> \
                                                        <span class="n">logsplit</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]]]</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">logsplit</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="n">sublogs</span><span class="p">[:]</span> <span class="o">+=</span> <span class="p">[[]]</span>
                    <span class="n">ver</span><span class="p">[:]</span> <span class="o">+=</span> <span class="p">[[]]</span>
            
        <span class="k">return</span> <span class="n">groups</span><span class="p">,</span> <span class="n">sublogs</span><span class="p">,</span> <span class="n">ver</span>
        

    <span class="c"># Generate background color for the graphs, depending the reduction version</span>
    <span class="k">def</span> <span class="nf">gencolour</span><span class="p">(</span><span class="n">ver</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">ver</span> <span class="o">==</span> <span class="s">&#39;best&#39;</span><span class="p">:</span> <span class="n">bkg</span> <span class="o">=</span> <span class="s">&#39;#d3dcf9&#39;</span>
        <span class="k">elif</span> <span class="n">ver</span> <span class="o">==</span> <span class="s">&#39;.1&#39;</span> <span class="ow">or</span> <span class="n">ver</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;.1_WP&#39;</span><span class="p">:</span> <span class="n">bkg</span> <span class="o">=</span> <span class="s">&#39;#f0ffe0&#39;</span>
        <span class="k">elif</span> <span class="n">ver</span> <span class="o">==</span> <span class="s">&#39;.2&#39;</span> <span class="ow">or</span> <span class="n">ver</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;.2_WP&#39;</span><span class="p">:</span> <span class="n">bkg</span> <span class="o">=</span> <span class="s">&#39;#f0fff0&#39;</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">bkg</span> <span class="o">=</span> <span class="s">&#39;#f5f5f5&#39;</span>

        <span class="k">return</span> <span class="n">bkg</span>
        

    <span class="c"># Plot graphs for &#39;shortmode&#39; and return &#39;sortout&#39; list. Shortmode consists in the</span>
    <span class="c"># processing of groups nn001.1, nn001.2 (nn is the number of WP), 08001.1, 08001.2,</span>
    <span class="c"># 08009.1, 08009.2 and an eventual 7th element in &#39;bestouts&#39; variable.</span>
    <span class="c"># The variable returned is a list with the outfiles displayed, sorted in same order</span>
    <span class="c"># that the showed.</span>
    <span class="c"># The input variables are exactly the outputs &quot;sublogs&quot; and &quot;groups&quot; from combineout subroutine.</span>
    <span class="k">def</span> <span class="nf">gengraphshort</span> <span class="p">(</span><span class="n">sublogs</span><span class="p">,</span> <span class="n">groups</span><span class="p">):</span>

        <span class="c"># Variables below are to mark the positions in lists</span>
        <span class="n">pos8ver1</span><span class="p">,</span> <span class="n">pos8ver2</span><span class="p">,</span> <span class="n">posnver1</span><span class="p">,</span> <span class="n">posnver2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">maxver1</span><span class="p">,</span> <span class="n">maxver2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>

        <span class="c"># Find index for 16 and 08 groups positions</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)):</span>
            <span class="c"># Only shows the groups with 8 positions if there are 08001 to 08009 files</span>
            <span class="k">if</span> <span class="n">groups</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span> <span class="ow">and</span> <span class="n">groups</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">9</span> <span class="ow">and</span> <span class="n">groups</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;.1&#39;</span><span class="p">:</span>
                <span class="n">pos8ver1</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">if</span> <span class="n">maxver1</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
                    <span class="n">maxver1</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="k">elif</span> <span class="n">groups</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">maxver1</span> <span class="ow">and</span> <span class="n">groups</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;.1&#39;</span><span class="p">:</span>
                <span class="n">maxver1</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">posnver1</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">if</span> <span class="n">groups</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span> <span class="ow">and</span> <span class="n">groups</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">9</span> <span class="ow">and</span> <span class="n">groups</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;.2&#39;</span><span class="p">:</span>
                <span class="n">pos8ver2</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">if</span> <span class="n">maxver2</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
                    <span class="n">maxver2</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="k">elif</span> <span class="n">groups</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">maxver2</span> <span class="ow">and</span> <span class="n">groups</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;.2&#39;</span><span class="p">:</span>
                <span class="n">maxver2</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">posnver2</span> <span class="o">=</span> <span class="n">i</span>

        <span class="c"># Set the logfiles in a first time</span>
        <span class="n">tlogs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span>
        <span class="n">tver</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;.1&#39;</span><span class="p">,</span><span class="s">&#39;.2&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span>
        <span class="k">if</span> <span class="n">posnver1</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">tlogs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sublogs</span><span class="p">[</span><span class="n">posnver1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">posnver2</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">tlogs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sublogs</span><span class="p">[</span><span class="n">posnver2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pos8ver1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">posnver1</span><span class="p">):</span>
            <span class="n">tlogs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">tlogs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">sublogs</span><span class="p">[</span><span class="n">pos8ver1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">sublogs</span><span class="p">[</span><span class="n">pos8ver1</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pos8ver2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">posnver2</span><span class="p">):</span>
            <span class="n">tlogs</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">tlogs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">sublogs</span><span class="p">[</span><span class="n">pos8ver2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">sublogs</span><span class="p">[</span><span class="n">pos8ver2</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span>

        <span class="c"># Set the bestout</span>
        <span class="k">if</span> <span class="n">bestouts</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bestouts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;# WARNING: grafall: more than one value of best .out passed as&#39;</span> <span class="o">+</span> \
                <span class="s">&#39; parameter in short mode. Only using the first one...</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bestouts</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;.log&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tlogs</span><span class="p">:</span>
                <span class="n">tlogs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">bestouts</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;.log&#39;</span><span class="p">]</span>
                <span class="n">tver</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;best&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tver</span><span class="p">[</span><span class="n">tlogs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">bestouts</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;.log&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s">&#39;best&#39;</span>

        <span class="c"># Set the logfiles once, erasing the void components</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">posnver1</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">pos8ver1</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">posnver2</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">pos8ver2</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">logs</span> <span class="o">=</span> <span class="p">[</span><span class="n">tlogs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tlogs</span><span class="p">))</span> <span class="k">if</span> <span class="n">tlogs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">]</span>
            <span class="n">ver</span> <span class="o">=</span> <span class="p">[</span><span class="n">tver</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tlogs</span><span class="p">))</span> <span class="k">if</span> <span class="n">tlogs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">]</span>
            <span class="n">mode</span><span class="o">=</span><span class="s">&#39;lin&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mode</span><span class="o">=</span><span class="s">&#39;col&#39;</span>
            <span class="n">logs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ver</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">posnver1</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">posnver2</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">logs</span> <span class="o">+=</span> <span class="n">tlogs</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">ver</span> <span class="o">+=</span> <span class="n">tver</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pos8ver1</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">pos8ver2</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">logs</span> <span class="o">+=</span> <span class="n">tlogs</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
                <span class="n">ver</span> <span class="o">+=</span> <span class="n">tver</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tlogs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                <span class="n">logs</span> <span class="o">+=</span> <span class="n">tlogs</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>
                <span class="n">ver</span> <span class="o">+=</span> <span class="n">tver</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>

        <span class="c"># Run gengraphl4!</span>
        <span class="n">gengraphl4</span><span class="p">(</span><span class="n">logs</span><span class="p">,</span><span class="n">ver</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">align</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

        <span class="c"># Return the &#39;sortlog&#39; file (sorted outfiles with extension &#39;.log&#39;)</span>
        <span class="k">return</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">log</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;.out&#39;</span> <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">logs</span> <span class="k">if</span> <span class="n">log</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">]</span>
        
    
    <span class="c"># Generate graphs for the cases nlog &lt;= 8</span>
    <span class="c"># align: align by lines or columns? 1234//5678 (&#39;lin&#39;) or 1357//2468 (&#39;col&#39;)?</span>
    <span class="k">def</span> <span class="nf">gengraphl4</span><span class="p">(</span><span class="n">logs</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s">&#39;lin&#39;</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">align</span><span class="o">==</span><span class="s">&#39;lin&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">nlin</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nlin</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span>
        <span class="k">elif</span> <span class="n">align</span><span class="o">==</span><span class="s">&#39;col&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">nlin</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nlin</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ncol</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: align mode {0} is not valid in grafall! Graphs not displayed!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">align</span><span class="p">))</span>
            <span class="k">return</span>            
        <span class="k">if</span> <span class="n">ncol</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: {0} figure(s) was(were) not displayed by grafall&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span><span class="o">-</span><span class="mi">8</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">if</span>   <span class="n">ncol</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">linit</span><span class="o">=</span><span class="mf">0.15</span>
        <span class="k">elif</span> <span class="n">ncol</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="n">linit</span><span class="o">=</span><span class="mf">0.08</span>
        <span class="k">else</span><span class="p">:</span>           <span class="n">linit</span><span class="o">=</span><span class="mf">0.05</span>

        <span class="k">if</span>   <span class="n">nlin</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">binit</span><span class="o">=</span><span class="mf">0.12</span><span class="p">;</span> <span class="n">tinit</span><span class="o">=</span><span class="mf">0.88</span>
        <span class="k">elif</span> <span class="n">nlin</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="n">binit</span><span class="o">=</span><span class="mf">0.19</span><span class="p">;</span> <span class="n">tinit</span><span class="o">=</span><span class="mf">0.94</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">ncol</span><span class="p">,</span><span class="mf">3.4</span><span class="o">*</span><span class="n">nlin</span><span class="p">))</span>

        <span class="c"># Estabelece os grids e cria todos os eixos</span>
        <span class="n">grids</span> <span class="o">=</span> <span class="p">[</span> <span class="n">_plt</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">nlin</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span> \
                        <span class="n">top</span><span class="o">=</span><span class="n">tinit</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">binit</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">linit</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">if</span> <span class="n">nlin</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">grids</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">_plt</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">nlin</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span> \
                        <span class="n">top</span><span class="o">=</span><span class="mf">0.81</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.06</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">linit</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">align</span> <span class="o">==</span> <span class="s">&#39;lin&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncol</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">logs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">ax</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grids</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]),</span>\
                            <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grids</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">])</span> <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span><span class="o">-</span><span class="n">ncol</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">logs</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="n">ncol</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">ax</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grids</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">]),</span>\
                            <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grids</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">,</span><span class="n">j</span><span class="p">])</span> <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">align</span> <span class="o">==</span> <span class="s">&#39;col&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncol</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">logs</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">ax</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grids</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]),</span>\
                            <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grids</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">])</span> <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">]</span>
                <span class="k">if</span> <span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">logs</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">ax</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grids</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">]),</span>\
                            <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grids</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">,</span><span class="n">j</span><span class="p">])</span> <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">]</span>

        <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">)):</span>
            <span class="c"># Case of even logs, breaks after the last one</span>
<span class="c">#            print logs[j]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">j</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">logs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="n">grafpol</span><span class="p">(</span><span class="n">logs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">nstar</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">],</span> <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s">&#39;#{0:&lt;2d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count</span><span class="o">+</span><span class="n">k</span><span class="p">),</span> \
                    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&#39;center&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">&#39;italic&#39;</span><span class="p">,</span> \
                    <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_bgcolor</span><span class="p">(</span><span class="n">gencolour</span><span class="p">(</span><span class="n">ver</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_bgcolor</span><span class="p">(</span><span class="n">gencolour</span><span class="p">(</span><span class="n">ver</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
            
        <span class="n">_plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="c"># Generate graphs for the cases nlog &gt; 8</span>
    <span class="k">def</span> <span class="nf">gengraphm4</span><span class="p">(</span><span class="n">logs</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>

        <span class="n">nwin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span><span class="o">/</span><span class="mi">12</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwin</span><span class="p">):</span>

            <span class="c"># set nlin/ncol values</span>
            <span class="n">nlog</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="mi">12</span>
            <span class="n">ncol</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">if</span>   <span class="n">nlog</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>  <span class="n">nlin</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">ncol</span><span class="o">=</span><span class="n">nlog</span>
            <span class="k">elif</span> <span class="n">nlog</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>  <span class="n">nlin</span><span class="o">=</span><span class="mi">2</span>
            <span class="k">elif</span> <span class="n">nlog</span> <span class="o">&lt;=</span> <span class="mi">12</span><span class="p">:</span> <span class="n">nlin</span><span class="o">=</span><span class="mi">3</span>
            <span class="k">else</span><span class="p">:</span>            <span class="n">nlin</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span> <span class="n">nlog</span><span class="o">=</span><span class="mi">12</span>

            <span class="c"># set left/right parametes</span>
            <span class="k">if</span>   <span class="n">nlog</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">linit</span><span class="o">=</span><span class="mf">0.15</span>
            <span class="k">elif</span> <span class="n">nlog</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="n">linit</span><span class="o">=</span><span class="mf">0.08</span>
            <span class="k">else</span><span class="p">:</span>           <span class="n">linit</span><span class="o">=</span><span class="mf">0.05</span>

            <span class="c"># set top/bottom parameters</span>
            <span class="k">if</span>   <span class="n">nlog</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span> <span class="n">delt</span><span class="o">=</span><span class="mf">0.10</span><span class="p">;</span> <span class="n">tinit</span><span class="o">=</span><span class="mf">0.86</span><span class="p">;</span> <span class="n">binit</span><span class="o">=</span><span class="mf">0.00</span>
            <span class="k">elif</span> <span class="n">nlog</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span> <span class="n">delt</span><span class="o">=</span><span class="mf">0.13</span><span class="p">;</span> <span class="n">tinit</span><span class="o">=</span><span class="mf">0.90</span><span class="p">;</span> <span class="n">binit</span><span class="o">=</span><span class="mf">0.00</span>
            <span class="k">else</span><span class="p">:</span>           <span class="n">delt</span><span class="o">=</span><span class="mf">0.10</span><span class="p">;</span> <span class="n">tinit</span><span class="o">=</span><span class="mf">0.95</span><span class="p">;</span> <span class="n">binit</span><span class="o">=</span><span class="mf">0.05</span>
            
            <span class="n">fig</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">ncol</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">nlin</span><span class="p">))</span>

            <span class="c"># Creates the axes of first row</span>
            <span class="n">grids</span> <span class="o">=</span> <span class="p">[</span> <span class="n">_plt</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">nlin</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span> \
                            <span class="n">top</span><span class="o">=</span><span class="n">tinit</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">binit</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">delt</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">linit</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span> <span class="p">]</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ncol</span><span class="p">):</span>
                <span class="n">ax</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grids</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]),</span>\
                        <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grids</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">])</span> <span class="p">]</span>

            <span class="c"># Creates the axes of second row</span>
            <span class="k">if</span> <span class="n">nlin</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">grids</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">_plt</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">nlin</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span> \
                            <span class="n">top</span><span class="o">=</span><span class="n">tinit</span><span class="o">-</span><span class="n">delt</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">binit</span><span class="o">+</span><span class="n">delt</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">linit</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span> <span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ncol</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">j</span><span class="o">+</span><span class="n">ncol</span> <span class="o">&gt;=</span> <span class="n">nlog</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">ax</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grids</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">]),</span>\
                            <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grids</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">,</span><span class="n">j</span><span class="p">])</span> <span class="p">]</span>

            <span class="c"># Creates the axes of third row</span>
            <span class="k">if</span> <span class="n">nlin</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">grids</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">_plt</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">nlin</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span> \
                            <span class="n">top</span><span class="o">=</span><span class="n">tinit</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">delt</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">binit</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">linit</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span> <span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ncol</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">ncol</span> <span class="o">&gt;=</span> <span class="n">nlog</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">ax</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grids</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">4</span><span class="p">,</span><span class="n">j</span><span class="p">]),</span>\
                            <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grids</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">5</span><span class="p">,</span><span class="n">j</span><span class="p">])</span> <span class="p">]</span>

            <span class="c"># Generates the plots on the axes</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nlog</span><span class="p">):</span>
                <span class="n">grafpol</span><span class="p">(</span><span class="n">logs</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">12</span><span class="o">*</span><span class="n">i</span><span class="p">],</span> <span class="n">nstar</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">],</span> <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_bgcolor</span><span class="p">(</span><span class="n">gencolour</span><span class="p">(</span><span class="n">ver</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_bgcolor</span><span class="p">(</span><span class="n">gencolour</span><span class="p">(</span><span class="n">ver</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s">&#39;#{0:&lt;2d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">12</span><span class="p">),</span> \
                        <span class="n">horizontalalignment</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&#39;center&#39;</span><span class="p">,</span> \
                        <span class="n">style</span><span class="o">=</span><span class="s">&#39;italic&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">)</span>

            <span class="n">_plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="n">logs</span> <span class="o">=</span> <span class="n">_glob</span><span class="p">(</span><span class="s">&#39;{0}/*_{1}_*.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objdir</span><span class="p">,</span> <span class="n">filt</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">logs</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: log files not found to plot. May the file names </span><span class="se">\</span>
<span class="s">              {0}/*_{1}_*.log are wrong!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objdir</span><span class="p">,</span> <span class="n">filt</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="n">gps</span><span class="p">,</span> <span class="n">sublogs</span><span class="p">,</span> <span class="n">ver</span> <span class="o">=</span> <span class="n">combineout</span><span class="p">(</span><span class="n">logs</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="c"># 1) Case short mode</span>
    <span class="k">if</span> <span class="n">shortmode</span><span class="p">:</span>
        <span class="n">sortout</span> <span class="o">=</span> <span class="n">gengraphshort</span><span class="p">(</span><span class="n">sublogs</span><span class="p">,</span> <span class="n">gps</span><span class="p">)</span>

    <span class="c"># 2) Case long mode</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nlog</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">subb</span><span class="p">)</span> <span class="k">for</span> <span class="n">subb</span> <span class="ow">in</span> <span class="n">sublogs</span><span class="p">])</span>
        <span class="c"># If a few logfiles, tries to use only one window</span>
        <span class="k">if</span> <span class="n">nlog</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">test</span><span class="o">=</span><span class="bp">True</span>
            <span class="c"># Test if all groups have two reduction versions</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gps</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">gps</span><span class="p">),</span><span class="mi">2</span><span class="p">):</span>
                    <span class="c"># [:2] and not [:1] because gps is a list of lists</span>
                    <span class="k">if</span> <span class="n">gps</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">gps</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][:</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="n">test</span><span class="o">=</span><span class="bp">False</span>
                        <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">test</span><span class="o">=</span><span class="bp">False</span>
            <span class="k">if</span> <span class="n">test</span><span class="p">:</span>
                <span class="n">tver</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">tlogs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sublogs</span><span class="p">)):</span>
                    <span class="n">tlogs</span> <span class="o">+=</span> <span class="n">sublogs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">tver</span> <span class="o">+=</span> <span class="n">ver</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">gengraphl4</span><span class="p">(</span><span class="n">tlogs</span><span class="p">,</span> <span class="n">tver</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c"># Otherwise, loop on lamina groups</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>       <span class="c"># variable to print the graph number</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">gps</span><span class="p">):</span>
                <span class="n">nout</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">iver</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">ilogs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c">#            print i</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">gps</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">nout</span> <span class="o">&lt;=</span> <span class="mi">8</span> <span class="ow">and</span> <span class="n">gps</span><span class="p">[</span><span class="n">j</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">gps</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="n">nout</span> <span class="o">+=</span> <span class="n">gps</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">iver</span> <span class="o">+=</span> <span class="n">ver</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                        <span class="n">ilogs</span> <span class="o">+=</span> <span class="n">sublogs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="c"># if isn&#39;t last gps element, nout&lt;=8 and number of versions is 2, 4, 6, etc</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gps</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">nout</span> <span class="o">&lt;=</span> <span class="mi">8</span> <span class="ow">and</span> <span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">gengraphl4</span><span class="p">(</span><span class="n">ilogs</span><span class="p">,</span><span class="n">iver</span><span class="p">,</span><span class="n">count</span><span class="p">)</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="n">nout</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span>
    <span class="c">#                print(&#39;entrou 1&#39;)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">gengraphm4</span><span class="p">(</span><span class="n">sublogs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ver</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">count</span><span class="p">)</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sublogs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="c">#                print(&#39;entrou 2&#39;)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">sortout</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ilogs</span> <span class="ow">in</span> <span class="n">sublogs</span><span class="p">:</span>
            <span class="n">sortout</span> <span class="o">+=</span> <span class="p">[</span><span class="n">log</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;.out&#39;</span> <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">ilogs</span><span class="p">]</span>

    <span class="c"># returns the sorted logs/outs, with &#39;.log&#39; changed to &#39;.out&#39;</span>
    <span class="k">return</span> <span class="n">sortout</span>



<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="grafpol"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.grafpol">[docs]</a><span class="k">def</span> <span class="nf">grafpol</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">nstar</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ax1</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ax2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">extens</span><span class="o">=</span><span class="s">&#39;png&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Program to plot the best adjust and its residuals of IRAF reduction.</span>
<span class="sd">    &#39;filename&#39; is the path to the .log output file from reduction.</span>
<span class="sd">    nstar is the star number inside out/log files to be plotted.</span>

<span class="sd">    NEW: Working for *_WP1110....log files!</span>
<span class="sd">    NEW (2): Working for logfiles with more than a single star!</span>

<span class="sd">    Two working modes:</span>

<span class="sd">    1) If only filename is given: displays the graph or, case save=True,</span>
<span class="sd">       save it into the logfile directory.</span>
<span class="sd">       &#39;extens&#39; parameter changes the extension.</span>
<span class="sd">    2) If filename, one figure and two axes are given: changes these axes,</span>
<span class="sd">       adding plots in them. Doesn&#39;t display, either save at the end,</span>
<span class="sd">       only adds a plot to the axes. Usefull for subplots in same figure.</span>
<span class="sd">  </span>
<span class="sd">    Authors: Moser and Bednarski</span>
<span class="sd">    Current version: May, 2015</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">readlog</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c"># CAUTION! BLANK LINES WILL BE SKIPPED!</span>
            <span class="n">file0</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: File {0} not found!</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="p">[</span><span class="n">lixo</span><span class="p">,</span><span class="n">lixo</span><span class="p">,</span><span class="n">lixo</span><span class="p">,</span><span class="n">lixo</span><span class="p">,</span><span class="n">lixo</span><span class="p">,</span><span class="n">lixo</span><span class="p">,</span><span class="n">lixo</span><span class="p">,</span><span class="n">lixo</span><span class="p">,</span><span class="n">MJD</span><span class="p">,</span><span class="n">lixo</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">readoutMJD</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.log&#39;</span><span class="p">,</span><span class="s">&#39;.out&#39;</span><span class="p">),</span> <span class="n">nstar</span><span class="o">=</span><span class="n">nstar</span><span class="p">)</span>
        <span class="n">MJD</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">MJD</span><span class="p">)</span>


        <span class="c"># npts: number of WP valid to be plotted.</span>
        <span class="c"># totpts: used for the total number of WP (for the *.2_WP11110...1.out)</span>
        <span class="n">nstars</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">file0</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">npts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">file0</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>    <span class="c"># Blank lines were SKIPPED!</span>
        <span class="n">tnpts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">file0</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">file0</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">isinstar</span><span class="o">=</span><span class="bp">False</span>

        <span class="k">if</span> <span class="n">nstars</span> <span class="o">&lt;</span> <span class="n">nstar</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: File {0} has {1} stars (you have selected star #{2}).&#39;</span><span class="o">.</span>\
                                                        <span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">nstars</span><span class="p">,</span> <span class="n">nstar</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            
        <span class="c"># Bednarski: corrected (25 -&gt; 19, because the blank lines had been ignorated by</span>
        <span class="c">#            np.loadtext function)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">file0</span><span class="p">)):</span>
            <span class="k">if</span> <span class="s">&#39;STAR # {0:d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nstar</span><span class="p">)</span> <span class="ow">in</span> <span class="n">file0</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">isinstar</span><span class="o">=</span><span class="bp">True</span>
            <span class="k">elif</span> <span class="s">&#39;STAR # {0:d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nstar</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">file0</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">isinstar</span> <span class="ow">and</span> <span class="s">&#39;APERTURE&#39;</span> <span class="ow">in</span> <span class="n">file0</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">file0</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">sig</span> <span class="o">&lt;</span> <span class="n">sigma</span><span class="p">:</span>
                    <span class="n">sigma</span> <span class="o">=</span> <span class="n">sig</span>

                    <span class="n">fator</span> <span class="o">=</span> <span class="n">thtFactor</span><span class="p">(</span><span class="n">MJD</span><span class="p">)</span>
                    <span class="n">thet</span> <span class="o">=</span> <span class="n">fator</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">file0</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span>
                    <span class="k">while</span> <span class="n">thet</span> <span class="o">&gt;=</span> <span class="mi">180</span><span class="p">:</span>
                        <span class="n">thet</span> <span class="o">-=</span> <span class="mi">180</span>
                    <span class="k">while</span> <span class="n">thet</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">thet</span> <span class="o">+=</span> <span class="mi">180</span>
                        
                    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                    # Bed: Os Q e U sao os abaixo, conforme copiei da rotina graf.cl</span>
<span class="sd">                    if float(file0[i+2].split()[4]) &lt; 0:</span>
<span class="sd">                        thet = - float(file0[i+2].split()[4])</span>
<span class="sd">                    else:</span>
<span class="sd">                        thet = 180. - float(file0[i+2].split()[4])</span>
<span class="sd">                    &#39;&#39;&#39;</span>

                    <span class="c"># Recalculating the new QU parameters</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">file0</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">thet</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span>
                    <span class="n">U</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">file0</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">thet</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span>
<span class="c">#                    print Q, U, thet, float(file0[i+2].split()[3])</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">npts</span><span class="o">/</span><span class="mi">4</span> 
                    <span class="k">if</span> <span class="n">npts</span><span class="o">%</span><span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">P_pts</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                        <span class="n">P_pts</span> <span class="o">+=</span> <span class="n">file0</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="c"># I think the P values are in reverse order inside Pereyra&#39;s .log files:</span>
                    <span class="c"># Uncomment the two lines below if you want to show the ascending x-axes</span>
                    <span class="c"># (and not descending x-axes) and comment the next two lines.</span>
<span class="c">#                    P_pts = _np.array(P_pts, dtype=float)[::-1]</span>
<span class="c">#                    th_pts = fator*(22.5*_np.arange(1,tnpts+1)+delta/2.)</span>
                    <span class="n">P_pts</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P_pts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                    <span class="n">th_pts</span> <span class="o">=</span> <span class="o">-</span><span class="n">fator</span><span class="o">*</span><span class="p">(</span><span class="mf">22.5</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">tnpts</span><span class="p">)</span><span class="o">-</span><span class="n">delta</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
                    <span class="n">delta2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="o">+</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
                    <span class="c"># Bed: Funcionando para nlam &gt;= 10  para impresso correta</span>
<span class="c">#                    str_pts = map(str, _np.arange(1,tnpts+1)+delta2)[::-1]</span>
                    <span class="n">str_pts</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">tnpts</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">delta2</span><span class="p">)</span>

                    <span class="c"># Case _WP11110...1.log file</span>
                    <span class="k">if</span> <span class="n">npts</span> <span class="o">!=</span> <span class="n">tnpts</span><span class="p">:</span>
                        <span class="n">refs</span> <span class="o">=</span> <span class="n">file0</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">rm</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tnpts</span><span class="p">)</span> <span class="k">if</span> <span class="n">refs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;0&#39;</span><span class="p">]</span>
                        <span class="n">th_pts</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">th_pts</span><span class="p">,</span> <span class="n">rm</span><span class="p">)</span>
                        <span class="n">str_pts</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">str_pts</span><span class="p">,</span> <span class="n">rm</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sigma</span> <span class="o">==</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR reading the file </span><span class="si">%s</span><span class="s"> !&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">U</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">P_pts</span> <span class="o">=</span> <span class="n">th_pts</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">str_pts</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;0&#39;</span><span class="p">,</span><span class="s">&#39;0&#39;</span><span class="p">]</span>

        <span class="k">return</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">P_pts</span><span class="p">,</span> <span class="n">th_pts</span><span class="p">,</span> <span class="n">str_pts</span><span class="p">,</span> <span class="n">nstars</span><span class="p">,</span> <span class="n">fator</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">plotlog</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">sigma</span><span class="p">,</span><span class="n">P_pts</span><span class="p">,</span><span class="n">th_pts</span><span class="p">,</span><span class="n">str_pts</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">fator</span><span class="p">):</span>

        <span class="c"># extract the group number</span>
        <span class="n">WPpos</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;_WP&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">WPpos</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">suff</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[</span><span class="n">filename</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">suff</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[</span><span class="n">filename</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WPpos</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">r&#39;Q={0:.3f}, U={1:.3f}, $\sigma$={2:.3f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Q</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="n">U</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="n">sigma</span><span class="o">*</span><span class="mi">100</span><span class="p">),</span>
                       <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&#39;bottom&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.98</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="s">&#39;{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suff</span><span class="p">),</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s">&#39;right&#39;</span><span class="p">,</span> \
                 <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;p (%)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
        
        <span class="n">ysigma</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">th_pts</span><span class="p">))</span><span class="o">+</span><span class="n">sigma</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">th_pts</span><span class="p">,</span><span class="n">P_pts</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">ysigma</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
    
        <span class="n">th_det</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">th_pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*.</span><span class="mi">98</span><span class="p">,</span><span class="n">th_pts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1.02</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">P_det</span> <span class="o">=</span> <span class="n">Q</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">th_det</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span><span class="o">+</span><span class="n">U</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">th_det</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">th_det</span><span class="p">,</span> <span class="n">P_det</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">th_det</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">th_det</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;k--&#39;</span><span class="p">)</span>    
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">th_pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">fator</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="n">th_pts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1.02</span><span class="o">-</span><span class="n">fator</span><span class="o">*</span><span class="mf">1.5</span><span class="p">])</span>
<span class="c">#        ax1.set_xlim([th_pts[0]-4,th_pts[-1]*1.02+3][::-1])</span>
<span class="c">#        ax1.set_ylim([min(P_pts*100)*1.1, max(P_pts*100)*1.1])</span>

        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;WP position&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Residuals&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">th_pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">fator</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="n">th_pts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1.02</span><span class="o">-</span><span class="n">fator</span><span class="o">*</span><span class="mf">1.5</span><span class="p">])</span>
<span class="c">#        ax2.set_xlim([th_pts[0]-4,th_pts[-1]*1.02+3][::-1])</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">th_det</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">th_det</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;k--&#39;</span><span class="p">)</span>

        <span class="n">_plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax1</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ax1</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">transOffset</span> <span class="o">=</span> <span class="n">_offset_copy</span><span class="p">(</span><span class="n">ax2</span><span class="o">.</span><span class="n">transData</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.00</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.10</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&#39;inches&#39;</span><span class="p">)</span>
        
        <span class="n">P_fit</span> <span class="o">=</span> <span class="n">Q</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">th_pts</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span><span class="o">+</span><span class="n">U</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">th_pts</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
        
        <span class="c"># Bed: Agora plota os residuos relativos (residuos divididos por sigma)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">th_pts</span><span class="p">,</span> <span class="p">(</span><span class="n">P_pts</span><span class="o">-</span><span class="n">P_fit</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
    
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">th_pts</span><span class="p">)):</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">th_pts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="n">P_pts</span><span class="o">-</span><span class="n">P_fit</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sigma</span><span class="p">,</span> <span class="n">str_pts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">transOffset</span><span class="p">)</span>  

        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">ax2</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">ax2</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">passo</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">passo</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="n">ax2</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ax2</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">ax2</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">passo</span><span class="p">))</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ax1</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">(),</span> <span class="n">size</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">ax1</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">(),</span> <span class="n">size</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">ax2</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">()[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ax2</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">()))],</span> <span class="n">size</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">ax2</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">(),</span> <span class="n">size</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

        <span class="k">return</span>



    <span class="k">if</span> <span class="n">fig</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">ax1</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">ax2</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">Q</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">P_pts</span><span class="p">,</span> <span class="n">th_pts</span><span class="p">,</span> <span class="n">str_pts</span><span class="p">,</span> <span class="n">nstars</span><span class="p">,</span> <span class="n">fator</span> <span class="o">=</span> <span class="n">readlog</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">plotlog</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">sigma</span><span class="p">,</span><span class="n">P_pts</span><span class="p">,</span><span class="n">th_pts</span><span class="p">,</span><span class="n">str_pts</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">fator</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nstars</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">_plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.log&#39;</span><span class="p">,</span><span class="s">&#39;.&#39;</span><span class="o">+</span><span class="n">extens</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.log&#39;</span><span class="p">,</span><span class="s">&#39;_star{0}.{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nstar</span><span class="p">,</span><span class="n">extens</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Q</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">P_pts</span><span class="p">,</span> <span class="n">th_pts</span><span class="p">,</span> <span class="n">str_pts</span><span class="p">,</span> <span class="n">nstars</span><span class="p">,</span> <span class="n">fator</span> <span class="o">=</span> <span class="n">readlog</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">plotlog</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">sigma</span><span class="p">,</span><span class="n">P_pts</span><span class="p">,</span><span class="n">th_pts</span><span class="p">,</span><span class="n">str_pts</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">fator</span><span class="p">)</span>
            
    <span class="k">return</span>



<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="verStdPol"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.verStdPol">[docs]</a><span class="k">def</span> <span class="nf">verStdPol</span><span class="p">(</span><span class="n">std</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">sig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate z test for standard &#39;std&#39;, filter &#39;filt&#39;, comparing</span>
<span class="sd">    the observed polarization &#39;p&#39; +- &#39;sig&#39; and the published value.</span>

<span class="sd">    Return z = abs(ppub-p)/sqrt(sigpub^2+sig^2) or -1 if there is</span>
<span class="sd">    no such object or filter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lstds</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/refs/pol_padroes.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

    <span class="c"># Get P_pub value</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">stdchk</span><span class="p">(</span><span class="n">std</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span><span class="o">+</span><span class="mi">11</span> <span class="c"># +11 devido as colunas a serem puladas pra</span>
                                   <span class="c"># chegar a coluna das polarizacoes</span>
        <span class="n">ppub</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lstds</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
        <span class="n">sppub</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lstds</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">5</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">ppub</span><span class="o">==</span><span class="mf">0.</span> <span class="ow">or</span> <span class="p">(</span><span class="n">sppub</span><span class="o">==</span><span class="mf">0.</span> <span class="ow">and</span> <span class="n">sig</span><span class="o">==</span><span class="mf">0.</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
<span class="c">#    if ztest &gt; 2.5</span>
<span class="c">#       loglines += (&#39;# CAUTION! Standard {0}, {1}, has polarization only compatible &#39;+\</span>
<span class="c">#                                  &#39;within {2:.1f} sigma.\n&#39;).format(std, f, ztest)</span>

    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ppub</span><span class="o">-</span><span class="n">p</span><span class="p">)</span><span class="o">/</span><span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sppub</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">sig</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>



<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="readTests"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.readTests">[docs]</a><span class="k">def</span> <span class="nf">readTests</span><span class="p">(</span><span class="n">tests</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read boolean list &#39;tests&#39; concerning to dictests</span>
<span class="sd">    dictionary and return a string list with tags and</span>
<span class="sd">    the flag value (&#39;OK&#39;,&#39;E&#39;,&#39;W&#39;)</span>

<span class="sd">    &#39;tags&#39; and &#39;flag&#39; are optional and are concerning to</span>
<span class="sd">    another tags already assigned and the current flag. The flag</span>
<span class="sd">    returned is the worst flag found between them</span>
<span class="sd">    (e.g., if input &#39;flag&#39; is &#39;W&#39; and tests results on flag</span>
<span class="sd">    &#39;OK&#39;, return flag &#39;W&#39;; if tests results in flag &#39;E&#39;,</span>
<span class="sd">    return &#39;E&#39;). Also, if they are given as input, return</span>
<span class="sd">    &#39;tags&#39;+tags concerning to &#39;tests&#39; list.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tagstr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="c"># Generate a string for such tests tags</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dictests</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">tests</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">tagstr</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="n">tagstr</span> <span class="o">+=</span> <span class="s">&#39;,&#39;</span>
            <span class="n">tagstr</span> <span class="o">+=</span> <span class="n">dictests</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="c"># Generate a string for such tags</span>
    <span class="k">if</span> <span class="n">tags</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dictags</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tags</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">tagstr</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">tagstr</span> <span class="o">+=</span> <span class="s">&#39;,&#39;</span>
                <span class="n">tagstr</span> <span class="o">+=</span> <span class="n">dictags</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="s">&#39;OK&#39;</span>

    <span class="c"># Get the worst case for the flag</span>
    <span class="k">if</span> <span class="s">&#39;E&#39;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dictests</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tests</span><span class="p">))</span> <span class="k">if</span> <span class="n">tests</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">+</span><span class="p">[</span><span class="n">flag</span><span class="p">]:</span>
        <span class="n">flag2</span> <span class="o">=</span> <span class="s">&#39;E&#39;</span>
    <span class="k">elif</span> <span class="s">&#39;W&#39;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dictests</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tests</span><span class="p">))</span> <span class="k">if</span> <span class="n">tests</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">+</span><span class="p">[</span><span class="n">flag</span><span class="p">]:</span>
        <span class="n">flag2</span> <span class="o">=</span> <span class="s">&#39;W&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flag2</span> <span class="o">=</span> <span class="s">&#39;OK&#39;</span>

    <span class="k">if</span> <span class="n">tagstr</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="n">tagstr</span> <span class="o">=</span> <span class="s">&#39;---&#39;</span>
    
    <span class="k">return</span> <span class="n">tagstr</span><span class="p">,</span> <span class="n">flag2</span>

    

    
<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c"># Bednarski: I added delta variable to (calc-calcst) tolerance</span></div>
<div class="viewcode-block" id="chkStdLog"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.chkStdLog">[docs]</a><span class="k">def</span> <span class="nf">chkStdLog</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">calc</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify if there are standards for filter `f` and</span>
<span class="sd">    calcite `calc` inside path/std.dat. Return True if</span>
<span class="sd">    successful, unless the standard has been reduced</span>
<span class="sd">    and marked with `E` flag.</span>

<span class="sd">    delta is the allowed variation for the angles between the two</span>
<span class="sd">    beams for one same calcite.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">loglines</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">path</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="c"># Read `obj.dat` and `std.dat`. If there are errors, assigns [&#39;&#39;] to get inside</span>
    <span class="c"># ifs below and print error messages</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/std.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

    <span class="c"># Verify if std.dat has more than one line. Caso no, do reshape (transform</span>
    <span class="c"># list type [] in [[]] for further compatibility)</span>
    <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">std</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c"># If std is of type [] -- one line with 9 elements:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">std</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">std</span><span class="p">)</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
            <span class="n">std</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">std</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">std</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">9</span><span class="p">)</span> \
                                <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">std</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">std</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">):</span>
            <span class="c"># Save loglines only if this function was called by genLog</span>
            <span class="k">if</span> <span class="n">_getouterframes</span><span class="p">(</span><span class="n">_currentframe</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;genLog&#39;</span><span class="p">:</span>
                <span class="n">writeLog</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;# ERROR: polt.chkStdLog() not runned! Incompatible number &#39;</span><span class="o">+</span> \
                                                            <span class="s">&#39;of columns in `std.dat`.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: Incompatible number of columns in `std.dat`.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="n">foundstd</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">stdi</span> <span class="ow">in</span> <span class="n">std</span><span class="p">:</span>
    <span class="c"># Skip if stdi is not to use (&#39;Error&#39; flag)</span>
        <span class="k">if</span> <span class="n">stdi</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;E&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">fst</span> <span class="o">=</span> <span class="n">stdi</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">calcst</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">stdi</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="n">fst</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">calc</span><span class="o">-</span><span class="n">calcst</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">delta</span><span class="p">:</span>
            <span class="n">foundstd</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">foundstd</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">((</span><span class="s">&#39;# WARNING: Standard star not found for filt. {0} and &#39;</span><span class="o">+</span>\
            <span class="s">&#39;calc. {1:.1f}</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">calc</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">foundstd</span>



<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="writeLog"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.writeLog">[docs]</a><span class="k">def</span> <span class="nf">writeLog</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">strin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Append &#39;strin&#39; string into &#39;path&#39;/polt.log file</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">f0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;{0}/polt.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s">&#39;a&#39;</span><span class="p">)</span>
    <span class="n">f0</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">strin</span><span class="p">)</span>
    <span class="n">f0</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span>



<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="genLog"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.genLog">[docs]</a><span class="k">def</span> <span class="nf">genLog</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">subdirs</span><span class="p">,</span> <span class="n">tgts</span><span class="p">,</span> <span class="n">fileout</span><span class="p">,</span> <span class="n">sigtol</span><span class="o">=</span><span class="k">lambda</span> <span class="n">sigm</span><span class="p">:</span> <span class="mf">1.4</span><span class="o">*</span><span class="n">sigm</span><span class="p">,</span> \
                    <span class="n">autochoose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">3.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate the .dat file with data of objects &#39;tgts[:]&#39; inside</span>
<span class="sd">    &#39;path&#39;/&#39;subdirs[:]&#39; directories</span>

<span class="sd">    Save the results in &#39;path&#39;/&#39;fileout&#39;</span>
<span class="sd">    Usable to generate target and standard lists (obj.dat and std.dat)</span>

<span class="sd">    delta: tolerance for the angle between the two beams of calcite.</span>
<span class="sd">           If abs(angle1 - angle2) &lt; delta, both observations 1 and 2</span>
<span class="sd">           are assigned as the same calcite.</span>
<span class="sd">    sigtol: tolerance to use the outfiles with all WP instead the</span>
<span class="sd">            out with best error. Must be a &#39;function&#39; that receives</span>
<span class="sd">            a pol sigma value (in decimal system and NOT in per cent,</span>
<span class="sd">            i.e., value from 0. to 1., where 1 is a 100% polarized</span>
<span class="sd">            source) and return the maximum sigma for which to ignore</span>
<span class="sd">            the best out. Its format must be a &#39;python&#39;s lambda function&#39;!</span>
<span class="sd">            The default values is sigtol=lambda sigm: 1.4*sigm, while</span>
<span class="sd">            the old value was sigtol=lambda sigm: 1.1*sigm + 0.00005. If</span>
<span class="sd">            you want to take just the groups with all WP, and none other,</span>
<span class="sd">            you can specify sigtol=lambda sigm: 1000.*sigm, for example.</span>
<span class="sd">    autochoose: choose best outfiles automatically, without</span>
<span class="sd">                interaction?</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">fileout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;std&#39;</span><span class="p">:</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="s">&#39;standards&#39;</span>
    <span class="k">elif</span> <span class="n">fileout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;obj&#39;</span><span class="p">:</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="s">&#39;targets&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">fileout</span>

<span class="c">#    if mode not in (&#39;std&#39;,&#39;obj&#39;):</span>
<span class="c">#        print(&#39;\n# ERROR: mode \&#39;{0}\&#39; not valid (it\&#39;s only valid \&#39;std\&#39; and \&#39;obj\&#39;)&#39;.format(mode))</span>
<span class="c">#        return 1</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tgts</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subdirs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s"># ERROR: polt.genLog() NOT RUNNED for {0} (len(tgts) != len(subdirs))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">typ</span><span class="p">))</span>
        <span class="n">writeLog</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;# ERROR: polt.genLog() NOT RUNNED for {0}! (len(tgts) != len(subdirs))</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">typ</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="n">continuerun</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c"># Checking if there exists a previous run and if it has generated unless one line.</span>
    <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}.tmp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">fileout</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/{1}.tmp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">fileout</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">while</span> <span class="n">opt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">,</span><span class="s">&#39;n&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">):</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">((</span><span class="s">&#39;There exists one file concerning to a uncompleted previous run for {0}. &#39;</span> <span class="o">+</span>\
                            <span class="s">&#39;Do you want to continue where it was stopped? (y/n): &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">typ</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">):</span>
                <span class="n">continuerun</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">continuerun</span><span class="p">:</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;{0}/{1}.tmp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">fileout</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f0</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s">&#39;{:12s} {:&gt;7s} {:&gt;10s} {:4s} {:&gt;5s} {:&lt;s} {:&gt;4s} {:&gt;5s}  {:&lt;s}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;#MJD&#39;</span><span class="p">,</span><span class="s">&#39;ccd&#39;</span><span class="p">,</span>\
                    <span class="s">&#39;target&#39;</span><span class="p">,</span><span class="s">&#39;filt&#39;</span><span class="p">,</span><span class="s">&#39;calc&#39;</span><span class="p">,</span><span class="s">&#39;:::outfile:::&#39;</span><span class="p">,</span><span class="s">&#39;star&#39;</span><span class="p">,</span><span class="s">&#39;flag&#39;</span><span class="p">,</span><span class="s">&#39;tags&#39;</span><span class="p">))</span>
        <span class="n">f0</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c"># Case continuing a previous run, identify the stars already runned</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ftemp</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/{1}.tmp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">fileout</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">odone</span><span class="o">=</span><span class="p">[]</span>  <span class="c"># odone and fdone is lists that contains subdirectories, star number and the</span>
        <span class="n">fdone</span><span class="o">=</span><span class="p">[]</span>                                    <span class="c"># filters already done by the previous run</span>
        <span class="c"># If there is just one line, transform np array type [] for [[]]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ftemp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ftemp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">9</span><span class="p">:</span>
            <span class="n">ftemp</span> <span class="o">=</span> <span class="n">ftemp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ftemp</span><span class="p">:</span>
            <span class="c"># [3:] because the firsts characters are &#39;:::&#39;</span>
            <span class="n">objct</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">:],</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">objct</span> <span class="ow">in</span> <span class="n">odone</span><span class="p">:</span>
                <span class="n">indx</span> <span class="o">=</span> <span class="n">odone</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">objct</span><span class="p">)</span>
                <span class="n">fdone</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">odone</span> <span class="o">+=</span> <span class="p">[</span><span class="n">objct</span><span class="p">]</span>
                <span class="n">fdone</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]]]</span>
<span class="c">#        print odone</span>
<span class="c">#        print fdone</span>
        
    <span class="c"># Loop on list of objects</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tgts</span><span class="p">)):</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="n">tgts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">objdir</span> <span class="o">=</span> <span class="n">subdirs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c"># Loop on filters</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>

            <span class="n">nstars</span> <span class="o">=</span> <span class="n">countStars</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">objdir</span><span class="p">),</span> <span class="n">f</span><span class="p">)</span>

            <span class="c"># Check if there exist fits files for object/filter, but not .out files (target not reduced)</span>
            <span class="k">if</span> <span class="n">nstars</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_glob</span><span class="p">(</span><span class="s">&#39;{0}/{1}/*_{2}_*.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">objdir</span><span class="p">,</span><span class="n">f</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">0</span> \
                            <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">_glob</span><span class="p">(</span><span class="s">&#39;{0}/{1}/{2}/p??0&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">objdir</span><span class="p">,</span><span class="n">f</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">print</span><span class="p">((</span><span class="s">&#39;</span><span class="se">\n</span><span class="s"># ERROR: {0}_{1}: Fits files found, but the object was not reduced! &#39;</span> <span class="o">+</span>\
                        <span class="s">&#39;Reduce and run again...</span><span class="se">\n\n</span><span class="s"> - HINT: if these fits files compose some &#39;</span> <span class="o">+</span>\
                        <span class="s">&#39;non-valid serie but need be kept in, move them for a subdir {2}/tmp, &#39;</span> <span class="o">+</span>\
                        <span class="s">&#39;and hence, the path will not be sweept by routine.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objdir</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">objdir</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="c"># Check if there exist some .out file for such object/filter, but not the fits files</span>
            <span class="k">elif</span> <span class="n">nstars</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_glob</span><span class="p">(</span><span class="s">&#39;{0}/{1}/*_{2}_*.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">objdir</span><span class="p">,</span><span class="n">f</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span> \
                                    <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">_glob</span><span class="p">(</span><span class="s">&#39;{0}/{1}/{2}/p??0&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">objdir</span><span class="p">,</span><span class="n">f</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">print</span><span class="p">((</span><span class="s">&#39;</span><span class="se">\n</span><span class="s"># ERROR: {0}_{1}: Fits files not found, but were found *_{2}_* files. &#39;</span> <span class="o">+</span>\
                        <span class="s">&#39;It can be by three reasons:</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span>\
                        <span class="s">&#39;  1) Fits files missing (in this case, search by them and add in such directory);</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span>\
                        <span class="s">&#39;  2) The found *_{3}_* files can be </span><span class="se">\&#39;</span><span class="s">spurious files</span><span class="se">\&#39;</span><span class="s"> (in this case, delete them);</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span>\
                        <span class="s">&#39;  3) The preffix of *_{4}_*.fits files can be different of the rest of *_{5}_* &#39;</span> <span class="o">+</span>\
                        <span class="s">&#39;files (in this case, rename them).</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objdir</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">f</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c"># Working for more than a single star inside .out files</span>
            <span class="k">for</span> <span class="n">nstar</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nstars</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

                <span class="n">loglines</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="c"># Skip if the object/filter was done already in a previous run</span>
                <span class="k">if</span> <span class="n">continuerun</span> <span class="ow">and</span> <span class="p">[</span><span class="n">objdir</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">nstar</span><span class="p">)]</span> <span class="ow">in</span> <span class="n">odone</span> <span class="ow">and</span> \
                                                <span class="n">f</span> <span class="ow">in</span> <span class="n">fdone</span><span class="p">[</span><span class="n">odone</span><span class="o">.</span><span class="n">index</span><span class="p">([</span><span class="n">objdir</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">nstar</span><span class="p">)])]:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">nstars</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="n">tgts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>   <span class="c"># It is needed this line here again</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                        <span class="n">obj</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">((</span><span class="s">&#39;Type a name for star #{0:d} (of {1:d}) &#39;</span> <span class="o">+</span>\
                               <span class="s">&#39;inside {2} dir, filter {3}: &#39;</span><span class="p">)</span><span class="o">.</span> <span class="n">format</span><span class="p">(</span><span class="n">nstar</span><span class="p">,</span> <span class="n">nstars</span><span class="p">,</span> <span class="n">objdir</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">obj</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span> <span class="ow">and</span> <span class="s">&#39; &#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obj</span> <span class="ow">and</span> <span class="s">&#39;#&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obj</span> <span class="ow">and</span> <span class="s">&#39;:&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                            <span class="n">loglines</span> <span class="o">+=</span> <span class="s">&#39;# WARNING: {0}_{1}: There are more than one star inside .out files.&#39;</span>\
                                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objdir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span><span class="o">+</span><span class="s">&#39; Star #{0:d} was named as {1}.</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nstar</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
                            <span class="k">break</span>

                <span class="k">if</span> <span class="n">autochoose</span><span class="p">:</span>
                    <span class="n">outs</span> <span class="o">=</span> <span class="n">chooseout</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">objdir</span><span class="p">),</span> <span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">nstar</span><span class="o">=</span><span class="n">nstar</span><span class="p">,</span> <span class="n">sigtol</span><span class="o">=</span><span class="n">sigtol</span><span class="p">)</span>
                    <span class="n">tags</span><span class="o">=</span><span class="bp">None</span>
                    <span class="n">flag</span><span class="o">=</span><span class="bp">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outs</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">flag</span> <span class="o">=</span> <span class="n">queryout</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">objdir</span><span class="p">),</span> <span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">nstar</span><span class="o">=</span><span class="n">nstar</span><span class="p">,</span> <span class="n">sigtol</span><span class="o">=</span><span class="n">sigtol</span><span class="p">)</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                        
                <span class="c"># Loop on outfiles</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outs</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">outs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                        <span class="p">[</span><span class="n">Q</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">th</span><span class="p">,</span><span class="n">sigT</span><span class="p">,</span><span class="n">ap</span><span class="p">,</span><span class="n">star</span><span class="p">,</span><span class="n">MJD</span><span class="p">,</span><span class="n">calc</span><span class="p">]</span> <span class="o">=</span> <span class="n">readoutMJD</span><span class="p">(</span><span class="n">outs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">nstar</span><span class="o">=</span><span class="n">nstar</span><span class="p">)</span>
                        <span class="n">tests</span><span class="p">,</span> <span class="n">logs</span> <span class="o">=</span> <span class="n">verout</span><span class="p">(</span><span class="n">outs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">nstar</span><span class="o">=</span><span class="n">nstar</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">)</span>
                        <span class="n">loglines</span> <span class="o">+=</span> <span class="n">logs</span>
                        <span class="k">if</span> <span class="n">tags</span><span class="o">!=</span><span class="bp">None</span> <span class="ow">and</span> <span class="n">flag</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
                            <span class="n">tagstr</span><span class="p">,</span> <span class="n">flagout</span> <span class="o">=</span> <span class="n">readTests</span><span class="p">(</span><span class="n">tests</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">flag</span><span class="o">=</span><span class="n">flag</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">tagstr</span><span class="p">,</span> <span class="n">flagout</span> <span class="o">=</span> <span class="n">readTests</span><span class="p">(</span><span class="n">tests</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
                        
                        <span class="c"># It is needed to open and close in each object</span>
                        <span class="n">lines</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&#39;{0:12.6f} {1:&gt;7s} {2:&gt;10s} {3:&gt;4s} {4:&gt;5.1f} {5:&lt;s} {6:&gt;4d} &#39;</span> \
                                    <span class="s">&#39;{7:&gt;5s}  {8:&lt;s}</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">MJD</span><span class="p">,</span> <span class="n">ccd</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">calc</span><span class="p">),</span> \
                                    <span class="s">&#39;:::&#39;</span><span class="o">+</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">outs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">path</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;:::&#39;</span><span class="p">,</span> <span class="n">nstar</span><span class="p">,</span> <span class="n">flagout</span><span class="p">,</span> <span class="n">tagstr</span><span class="p">)</span>

                <span class="c"># Write lines after process all outfiles for object in one filter</span>
                <span class="k">if</span> <span class="n">lines</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">writeLog</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">loglines</span><span class="p">)</span>
                    <span class="n">f0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;{0}/{1}.tmp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">fileout</span><span class="p">),</span> <span class="s">&#39;a&#39;</span><span class="p">)</span>
                    <span class="n">f0</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                    <span class="n">f0</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


    <span class="c"># Read fileout+&#39;.tmp&#39;, realign columns to fileout and delete fileout+&#39;.tmp&#39;</span>
    <span class="n">fin</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;{0}/{1}.tmp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">fileout</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">li</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:::&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="n">fin</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>
    <span class="n">fin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">writeLog</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;# WARNING: No valid {0} were found by polt.genLog().</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">typ</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">maxsize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">li</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">])</span>
        <span class="n">linesout</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span>
                <span class="k">continue</span>        
            <span class="n">linesout</span> <span class="o">+=</span> <span class="p">[</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">maxsize</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">fout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">fileout</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">linesout</span><span class="p">)</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="s">&#39;{0}/{1}.tmp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">fileout</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>


    <span class="k">return</span> <span class="mi">0</span>




<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="genAllLog"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.genAllLog">[docs]</a><span class="k">def</span> <span class="nf">genAllLog</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sigtol</span><span class="o">=</span><span class="k">lambda</span> <span class="n">sigm</span><span class="p">:</span> <span class="mf">1.4</span><span class="o">*</span><span class="n">sigm</span><span class="p">,</span> <span class="n">autochoose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">3.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate the std.dat/obj.dat for one reduced night</span>
<span class="sd">    </span>
<span class="sd">    path: path of night</span>
<span class="sd">    delta: tolerance for the angle between the two beams of calcite.</span>
<span class="sd">           If abs(angle1 - angle2) &lt; delta, both observations 1 and 2</span>
<span class="sd">           are assigned as the same calcite.</span>
<span class="sd">    sigtol: tolerance to use the outfiles with all WP instead the</span>
<span class="sd">            out with best error. Must be a &#39;function&#39; that receives</span>
<span class="sd">            a pol sigma value (in decimal system and NOT in per cent,</span>
<span class="sd">            i.e., value from 0. to 1., where 1 is a 100% polarized</span>
<span class="sd">            source) and return the maximum sigma for which to ignore</span>
<span class="sd">            the best out. Its format must be a &#39;python&#39;s lambda function&#39;!</span>
<span class="sd">            The default values is sigtol=lambda sigm: 1.4*sigm, while</span>
<span class="sd">            the old value was sigtol=lambda sigm: 1.1*sigm + 0.00005. If</span>
<span class="sd">            you want to take just the groups with all WP, and none other,</span>
<span class="sd">            you can specify sigtol=lambda sigm: 1000.*sigm, for example.</span>
<span class="sd">    autochoose: choose best outfiles automatically, without</span>
<span class="sd">                interaction?</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">path</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="c"># Verifies if std.dat and obj.dat files exist. Case True, queries to delete</span>
    <span class="c"># Doesn&#39;t delete polt.log because the aiming is keep every information about the previous run</span>
    <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/std.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/obj.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">verif</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;Caution: obj.dat and std.dat already exists. Are you sure to overwrite it/them (y/n): &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verif</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;n&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Aborted!&#39;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">elif</span> <span class="n">verif</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">):</span>
                    <span class="k">break</span>
            <span class="k">for</span> <span class="n">arq</span> <span class="ow">in</span> <span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s">&#39;/obj.dat&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">+</span><span class="s">&#39;/std.dat&#39;</span><span class="p">):</span> <span class="c">#, path+&#39;/polt.log&#39;):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">arq</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/obj.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="ow">and</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/obj.dat.tmp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;# WARNING: keeping file std.dat and processing only obj.dat...</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="c"># Generates lists</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ltgts</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/refs/pol_alvos.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/refs/pol_hip.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">())):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ltgts</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ltgts</span><span class="p">,</span><span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/refs/pol_hip.txt&#39;</span><span class="o">.</span>\
                                                    <span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/refs/pol_unpol.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">())):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ltgts</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ltgts</span><span class="p">,</span><span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/refs/pol_unpol.txt&#39;</span><span class="o">.</span>\
                                                    <span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">lstds</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/refs/pol_padroes.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">()),</span> \
                                                           <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: Can</span><span class="se">\&#39;</span><span class="s">t read files pyhdust/refs/pol_alvos.txt and/or pyhdust/refs/pol_padroes.txt.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">subdirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">fld</span> <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">_os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s">&#39;{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="k">if</span> \
            <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">fld</span><span class="p">))]</span>
    <span class="n">tgts</span><span class="o">=</span><span class="p">[]</span>    <span class="c"># variable for real target names, not the subdirectory names</span>
    <span class="n">stds</span><span class="o">=</span><span class="p">[]</span>    <span class="c"># variable for real standard names, not the subdirectory names</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="c"># set ccd name from first .fits file</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">setCCD</span><span class="p">(</span><span class="n">_glob</span><span class="p">(</span><span class="s">&#39;{0}/{1}/*.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subdirs</span><span class="p">)</span>\
                                                                            <span class="k">if</span> <span class="n">k</span><span class="o">!=</span><span class="s">&#39;&#39;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">setCCD</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>     <span class="c"># set manually inside the function</span>

    <span class="c"># Verifies if object is a standard star or target</span>
    <span class="c"># (Works on directories with suffix also (like &#39;dsco_a0&#39;))</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="p">[</span><span class="n">elem</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">subdirs</span><span class="p">]:</span>
        <span class="n">obj_curr</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="k">while</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">ltgts</span><span class="p">,</span><span class="n">lstds</span><span class="p">,</span><span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s">&#39;calib&#39;</span><span class="p">,</span><span class="s">&#39;flat&#39;</span><span class="p">,</span><span class="s">&#39;dark&#39;</span><span class="p">,</span><span class="s">&#39;bias&#39;</span><span class="p">]))):</span>
            <span class="k">if</span> <span class="n">obj_curr</span> <span class="o">==</span> <span class="n">obj</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Object {0} is not a known target or standard!!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj_curr</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Object {0} (and {1}) is not a known target or standard!!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj_curr</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;Type the common name (you can add a new target inside pyhdust/ref/pol_*.txt files, but be careful!): &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">lstds</span><span class="p">:</span>
            <span class="n">tgts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="c"># Only assigns standard&#39;s name if there is no std.dat file. Otherwise,</span>
            <span class="c"># it&#39;s because the actual run will process only the targets, not standards.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/std.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
                <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">ltgts</span><span class="p">:</span>
            <span class="n">tgts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">obj</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;calib&#39;</span><span class="p">,</span><span class="s">&#39;flat&#39;</span><span class="p">,</span><span class="s">&#39;dark&#39;</span><span class="p">,</span><span class="s">&#39;bias&#39;</span><span class="p">):</span>
            <span class="n">tgts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="n">writeLog</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;#### BEGIN</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/std.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
        <span class="n">genLog</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">subdirs</span><span class="p">,</span> <span class="n">stds</span><span class="p">,</span> <span class="n">fileout</span><span class="o">=</span><span class="s">&#39;std.dat&#39;</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span> <span class="n">sigtol</span><span class="o">=</span><span class="n">sigtol</span><span class="p">,</span> <span class="n">autochoose</span><span class="o">=</span><span class="n">autochoose</span><span class="p">)</span>
    <span class="n">genLog</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">subdirs</span><span class="p">,</span> <span class="n">tgts</span><span class="p">,</span> <span class="n">fileout</span><span class="o">=</span><span class="s">&#39;obj.dat&#39;</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span> <span class="n">sigtol</span><span class="o">=</span><span class="n">sigtol</span><span class="p">,</span> <span class="n">autochoose</span><span class="o">=</span><span class="n">autochoose</span><span class="p">)</span>

    <span class="c"># Write user name and date+time</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">_pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">getuid</span><span class="p">())[</span><span class="mi">4</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">username</span><span class="o">.</span><span class="n">find</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">username</span><span class="p">[:</span><span class="n">username</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)]</span>
    <span class="n">loglines</span> <span class="o">=</span> <span class="n">_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Generated at: %Y/%m/</span><span class="si">%d</span><span class="s"> - %I:%M %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">loglines</span> <span class="o">+=</span> <span class="s">&#39;          by: &#39;</span> <span class="o">+</span> <span class="n">_pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">getuid</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; (&#39;</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="s">&#39;)</span><span class="se">\n\n</span><span class="s">&#39;</span>
    <span class="n">writeLog</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">loglines</span><span class="p">)</span>
    
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;{0}/polt.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fl</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">{0}</span><span class="se">\n</span><span class="s">POLTOOLS LOG (content of {1}/polt.log)</span><span class="se">\n\n</span><span class="s">{2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="o">*</span><span class="mi">40</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">fl</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>

    <span class="k">return</span>




<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="corObjStd"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.corObjStd">[docs]</a><span class="k">def</span> <span class="nf">corObjStd</span><span class="p">(</span><span class="n">night</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">calc</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the correction factor delta theta for filter &#39;f&#39;</span>
<span class="sd">    inside night &#39;night&#39;, for calcite &#39;calc&#39; (the last variable</span>
<span class="sd">    must be the angle between the ord. and extraord. beams).</span>
<span class="sd">    Returns the values for matching standard stars inside</span>
<span class="sd">    &#39;night&#39;/std.dat file, except when marked with an &#39;E&#39; flag.</span>

<span class="sd">    NEW: In case of missing data in filter &#39;f&#39;, this routine</span>
<span class="sd">         tries to compute delta theta by using the data from</span>
<span class="sd">         another filter, making use of the relations among the</span>
<span class="sd">         values of delta theta for each filter). But only the</span>
<span class="sd">         estimate presenting the smaller error will be taken.</span>

<span class="sd">    verbose: auxiliary variable used as False inside</span>
<span class="sd">             polt.genTarget routine. Keep it as True</span>
<span class="sd">             otherwise.</span>

<span class="sd">    Formulas:</span>
<span class="sd">        * dth = fact*th^std_measured - th^std_published</span>
<span class="sd">        * fact = -1  for observations before 2015 March 1st</span>
<span class="sd">                 +1  otherwise</span>

<span class="sd">    delta: tolerance, in degree, of angle of two beams for</span>
<span class="sd">           one same calcite (default: +/-3.5 degree)</span>

<span class="sd">    Output, in order: stdnames, mdth, smdth, flag, tags</span>
<span class="sd">      - stdnames: string with standard star names separated</span>
<span class="sd">                  by commas (,)</span>
<span class="sd">      - mdth: mean delta theta (corrected by the output factor</span>
<span class="sd">              +-1 of routine polt.thtFactor())</span>
<span class="sd">      - smdth: the error of the mean delta theta</span>
<span class="sd">      - flag: flag concerning to the standards.</span>
<span class="sd">      - tags: string with the tags concerning to the standards,</span>
<span class="sd">              separated by commas (,), or &#39;---&#39; if none.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c">########################</span>
    <span class="k">def</span> <span class="nf">computeDth</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main routine</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dthref</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/refs/dths.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: Can</span><span class="se">\&#39;</span><span class="s">t read files pyhdust/refs/dths.txt&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c"># Try to use the standard star observation at filter f</span>
        <span class="n">stdnames</span><span class="p">,</span> <span class="n">dth</span><span class="p">,</span> <span class="n">sdth</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">readFilter</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="c">#        print(&#39;STD REPORT: filter {0} runned...\t stdnames={1}\t dth={2}\t sdth={3}\t flag={4}\t tags={5}&#39;.format(f, stdnames, dth, sdth, flag, tags))</span>

        <span class="c"># Case successful on find</span>
        <span class="k">if</span> <span class="n">stdnames</span> <span class="o">!=</span> <span class="s">&#39;---&#39;</span><span class="p">:</span>
            <span class="n">mdth</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">dth</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">dth</span><span class="p">)</span> <span class="c"># Mean dth</span>
            <span class="n">devth</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dth</span><span class="p">)</span><span class="o">/</span><span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dth</span><span class="p">))</span>  <span class="c"># Std dev of the mean</span>
            <span class="n">smdth</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">devth</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">_np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sdth</span><span class="p">,</span><span class="n">sdth</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sdth</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>  <span class="c"># Combined final error</span>
<span class="c">#            print(&#39;STD REPORT: filter {0} has...\t dth={1}\t mdth=mean(dth)={2}\t smdth={3}&#39;.format(f, dth, mdth, smdth))</span>
        <span class="c"># Otherwise</span>
        <span class="k">else</span><span class="p">:</span>
 <span class="c">#           print(&#39;STD REPORT: filter {0} has not standard... trying compute dth from another filter...&#39;.format(f))</span>
<span class="c">#            print(&#39;{0:&lt;10s} Trying compute delta_theta from another filter...&#39;.format(f))</span>
            <span class="n">mdth</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">smdth</span> <span class="o">=</span> <span class="mf">10000.</span>
 
            <span class="c"># To identify the calcite I propose the if below, because is just like the beams</span>
            <span class="c"># seem to behave within the CCD.</span>
<span class="c">#            if calc == 0:</span>
<span class="c">#                calcite = &#39;&#39;</span>
<span class="c">#                print(&#39;{0:&lt;12s} WARNING! Calcite name not identified for an angle of 0 degrees.&#39;.format(night+&#39;, &#39;+f+&#39;:&#39;))</span>
<span class="c">#                while calcite not in (&#39;a0&#39;,&#39;a2&#39;):</span>
<span class="c">#                    calcite = raw_input(&#39;      Type the calcite name (a0/a2): &#39;)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">calc</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="ow">and</span> <span class="n">calc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">calc</span> <span class="o">&gt;</span> <span class="mi">78</span> <span class="ow">and</span> <span class="n">calc</span> <span class="o">&lt;</span> <span class="mi">102</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">calc</span> <span class="o">&gt;</span> <span class="mi">168</span> <span class="ow">and</span> <span class="n">calc</span> <span class="o">&lt;</span> <span class="mi">180</span><span class="p">):</span>
                <span class="n">calcite</span> <span class="o">=</span> <span class="s">&#39;a2&#39;</span>
            <span class="k">elif</span> <span class="n">calc</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">calc</span> <span class="o">&lt;</span> <span class="mi">180</span><span class="p">:</span>
                <span class="n">calcite</span> <span class="o">=</span> <span class="s">&#39;a0&#39;</span>
            <span class="c"># Useful because sometimes I set the calc value manually inside std.dat/obj.dat for special</span>
            <span class="c"># cases, putting a negative value.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">calcite</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;{0:&lt;12s} WARNING! Calcite name not identified for an angle of {1} degrees.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">night</span><span class="o">+</span><span class="s">&#39;, &#39;</span><span class="o">+</span><span class="n">f</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">calc</span><span class="p">))</span>
                <span class="k">while</span> <span class="n">calcite</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;a0&#39;</span><span class="p">,</span><span class="s">&#39;a2&#39;</span><span class="p">):</span>
                    <span class="n">calcite</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;      Type the calcite name (a0/a2): &#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">filt</span> <span class="o">==</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">continue</span>

                <span class="n">ddth</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">sddth</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">stdnamesaux</span><span class="p">,</span> <span class="n">dth</span><span class="p">,</span> <span class="n">sdth</span><span class="p">,</span> <span class="n">flagaux</span><span class="p">,</span> <span class="n">tagsaux</span> <span class="o">=</span> <span class="n">readFilter</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span>
<span class="c">#                print(&#39;STD REPORT: filter {0} runned to correction of filter {1}...\t stdnames={2}\t dth={3}\t sdth={4}\t flag={5}\t tags={6}&#39;.format(filt, f, stdnamesaux, dth, sdth, flagaux, tagsaux))</span>
                <span class="k">if</span> <span class="n">stdnamesaux</span> <span class="o">==</span> <span class="s">&#39;---&#39;</span><span class="p">:</span>
<span class="c">#                    print(&#39;STD REPORT: filter {0} (runned to correction of filter {1}) has not standard... trying compute dth from another filter...&#39;.format(filt, f))</span>
                    <span class="k">continue</span>

                <span class="c"># Try to find the &#39;delta delta theta&#39;</span>
                <span class="k">for</span> <span class="n">dthi</span> <span class="ow">in</span> <span class="n">dthref</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">dthi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;{0}-{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">filt</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dthi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">calcite</span><span class="p">:</span>

                        <span class="n">ddth</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dthi</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">sddth</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dthi</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

                        <span class="n">dth</span> <span class="o">=</span> <span class="p">[</span><span class="n">di</span><span class="o">+</span><span class="n">ddth</span> <span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="n">dth</span><span class="p">]</span>               <span class="c"># Refresh the new dth list</span>
                        <span class="n">mdthaux</span>  <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">dth</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">dth</span><span class="p">)</span>                <span class="c"># Mean dth</span>
                        <span class="n">devthaux</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dth</span><span class="p">)</span><span class="o">/</span><span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dth</span><span class="p">))</span>  <span class="c"># Std dev of the mean</span>
                        <span class="n">smdthaux</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">devthaux</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">_np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sdth</span><span class="p">,</span><span class="n">sdth</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sdth</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">sddth</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c"># Combined final error</span>

<span class="c">#                        print(&#39;STD REPORT: filter {0} (runned to correction of filter {1}) has the identified {2}-{3} value for calcite {4} ({5}): ddth={6}\t sddth={7}&#39;.format(filt, f, f, filt, calc, calcite, ddth, sddth))</span>

                        <span class="c"># Case there exists some observation in filter filt, as well as the study</span>
                        <span class="c"># of delta that inside sths.txt file, compare if it have a best error</span>
                        <span class="k">if</span> <span class="n">smdthaux</span> <span class="o">&lt;</span> <span class="n">smdth</span><span class="p">:</span>
                            <span class="n">stdnames</span> <span class="o">=</span> <span class="n">stdnamesaux</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="n">flagaux</span>
                            <span class="n">tags</span> <span class="o">=</span> <span class="n">tagsaux</span>
                            <span class="n">mdth</span> <span class="o">=</span> <span class="n">mdthaux</span>
                            <span class="n">devth</span> <span class="o">=</span> <span class="n">devthaux</span>
 <span class="c">#                           print(&#39;STD REPORT: filter {0} (runned to correction of filter {1}) has a best error in mdth...\t dth={2}\t ddth={3}\t mdth=mean(dth)+ddth={4}\t smdth={5}&lt;{6}. Refreshing...&#39;.format(filt, f, [di-ddth for di in dth], ddth, mdth, smdthaux, smdth))</span>
                            <span class="n">smdth</span> <span class="o">=</span> <span class="n">smdthaux</span>
 <span class="c">#                       else:</span>
<span class="c">#                            print(&#39;STD REPORT: filter {0} (runned to correction of filter {1}) has NOT a best error in mdth: smdth={2}&gt;={3}. Skipping this filter...&#39;.format(filt, f, smdthaux, smdth))</span>
                        <span class="k">break</span>

<span class="c">#                if ddth == 0 and sddth == 0:</span>
<span class="c">#                    print(&#39;STD REPORT: filter {0} (runned to correction of filter {1}) doesn\&#39;t have {2}-{3} ddth value found for calcite {4} ({5}). Skipping this filter...&#39;.format(filt, f, f, filt, calc, calcite))</span>

            <span class="k">if</span> <span class="n">stdnames</span> <span class="o">==</span> <span class="s">&#39;---&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">((</span><span class="s">&#39;{0:&lt;12s} WARNING! None standard found in `std.dat` for filter {1}.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">night</span><span class="o">+</span><span class="s">&#39;, &#39;</span><span class="o">+</span><span class="n">f</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
                <span class="n">smdth</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s">&#39;OK&#39;</span><span class="p">:</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="s">&#39;W&#39;</span>
                <span class="k">if</span> <span class="n">tags</span> <span class="o">==</span> <span class="s">&#39;---&#39;</span><span class="p">:</span>
                    <span class="n">tags</span> <span class="o">=</span> <span class="s">&#39;oth-dth&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tags</span> <span class="o">+=</span> <span class="s">&#39;,oth-dth&#39;</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">((</span><span class="s">&#39;{0:&lt;12s} WARNING! Delta theta for filter {1} was computed using an delta theta from another filter.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">night</span><span class="o">+</span><span class="s">&#39;, &#39;</span><span class="o">+</span><span class="n">f</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">((</span><span class="s">&#39;{0:&lt;12s} WARNING! Delta theta for filter {1} was computed using an delta theta from another filter.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>

 <span class="c">#       print(&#39;STD REPORT: filter {0} - final values...\t stdnames={1}\t mdth={2}\t smdth={3}\t flag={4}\t tags={5}\n&#39;.format(f, stdnames, mdth, smdth, flag, tags))</span>

        <span class="k">return</span> <span class="n">stdnames</span><span class="p">,</span> <span class="n">mdth</span><span class="p">,</span> <span class="n">smdth</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">tags</span>
        <span class="c">########################</span>


    <span class="c">########################</span>
    <span class="k">def</span> <span class="nf">readFilter</span><span class="p">(</span><span class="n">filt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Receive a filter &#39;filt&#39; and return two lists with the delta theta values</span>
<span class="sd">        and the errors. Return also a string with the names of standards and</span>
<span class="sd">        the flag and tags string.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">stdref</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/refs/pol_padroes.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: Can</span><span class="se">\&#39;</span><span class="s">t read files pyhdust/refs/pol_padroes.txt&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">dth</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sdth</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stdnames</span> <span class="o">=</span> <span class="s">&#39;---&#39;</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="s">&#39;---&#39;</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="s">&#39;OK&#39;</span>

        <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}/std.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">night</span><span class="p">)):</span>
            <span class="n">stds</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/{1}/std.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">night</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">stds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">9</span><span class="p">:</span>
                <span class="n">stds</span> <span class="o">=</span> <span class="n">stds</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">stdinf</span> <span class="ow">in</span> <span class="n">stds</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">stdinf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;E&#39;</span> <span class="ow">and</span> <span class="n">stdchk</span><span class="p">(</span><span class="n">stdinf</span><span class="p">[</span><span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">stdinf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">filt</span> <span class="ow">and</span> \
                                                        <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">stdinf</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">-</span><span class="n">calc</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">delta</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="n">filt</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">((</span><span class="s">&#39;{0:&lt;12s} WARNING! Standard `{1}` ({2}) wasn</span><span class="se">\&#39;</span><span class="s">t used because it &#39;</span> <span class="o">+</span>\
                                    <span class="s">&#39;had `E` flag. Skipping this standard data...&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">night</span><span class="o">+</span><span class="s">&#39;, &#39;</span><span class="o">+</span><span class="n">f</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="p">,</span><span class="n">stdinf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">f</span><span class="p">))</span>
<span class="c">#                        else:</span>
<span class="c">#                            print((&#39;{0:&lt;12s} WARNING! Standard `{1}` ({2}) wasn\&#39;t used because it &#39; +\</span>
<span class="c">#                                    &#39;had `E` flag. Skipping this obs serie...&#39;).format(&#39;&#39;,stdinf[2],f))</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">stdinf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;E&#39;</span> <span class="ow">and</span> <span class="n">stdchk</span><span class="p">(</span><span class="n">stdinf</span><span class="p">[</span><span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">stdinf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">filt</span> <span class="ow">and</span> \
                                                        <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">stdinf</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">-</span><span class="n">calc</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">delta</span><span class="p">:</span>
                    <span class="c"># Bednarski: Show error message now</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">nstar</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stdinf</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
                        <span class="n">Q</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="n">sigT</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp2</span> <span class="o">=</span> <span class="n">readout</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span>\
                                                <span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="n">night</span><span class="p">,</span><span class="n">stdinf</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span> <span class="n">nstar</span><span class="o">=</span><span class="n">nstar</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="n">filt</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">((</span><span class="s">&#39;{0:&lt;12s} WARNING! Standard `{1}` ({2}) wasn</span><span class="se">\&#39;</span><span class="s">t used because&#39;</span> <span class="o">+</span>\
                                                <span class="s">&#39; can</span><span class="se">\&#39;</span><span class="s">t open/read {3}. Skipping this standard data...&#39;</span><span class="p">)</span><span class="o">.</span>\
                                                <span class="n">format</span><span class="p">(</span><span class="n">night</span><span class="o">+</span><span class="s">&#39;, &#39;</span><span class="o">+</span><span class="n">f</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">stdinf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">filt</span><span class="p">,</span> <span class="n">stdinf</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
 <span class="c">#                           else:</span>
 <span class="c">#                               print((&#39;{0:&lt;12s} WARNING! Standard `{1}` ({2}) wasn\&#39;t used because&#39; +\</span>
 <span class="c">#                                               &#39; can\&#39;t open/read {3}. Skipping this obs serie...&#39;).\</span>
  <span class="c">#                                              format(&#39;&#39;, stdinf[2], filt, stdinf[5]))</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">stdref</span><span class="p">[</span><span class="n">stdchk</span><span class="p">(</span><span class="n">stdinf</span><span class="p">[</span><span class="mi">2</span><span class="p">])[</span><span class="mi">1</span><span class="p">],</span><span class="n">filters</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">filt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;0&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="n">filt</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">((</span><span class="s">&#39;{0:&lt;12s} WARNING! Standard `{1}` ({2}) wasn</span><span class="se">\&#39;</span><span class="s">t used because&#39;</span> <span class="o">+</span>\
                                <span class="s">&#39; there is no published value in such filter. Skipping this standard data...&#39;</span><span class="p">)</span><span class="o">.</span>\
                                                <span class="n">format</span><span class="p">(</span><span class="n">night</span><span class="o">+</span><span class="s">&#39;, &#39;</span><span class="o">+</span><span class="n">f</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">stdinf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">filt</span><span class="p">))</span>
                        <span class="k">continue</span>
                        
                    <span class="c"># Refresh string for std names</span>
                    <span class="k">if</span> <span class="n">stdnames</span> <span class="o">==</span> <span class="s">&#39;---&#39;</span><span class="p">:</span>
                        <span class="n">stdnames</span> <span class="o">=</span> <span class="n">stdinf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">stdinf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stdnames</span><span class="p">:</span>
                        <span class="n">stdnames</span> <span class="o">+=</span> <span class="s">&#39;,&#39;</span><span class="o">+</span><span class="n">stdinf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                    <span class="c"># Receive the published theta and its error</span>
                    <span class="c"># (Let filt[0] because sometimes filter can be &#39;v2&#39; for example)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">stdchk</span><span class="p">(</span><span class="n">stdinf</span><span class="p">[</span><span class="mi">2</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">angref</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">stdref</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">filters</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">filt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">sangref</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">stdref</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">filters</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">filt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">6</span><span class="p">])</span>

                    <span class="c"># Calculate dth and its error</span>
                    <span class="n">dth</span> <span class="o">+=</span> <span class="p">[</span><span class="n">thtFactor</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">stdinf</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">th</span><span class="p">)</span><span class="o">-</span><span class="n">angref</span><span class="p">]</span>
                    <span class="k">while</span> <span class="n">dth</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">180</span><span class="p">:</span>
                        <span class="n">dth</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">180</span>
                    <span class="k">while</span> <span class="n">dth</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dth</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">180</span>
                    <span class="n">sdth</span> <span class="o">+=</span> <span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mf">28.65</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">P</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sangref</span><span class="o">**</span><span class="mi">2</span><span class="p">)]</span>

<span class="c">#                    print(&#39;STD:    dth({0}) = factor*th_obs - th_pub = {1} * {2:.2f} - {3:.2f} = {4:.3f}&#39;.format(len(dth),thtFactor(float(stdinf[0])),float(th), angref, dth[-1]))</span>
 <span class="c">#                   print(&#39;STD:    s_th_pub={0:.3f}&#39;.format(sangref))</span>
                    
                    <span class="c"># Receive the flag</span>
                    <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s">&#39;OK&#39;</span> <span class="ow">and</span> <span class="n">stdinf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;W&#39;</span><span class="p">:</span>
                        <span class="n">flag</span> <span class="o">=</span> <span class="s">&#39;W&#39;</span>

                    <span class="c"># Refresh the tag list</span>
                    <span class="k">for</span> <span class="n">tagi</span> <span class="ow">in</span> <span class="n">stdinf</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">tagi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags</span><span class="o">+</span><span class="s">&#39;,---&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">tags</span> <span class="o">==</span> <span class="s">&#39;---&#39;</span><span class="p">:</span>
                                <span class="n">tags</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">tags</span> <span class="o">+=</span> <span class="s">&#39;,&#39;</span>
                            <span class="n">tags</span> <span class="o">+=</span> <span class="n">tagi</span>

            <span class="c"># Fixes the cases where dth is close to 0 (for instance, if dth[0]=0.3,</span>
            <span class="c"># dth[1] must be -1.0 and not 179.0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dth</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">dth</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">dth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">170</span><span class="p">:</span>
                    <span class="n">dth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">180</span>

            <span class="k">if</span> <span class="n">stdnames</span> <span class="o">==</span> <span class="s">&#39;---&#39;</span><span class="p">:</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="s">&#39;W&#39;</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="s">&#39;no-std&#39;</span>
                   
        <span class="k">return</span> <span class="n">stdnames</span><span class="p">,</span> <span class="n">dth</span><span class="p">,</span> <span class="n">sdth</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">tags</span>
        <span class="c">########################</span>


    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">path</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="n">calc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">calc</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}/std.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">night</span><span class="p">)):</span>
<span class="c">#        print(&#39;{0:&lt;12s} WARNING! `std.dat` file not found.&#39;.format(night+&#39;, &#39;+f+&#39;:&#39;))</span>
        <span class="k">return</span> <span class="s">&#39;---&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="s">&#39;W&#39;</span><span class="p">,</span> <span class="s">&#39;no-std&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">computeDth</span><span class="p">()</span>




<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="genTarget"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.genTarget">[docs]</a><span class="k">def</span> <span class="nf">genTarget</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ispol</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">skipdth</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">epssig</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Gen. target</span>

<span class="sd">    Generate a table with all observations found for &#39;target&#39;,</span>
<span class="sd">    unless those which have `E` flag.</span>

<span class="sd">    The error in delta theta (factor from observation of standard</span>
<span class="sd">    star) IS NOT propagated to the theta of Be star.</span>

<span class="sd">    skipdth: skip the observations without estimates for delta</span>
<span class="sd">             theta (no standard star in none filter and no</span>
<span class="sd">             standard star in previous and next nights)? Case</span>
<span class="sd">             True, the exception is only when the data is</span>
<span class="sd">             &#39;unpolarized&#39; (defined by &#39;epssig&#39; variable).</span>
<span class="sd">    epssig: sigP/P max for unpolarized target (sigP/P up to</span>
<span class="sd">            epssig doesn&#39;t need standard star when skipdth=True)</span>
<span class="sd">    ispol: the Serkowski parameters [P_max, lambda_max, theta_IS]</span>
<span class="sd">            to correct IS polarization (P_max ein % and lambda_max in</span>
<span class="sd">            Angstrom). If ispol==None, don&#39;t make the correction</span>
<span class="sd">            of ISP.</span>
<span class="sd">    </span>
<span class="sd">    Syntax of out tags:   tags1:tags2:tags3, where tags1 is concerning</span>
<span class="sd">                          to the method to calculate delta_theta</span>
<span class="sd">                          correction factor, tags2 is the tag list of</span>
<span class="sd">                          the observation of object and tags3 is the</span>
<span class="sd">                          tags of the standard star that has been used.</span>


<span class="sd">    If no standard star was found in some night for one filter, this</span>
<span class="sd">    routine tries to use the standard from another filter to compute</span>
<span class="sd">    the delta theta in missing filter. Case there are no standard star</span>
<span class="sd">    in the other filters also, the routine tries to read a file named</span>
<span class="sd">    as std.link, whose lines content must be [calc   night]. It points to</span>
<span class="sd">    a standard from another night `night` in calcite `calc` (an example</span>
<span class="sd">    of sintax: [calc   night] = [136.1   15out22]). Caso this file was</span>
<span class="sd">    not found, the routine queries directly of what night to use the</span>
<span class="sd">    standard stars.</span>

<span class="sd">    Formulas:</span>
<span class="sd">        * th_eq = fact*th_measured - fact*th^std_measured + th^std_published</span>
<span class="sd">        * th_eq = fact*th_measured - dth</span>
<span class="sd">        * dth = fact*th^std_measured - th^std_published</span>
<span class="sd">        * fact = -1 for observations before 2015 March 1st</span>
<span class="sd">                 +1 otherwise</span>
<span class="sd">        * Q_eq = P*cos(2*th_eq*pi/180)</span>
<span class="sd">        * U_eq = P*sin(2*th_eq*pi/180)</span>
<span class="sd">        * sigth = 28.65*sig/P</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">verbose</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">nlines</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">path</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="k">print</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="c"># Read lists and verify if target is a valid target</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/refs/pol_alvos.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/refs/pol_hip.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">)):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">obj</span><span class="p">,</span><span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/refs/pol_hip.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/refs/pol_unpol.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">)):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">obj</span><span class="p">,</span><span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/refs/pol_unpol.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)))</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/refs/pol_padroes.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: Can</span><span class="se">\&#39;</span><span class="s">t read files pyhdust/refs/pol_alvos.txt and/or pyhdust/refs/pol_padroes.txt.&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">std</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">ftype</span><span class="o">=</span><span class="s">&#39;std&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ftype</span><span class="o">=</span><span class="s">&#39;obj&#39;</span>

    <span class="k">if</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">std</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">obj</span><span class="p">))</span> <span class="ow">and</span> <span class="s">&#39;field&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">target</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">WARNING: Target {0} is not a default target or standard!&#39;</span><span class="o">.</span>\
        <span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="s">&#39;=&#39;</span><span class="o">*</span><span class="mi">30</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="n">nights</span> <span class="o">=</span> <span class="p">[</span><span class="n">fld</span> <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">_os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">fld</span><span class="p">))]</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="k">for</span> <span class="n">night</span> <span class="ow">in</span> <span class="n">nights</span><span class="p">:</span>

        <span class="c"># Check obj.dat/std.dat for the night</span>
        <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}/{2}.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">night</span><span class="p">,</span><span class="n">ftype</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">objs</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/{1}/{2}.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">night</span><span class="p">,</span><span class="n">ftype</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;{0:&lt;12s} ERROR! Can</span><span class="se">\&#39;</span><span class="s">t read {1}.dat file. Ignoring this night...</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">night</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="p">,</span><span class="n">ftype</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="c"># Verify if std has more than one line. Case not, do the reshape</span>
            <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
                <span class="n">objs</span> <span class="o">=</span> <span class="n">objs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span> <span class="o">%</span> <span class="mi">9</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;{0:&lt;12s} ERROR! Wrong column type in {1}.dat file. Ignoring this night...</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">night</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="p">,</span><span class="n">ftype</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="n">valc</span> <span class="o">=</span> <span class="bp">True</span>
            
            <span class="c"># Loop on found nights</span>
            <span class="k">for</span> <span class="n">objinf</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">objinf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">target</span> <span class="ow">or</span> <span class="p">(</span><span class="s">&#39;field&#39;</span> <span class="ow">in</span> <span class="n">objinf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">target</span> <span class="o">==</span> <span class="s">&#39;field&#39;</span><span class="p">):</span>
                    <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;---&#39;</span><span class="p">,</span><span class="s">&#39;---&#39;</span><span class="p">,</span><span class="s">&#39;---&#39;</span><span class="p">]</span>
                    <span class="n">MJD</span><span class="p">,</span> <span class="n">ccd</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">calc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">nstar</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">tags</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">objinf</span>
                    <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s">&#39;E&#39;</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">((</span><span class="s">&#39;{0:&lt;12s} WARNING! Star found ({1}), but with `E` flag &#39;</span> <span class="o">+</span>\
                                        <span class="s">&#39;and tags `{2}`. Ignoring this data...&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">night</span><span class="o">+</span><span class="s">&#39;, &#39;</span><span class="o">+</span><span class="n">f</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">tags</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c"># Fator is a var to indicate when polarization angle must be taken as 180-theta or +theta</span>
                        <span class="n">fator</span> <span class="o">=</span> <span class="n">thtFactor</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">MJD</span><span class="p">))</span>
                        <span class="n">Q</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="n">sigT</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp2</span> <span class="o">=</span> <span class="n">readout</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span>\
                                                    <span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="n">night</span><span class="p">,</span><span class="n">out</span><span class="p">),</span> <span class="n">nstar</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">nstar</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39;{0:&lt;12s} ERROR! Can</span><span class="se">\&#39;</span><span class="s">t open/read out file {1}. Ignoring this data...</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">night</span><span class="o">+</span><span class="s">&#39;, &#39;</span><span class="o">+</span><span class="n">f</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="p">,</span><span class="n">out</span><span class="p">))</span>
                        <span class="k">continue</span>

                    <span class="n">P</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">P</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>
                    <span class="n">th</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
                    <span class="n">sig</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>
                    <span class="n">sigth</span> <span class="o">=</span> <span class="mf">28.65</span><span class="o">*</span><span class="n">sig</span><span class="o">/</span><span class="n">P</span>
<span class="c">#                    print objinf, objinf[2], target, tags[1]</span>

                    <span class="c"># Try to get the night&#39;s standard</span>
                    <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s">&#39;obj&#39;</span><span class="p">:</span>
                        <span class="c"># Print below the warning message and only one time by night</span>
                        <span class="k">if</span> <span class="n">valc</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}/std.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">night</span><span class="p">)):</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">&#39;{0:&lt;12s} WARNING! `std.dat` file not found.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">night</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="p">))</span>
                            <span class="n">valc</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="n">stdnames</span><span class="p">,</span> <span class="n">mdth</span><span class="p">,</span> <span class="n">smdth</span><span class="p">,</span> <span class="n">flagstd</span><span class="p">,</span> <span class="n">tags</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">corObjStd</span><span class="p">(</span><span class="n">night</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">calc</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">stdnames</span> <span class="o">=</span> <span class="s">&#39;---&#39;</span>
                        <span class="n">mdth</span><span class="p">,</span> <span class="n">smdth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
                        <span class="n">flagstd</span><span class="p">,</span> <span class="n">tags</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;OK&#39;</span><span class="p">,</span> <span class="s">&#39;---&#39;</span>

<span class="c">#                    if flagstd == &#39;E&#39;:</span>
<span class="c">#                        mdth = 0.</span>
<span class="c">#                        smdth = 0.</span>
<span class="c">#                        stdnames = &#39;---&#39;</span>
<span class="c">#                        flagstd = &#39;W&#39;</span>
<span class="c">#                        tags[2] = &#39;no-std&#39;</span>

                    <span class="n">vald</span><span class="o">=</span><span class="bp">True</span>
                    <span class="c"># APPLY ALTERNATIVE METHOD TO COMPUTE DTHETA IN CASES WHERE THERE IS NO NIGHT&#39;S STANDARD</span>
                    <span class="k">while</span> <span class="n">stdnames</span> <span class="o">==</span> <span class="s">&#39;---&#39;</span> <span class="ow">and</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s">&#39;obj&#39;</span><span class="p">:</span>

                        <span class="n">night_alt</span><span class="o">=</span><span class="s">&#39;&#39;</span>
<span class="c">#                        print &#39;{0}/{1}/std.link&#39;.format(path,night)</span>
<span class="c">#                        print _os.path.exists(&#39;{0}/{1}/std.link&#39;.format(path,night))</span>
                        <span class="k">if</span> <span class="n">vald</span> <span class="ow">and</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}/std.link&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">night</span><span class="p">)):</span>
<span class="c">#                            print &#39;entrou&#39;</span>
                            <span class="n">file0</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/{1}/std.link&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">night</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">file0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">file0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">file0</span> <span class="o">=</span> <span class="n">file0</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">line0</span> <span class="ow">in</span> <span class="n">file0</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">calc</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">delta</span><span class="p">:</span>
                                    <span class="n">night_alt</span> <span class="o">=</span> <span class="n">line0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="k">break</span>
                            <span class="c"># if temporary for me.</span>
                        <span class="k">if</span> <span class="n">night_alt</span> <span class="o">==</span> <span class="s">&#39;s&#39;</span> <span class="ow">or</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}/skipstd&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">night</span><span class="p">)):</span>
                            <span class="k">print</span><span class="p">((</span><span class="s">&#39;{0:&lt;12s} WARNING! No standard correction as specified inside std.link.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">night</span><span class="o">+</span><span class="s">&#39;, &#39;</span><span class="o">+</span><span class="n">f</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">night_alt</span><span class="p">))</span>
                            <span class="k">break</span>
                        <span class="k">if</span> <span class="n">night_alt</span><span class="o">==</span><span class="s">&#39;&#39;</span><span class="p">:</span>
                            <span class="n">night_alt</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">{0:&lt;12s} Do you want to select some standard from another day?</span><span class="se">\n</span><span class="s">{0:&lt;12s} #Type the date or `s` to skip: &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;#&#39;</span><span class="p">))</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">night_alt</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;s&#39;</span><span class="p">,</span><span class="s">&#39;S&#39;</span><span class="p">):</span>
                                <span class="k">break</span>

                        <span class="k">if</span> <span class="n">night_alt</span><span class="o">!=</span><span class="s">&#39;&#39;</span> <span class="ow">and</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">night_alt</span><span class="p">)):</span>
                            <span class="n">stdnames</span><span class="p">,</span> <span class="n">mdth</span><span class="p">,</span> <span class="n">smdth</span><span class="p">,</span> <span class="n">flagstd</span><span class="p">,</span> <span class="n">tags</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">corObjStd</span><span class="p">(</span><span class="n">night_alt</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">calc</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                            <span class="n">valc</span> <span class="o">=</span> <span class="bp">False</span>
                            <span class="k">if</span> <span class="n">stdnames</span> <span class="o">!=</span> <span class="s">&#39;---&#39;</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">flagstd</span> <span class="o">==</span> <span class="s">&#39;OK&#39;</span><span class="p">:</span>
                                    <span class="n">flagstd</span> <span class="o">=</span> <span class="s">&#39;W&#39;</span>
                                <span class="k">if</span> <span class="n">tags</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;---&#39;</span><span class="p">:</span>
                                    <span class="n">tags</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;oth-day-std&#39;</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">tags</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39;,oth-day-std&#39;</span>
                                <span class="k">if</span> <span class="n">vald</span><span class="p">:</span>
                                    <span class="k">print</span><span class="p">((</span><span class="s">&#39;{0:&lt;12s} WARNING! Using standard from another night ({1}) as specified inside std.link.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">night</span><span class="o">+</span><span class="s">&#39;, &#39;</span><span class="o">+</span><span class="n">f</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">night_alt</span><span class="p">))</span>
                            <span class="k">elif</span> <span class="n">vald</span><span class="p">:</span> 
                                <span class="k">print</span><span class="p">((</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">{0:&lt;12s} ERROR! Standard not found inside the alternative night {1}!&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">night</span><span class="o">+</span><span class="s">&#39;, &#39;</span><span class="o">+</span><span class="n">f</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">night_alt</span><span class="p">))</span>
                                <span class="n">vald</span> <span class="o">=</span> <span class="bp">False</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">print</span><span class="p">((</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">{0:&lt;12s} ERROR! Standard not found inside the alternative night {1}!&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">night_alt</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="n">vald</span><span class="p">:</span> 
                            <span class="k">print</span><span class="p">((</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">{0:&lt;12s} ERROR! Standard not found inside the alternative night {1}!&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">night</span><span class="o">+</span><span class="s">&#39;, &#39;</span><span class="o">+</span><span class="n">f</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">night_alt</span><span class="p">))</span>
                            <span class="n">vald</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">((</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">{0:&lt;12s} ERROR! Standard not found inside the alternative night {1}!&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">night_alt</span><span class="p">))</span>
<span class="c">#                        print stdname, thstd, angref, flagstd, tags[2]</span>

                    <span class="c"># Set the tags concerning to the standard</span>
                    <span class="k">if</span> <span class="n">stdnames</span> <span class="o">==</span> <span class="s">&#39;---&#39;</span> <span class="ow">and</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s">&#39;obj&#39;</span><span class="p">:</span>
                        <span class="n">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;no-std&#39;</span>
                    <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s">&#39;obj&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s">&#39;oth-day-std&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                            <span class="n">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;oth-day-std&#39;</span>
                        <span class="k">if</span> <span class="s">&#39;oth-dth&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;---&#39;</span><span class="p">:</span>
                            <span class="n">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;oth-dth&#39;</span>
                        <span class="k">elif</span> <span class="s">&#39;oth-dth&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                            <span class="n">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39;,oth-dth&#39;</span>

                    <span class="c"># Refresh tags and flags</span>
                    <span class="k">for</span> <span class="n">specialtag</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;no-std&#39;</span><span class="p">,</span><span class="s">&#39;oth-day-std&#39;</span><span class="p">,</span><span class="s">&#39;oth-dth&#39;</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">tags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">specialtag</span><span class="p">:</span>
                                <span class="n">tags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;---&#39;</span>
                                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">flag</span> <span class="o">=</span> <span class="s">&#39;OK&#39;</span>
                            <span class="k">elif</span> <span class="n">tags</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="n">specialtag</span><span class="o">+</span><span class="s">&#39;,&#39;</span><span class="p">:</span>
                                <span class="n">tags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">specialtag</span><span class="o">+</span><span class="s">&#39;,&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">tags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="o">+</span><span class="n">specialtag</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>

                    <span class="c"># Set the &quot;global&quot; flag (for object+standard)</span>
                    <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s">&#39;E&#39;</span> <span class="ow">or</span> <span class="n">flagstd</span> <span class="o">==</span> <span class="s">&#39;E&#39;</span><span class="p">:</span>
                        <span class="n">flag</span> <span class="o">=</span> <span class="s">&#39;E&#39;</span>
                    <span class="k">elif</span> <span class="n">flag</span> <span class="o">==</span> <span class="s">&#39;W&#39;</span> <span class="ow">or</span> <span class="n">flagstd</span> <span class="o">==</span> <span class="s">&#39;W&#39;</span><span class="p">:</span>
                        <span class="n">flag</span> <span class="o">=</span> <span class="s">&#39;W&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">flag</span> <span class="o">=</span> <span class="s">&#39;OK&#39;</span>

                    <span class="c"># Applying the correction of standard star</span>
                    <span class="n">th</span> <span class="o">=</span> <span class="n">fator</span><span class="o">*</span><span class="n">th</span><span class="o">-</span><span class="n">mdth</span>

                    <span class="c"># Fixing the angle value and computing QU parameters</span>
                    <span class="k">while</span> <span class="n">th</span> <span class="o">&gt;=</span> <span class="mi">180</span><span class="p">:</span>
                        <span class="n">th</span><span class="o">-=</span> <span class="mi">180</span>
                    <span class="k">while</span> <span class="n">th</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">th</span><span class="o">+=</span> <span class="mi">180</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">P</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">th</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
                    <span class="n">U</span> <span class="o">=</span> <span class="n">P</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">th</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>

                    <span class="c"># Correction of IS polarization</span>
                    <span class="k">if</span> <span class="n">ispol</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">QIS</span><span class="p">,</span> <span class="n">UIS</span> <span class="o">=</span> <span class="n">serkowski</span><span class="p">(</span><span class="n">ispol</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ispol</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pa</span><span class="o">=</span><span class="n">ispol</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">-</span> <span class="n">QIS</span>
                        <span class="n">U</span> <span class="o">=</span> <span class="n">U</span> <span class="o">-</span> <span class="n">UIS</span>
                        <span class="n">P</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">U</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">th</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">Q</span><span class="o">/</span><span class="n">U</span><span class="p">)</span><span class="o">*</span><span class="mi">90</span><span class="o">/</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span>
<span class="c">#                        sigth = 28.65*sig/P</span>

                        <span class="c"># Fix the angle to the correct in QU diagram</span>
                        <span class="k">if</span> <span class="n">Q</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">th</span> <span class="o">+=</span> <span class="mi">90</span>
                        <span class="k">elif</span> <span class="n">Q</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">U</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">th</span> <span class="o">+=</span> <span class="mi">180</span>
                

                    <span class="c"># Write the line</span>
                    <span class="k">if</span> <span class="n">stdnames</span> <span class="o">!=</span> <span class="s">&#39;---&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">skipdth</span><span class="p">)</span> <span class="ow">or</span> <span class="n">P</span><span class="o">/</span><span class="n">sig</span> <span class="o">&lt;=</span> <span class="n">epssig</span> <span class="ow">or</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s">&#39;std&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;_WP&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">outn</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="o">-</span><span class="mi">11</span><span class="p">:]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">outn</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">out</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;_WP&#39;</span><span class="p">)</span><span class="o">-</span><span class="mi">7</span><span class="p">:]</span>
                        <span class="n">lines</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&#39;{:12s} {:&gt;7s} {:&gt;7s} {:&gt;4s} {:&gt;5s} {:&gt;12s} {:&gt;6.1f} {:&gt;6.1f}&#39;</span><span class="o">+</span>
                                <span class="s">&#39; {:&gt;8.4f} {:&gt;8.4f} {:&gt;8.4f} {:&gt;7.2f} {:&gt;7.4f} &#39;</span><span class="o">+</span>
                                <span class="s">&#39;{:&gt;6.2f} {:&gt;13s} {:&gt;4s} {:&gt;5s} {:&gt;s}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">MJD</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">ccd</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> \
                                <span class="n">calc</span><span class="p">,</span> <span class="n">stdnames</span><span class="p">,</span> <span class="n">mdth</span><span class="p">,</span> <span class="n">smdth</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">sigth</span><span class="p">,</span> <span class="n">outn</span><span class="p">,</span> <span class="n">nstar</span><span class="p">,</span> \
                                <span class="n">flag</span><span class="p">,</span> <span class="s">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tags</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="s">&#39;field&#39;</span><span class="p">:</span>
                            <span class="n">lines</span> <span class="o">+=</span> <span class="s">&#39;   {0}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">lines</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                            
                        <span class="n">nlines</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">((</span><span class="s">&#39;{0:&lt;12s} ERROR! No valid delta_theta value estimated in filter {1}.&#39;</span> <span class="o">+</span>\
                                        <span class="s">&#39; Ignoring this data...</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">night</span><span class="o">+</span><span class="s">&#39;, &#39;</span><span class="o">+</span><span class="n">f</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="n">verbose</span> <span class="o">+=</span> <span class="s">&#39;, &#39;</span>
            <span class="n">verbose</span> <span class="o">+=</span> <span class="n">night</span>

    <span class="c"># Print &quot;no obj/std.dat found&quot; message</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;{0:&lt;12s} WARNING! No `{1}.dat` file found for the following nights: {2}. Ignoring these nights...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;-------&#39;</span><span class="p">,</span><span class="n">ftype</span><span class="p">,</span><span class="n">verbose</span><span class="p">))</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="s">&#39;=&#39;</span><span class="o">*</span><span class="mi">30</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="c"># Write the output</span>
    <span class="k">if</span> <span class="n">lines</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ispol</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">f0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;{0}/{1}.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">target</span><span class="p">),</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;{0}/{1}_iscor.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">target</span><span class="p">),</span><span class="s">&#39;w&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="s">&#39;field&#39;</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;#{:&gt;11s} {:&gt;7s} {:&gt;7s} {:&gt;4s} {:&gt;5s} {:&gt;12s} {:&gt;6s} {:&gt;6s}&#39;</span> <span class="o">+</span>\
                        <span class="s">&#39; {:&gt;8s} {:&gt;8s} {:&gt;8s} {:&gt;7s} {:&gt;7s} {:&gt;6s} {:&gt;13s}&#39;</span> <span class="o">+</span>\
                        <span class="s">&#39; {:&gt;4s} {:&gt;5s} {:&gt;s}   {:s}</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;MJD&#39;</span><span class="p">,</span> <span class="s">&#39;night&#39;</span><span class="p">,</span>\
                        <span class="s">&#39;ccd&#39;</span><span class="p">,</span> <span class="s">&#39;filt&#39;</span><span class="p">,</span> <span class="s">&#39;calc&#39;</span><span class="p">,</span> <span class="s">&#39;stdstars&#39;</span><span class="p">,</span> <span class="s">&#39;dth&#39;</span><span class="p">,</span> <span class="s">&#39;sigdth&#39;</span><span class="p">,</span> <span class="s">&#39;P&#39;</span><span class="p">,</span> <span class="s">&#39;Q&#39;</span><span class="p">,</span> <span class="s">&#39;U&#39;</span><span class="p">,</span>\
                        <span class="s">&#39;th&#39;</span><span class="p">,</span> <span class="s">&#39;sigP&#39;</span><span class="p">,</span> <span class="s">&#39;sigth&#39;</span><span class="p">,</span> <span class="s">&#39;outfile&#39;</span><span class="p">,</span> <span class="s">&#39;star&#39;</span><span class="p">,</span> <span class="s">&#39;flag&#39;</span><span class="p">,</span> <span class="s">&#39;tags&#39;</span><span class="p">,</span> <span class="s">&#39;obj_name&#39;</span><span class="p">)</span><span class="o">+</span><span class="n">lines</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;#{:&gt;11s} {:&gt;7s} {:&gt;7s} {:&gt;4s} {:&gt;5s} {:&gt;12s} {:&gt;6s} {:&gt;6s}&#39;</span> <span class="o">+</span>\
                        <span class="s">&#39; {:&gt;8s} {:&gt;8s} {:&gt;8s} {:&gt;7s} {:&gt;7s} {:&gt;6s} {:&gt;13s}&#39;</span> <span class="o">+</span>\
                        <span class="s">&#39; {:&gt;4s} {:&gt;5s} {:&gt;s}</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;MJD&#39;</span><span class="p">,</span> <span class="s">&#39;night&#39;</span><span class="p">,</span>\
                        <span class="s">&#39;ccd&#39;</span><span class="p">,</span> <span class="s">&#39;filt&#39;</span><span class="p">,</span> <span class="s">&#39;calc&#39;</span><span class="p">,</span> <span class="s">&#39;stdstars&#39;</span><span class="p">,</span> <span class="s">&#39;dth&#39;</span><span class="p">,</span> <span class="s">&#39;sigdth&#39;</span><span class="p">,</span> <span class="s">&#39;P&#39;</span><span class="p">,</span> <span class="s">&#39;Q&#39;</span><span class="p">,</span> <span class="s">&#39;U&#39;</span><span class="p">,</span>\
                        <span class="s">&#39;th&#39;</span><span class="p">,</span> <span class="s">&#39;sigP&#39;</span><span class="p">,</span> <span class="s">&#39;sigth&#39;</span><span class="p">,</span> <span class="s">&#39;outfile&#39;</span><span class="p">,</span> <span class="s">&#39;star&#39;</span><span class="p">,</span> <span class="s">&#39;flag&#39;</span><span class="p">,</span> <span class="s">&#39;tags&#39;</span><span class="p">)</span><span class="o">+</span><span class="n">lines</span>

        <span class="k">if</span> <span class="n">ispol</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">ispol</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;# ISP parameters used:</span><span class="se">\n</span><span class="s">#</span><span class="se">\n</span><span class="s"># Pmax (%)   lmax (A)     PA</span><span class="se">\n</span><span class="s"># {0:&gt;8.4f} {1:&gt;9.2f} {2:&gt;7.2f}</span><span class="se">\n</span><span class="s">#</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>\
                                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ispol</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ispol</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ispol</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">lines</span>
        <span class="n">f0</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">f0</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">ispol</span><span class="o">==</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;DONE! {0} lines written in {1}/{2}.log.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nlines</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">target</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;DONE! {0} lines written in {1}/{2}_iscor.log.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nlines</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">target</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;NOT DONE! No valid observation was found for target `{0}`.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
      
    <span class="k">return</span>




<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="serkowski"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.serkowski">[docs]</a><span class="k">def</span> <span class="nf">serkowski</span><span class="p">(</span><span class="n">pmax</span><span class="p">,</span> <span class="n">lmax</span><span class="p">,</span> <span class="n">wlen</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">pa</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">law</span><span class="o">=</span><span class="s">&#39;w82&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Mode==1</span>
<span class="sd">    Receive ISP parameters &#39;pmax&#39;, &#39;lmax&#39; e &#39;pa&#39; and return</span>
<span class="sd">    the Stokes QU parameters concerning to the value</span>
<span class="sd">    of Serkowski&#39;s law at wavelenght &#39;wlen&#39;.</span>

<span class="sd">    Mode==2</span>
<span class="sd">    Receive ISP parameters &#39;pmax&#39;, &#39;lmax&#39; and return</span>
<span class="sd">    the P value computed by the Serkowski&#39;s law at</span>
<span class="sd">    wavelenght &#39;wlen&#39;.</span>
<span class="sd">    </span>

<span class="sd">    &#39;wlen&#39; and &#39;lmax&#39; must be in Angstrom.</span>
<span class="sd">    &#39;wlen&#39; can be &#39;u&#39;/&#39;b&#39;/&#39;v&#39;/&#39;r&#39;/&#39;i&#39; also.</span>

<span class="sd">    &#39;law&#39; defines what value use to K parameter:</span>

<span class="sd">    w82  -  Wilking (1982)</span>
<span class="sd">        K = 1.86*lmax - 0.1</span>
<span class="sd">    w80  -  Wilking (1980)</span>
<span class="sd">        K = 1.68*lmax - 0.002</span>
<span class="sd">    serk  -  Serkowski</span>
<span class="sd">        K = 1.15</span>

<span class="sd">    Serkowski&#39;s Law:</span>
<span class="sd">        P = pmax*np.exp(-K*np.log(lmax/wlen)**2)</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">law</span><span class="o">==</span><span class="s">&#39;w82&#39;</span><span class="p">:</span>
        <span class="n">K</span> <span class="o">=</span> <span class="mf">1.86</span><span class="o">*</span><span class="n">lmax</span><span class="o">/</span><span class="mi">10000</span> <span class="o">-</span> <span class="mf">0.1</span>     <span class="c"># Wilking (1982)</span>
    <span class="k">elif</span> <span class="n">law</span><span class="o">==</span><span class="s">&#39;w80&#39;</span><span class="p">:</span>
        <span class="n">K</span> <span class="o">=</span> <span class="mf">1.68</span><span class="o">*</span><span class="n">lmax</span><span class="o">/</span><span class="mi">10000</span> <span class="o">-</span> <span class="mf">0.002</span>   <span class="c"># Wilking (1980)</span>
    <span class="k">elif</span> <span class="n">law</span><span class="o">==</span><span class="s">&#39;serk&#39;</span><span class="p">:</span>
        <span class="n">K</span> <span class="o">=</span> <span class="mf">1.15</span>                <span class="c"># Serkowski</span>

    <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">wlen</span> <span class="ow">in</span> <span class="n">_phc</span><span class="o">.</span><span class="n">lbds</span><span class="p">:</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">pmax</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">K</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lmax</span><span class="o">/</span><span class="n">_phc</span><span class="o">.</span><span class="n">lbds</span><span class="p">[</span><span class="n">wlen</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">pmax</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">K</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lmax</span><span class="o">/</span><span class="n">wlen</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="c">#    print wlen, P, pa</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">P</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pa</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">P</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pa</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">,</span> <span class="n">U</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">P</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span>




<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">### IMPLEMENTAR CORLOWPOL QUE SER A CORREO</span>
<span class="c">### DAS INCERTEZAS PARA POLARIZAES BAIXAS</span></div>
<div class="viewcode-block" id="propQU"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.propQU">[docs]</a><span class="k">def</span> <span class="nf">propQU</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sdth</span><span class="p">,</span> <span class="n">estim</span><span class="o">=</span><span class="s">&#39;wk&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Propagate the delta theta error over the polarization</span>
<span class="sd">    angle, computing the new errors for theta, Q and U.</span>

<span class="sd">    Input:</span>

<span class="sd">    - p, th: lists holding the P and theta values.</span>
<span class="sd">    - sp, sdth: lists holding the P and delta theta errors.</span>

<span class="sd">    Return lists containing the new errors for theta,</span>
<span class="sd">    Q and U.: sth, sq, su.</span>

<span class="sd">    Formulas:</span>
<span class="sd">    </span>
<span class="sd">    sth = sqrt( sth0^2 + sdth^2 )</span>
<span class="sd">    sq = sqrt( (cos(2*th)*sp)^2 + (p*sin(2*th)*sth)**2 )</span>
<span class="sd">    su = sqrt( (sin(2*th)*sp)^2 + (p*cos(2*th)*sth)**2 )</span>


<span class="sd">    Unbias theta error using &#39;estim&#39; estimator:</span>

<span class="sd">        if p/sp &lt;= K,   sth0 = psi</span>
<span class="sd">        otherwise,      sth0 = propagated error</span>

<span class="sd">      where K is given by the estimator related to the</span>
<span class="sd">      &#39;estim&#39; variable:</span>

<span class="sd">         a) &#39;ml&#39; : Maximum Likelihood (K=1.41, psi=51.96)</span>
<span class="sd">         b) &#39;wk&#39; : Wardle &amp; Kronberg (K=1.0, psi=51.96)</span>
<span class="sd">         c) &#39;&#39;   : None (K=0, psi=51.96)</span>
<span class="sd">         d) &#39;mts&#39;: Maier, Tenzer &amp; Santangelo (estimates</span>
<span class="sd">                   from Bayesian analysis, psi=61.14)</span>
<span class="sd">             </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">if</span> <span class="n">estim</span><span class="o">==</span><span class="s">&#39;wk&#39;</span><span class="p">:</span>
        <span class="n">k</span><span class="o">=</span><span class="mf">1.</span>
    <span class="k">elif</span> <span class="n">estim</span><span class="o">==</span><span class="s">&#39;ml&#39;</span><span class="p">:</span>
        <span class="n">k</span><span class="o">=</span><span class="mf">1.41</span>
    <span class="k">elif</span> <span class="n">estim</span><span class="o">==</span><span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="n">k</span><span class="o">=</span><span class="mf">0.</span>
    <span class="k">elif</span> <span class="n">estim</span><span class="o">!=</span><span class="s">&#39;mts&#39;</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: estimation type `{0}` not valid!.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">estim</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">sth</span><span class="p">,</span><span class="n">sq</span><span class="p">,</span><span class="n">su</span> <span class="o">=</span> <span class="p">[],[],[]</span>
    <span class="n">sth0</span><span class="o">=</span><span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)):</span>

        <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">estim</span><span class="o">!=</span><span class="s">&#39;mts&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">sth0</span> <span class="o">=</span> <span class="mf">28.65</span><span class="o">*</span><span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sth0</span> <span class="o">=</span> <span class="mf">51.96</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">sth0</span> <span class="o">=</span> <span class="mf">28.65</span><span class="o">*</span><span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">a</span><span class="o">=</span><span class="mf">32.50</span>
                    <span class="n">b</span><span class="o">=</span><span class="mf">1.350</span>
                    <span class="n">c</span><span class="o">=</span><span class="mf">0.739</span>
                    <span class="n">d</span><span class="o">=</span><span class="mf">0.801</span>
                    <span class="n">e</span><span class="o">=</span><span class="mf">1.154</span>
                    <span class="n">sth0</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="n">_np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span> <span class="o">-</span> <span class="n">e</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sth0</span> <span class="o">=</span> <span class="mf">61.14</span>

            <span class="n">sth</span> <span class="o">+=</span> <span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sth0</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sdth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">estim</span><span class="o">!=</span><span class="s">&#39;mts&#39;</span><span class="p">:</span>
                <span class="n">sth</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">51.96</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sth</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">61.14</span><span class="p">]</span>

        <span class="n">sq</span> <span class="o">+=</span> <span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">90</span><span class="p">)</span><span class="o">*</span><span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">90</span><span class="p">)</span><span class="o">*</span><span class="n">sth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">90</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)]</span>
        <span class="n">su</span> <span class="o">+=</span> <span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">90</span><span class="p">)</span><span class="o">*</span><span class="n">sp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">90</span><span class="p">)</span><span class="o">*</span><span class="n">sth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">90</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)]</span>
       
 
    <span class="k">return</span> <span class="n">sth</span><span class="p">,</span> <span class="n">sq</span><span class="p">,</span> <span class="n">su</span>

    


<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="genJD"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.genJD">[docs]</a><span class="k">def</span> <span class="nf">genJD</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate de JD file for the fits inside the folder</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">path</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
        <span class="n">lfits</span> <span class="o">=</span> <span class="n">_glob</span><span class="p">(</span><span class="s">&#39;*_{0}_*.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lfits</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lfits</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">lfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;_{0}_&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
            <span class="n">pref</span> <span class="o">=</span> <span class="n">lfits</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">lfits</span> <span class="o">=</span> <span class="n">_glob</span><span class="p">(</span><span class="s">&#39;{0}_*.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pref</span><span class="p">))</span>
            <span class="n">lfits</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lfits</span><span class="p">)</span><span class="o">%</span><span class="mi">8</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Warning! Strange number of fits files!&#39;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="n">lfits</span><span class="p">)</span>
            <span class="n">JDout</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">fits</span> <span class="ow">in</span> <span class="n">lfits</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">imfits</span> <span class="o">=</span> <span class="n">_pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fits</span><span class="p">)</span>
                <span class="n">dtobs</span> <span class="o">=</span> <span class="n">imfits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;DATE&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">dtobs</span><span class="p">:</span>
                    <span class="n">dtobs</span><span class="p">,</span> <span class="n">tobs</span> <span class="o">=</span> <span class="n">dtobs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;T&#39;</span><span class="p">)</span>
                    <span class="n">dtobs</span> <span class="o">=</span> <span class="n">dtobs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
                    <span class="n">tobs</span> <span class="o">=</span> <span class="n">tobs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
                    <span class="n">tobs</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tobs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">3600</span><span class="o">+</span><span class="nb">float</span><span class="p">(</span><span class="n">tobs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mi">60</span><span class="o">+</span><span class="nb">float</span><span class="p">(</span><span class="n">tobs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">tobs</span> <span class="o">/=</span> <span class="p">(</span><span class="mi">24</span><span class="o">*</span><span class="mi">3600</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR! Wrong DATE-OBS in header! {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fits</span><span class="p">))</span>
                    <span class="k">raise</span> <span class="n">systemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">JD</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">_jdcal</span><span class="o">.</span><span class="n">gcal2jd</span><span class="p">(</span><span class="o">*</span><span class="n">dtobs</span><span class="p">))</span><span class="o">+</span><span class="n">tobs</span>
                <span class="n">JDout</span> <span class="o">+=</span> <span class="s">&#39;WP {0}  {1:.7f}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">JD</span><span class="p">)</span>
            <span class="n">f0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;JD_{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pref</span><span class="p">),</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">f0</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">JDout</span><span class="p">)</span>
            <span class="n">f0</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span>




<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="listNights"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.listNights">[docs]</a><span class="k">def</span> <span class="nf">listNights</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">tgt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List Nights</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ltgts</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/refs/pol_alvos.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">lstds</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/refs/pol_padroes.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>\
    <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">tgt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">ltgts</span><span class="p">,</span><span class="n">lstds</span><span class="p">)):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# Warning! Target {0} is not a default target or standard!!&#39;</span><span class="o">.</span>\
        <span class="n">format</span><span class="p">(</span><span class="n">tgt</span><span class="p">))</span>

    <span class="n">lnights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nights</span> <span class="o">=</span> <span class="p">[</span><span class="n">fld</span> <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">_os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> \
    <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">fld</span><span class="p">))]</span>

    <span class="k">for</span> <span class="n">night</span> <span class="ow">in</span> <span class="n">nights</span><span class="p">:</span>
        <span class="n">tgts</span> <span class="o">=</span> <span class="p">[</span><span class="n">fld</span> <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">_os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">night</span><span class="p">))</span> <span class="k">if</span> \
    <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">night</span><span class="p">),</span> <span class="n">fld</span><span class="p">))]</span>
        <span class="k">if</span> <span class="n">tgt</span> <span class="ow">in</span> <span class="n">tgts</span><span class="p">:</span>
            <span class="n">lnights</span> <span class="o">+=</span> <span class="p">[</span><span class="n">night</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">tgts</span> <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">tgt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lnights</span> <span class="o">+=</span> <span class="p">[</span><span class="n">night</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">lnights</span>




<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c"># Falta alterar para novos ndices das colunas dos arquivos std.dat e obj.dat</span>
<span class="c"># das mudanas que fiz. Bednarski.</span></div>
<div class="viewcode-block" id="plotMagStar"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.plotMagStar">[docs]</a><span class="k">def</span> <span class="nf">plotMagStar</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function doc</span>

<span class="sd">    @param PARAM: DESCRIPTION</span>
<span class="sd">    @return RETURN: DESCRIPTION</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">path</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">lmags</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/refs/pol_mags.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tgt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lmags</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR! {0} is not a valid mag. star!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tgt</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/{1}.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">tgt</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">fromarrays</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">names</span><span class="o">=</span><span class="s">&#39;MJD,night,filt,</span><span class="se">\</span>
<span class="s">    calc,ang.ref,dth,P,Q,U,th,sigP,sigth&#39;</span><span class="p">,</span> <span class="n">formats</span><span class="o">=</span><span class="s">&#39;f8,a7,a1,f8,f8,f8,f8,</span><span class="se">\</span>
<span class="s">    f8,f8,f8,f8,f8&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span><span class="c">#figsize=(5.6,8))</span>
        <span class="n">ax0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">311</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;MJD&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;P&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;sigP&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">312</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;MJD&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Q&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;sigP&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;blue&#39;</span><span class="p">)</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">313</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;MJD&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;U&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;sigP&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">)</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lmags</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">tgt</span><span class="p">)</span>
    <span class="n">P</span><span class="p">,</span> <span class="n">ph0</span> <span class="o">=</span> <span class="n">lmags</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">ph0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ph0</span><span class="p">)</span> <span class="o">-</span> <span class="n">_jdcal</span><span class="o">.</span><span class="n">MJD_0</span>
    
    <span class="n">phase</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;MJD&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">ph0</span>
    <span class="n">phase</span> <span class="o">/=</span> <span class="nb">float</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">phase</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">modf</span><span class="p">(</span><span class="n">phase</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">phase</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">phase</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>

    <span class="n">fig2</span><span class="p">,</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">)</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;P&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;sigP&#39;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;ok&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Q&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;sigP&#39;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;or&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;U&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;sigP&#39;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;ob&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;th&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;sigth&#39;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;ok&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;Phase&#39;</span><span class="p">)</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">u&#39;P (%)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">u&#39;Q (%)&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">u&#39;U (%)&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;$\theta$ (deg.)&#39;</span><span class="p">)</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;{0} ; P={1} days, ph0={2:.3f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">ph0</span><span class="o">+</span><span class="n">_jdcal</span><span class="o">.</span><span class="n">MJD_0</span><span class="p">))</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}/{1}.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">tgt</span><span class="p">))</span>

    <span class="n">bphase</span><span class="p">,</span> <span class="n">bP</span><span class="p">,</span> <span class="n">bsigP</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">bindata</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;P&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;sigP&#39;</span><span class="p">],</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">bphase</span><span class="p">,</span> <span class="n">bQ</span><span class="p">,</span> <span class="n">bsigP</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">bindata</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Q&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;sigP&#39;</span><span class="p">],</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">bphase</span><span class="p">,</span> <span class="n">bU</span><span class="p">,</span> <span class="n">bsigP</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">bindata</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;U&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;sigP&#39;</span><span class="p">],</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">bphase</span><span class="p">,</span> <span class="n">bth</span><span class="p">,</span> <span class="n">bsigth</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">bindata</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;th&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;sigth&#39;</span><span class="p">],</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">fig3</span><span class="p">,</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">)</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">bphase</span><span class="p">,</span> <span class="n">bP</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">bsigP</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;ok&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">bphase</span><span class="p">,</span> <span class="n">bQ</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">bsigP</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;or&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">bphase</span><span class="p">,</span> <span class="n">bU</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">bsigP</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;ob&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">bphase</span><span class="p">,</span> <span class="n">bth</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">bsigth</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;ok&#39;</span><span class="p">)</span> 
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;Phase&#39;</span><span class="p">)</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">u&#39;P (%)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">u&#39;Q (%)&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">u&#39;U (%)&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;$\theta$ (deg.)&#39;</span><span class="p">)</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;{0} (binned); P={1} days, ph0={2:.3f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">ph0</span><span class="o">+</span><span class="n">_jdcal</span><span class="o">.</span><span class="n">MJD_0</span><span class="p">))</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}/{1}_bin.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">tgt</span><span class="p">))</span>
    <span class="c">#_plt.show()</span>
    <span class="k">return</span>




<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="sortLog"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.sortLog">[docs]</a><span class="k">def</span> <span class="nf">sortLog</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Sort the *.out file &quot;&quot;&quot;</span>
    <span class="n">f0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">f0</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">f0</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">log</span><span class="p">[</span><span class="n">log</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%12s</span><span class="s"> </span><span class="si">%7s</span><span class="s"> </span><span class="si">%1s</span><span class="s"> </span><span class="si">%5s</span><span class="s"> </span><span class="si">%5s</span><span class="s"> </span><span class="si">%6s</span><span class="s"> </span><span class="si">%5s</span><span class="s"> </span><span class="si">%6s</span><span class="s"> </span><span class="si">%6s</span><span class="s"> </span><span class="si">%6s</span><span class="s"> </span><span class="si">%5s</span><span class="s"> </span><span class="si">%5s</span><span class="s">&#39;</span>
    <span class="n">_np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.log&#39;</span><span class="p">,</span><span class="s">&#39;.txt&#39;</span><span class="p">),</span> <span class="n">log</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span>




<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="filtra_obs"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.filtra_obs">[docs]</a><span class="k">def</span> <span class="nf">filtra_obs</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">obs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; ### FILTER OBSERV. ### &quot;&quot;&quot;</span>
    <span class="n">nobs</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">nobs</span> <span class="o">=</span> <span class="n">nobs</span><span class="o">+</span><span class="p">[</span><span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nobs</span><span class="p">)</span>




<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="filtraobs"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.filtraobs">[docs]</a><span class="k">def</span> <span class="nf">filtraobs</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; filtro! &quot;&quot;&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;P&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;sigP&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">r</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>




<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="setCCD"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.setCCD">[docs]</a><span class="k">def</span> <span class="nf">setCCD</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set CCD name in global variable &#39;ccd&#39;.</span>

<span class="sd">    The CCD name can be: &#39;ikon&#39;, &#39;ixon&#39;, &#39;301&#39; or</span>
<span class="sd">    &#39;ikon-14912&#39; (the last one is the Ikon CCD with</span>
<span class="sd">    Deep Depletion).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">ccd</span>
    <span class="n">ccd</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="k">if</span> <span class="n">fitsfile</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fits</span> <span class="o">=</span> <span class="n">_pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
            <span class="n">instrume</span> <span class="o">=</span> <span class="s">&#39;{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;SERNO&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">instrume</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;4335&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ccd</span> <span class="o">=</span> <span class="s">&#39;ixon&#39;</span>
            <span class="k">elif</span> <span class="n">instrume</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;4269&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ccd</span> <span class="o">=</span> <span class="s">&#39;ixon&#39;</span>
            <span class="k">elif</span> <span class="n">instrume</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;10127&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ccd</span> <span class="o">=</span> <span class="s">&#39;ikon&#39;</span>
            <span class="k">elif</span> <span class="n">instrume</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;9867&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ccd</span> <span class="o">=</span> <span class="s">&#39;ikon&#39;</span>
            <span class="k">elif</span> <span class="n">instrume</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;14912&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ccd</span> <span class="o">=</span> <span class="s">&#39;ikon-14912&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ccd</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">while</span> <span class="n">ccd</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;ikon&#39;</span><span class="p">,</span> <span class="s">&#39;ixon&#39;</span><span class="p">,</span> <span class="s">&#39;301&#39;</span><span class="p">,</span> <span class="s">&#39;654&#39;</span><span class="p">,</span> <span class="s">&#39;ikon-14912&#39;</span><span class="p">):</span>
        <span class="n">ccd</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;Type the CCD name (301/654/ikon/ikon-14912/ixon): &#39;</span><span class="p">)</span>




<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="splitData"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.splitData">[docs]</a><span class="k">def</span> <span class="nf">splitData</span><span class="p">(</span><span class="n">night</span><span class="p">,</span> <span class="n">path_raw</span><span class="o">=</span><span class="s">&#39;raw&#39;</span><span class="p">,</span> <span class="n">path_red</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split the raw files and reduced files for a night.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        night: path to the night (this directory will be fully preserved)</span>
<span class="sd">        path_raw: directory with the raw data of the nights</span>
<span class="sd">        path_red: directory with the output files of reduction</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_raw</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_red</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Error: Directory </span><span class="se">\&#39;</span><span class="s">{0}</span><span class="se">\&#39;</span><span class="s"> and/or </span><span class="se">\&#39;</span><span class="s">{1}</span><span class="se">\&#39;</span><span class="s"> doesn</span><span class="se">\&#39;</span><span class="s">t exist!</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_raw</span><span class="p">,</span> <span class="n">path_red</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">night</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Error: Directory </span><span class="se">\&#39;</span><span class="s">{0}</span><span class="se">\&#39;</span><span class="s"> doesn</span><span class="se">\&#39;</span><span class="s">t exist!</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">night</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">night</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">night</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
        <span class="n">night</span> <span class="o">=</span> <span class="n">night</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">night</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">trimpathname</span><span class="p">(</span><span class="n">night</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">night</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">trimpathname</span><span class="p">(</span><span class="n">night</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c">#print path, night</span>

    <span class="c"># Verify if the splitted directories exist</span>
    <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_raw</span><span class="p">,</span> <span class="n">night</span><span class="p">))</span> <span class="ow">or</span>  \
                        <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_red</span><span class="p">,</span> <span class="n">night</span><span class="p">)):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">verif</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;CAUTION: Directory </span><span class="se">\&#39;</span><span class="s">{0}/{1}</span><span class="se">\&#39;</span><span class="s"> and/or </span><span class="se">\&#39;</span><span class="s">{2}/{1}</span><span class="se">\&#39;</span><span class="s"> already exists! &#39;</span><span class="o">.</span>\
                           <span class="n">format</span><span class="p">(</span><span class="n">path_raw</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">path_red</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;Are you sure to continue, &#39;</span> <span class="o">+</span> \
                           <span class="s">&#39;overwriting all data inside these directories? (y/n): &#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verif</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="s">&#39;Y&#39;</span><span class="p">]:</span>
                
                <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_raw</span><span class="p">,</span> <span class="n">night</span><span class="p">)):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">_shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_raw</span><span class="p">,</span> <span class="n">night</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39;ERROR when deleting directory </span><span class="se">\&#39;</span><span class="s">{0}/{1}</span><span class="se">\&#39;</span><span class="s">. Check the permissions.</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_raw</span><span class="p">,</span> <span class="n">night</span><span class="p">))</span>
                        <span class="k">return</span> <span class="mi">2</span>

                <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_red</span><span class="p">,</span> <span class="n">night</span><span class="p">)):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">_shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_red</span><span class="p">,</span> <span class="n">night</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39;ERROR when deleting directory </span><span class="se">\&#39;</span><span class="s">{0}/{1}</span><span class="se">\&#39;</span><span class="s">. Check the permissions.</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_red</span><span class="p">,</span> <span class="n">night</span><span class="p">))</span>
                        <span class="k">return</span> <span class="mi">2</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">verif</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;n&#39;</span><span class="p">,</span> <span class="s">&#39;N&#39;</span><span class="p">]:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Aborted!</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="k">print</span><span class="p">(</span><span class="s">&#39;Value not valid!</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="c"># Loop for splitting</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">direc</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">file_old</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">direc</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
           
            <span class="c"># Case a raw file</span>
            <span class="k">if</span> <span class="n">_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;[0-9][0-9].fits$&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;.doc$&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
                <span class="n">file_new</span> <span class="o">=</span> <span class="n">path_raw</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">file_old</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="c"># Case a file from reduction</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file_new</span> <span class="o">=</span> <span class="n">path_red</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">file_old</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

            <span class="c"># Create all subdirectories</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">trimpathname</span><span class="p">(</span><span class="n">file_new</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">trimpathname</span><span class="p">(</span><span class="n">file_new</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;ERROR when copying files. Check the permissions to directories&#39;</span> <span class="o">+</span> \
                                <span class="s">&#39; </span><span class="se">\&#39;</span><span class="s">{0}</span><span class="se">\&#39;</span><span class="s"> and </span><span class="se">\&#39;</span><span class="s">{1}</span><span class="se">\&#39;\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_raw</span><span class="p">,</span> <span class="n">path_red</span><span class="p">))</span>
                    <span class="k">return</span> <span class="mi">2</span>

            <span class="n">_shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">file_old</span><span class="p">,</span> <span class="n">file_new</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Done!</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>




<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="splitData301"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.splitData301">[docs]</a><span class="k">def</span> <span class="nf">splitData301</span><span class="p">(</span><span class="n">night</span><span class="p">,</span> <span class="n">path_raw</span><span class="o">=</span><span class="s">&#39;raw&#39;</span><span class="p">,</span> <span class="n">path_red</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split the raw files and reduced files for a night, renaming according</span>
<span class="sd">       CCD iXon nomenclature.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        night: path to the night (this directory will be fully preserved)</span>
<span class="sd">        path_raw: directory with the raw data of the nights</span>
<span class="sd">        path_red: directory with the output files of reduction</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="c"># Verify if raw and red directories exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_raw</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_red</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Error: Directory </span><span class="se">\&#39;</span><span class="s">{0}</span><span class="se">\&#39;</span><span class="s"> and/or </span><span class="se">\&#39;</span><span class="s">{1}</span><span class="se">\&#39;</span><span class="s"> doesn</span><span class="se">\&#39;</span><span class="s">t exist!</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_raw</span><span class="p">,</span> <span class="n">path_red</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">night</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Error: Directory </span><span class="se">\&#39;</span><span class="s">{0}</span><span class="se">\&#39;</span><span class="s"> doesn</span><span class="se">\&#39;</span><span class="s">t exist!</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">night</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">night</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">night</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
        <span class="n">night</span> <span class="o">=</span> <span class="n">night</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">night</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">trimpathname</span><span class="p">(</span><span class="n">night</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">night</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">trimpathname</span><span class="p">(</span><span class="n">night</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c"># Verify if the splitted directories exist</span>
    <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_raw</span><span class="p">,</span> <span class="n">night</span><span class="p">))</span> <span class="ow">or</span>  \
                        <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_red</span><span class="p">,</span> <span class="n">night</span><span class="p">)):</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">verif</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;CAUTION: Directory </span><span class="se">\&#39;</span><span class="s">{0}/{1}</span><span class="se">\&#39;</span><span class="s"> and/or </span><span class="se">\&#39;</span><span class="s">{2}/{1}</span><span class="se">\&#39;</span><span class="s"> already exists!</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span>\
                           <span class="n">format</span><span class="p">(</span><span class="n">path_raw</span><span class="p">,</span> <span class="n">night</span><span class="p">,</span> <span class="n">path_red</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;Are you sure to continue, &#39;</span> <span class="o">+</span> \
                           <span class="s">&#39;overwriting all data inside these directories? (y/n): &#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verif</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="s">&#39;Y&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_raw</span><span class="p">,</span> <span class="n">night</span><span class="p">)):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">_shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_raw</span><span class="p">,</span> <span class="n">night</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39;ERROR when deleting directory </span><span class="se">\&#39;</span><span class="s">{0}/{1}</span><span class="se">\&#39;</span><span class="s">. Check the permissions.</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_raw</span><span class="p">,</span> <span class="n">night</span><span class="p">))</span>
                        <span class="k">return</span> <span class="mi">2</span>

                <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_red</span><span class="p">,</span> <span class="n">night</span><span class="p">)):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">_shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_red</span><span class="p">,</span> <span class="n">night</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39;ERROR when deleting directory </span><span class="se">\&#39;</span><span class="s">{0}/{1}</span><span class="se">\&#39;</span><span class="s">. Check the permissions.</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_red</span><span class="p">,</span> <span class="n">night</span><span class="p">))</span>
                        <span class="k">return</span> <span class="mi">2</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">verif</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;n&#39;</span><span class="p">,</span> <span class="s">&#39;N&#39;</span><span class="p">]:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Aborted!</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="k">print</span><span class="p">(</span><span class="s">&#39;Value not valid!</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>


    <span class="c"># Loop for splitting</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">direc</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">night</span><span class="p">)):</span>

        <span class="n">jds</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;^jd[0-9]*&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">file_old</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">direc</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

            <span class="c"># If filename is &#39;logfile&#39;</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s">&#39;logfile&#39;</span><span class="p">:</span>
                <span class="n">file_new</span> <span class="o">=</span> <span class="n">path_red</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">file_old</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="c"># If file is inside dark/flat/bias path</span>
            <span class="k">elif</span> <span class="n">file_old</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;/dark/&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">file_old</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;/flat/&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> \
                                            <span class="n">file_old</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;/bias/&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;.fits$&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
                    <span class="n">file_new</span> <span class="o">=</span> <span class="n">path_red</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">file_old</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">file_new</span> <span class="o">=</span> <span class="n">path_raw</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">file_old</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="c"># If filename is type p010001, fb01001, s001001, d001001, b01001</span>
            <span class="k">elif</span> <span class="n">_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;p[0-9]*$&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
                <span class="n">file_new</span> <span class="o">=</span> <span class="n">path_raw</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">file_old</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="c"># The other cases</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="c"># Tries to get object and filter names (it can be a file of none object)</span>
                <span class="n">elem</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">file_old</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/{0}/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">night</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;u&#39;</span><span class="p">,</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="s">&#39;v&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;i&#39;</span><span class="p">):</span>
                    <span class="n">filt</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">filt</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

                <span class="c"># Case sum*.dat files</span>
                <span class="k">if</span> <span class="n">_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;^sum&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
<span class="c">#                    print f</span>
                    <span class="k">if</span> <span class="n">filt</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">((</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">ERROR: No filter was identified for file {0}.</span><span class="se">\n</span><span class="s">Put this files &#39;</span> <span class="o">+</span>\
                        <span class="s">&#39; inside a subdir named with the filter name and run again!&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_old</span><span class="p">))</span>
                        <span class="k">return</span> <span class="mi">3</span>
                    <span class="n">file_new</span> <span class="o">=</span> <span class="n">path_red</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">night</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">obj</span> <span class="o">+</span> <span class="s">&#39;/sum_&#39;</span> <span class="o">+</span> <span class="n">obj</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span>\
                                                                      <span class="n">filt</span> <span class="o">+</span> <span class="s">&#39;_0&#39;</span> <span class="o">+</span> <span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:]</span>
                <span class="c"># Case w*.dat, w*.log, w*.out files</span>
                <span class="k">elif</span> <span class="n">_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;\.dat|\.log|\.out$&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">filt</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">((</span><span class="s">&#39;# ERROR: No filter was identified for file {0}.</span><span class="se">\n</span><span class="s">Put this files &#39;</span> <span class="o">+</span>\
                        <span class="s">&#39; inside a subdir named with the filter letter and run again!&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_old</span><span class="p">))</span>
                        <span class="k">return</span> <span class="mi">3</span>
                    <span class="n">file_new</span> <span class="o">=</span> <span class="n">path_red</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">night</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">obj</span> <span class="o">+</span> <span class="s">&#39;/w&#39;</span> <span class="o">+</span> <span class="n">obj</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span>\
                                                                        <span class="n">filt</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="c"># Case coord.*.ord files</span>
                <span class="k">elif</span> <span class="n">_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;^coord&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">filt</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">((</span><span class="s">&#39;# ERROR: No filter was identified for file {0}.</span><span class="se">\n</span><span class="s">Put this files &#39;</span> <span class="o">+</span>\
                        <span class="s">&#39; inside a subdir named with the filter letter and run again!&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_old</span><span class="p">))</span>
                        <span class="k">return</span> <span class="mi">3</span>
                    <span class="n">file_new</span> <span class="o">=</span> <span class="n">path_red</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">night</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">obj</span> <span class="o">+</span> <span class="s">&#39;/coord_&#39;</span> <span class="o">+</span> <span class="n">obj</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span>\
                                                                        <span class="n">filt</span> <span class="o">+</span> <span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span>
                <span class="c"># Case JD* files, pass and concatenate only at the end of this loop</span>
                <span class="k">elif</span> <span class="n">_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;^jd[0-9]*&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">file_new</span> <span class="o">=</span> <span class="n">path_red</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">file_old</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

            <span class="c"># Create all subdirectories</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">trimpathname</span><span class="p">(</span><span class="n">file_new</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">_phc</span><span class="o">.</span><span class="n">trimpathname</span><span class="p">(</span><span class="n">file_new</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;ERROR when copying files. Check the permissions to directories&#39;</span> <span class="o">+</span> \
                                <span class="s">&#39; </span><span class="se">\&#39;</span><span class="s">{0}</span><span class="se">\&#39;</span><span class="s"> and </span><span class="se">\&#39;</span><span class="s">{1}</span><span class="se">\&#39;\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_raw</span><span class="p">,</span> <span class="n">path_red</span><span class="p">))</span>
                    <span class="k">return</span> <span class="mi">2</span>

            <span class="k">print</span><span class="p">(</span><span class="s">&#39;OLD:&#39;</span> <span class="o">+</span> <span class="n">file_old</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;NEW:&#39;</span> <span class="o">+</span> <span class="n">file_new</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">_shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">file_old</span><span class="p">,</span> <span class="n">file_new</span><span class="p">)</span>

        <span class="c"># Concatenate all JD files now</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">jds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">jds</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;{0}/{1}/{2}/JD_{3}_{4}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_red</span><span class="p">,</span><span class="n">night</span><span class="p">,</span><span class="n">obj</span><span class="p">,</span><span class="n">obj</span><span class="p">,</span><span class="n">filt</span><span class="p">),</span> <span class="s">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_out</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">jds</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;{0}/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">direc</span><span class="p">,</span><span class="n">f</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_in</span><span class="p">:</span>
                        <span class="n">f_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f_in</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Done!</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>




<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="graf_t"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.graf_t">[docs]</a><span class="k">def</span> <span class="nf">graf_t</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">vfilter</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;no-std&#39;</span><span class="p">],</span> <span class="n">save</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">extens</span><span class="o">=</span><span class="s">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="s">&#39;v&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a P_V x t, theta_V x t and P_B/P_I x t graphs for the</span>
<span class="sd">    Be star in the logfile .log file (the outfile from</span>
<span class="sd">    polt.genTarget). Propagates error of standard star.</span>

<span class="sd">    If &#39;no-std&#39; is in vfilter, no data with &#39;no-std&#39; tag will be</span>
<span class="sd">    displayed, but the others filtered data will be showed</span>
<span class="sd">    with a &#39;x&#39; symbol.</span>
<span class="sd">    If &#39;no-std&#39; is not in vfilter, the data with &#39;no-std&#39; will</span>
<span class="sd">    be displayed normally and the other filtered will be</span>
<span class="sd">    showed with a &#39;x&#39; symbol.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c">###########</span>
    <span class="c">## FUNC</span>
    <span class="k">def</span> <span class="nf">polColor</span><span class="p">(</span><span class="n">dayp</span><span class="p">,</span> <span class="n">jdp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">dayp_filt</span><span class="p">,</span> <span class="n">jdp_filt</span><span class="p">,</span> <span class="n">p_filt</span><span class="p">,</span> <span class="n">s_filt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return pb/pi from input lists</span>
<span class="sd">        &quot;&quot;&quot;</span>
       
        <span class="n">jd</span><span class="p">,</span> <span class="n">pbpi</span><span class="p">,</span> <span class="n">spbpi</span> <span class="o">=</span> <span class="p">[],[],[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dayp</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dayp</span><span class="p">[</span><span class="mi">4</span><span class="p">])):</span>
                <span class="c"># p[4][j] != 0 is to prevent division by 0.</span>
                <span class="k">if</span> <span class="n">dayp</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">dayp</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="ow">and</span> <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
 <span class="c">#                   print dayp[1][i], dayp[4][j]</span>
                    <span class="n">jd</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">jdp</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">jdp</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">j</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">pbpi</span> <span class="o">+=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">j</span><span class="p">]]</span>
                    <span class="n">spbpi</span> <span class="o">+=</span> <span class="p">[</span><span class="n">pbpi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)]</span>
<span class="c">#                    print pbpi[-1], p[1][i], p[4][j]</span>
<span class="c">#                    print &#39;&#39;</span>

                    <span class="c"># This line below prevent to take the same point more once</span>
                    <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="n">jd</span><span class="p">,</span> <span class="n">pbpi</span><span class="p">,</span> <span class="n">spbpi</span>
        <span class="c">###########</span>


    <span class="c">###########</span>
    <span class="c">## FUNC</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Receive figure and an axes list (with three axes objects)and do the plots</span>
<span class="sd">        filt WITHOUT show or save the image.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cm</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_rainbow</span>     <span class="c"># Setting the color map</span>
        <span class="n">factor</span><span class="o">=</span><span class="mf">0.7</span>                   <span class="c"># Factor to fix the font sizes</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: Can</span><span class="se">\&#39;</span><span class="s">t read file {0}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logfile</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">18</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span>

<span class="c">#        ax.set_title(&#39;{0} filter&#39;.format(filt.upper()), fontsize=fonts[0]*factor, verticalalignment=&#39;bottom&#39;)</span>
<span class="c">#        ax.text(0.98, 0.9, &#39;{0} filter&#39;.format(filt.upper()), horizontalalignment=&#39;right&#39;, \</span>
<span class="c">#                 verticalalignment=&#39;bottom&#39;, transform=ax.transAxes, fontsize=fonts[1]*factor)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;MJD&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;$P_{0}$ (%)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filt</span><span class="o">.</span><span class="n">upper</span><span class="p">()),</span> <span class="n">size</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;$P_B / P_I$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;$\theta_{0}$ (degree)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filt</span><span class="o">.</span><span class="n">upper</span><span class="p">()),</span> <span class="n">size</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>


        <span class="n">dayp</span><span class="p">,</span> <span class="n">jdp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="p">[[],[],[],[],[]],</span> <span class="p">[[],[],[],[],[]],</span> <span class="p">[[],[],[],[],[]],</span> <span class="p">[[],[],[],[],[]]</span>
        <span class="n">daythet</span><span class="p">,</span> <span class="n">jdthet</span><span class="p">,</span> <span class="n">thet</span><span class="p">,</span> <span class="n">sthet</span> <span class="o">=</span> <span class="p">[[],[],[],[],[]],</span> <span class="p">[[],[],[],[],[]],</span> <span class="p">[[],[],[],[],[]],</span> <span class="p">[[],[],[],[],[]]</span>
        <span class="n">dayp_filt</span><span class="p">,</span> <span class="n">jdp_filt</span><span class="p">,</span> <span class="n">p_filt</span><span class="p">,</span> <span class="n">s_filt</span> <span class="o">=</span> <span class="p">[[],[],[],[],[]],</span> <span class="p">[[],[],[],[],[]],</span> <span class="p">[[],[],[],[],[]],</span> <span class="p">[[],[],[],[],[]]</span>
        <span class="n">daythet_filt</span><span class="p">,</span> <span class="n">jdthet_filt</span><span class="p">,</span> <span class="n">thet_filt</span><span class="p">,</span> <span class="n">sthet_filt</span> <span class="o">=</span> <span class="p">[[],[],[],[],[]],</span> <span class="p">[[],[],[],[],[]],</span> <span class="p">[[],[],[],[],[]],</span> <span class="p">[[],[],[],[],[]]</span>
        <span class="n">image</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">limJD</span><span class="o">=</span><span class="p">[</span><span class="mf">10000000000000.</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

        <span class="c"># Getting the values to fit and plot</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;E&#39;</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

                <span class="c"># Refresh the limits</span>
                <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">limJD</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">limJD</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="c"># Not filtered data</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">sub</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">vfilter</span><span class="p">):</span> <span class="c"># if sub != &#39;no-std&#39;):</span>
                    <span class="n">jdp</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
                    <span class="n">dayp</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="n">p</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">8</span><span class="p">])]</span>
                    <span class="n">s</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">12</span><span class="p">])]</span>
                    <span class="k">if</span> <span class="s">&#39;no-std&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">]:</span>
                        <span class="n">jdthet</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
                        <span class="n">daythet</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                        <span class="n">thet</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">])]</span>
                        <span class="n">sthet</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)]</span>

                <span class="c"># Filtered data</span>
                <span class="k">elif</span> <span class="s">&#39;no-std&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">]:</span>
                    <span class="n">jdp_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
                    <span class="n">dayp_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="n">p_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">8</span><span class="p">])]</span>
                    <span class="n">s_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">12</span><span class="p">])]</span>
                    <span class="n">jdthet_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
                    <span class="n">daythet_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="n">thet_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">])]</span>
                    <span class="n">sthet_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)]</span>

        <span class="n">jdpbpi</span><span class="p">,</span> <span class="n">pbpi</span><span class="p">,</span> <span class="n">spbpi</span> <span class="o">=</span> <span class="n">polColor</span><span class="p">(</span><span class="n">dayp</span><span class="p">,</span> <span class="n">jdp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">dayp_filt</span><span class="p">,</span> <span class="n">jdp_filt</span><span class="p">,</span> <span class="n">p_filt</span><span class="p">,</span> <span class="n">s_filt</span><span class="p">)</span>

<span class="c">#        print jdp, p, s</span>
<span class="c">#        print jdp_filt, p_filt, s_filt</span>


        <span class="c">##############</span>
        <span class="c">### 1ST GRAPH</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span>

        <span class="c"># Plot data</span>
        <span class="k">if</span> <span class="n">jdp</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">limJD</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_rainbow</span><span class="p">([(</span><span class="n">jdi</span><span class="o">-</span><span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">limJD</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">jdi</span> <span class="ow">in</span> <span class="n">jdp</span><span class="p">[</span><span class="n">idx</span><span class="p">]])</span>
                <span class="n">image</span> <span class="o">+=</span> <span class="p">[</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">jdp</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">jdp</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> \
                                    <span class="n">vmax</span><span class="o">=</span><span class="n">limJD</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s">&#39;white&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_rainbow</span><span class="p">([</span><span class="mf">0.5</span><span class="p">])</span>
                <span class="n">lixo</span> <span class="o">=</span> <span class="p">[</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">jdp</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> \
                                    <span class="n">edgecolors</span><span class="o">=</span><span class="s">&#39;white&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">jdp</span><span class="p">[</span><span class="n">idx</span><span class="p">])):</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">jdp</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">s</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> \
                                       <span class="n">elinewidth</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

        <span class="c"># Plot ignored data</span>
        <span class="k">if</span> <span class="n">jdp_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">limJD</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_rainbow</span><span class="p">([(</span><span class="n">jdi</span><span class="o">-</span><span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">limJD</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">jdi</span> <span class="ow">in</span> <span class="n">jdp_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">]])</span>
                <span class="n">image</span> <span class="o">+=</span> <span class="p">[</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">jdp_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">p_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">jdp_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> \
                                    <span class="n">vmax</span><span class="o">=</span><span class="n">limJD</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_rainbow</span><span class="p">([</span><span class="mf">0.5</span><span class="p">])</span>
                <span class="n">lixo</span> <span class="o">=</span> <span class="p">[</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">jdp_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">p_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> \
                                                    <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">jdp_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">])):</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">jdp_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">p_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">s_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> \
                                    <span class="n">elinewidth</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

        <span class="c">##############</span>
        <span class="c">### 2ND GRAPH</span>

        <span class="c"># Plot data </span>
        <span class="k">if</span> <span class="n">jdpbpi</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">limJD</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_rainbow</span><span class="p">([(</span><span class="n">jdi</span><span class="o">-</span><span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">limJD</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">jdi</span> <span class="ow">in</span> <span class="n">jdpbpi</span><span class="p">])</span>
                <span class="n">image</span> <span class="o">+=</span> <span class="p">[</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">jdpbpi</span><span class="p">,</span> <span class="n">pbpi</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">jdpbpi</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> \
                                    <span class="n">vmax</span><span class="o">=</span><span class="n">limJD</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s">&#39;white&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_rainbow</span><span class="p">([</span><span class="mf">0.5</span><span class="p">])</span>
                <span class="n">lixo</span> <span class="o">=</span> <span class="p">[</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">jdpbpi</span><span class="p">,</span> <span class="n">pbpi</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> \
                                     <span class="n">edgecolors</span><span class="o">=</span><span class="s">&#39;white&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">jdpbpi</span><span class="p">)):</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">jdpbpi</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pbpi</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">spbpi</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> \
                                    <span class="n">elinewidth</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

        <span class="c"># Plot ignored data</span>
<span class="c">#        image += [axs[1].scatter(jdp_filt[idx], p_filt[idx], marker=&#39;x&#39;, c=jdp_filt[idx], vmin=limJD[0], \</span>
 <span class="c">#                                   vmax=limJD[1], s=50, linewidths=1.8, cmap=cm)]</span>
 <span class="c">#       axs[1].errorbar(jdp_filt[idx], p_filt[idx], yerr=s_filt[idx], linestyle=&#39;&#39;, \</span>
 <span class="c">#                                   elinewidth=0.6, marker=&#39;&#39;, color=&#39;black&#39;, alpha=0.7)</span>

        <span class="c">##############</span>
        <span class="c">### 3RD GRAPH</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span>

        <span class="c"># Plot data </span>
        <span class="k">if</span> <span class="n">jdthet</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">limJD</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_rainbow</span><span class="p">([(</span><span class="n">jdi</span><span class="o">-</span><span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">limJD</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">jdi</span> <span class="ow">in</span> <span class="n">jdthet</span><span class="p">[</span><span class="n">idx</span><span class="p">]])</span>
                <span class="n">image</span> <span class="o">+=</span> <span class="p">[</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">jdthet</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">thet</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">jdthet</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> \
                                    <span class="n">vmax</span><span class="o">=</span><span class="n">limJD</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s">&#39;white&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_rainbow</span><span class="p">([</span><span class="mf">0.5</span><span class="p">])</span>
                <span class="n">lixo</span> <span class="o">=</span> <span class="p">[</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">jdthet</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">thet</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> \
                                       <span class="n">edgecolors</span><span class="o">=</span><span class="s">&#39;white&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">)]</span>


            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">jdthet</span><span class="p">[</span><span class="n">idx</span><span class="p">])):</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">jdthet</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">thet</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sthet</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> \
                                    <span class="n">elinewidth</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

        <span class="c"># Plot ignored data</span>
        <span class="k">if</span> <span class="n">jdthet_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">limJD</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_rainbow</span><span class="p">([(</span><span class="n">jdi</span><span class="o">-</span><span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">limJD</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">jdi</span> <span class="ow">in</span> <span class="n">jdthet_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">]])</span>
                <span class="n">image</span> <span class="o">+=</span> <span class="p">[</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">jdthet_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">thet_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">jdthet_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> \
                                    <span class="n">vmax</span><span class="o">=</span><span class="n">limJD</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_rainbow</span><span class="p">([</span><span class="mf">0.5</span><span class="p">])</span>
                <span class="n">lixo</span> <span class="o">=</span> <span class="p">[</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">jdthet_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">thet_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> \
                                       <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">)]</span>
                            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">jdthet_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">])):</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">jdthet_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">thet_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sthet_filt</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> \
                                    <span class="n">elinewidth</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

        <span class="c"># Fix limits</span>
<span class="c">#        ax.autoscale(False)</span>
<span class="c">#        ax.plot(ax.get_xlim(), [0,0], &#39;k--&#39;)</span>
<span class="c">#        ax.plot([0,0], ax.get_ylim(), &#39;k--&#39;)</span>

        <span class="c"># Setting sizes</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
            <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">():</span>
            <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">():</span>
            <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">():</span>
            <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">image</span>
        <span class="c">###########</span>

   

    <span class="n">_plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">logfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">_phc</span><span class="o">.</span><span class="n">bes</span><span class="p">:</span>
        <span class="n">be</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">bes</span><span class="p">[</span><span class="n">logfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">be</span> <span class="o">=</span> <span class="n">logfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c"># Verify if vfilter is a special filter</span>
    <span class="k">if</span> <span class="n">vfilter</span> <span class="ow">in</span> <span class="n">vfil</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">vfilter</span> <span class="o">=</span> <span class="n">vfil</span><span class="p">[</span><span class="n">vfilter</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">vfilter</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">vfilter</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c"># Generate the four axes (sorted as BVRI)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">_plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="n">axs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">_plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="n">axs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">_plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    
    <span class="c"># Fix the spacing among the subgraphs and set the QU limits</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.06</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.06</span><span class="p">)</span>

    <span class="c"># Do the graphs</span>
    <span class="n">images</span> <span class="o">+=</span> <span class="p">[</span><span class="n">plot</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span><span class="p">)]</span>

    <span class="c"># Unset the ticklabels</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">_plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

    <span class="c"># Plot colormap</span>
    <span class="k">if</span> <span class="n">images</span> <span class="o">!=</span> <span class="p">[[]]:</span>
        <span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s">&#39;vertical&#39;</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s">&#39;MJD&#39;</span><span class="p">)</span>
<span class="c">#        cb.ColorbarBase(cax, orientation=&#39;vertical&#39;, cmap=_plt.cm.gist_rainbow)</span>
<span class="c">#        cb.set_ticklabels(range(int(limJD[0]),int(limJD[1]),50))</span>

    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}_t.{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">extens</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">return</span>




<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span></div>
<div class="viewcode-block" id="graf_qu"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.graf_qu">[docs]</a><span class="k">def</span> <span class="nf">graf_qu</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">odr</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">mcmc</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">nn</span><span class="o">=</span><span class="p">[</span><span class="mi">120</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">600</span><span class="p">],</span> \
                           <span class="n">thet_ran</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">180.</span><span class="p">],</span> <span class="n">b_ran</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">Pb_ran</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> \
                           <span class="n">Yb_ran</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">Vb_ran</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">clip</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">sclip</span><span class="o">=</span><span class="mf">4.5</span><span class="p">,</span> \
                           <span class="n">nmax</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">vfilter</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;no-std&#39;</span><span class="p">],</span> <span class="n">save</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">extens</span><span class="o">=</span><span class="s">&#39;pdf&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a QU diagram for the Be star in the logfile .log</span>
<span class="sd">    file (the outfile from polt.genTarget) and fit a line</span>
<span class="sd">    if specified. Propagates error of standard star.</span>

<span class="sd">         ODR: dot-line</span>
<span class="sd">        MCMC: continuous line</span>
<span class="sd">        </span>
<span class="sd">    mode=1 plot BVRI graphs in the same figure + U in another;</span>
<span class="sd">    mode=2 plot UBVRI graphs in separated figures.</span>

<span class="sd">    INPUT</span>

<span class="sd">        logfile: Logfile with QU data</span>
<span class="sd">           mode: 1) Plot a figure to filter U and another for</span>
<span class="sd">                 BVRI filters; 2) Plot a figure for filter</span>
<span class="sd">            odr: Run phc.fit_linear to fit a line?</span>
<span class="sd">           mcmc: Run fitMCMCline to fit a line?</span>
<span class="sd">             nn: fitMCMCline: [n_walkers, n_burnin, n_mcmc]</span>
<span class="sd">       thet_ran: fitMCMCline: [thet_min, thet_max]</span>
<span class="sd">          b_ran: fitMCMCline: [b_min, b_max]</span>
<span class="sd">         Pb_ran: fitMCMCline: [Pb_min, Pb_max], with Pb_min &gt;= 0</span>
<span class="sd">         Yb_ran: fitMCMCline: [Yb_min, Yb_max]</span>
<span class="sd">         Vb_ran: fitMCMCline: [Vb_min, Vb_max], with Vb_min &gt;= 0</span>
<span class="sd">           clip: phc.fit_linear: apply sigma clipping?</span>
<span class="sd">          sclip: phc.fit_linear: sigma value to clip</span>
<span class="sd">           nmax: phc.fit_linear: sigma clipping max number of</span>
<span class="sd">                 iterations</span>
<span class="sd">        vfilter: list of flags to filter (will be marked with</span>
<span class="sd">                 a &#39;x&#39; symbol and won&#39;t considered in odr</span>
<span class="sd">                 fitting). The observations with flag &#39;no-std&#39;</span>
<span class="sd">                 never are shown. mcmc fitting uses the filtered</span>
<span class="sd">                 observations, except those with &#39;no-std&#39; flag.</span>
<span class="sd">           save: Save the graphs? If False, just shows</span>
<span class="sd">         extens: Extension for the graphs</span>

<span class="sd">    OUTPUT</span>

<span class="sd">        1) None if odr and mcmc are False</span>
<span class="sd">        2) When mcmc==True:</span>
<span class="sd">           [[[param_u], [sparam_+_u], [sparam_-_u], n_u, obj_u],</span>
<span class="sd">             ...</span>
<span class="sd">            [[param_i], [sparam_+_i], [sparam_-_i], n_i, obj_i]],</span>

<span class="sd">           where param, sparam_+ and sparam_- are arrays with</span>
<span class="sd">           the five parameters for MCMC fitting (thet, b, Pb,</span>
<span class="sd">           Yb and Vb) and its errors (at right and left), n is</span>
<span class="sd">           the number of points and obj is one graphical dummy object.</span>
<span class="sd">        3) When odr==True AND mcmc==False:</span>
<span class="sd">           Idem, but param, sparam_+ and sparam_- are arrays with the</span>
<span class="sd">           two parameters for ODR fitting (a, b) and its errors.</span>


<span class="sd">    CAUTION:</span>

<span class="sd">      - The angle returned IS NOT the PA angle obtained from the slop,</span>
<span class="sd">        but the own inclination angle of the fitted line! PA is this</span>
<span class="sd">        angle divided by 2.</span>
<span class="sd">      - PA angle is indefined by a factor of +-90 degrees</span>
<span class="sd">      - This routine NEVER shows the data with &#39;no-std&#39; tag,</span>
<span class="sd">        independently of vfilter variable!</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">def</span> <span class="nf">plotQU</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">vfilter</span><span class="p">,</span> <span class="n">odr_fit</span><span class="p">,</span> <span class="n">mcmc_fit</span><span class="p">,</span> <span class="n">limq</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">limu</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">limJD</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Receive figure and axes objects and do the plot for filter</span>
<span class="sd">        filt WITHOUT show or save the image.</span>

<span class="sd">        limq=[qmin, qmax] and limu=[umin, umax] are lists for the min</span>
<span class="sd">        and max limits for the axes. Case no specified, they are</span>
<span class="sd">        automatically chosen.</span>
<span class="sd">        </span>
<span class="sd">        Return [param, sparam_+, sparam_-, n, image]</span>

<span class="sd">        param, sparam_+ and sparam_- are lists when two peaks are selected</span>
<span class="sd">        from chi2 distribution.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Setting the color map</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_rainbow</span>
        
        <span class="c"># Factor to fix the font sizes</span>
        <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">factor</span><span class="o">=</span><span class="mf">0.7</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">factor</span><span class="o">=</span><span class="mf">1.</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: Can</span><span class="se">\&#39;</span><span class="s">t read file {0}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logfile</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c">#        ax.set_title(&#39;{0} filter&#39;.format(filt.upper()), fontsize=fonts[0]*factor, verticalalignment=&#39;bottom&#39;)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.98</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="s">&#39;{0} filter&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filt</span><span class="o">.</span><span class="n">upper</span><span class="p">()),</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s">&#39;right&#39;</span><span class="p">,</span> \
                 <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;Q (%)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;U (%)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">18</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span>

        <span class="n">JD</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">thet</span><span class="p">,</span> <span class="n">sdth</span> <span class="o">=</span> <span class="p">[],[],[],[],[],[],[]</span>
        <span class="n">JD_filt</span><span class="p">,</span> <span class="n">p_filt</span><span class="p">,</span> <span class="n">q_filt</span><span class="p">,</span> <span class="n">u_filt</span><span class="p">,</span> <span class="n">s_filt</span><span class="p">,</span> <span class="n">thet_filt</span><span class="p">,</span> <span class="n">sdth_filt</span> <span class="o">=</span> <span class="p">[],[],[],[],[],[],[]</span>
        <span class="n">sq</span><span class="p">,</span> <span class="n">su</span><span class="p">,</span> <span class="n">sq_filt</span><span class="p">,</span> <span class="n">su_filt</span> <span class="o">=</span> <span class="p">[],[],[],[]</span>
        <span class="n">image</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Getting the values of the points and filtered points</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">filt</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;E&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">sub</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">vfilter</span><span class="p">):</span>
                <span class="n">JD</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
                <span class="n">p</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">8</span><span class="p">])]</span>
                <span class="n">q</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">9</span><span class="p">])]</span>
                <span class="n">u</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">10</span><span class="p">])]</span>
                <span class="n">thet</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">])]</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">12</span><span class="p">])]</span>
                <span class="n">sdth</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">])]</span>
            <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">filt</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;E&#39;</span> <span class="ow">and</span> <span class="s">&#39;no-std&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">]:</span>
                <span class="n">JD_filt</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
                <span class="n">p_filt</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">8</span><span class="p">])]</span>
                <span class="n">q_filt</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">9</span><span class="p">])]</span>
                <span class="n">u_filt</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">10</span><span class="p">])]</span>
                <span class="n">thet_filt</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">])]</span>
                <span class="n">s_filt</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">12</span><span class="p">])]</span>
                <span class="n">sdth_filt</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">])]</span>

        <span class="c"># Propagate errors</span>
        <span class="n">lixo</span><span class="p">,</span> <span class="n">sq</span><span class="p">,</span> <span class="n">su</span> <span class="o">=</span> <span class="n">propQU</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">thet</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sdth</span><span class="p">)</span>
        <span class="n">lixo</span><span class="p">,</span> <span class="n">sq_filt</span><span class="p">,</span> <span class="n">su_filt</span> <span class="o">=</span> <span class="n">propQU</span><span class="p">(</span><span class="n">p_filt</span><span class="p">,</span> <span class="n">thet_filt</span><span class="p">,</span> <span class="n">s_filt</span><span class="p">,</span> <span class="n">sdth_filt</span><span class="p">)</span>
<span class="c">#        print &#39;original:&#39;</span>
<span class="c">#        print q</span>
<span class="c">#        print q_filt</span>

        <span class="c"># Case some valid data was found</span>
        <span class="k">if</span> <span class="p">[</span><span class="n">q</span><span class="p">,</span> <span class="n">u</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[[],[]]:</span>

            <span class="c"># Fitting and plotting by least squares (must be found at least 2 points)</span>
            <span class="k">if</span> <span class="n">odr_fit</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="o">*</span><span class="mi">6</span> <span class="o">+</span> <span class="s">&#39;  FILTER &#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="n">tht</span><span class="p">,</span> <span class="n">stht</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">sparam1</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="n">fitodr</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">sq</span><span class="p">,</span><span class="n">su</span><span class="p">,</span><span class="n">JD</span><span class="p">,</span><span class="n">q_filt</span><span class="p">,</span><span class="n">u_filt</span><span class="p">,</span><span class="n">sq_filt</span><span class="p">,</span><span class="n">su_filt</span><span class="p">,</span><span class="n">JD_filt</span><span class="p">,</span><span class="n">filt</span><span class="p">)</span>
                <span class="n">sparam2</span> <span class="o">=</span> <span class="n">sparam1</span>
                <span class="n">delt</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">q</span><span class="o">+</span><span class="n">q_filt</span><span class="p">)</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">q</span><span class="o">+</span><span class="n">q_filt</span><span class="p">))</span><span class="o">/</span><span class="mi">8</span>
                <span class="n">xadj</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">q</span><span class="o">+</span><span class="n">q_filt</span><span class="p">)</span><span class="o">-</span><span class="n">delt</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">q</span><span class="o">+</span><span class="n">q_filt</span><span class="p">)</span><span class="o">+</span><span class="n">delt</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">yadj</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xadj</span><span class="o">+</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xadj</span><span class="p">,</span> <span class="n">yadj</span><span class="p">,</span> <span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;dimgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.7</span><span class="o">*</span><span class="n">factor</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;odr&#39;</span><span class="p">)</span>

            <span class="c"># Fitting and plotting by MCMC</span>
            <span class="k">if</span> <span class="n">mcmc_fit</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">odr_fit</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="o">*</span><span class="mi">6</span> <span class="o">+</span> <span class="s">&#39;  FILTER &#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="n">param</span><span class="p">,</span> <span class="n">sparam1</span><span class="p">,</span> <span class="n">sparam2</span> <span class="o">=</span> <span class="n">fitmcmc</span><span class="p">(</span><span class="n">q</span><span class="o">+</span><span class="n">q_filt</span><span class="p">,</span><span class="n">u</span><span class="o">+</span><span class="n">u_filt</span><span class="p">,</span><span class="n">sq</span><span class="o">+</span><span class="n">sq_filt</span><span class="p">,</span><span class="n">su</span><span class="o">+</span><span class="n">su_filt</span><span class="p">,</span><span class="n">filt</span><span class="p">)</span>
                <span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="o">+</span><span class="n">q_filt</span><span class="p">)</span>
                <span class="n">delt</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">q</span><span class="o">+</span><span class="n">q_filt</span><span class="p">)</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">q</span><span class="o">+</span><span class="n">q_filt</span><span class="p">))</span><span class="o">/</span><span class="mi">8</span>
                <span class="n">xadj</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">q</span><span class="o">+</span><span class="n">q_filt</span><span class="p">)</span><span class="o">-</span><span class="n">delt</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">q</span><span class="o">+</span><span class="n">q_filt</span><span class="p">)</span><span class="o">+</span><span class="n">delt</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="c">#                print param</span>
                <span class="c"># Only plot the curve when the number of points is &gt; 1</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">parami</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
                        <span class="n">b0</span> <span class="o">=</span> <span class="n">parami</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">parami</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
                        <span class="n">a0</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">parami</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
                        <span class="n">yadj</span> <span class="o">=</span> <span class="n">a0</span><span class="o">*</span><span class="n">xadj</span><span class="o">+</span><span class="n">b0</span>
                        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xadj</span><span class="p">,</span> <span class="n">yadj</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;dimgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.7</span><span class="o">*</span><span class="n">factor</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;mcmc&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xadj</span><span class="p">,</span> <span class="n">yadj</span><span class="p">,</span> <span class="s">&#39;-.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;dimgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.7</span><span class="o">*</span><span class="n">factor</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;mcmc&#39;</span><span class="p">)</span>
                <span class="c"># Reshape the lists when there is just one peak selected from mcmc.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">param</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">sparam1</span> <span class="o">=</span> <span class="n">sparam1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">sparam2</span> <span class="o">=</span> <span class="n">sparam2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">odr</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">param</span><span class="p">,</span> <span class="n">sparam1</span><span class="p">,</span> <span class="n">sparam2</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
                <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>


            <span class="c"># Specify the colors according to the JD if limJD is None</span>
            <span class="k">if</span> <span class="n">limJD</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">limJD</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="n">limJD</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">JD</span><span class="o">+</span><span class="n">JD_filt</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">JD</span><span class="o">+</span><span class="n">JD_filt</span><span class="p">)]</span>

            <span class="c"># Plot data </span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="c">#                image += [ax.scatter(pts[0], pts[1], marker=&#39;o&#39;, edgecolors=colors, facecolors=colors, s=50)]</span>
                <span class="k">if</span> <span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">limJD</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_rainbow</span><span class="p">([(</span><span class="n">jdi</span><span class="o">-</span><span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">limJD</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">jdi</span> <span class="ow">in</span> <span class="n">JD</span><span class="p">])</span>
                    <span class="n">image</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">JD</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> \
                                            <span class="n">vmax</span><span class="o">=</span><span class="n">limJD</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s">&#39;white&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">72</span><span class="o">*</span><span class="n">factor</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_rainbow</span><span class="p">([</span><span class="mf">0.5</span><span class="p">])</span>
                    <span class="n">lixo</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> \
                                      <span class="n">edgecolors</span><span class="o">=</span><span class="s">&#39;white&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">72</span><span class="o">*</span><span class="n">factor</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xerr</span><span class="o">=</span><span class="n">sq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">su</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> \
                                                <span class="n">elinewidth</span><span class="o">=</span><span class="mf">1.05</span><span class="o">*</span><span class="n">factor</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">4</span><span class="o">*</span><span class="n">factor</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

            <span class="c"># Plot ignored data</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">q_filt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="c">#                image += [ax.scatter(pts_filt[0], pts_filt[1], marker=&#39;x&#39;, edgecolors=colors_filt, facecolors=colors_filt, s=60, linewidths=2)]</span>
<span class="c">#                print &quot;Entrou IF&quot;</span>
                <span class="k">if</span> <span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">limJD</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_rainbow</span><span class="p">([(</span><span class="n">jdi</span><span class="o">-</span><span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">limJD</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">jdi</span> <span class="ow">in</span> <span class="n">JD_filt</span><span class="p">])</span>
                    <span class="n">image</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q_filt</span><span class="p">,</span> <span class="n">u_filt</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">JD_filt</span><span class="p">,</span> \
                                <span class="n">vmin</span><span class="o">=</span><span class="n">limJD</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">limJD</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">72</span><span class="o">*</span><span class="n">factor</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.4</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_rainbow</span><span class="p">([</span><span class="mf">0.5</span><span class="p">])</span>
                    <span class="n">lixo</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">q_filt</span><span class="p">,</span> <span class="n">u_filt</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> \
                                      <span class="n">s</span><span class="o">=</span><span class="mi">72</span><span class="o">*</span><span class="n">factor</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.4</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q_filt</span><span class="p">)):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">q_filt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">u_filt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xerr</span><span class="o">=</span><span class="n">sq_filt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">su_filt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> \
                                        <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">elinewidth</span><span class="o">=</span><span class="mf">1.05</span><span class="o">*</span><span class="n">factor</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">4</span><span class="o">*</span><span class="n">factor</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

            <span class="c"># If mode==2, print the colorbar here</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">image</span> <span class="o">!=</span> <span class="p">[]:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
                    <span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
                    <span class="n">cb</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s">&#39;vertical&#39;</span><span class="p">)</span>
                    <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s">&#39;MJD&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">param</span><span class="p">,</span> <span class="n">sparam1</span><span class="p">,</span> <span class="n">sparam2</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">image</span> <span class="o">=</span> <span class="p">[]</span>


        <span class="c"># Fix limits</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">autoscale</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">limq</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">limq</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">limq</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">limu</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">limu</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">limu</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;k--&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">(),</span> <span class="s">&#39;k--&#39;</span><span class="p">)</span>

        <span class="c"># Setting sizes</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
            <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>


        <span class="k">return</span> <span class="p">[</span><span class="n">param</span><span class="p">,</span> <span class="n">sparam1</span><span class="p">,</span> <span class="n">sparam2</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">image</span><span class="p">]</span>



    <span class="k">def</span> <span class="nf">fitodr</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">sq</span><span class="p">,</span><span class="n">su</span><span class="p">,</span><span class="n">JD</span><span class="p">,</span><span class="n">q_filt</span><span class="p">,</span><span class="n">u_filt</span><span class="p">,</span><span class="n">sq_filt</span><span class="p">,</span><span class="n">su_filt</span><span class="p">,</span><span class="n">JD_filt</span><span class="p">,</span><span class="n">filt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit ODR</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">jd</span><span class="p">,</span> <span class="n">jd_filt</span><span class="p">,</span> <span class="n">pts</span><span class="p">,</span> <span class="n">spts</span><span class="p">,</span> <span class="n">pts_filt</span><span class="p">,</span> <span class="n">spts_filt</span> <span class="o">=</span> <span class="p">[],[],[[],[]],[[],[]],[[],[]],[[],[]]</span>
        <span class="n">jd_filt</span> <span class="o">=</span> <span class="n">JD_filt</span><span class="p">[:]</span>
        <span class="n">pts_filt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_filt</span><span class="p">[:]</span>
        <span class="n">pts_filt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_filt</span><span class="p">[:]</span>
        <span class="n">spts_filt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sq_filt</span><span class="p">[:]</span>
        <span class="n">spts_filt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">su_filt</span><span class="p">[:]</span>

        <span class="c"># Fit the simple least squares (only considering y errors) to find</span>
        <span class="c"># initial parameters to the next adjust</span>
        <span class="n">param0</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">_curve_fit</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">:</span> <span class="n">a</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">su</span><span class="p">)</span>
        <span class="n">sparam0</span> <span class="o">=</span> <span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">tht0</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">param0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">stht0</span> <span class="o">=</span> <span class="p">(</span><span class="mi">180</span><span class="o">*</span><span class="n">sparam0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">param0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

        <span class="c"># Fit by the total least squares method (orthogonal distance regression) with clipping</span>
        <span class="n">param</span><span class="p">,</span> <span class="n">sparam</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">niter</span><span class="p">,</span><span class="n">bolfilt</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">fit_linear</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">sq</span><span class="p">,</span> <span class="n">su</span><span class="p">,</span> <span class="n">param0</span><span class="o">=</span><span class="n">param0</span><span class="p">,</span>
                                                     <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">,</span> <span class="n">sclip</span><span class="o">=</span><span class="n">sclip</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="n">nmax</span><span class="p">)</span>
        <span class="n">tht</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">stht</span> <span class="o">=</span> <span class="p">(</span><span class="mi">180</span><span class="o">*</span><span class="n">sparam</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

        <span class="c"># Splitting the data into the selected data and the filtered by the clipping</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">bolfilt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">jd</span> <span class="o">+=</span> <span class="p">[</span><span class="n">JD</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="n">spts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">sq</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="n">spts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">su</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">jd_filt</span> <span class="o">+=</span> <span class="p">[</span><span class="n">JD</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="n">pts_filt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="n">pts_filt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="n">spts_filt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">sq</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="n">spts_filt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">su</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

        <span class="c"># Calculate the reduced chi-squared</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">rchi2</span> <span class="o">=</span> <span class="n">chi2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rchi2</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># Print informations only if mcmc==False (to prevent to print twice)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mcmc</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="mi">55</span><span class="o">*</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;  Total least squares fit  (y = a*x+b):&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="mi">55</span><span class="o">*</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;             a = {0:.3f} +- {1:.3f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sparam</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;             b = {0:.3f} +- {1:.3f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sparam</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;         theta = {0:.2f} +- {1:.2f} (+- n*90)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tht</span><span class="p">,</span> <span class="n">stht</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;             N = {0:d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;             red chi^2 = {0:2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rchi2</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="mi">55</span><span class="o">*</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">tht</span><span class="p">,</span> <span class="n">stht</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">sparam</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


    <span class="k">def</span> <span class="nf">fitmcmc</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">sq</span><span class="p">,</span> <span class="n">su</span><span class="p">,</span> <span class="n">filt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit MCMC</span>
<span class="sd">        The returned variable are &quot;lists&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dictvar</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;theta&#39;</span><span class="p">,</span><span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="s">&#39;P_b&#39;</span><span class="p">,</span> <span class="s">&#39;Y_b&#39;</span><span class="p">,</span> <span class="s">&#39;V_b&#39;</span><span class="p">]</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="p">[</span><span class="n">thet_ran</span><span class="p">,</span> <span class="n">b_ran</span><span class="p">,</span> <span class="n">Pb_ran</span><span class="p">,</span> <span class="n">Yb_ran</span><span class="p">,</span> <span class="n">Vb_ran</span><span class="p">]</span>

        <span class="n">opt2</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">thet_mcmc</span><span class="p">,</span> <span class="n">b_mcmc</span><span class="p">,</span> <span class="n">Pb_mcmc</span><span class="p">,</span> <span class="n">Yb_mcmc</span><span class="p">,</span> <span class="n">Vb_mcmc</span><span class="p">,</span> <span class="n">fig1</span><span class="p">,</span> <span class="n">fig2</span> <span class="o">=</span> <span class="n">fitMCMCline</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">sq</span><span class="p">,</span> <span class="n">su</span><span class="p">,</span> \
                                <span class="n">star</span><span class="o">=</span><span class="n">star</span><span class="o">+</span><span class="s">&#39;_&#39;</span><span class="o">+</span><span class="n">filt</span><span class="p">,</span> <span class="n">plot_adj</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">n_burnin</span><span class="o">=</span><span class="n">nn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> \
                                <span class="n">n_mcmc</span><span class="o">=</span><span class="n">nn</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">n_walkers</span><span class="o">=</span><span class="n">nn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">thet_ran</span><span class="o">=</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>   \
                                <span class="n">b_ran</span><span class="o">=</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Pb_ran</span><span class="o">=</span><span class="n">ranges</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">Yb_ran</span><span class="o">=</span><span class="n">ranges</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> \
                                <span class="n">Vb_ran</span><span class="o">=</span><span class="n">ranges</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">extens</span><span class="o">=</span><span class="n">extens</span><span class="p">)</span>
                        
            <span class="k">if</span> <span class="n">opt2</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">):</span>
                <span class="n">param</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[[</span><span class="n">thet_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Pb_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Yb_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Vb_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
                <span class="n">sparam1</span> <span class="o">=</span> <span class="p">[</span><span class="n">sparam1</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[[</span><span class="n">thet_mcmc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">b_mcmc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Pb_mcmc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Yb_mcmc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Vb_mcmc</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
                <span class="n">sparam2</span> <span class="o">=</span> <span class="p">[</span><span class="n">sparam2</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[[</span><span class="n">thet_mcmc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">b_mcmc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">Pb_mcmc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">Yb_mcmc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">Vb_mcmc</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">param</span> <span class="o">=</span> <span class="p">[[</span><span class="n">thet_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Pb_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Yb_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Vb_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
                <span class="n">sparam1</span> <span class="o">=</span> <span class="p">[[</span><span class="n">thet_mcmc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">b_mcmc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Pb_mcmc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Yb_mcmc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Vb_mcmc</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
                <span class="n">sparam2</span> <span class="o">=</span> <span class="p">[[</span><span class="n">thet_mcmc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">b_mcmc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">Pb_mcmc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">Yb_mcmc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">Vb_mcmc</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>

            <span class="c"># NEW: Requests if the user want to use another interval</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">while</span> <span class="n">opt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">,</span><span class="s">&#39;n&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Do you want to prune the limits and run again MCMC?&#39;</span><span class="p">)</span>
                <span class="n">opt</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;(y/n): &#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">):</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">ranges</span> <span class="o">=</span> <span class="p">[[],[],[],[],[]]</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dictvar</span><span class="p">):</span>
                        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">etr</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;{0}: specify in format `{0}_min,{0}_max`: &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
            <span class="c">#                        p_int = [float(ei)-params_fit[0] for ei in petr.split(&#39;,&#39;)]</span>
                                <span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">ei</span><span class="p">)</span> <span class="k">for</span> <span class="n">ei</span> <span class="ow">in</span> <span class="n">etr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)]</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                                        <span class="k">break</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Error: {0}_max must be greather than {0}_min!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Invalid input!&#39;</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Invalid input!&#39;</span><span class="p">)</span>

                    <span class="n">opt</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                    <span class="k">while</span> <span class="n">opt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">,</span><span class="s">&#39;n&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">):</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Is it correct?&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dictvar</span><span class="p">):</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">&#39;              {0}_min,{0}_max: {1},{2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>

                        <span class="n">opt</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;(y/n): &#39;</span> <span class="p">)</span>
                    <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">):</span>
                        <span class="n">_plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig1</span><span class="p">)</span>
                        <span class="n">_plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig2</span><span class="p">)</span>
                        <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># To precent a &#39;third&#39; peak</span>
                <span class="k">if</span> <span class="n">opt2</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">):</span>
                    <span class="n">opt2</span> <span class="o">=</span> <span class="s">&#39;N&#39;</span>
                <span class="k">while</span> <span class="n">opt2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">,</span><span class="s">&#39;n&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Do you want select a second peak?&#39;</span><span class="p">)</span>
                    <span class="n">opt2</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;(y/n): &#39;</span><span class="p">)</span>

                <span class="n">_plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig1</span><span class="p">)</span>
                <span class="n">_plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">opt2</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;n&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">):</span>
                    <span class="k">break</span>


        <span class="k">return</span> <span class="n">param</span><span class="p">,</span> <span class="n">sparam1</span><span class="p">,</span> <span class="n">sparam2</span>



    <span class="k">def</span> <span class="nf">fixLimits</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Found the min and max Q, U and JD values to set the limits of plot</span>
<span class="sd">        (excluding the observations for U filter).</span>
<span class="sd">        Return 3 lists: [qmin, qmax], [umin, umax], [JDmin, JDmax]</span>
<span class="sd">        Return [],[],[] if there is none observations.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: Can</span><span class="se">\&#39;</span><span class="s">t read file {0}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logfile</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span> <span class="n">_np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">18</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span>

        <span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;u&#39;</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;E&#39;</span> <span class="ow">and</span> <span class="s">&#39;no-std&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">]]</span>
<span class="c">#                                                 not any(sub in line[17] for sub in vfilter)]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;u&#39;</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;E&#39;</span> <span class="ow">and</span> <span class="s">&#39;no-std&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">]]</span>
<span class="c">#                                                 not any(sub in line[17] for sub in vfilter)]</span>
        <span class="n">JD</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;u&#39;</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;E&#39;</span> <span class="ow">and</span> <span class="s">&#39;no-std&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">]]</span>
<span class="c">#                                                 not any(sub in line[17] for sub in vfilter)]</span>

        <span class="k">if</span> <span class="n">q</span><span class="o">==</span><span class="p">[]:</span>
            <span class="k">return</span> <span class="p">[],[],[]</span>
        
        <span class="c"># A scaled value to shift</span>
        <span class="n">deltq</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">q</span><span class="p">))</span><span class="o">/</span><span class="mi">8</span>
        <span class="n">deltu</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">u</span><span class="p">))</span><span class="o">/</span><span class="mi">8</span>

        <span class="k">return</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">-</span><span class="n">deltq</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">+</span><span class="n">deltq</span><span class="p">],</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">-</span><span class="n">deltu</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">+</span><span class="n">deltu</span><span class="p">],</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">JD</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">JD</span><span class="p">)]</span>



    <span class="n">_plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">)</span>
    <span class="n">star</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">trimpathname</span><span class="p">(</span><span class="n">logfile</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">star</span> <span class="ow">in</span> <span class="n">_phc</span><span class="o">.</span><span class="n">bes</span><span class="p">:</span>
        <span class="n">be</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">bes</span><span class="p">[</span><span class="n">star</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">be</span> <span class="o">=</span> <span class="n">star</span>
    <span class="n">arr</span><span class="p">,</span> <span class="n">images</span> <span class="o">=</span> <span class="p">[],[]</span>

    <span class="c"># Verify if vfilter is a special filter</span>
    <span class="k">if</span> <span class="n">vfilter</span> <span class="ow">in</span> <span class="n">vfil</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">vfilter</span> <span class="o">=</span> <span class="n">vfil</span><span class="p">[</span><span class="n">vfilter</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">vfilter</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">vfilter</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c">######</span>
    <span class="c">## 1) Mode 1 plots QU diagram for BVRI filters in the same image and for U in another</span>
    <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>

        <span class="c">### 1.1 Do the graph for U filter</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">arr</span> <span class="o">+=</span> <span class="p">[</span><span class="n">plotQU</span><span class="p">(</span><span class="s">&#39;u&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">vfilter</span><span class="p">,</span> <span class="n">odr</span><span class="p">,</span> <span class="n">mcmc</span><span class="p">)]</span>
<span class="c">#        _plt.close(fig_aux)</span>
        
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}_qu_u.{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star</span><span class="p">,</span><span class="n">extens</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s">&#39;tight&#39;</span><span class="p">)</span>
<span class="c">#            _plt.close(fig)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">odr</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        
        <span class="c"># Generate the four axes (sorted as BVRI)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">_plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">axs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">_plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="n">axs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">_plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="n">axs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">_plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharey</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
<span class="c">#            ax.locator_params(axis=&#39;x&#39;, nbins=6)</span>
            <span class="n">xloc</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">xloc</span><span class="p">)</span>
        
        <span class="c"># Fix the spacing among the subgraphs and set the QU limits</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">limq</span><span class="p">,</span> <span class="n">limu</span><span class="p">,</span> <span class="n">limJD</span> <span class="o">=</span> <span class="n">fixLimits</span><span class="p">()</span>


        <span class="c">### 1.2 Do the graphs fo BVRI</span>
        <span class="n">nax</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="s">&#39;v&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;i&#39;</span><span class="p">):</span>
            <span class="n">arr</span> <span class="o">+=</span> <span class="p">[</span><span class="n">plotQU</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="n">nax</span><span class="p">],</span> <span class="n">vfilter</span><span class="p">,</span> <span class="n">odr</span><span class="p">,</span> <span class="n">mcmc</span><span class="p">,</span> <span class="n">limq</span><span class="o">=</span><span class="n">limq</span><span class="p">,</span> <span class="n">limu</span><span class="o">=</span><span class="n">limu</span><span class="p">,</span> <span class="n">limJD</span><span class="o">=</span><span class="n">limJD</span><span class="p">)]</span>
            <span class="n">nax</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">arr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">images</span> <span class="o">+=</span> <span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">odr</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="c"># Unset the ticklabels</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

        <span class="c"># Plot colormap</span>
        <span class="k">if</span> <span class="n">images</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s">&#39;vertical&#39;</span><span class="p">)</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s">&#39;MJD&#39;</span><span class="p">)</span>
<span class="c">#        cb.ColorbarBase(cax, orientation=&#39;vertical&#39;, cmap=_plt.cm.gist_rainbow)</span>
<span class="c">#        cb.set_ticklabels(range(int(limJD[0]),int(limJD[1]),50))</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}_qu.{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star</span><span class="p">,</span><span class="n">extens</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s">&#39;tight&#39;</span><span class="p">)</span>
<span class="c">#            _plt.close(fig)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


    <span class="c">######</span>
    <span class="c">## 2) Mode 2 plots QU diagram for UBVRI filters in different images</span>
    <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;u&#39;</span><span class="p">,</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="s">&#39;v&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;i&#39;</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">arr</span> <span class="o">+=</span> <span class="p">[</span><span class="n">plotQU</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">vfilter</span><span class="p">,</span> <span class="n">odr</span><span class="p">,</span> <span class="n">mcmc</span><span class="p">)]</span>
<span class="c">#            _plt.close(fig_aux)</span>

            <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}_qu_{1}.{2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star</span><span class="p">,</span><span class="n">filt</span><span class="p">,</span><span class="n">extens</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s">&#39;tight&#39;</span><span class="p">)</span>
<span class="c">#                _plt.close(fig)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">odr</span> <span class="ow">or</span> <span class="n">mcmc</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">arr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span>



</div>
<div class="viewcode-block" id="sintLeff"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.sintLeff">[docs]</a><span class="k">def</span> <span class="nf">sintLeff</span><span class="p">(</span><span class="n">ccdn</span><span class="o">=</span><span class="s">&#39;ixon&#39;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">extens</span><span class="o">=</span><span class="s">&#39;pdf&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sintetizes the response curve, considering the</span>
<span class="sd">    CCD Quantum Efficience (QE) and filter transmitance</span>
<span class="sd">    from OPD and the stellar models from Pickles (1998).</span>
<span class="sd">    Interpolations are made by using cubic splines.</span>

<span class="sd">    This code DON&#39;T use none curve for sky transmitance!</span>

<span class="sd">    Creates two data files:</span>

<span class="sd">    leff_stars_[ccdn].dat : table with l_eff calculated</span>
<span class="sd">                            for each star type</span>
<span class="sd">    leff_[ccdn].dat : table with the parameters for the</span>
<span class="sd">                      adjusted cubic function for l_eff(b-v)</span>
<span class="sd">                      (or l_eff(u-b) to the filter U). The</span>
<span class="sd">                      M-type stars were excluded from the</span>
<span class="sd">                      adjusts, because the molecular lines</span>
<span class="sd">                      were affecting these curves.</span>

<span class="sd">    &#39;ccdn&#39;:  CCD to use in QE curve</span>
<span class="sd">                 ixon: CON, Frame Transfer</span>
<span class="sd">                 ikon: High Sensitive, Frame Transfer</span>
<span class="sd">           ikon-14912: High Sensitive, Frame Transfer</span>
<span class="sd">                  301: not avaible</span>

<span class="sd">        New eventual CCD files must sample the QE, at least,</span>
<span class="sd">        inside the range [2800,11000] Angstrom.</span>

<span class="sd">    &#39;step&#39;: step, in angstrom, used for the integration</span>
<span class="sd">            (Simpson&#39;s method) to calculate lambda_eff.</span>
<span class="sd">            Allowed values are 5, 10, 15, ..., 500.</span>


<span class="sd">    FORMULAS:</span>

<span class="sd">    The lbd_eff is computed as **the flux-weighted mean</span>
<span class="sd">    wavelenght in terms of photons**:</span>

<span class="sd">    lbd_eff = \int(lbd*phi(lbd) * d_lbd) / \int(phi(lbd) * d_lbd)</span>


<span class="sd">    where  phi(lbd) = lbd * F_lbd * QE(lbd) * T(lbd)</span>
<span class="sd">           F_lbd: stellar flux in erg cm-2 s-1 A-1</span>
<span class="sd">           QE(lbd): curve for quantum efficience</span>
<span class="sd">           T(lbd):  curve for filter transmitance</span>
<span class="sd">           d_lbd: infinitesimal element of wavelength</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># List the files for standard stars models</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">_glob</span><span class="p">(</span><span class="s">&#39;{0}/stars/uk*.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">()))</span>

    <span class="c"># Open file with informations about the standard stars models</span>
    <span class="n">dstars</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/stars/synphot.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">()),</span><span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">lbds</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">2800.</span><span class="p">,</span><span class="mf">11000.001</span><span class="p">,</span><span class="n">step</span><span class="p">)</span>

    <span class="c"># Open file with CCD Quantum Efficience (QE)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fqe</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/refs/opd/QE_{1}.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">(),</span><span class="n">ccdn</span><span class="p">),</span><span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c"># unpack is to get the transposed array</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;ERROR: CCD name </span><span class="se">\&#39;</span><span class="s">{0}</span><span class="se">\&#39;</span><span class="s"> not identified!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ccdn</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">step</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">505</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;ERROR: step value not valid! Put some value among 5, 10, 15, ..., 500&#39;</span><span class="p">)</span>
        <span class="k">return</span>        

    <span class="c"># Interpolate QE</span>
    <span class="n">qe</span> <span class="o">=</span> <span class="n">_interp1d</span><span class="p">(</span><span class="n">fqe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fqe</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s">&#39;cubic&#39;</span><span class="p">)</span>

    <span class="c"># Delete the old .dat files</span>
    <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;leff_stars_{0}.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ccdn</span><span class="p">)):</span>
        <span class="n">_os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="s">&#39;leff_stars_{0}.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ccdn</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;leff_{0}.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ccdn</span><span class="p">)):</span>
        <span class="n">_os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="s">&#39;leff_{0}.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ccdn</span><span class="p">))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;leff_stars_{0}.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ccdn</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f0</span><span class="p">:</span>
        <span class="n">f0</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;{0:5s} {1:&gt;6s} {2:&gt;7s} {3:&gt;7s} {4:&gt;10s}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;#filt&#39;</span><span class="p">,</span><span class="s">&#39;stype&#39;</span><span class="p">,</span><span class="s">&#39;u-b&#39;</span><span class="p">,</span><span class="s">&#39;b-v&#39;</span><span class="p">,</span><span class="s">&#39;leff&#39;</span><span class="p">))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;leff_{0}.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ccdn</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f0</span><span class="p">:</span>
        <span class="n">f0</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;# For U filter:      leff = l0 + k1*(u-b) + k2*(u-b)^2 + k3*(u-b)^3</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">f0</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;# For BVRI filters:  leff = l0 + k1*(b-v) + k2*(b-v)^2 + k3*(b-v)^3</span><span class="se">\n</span><span class="s">#</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">f0</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s">&#39;{0:5s} {1:&gt;8s} {2:&gt;10s} {3:&gt;8s} {4:&gt;8s} {5:&gt;7s} {6:&gt;7s} {7:&gt;7s}&#39;</span> <span class="o">+</span>\
                  <span class="s">&#39;{8:&gt;7s} {9:&gt;7s}</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;#filt&#39;</span><span class="p">,</span><span class="s">&#39;adj_col&#39;</span><span class="p">,</span><span class="s">&#39;l0&#39;</span><span class="p">,</span><span class="s">&#39;k1&#39;</span><span class="p">,</span><span class="s">&#39;k2&#39;</span><span class="p">,</span><span class="s">&#39;k3&#39;</span><span class="p">,</span>\
                  <span class="s">&#39;sl0&#39;</span><span class="p">,</span><span class="s">&#39;sk1&#39;</span><span class="p">,</span><span class="s">&#39;sk2&#39;</span><span class="p">,</span><span class="s">&#39;sk3&#39;</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>

        <span class="c"># Open file with Filter Transmitance</span>
        <span class="n">ftr</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/filters/T{1}_POL.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">(),</span><span class="n">filt</span><span class="o">.</span><span class="n">upper</span><span class="p">()),</span><span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c"># Interpolate Filter Transmitance</span>
        <span class="k">if</span> <span class="n">filt</span><span class="o">==</span><span class="s">&#39;u&#39;</span><span class="p">:</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="n">_interp1d</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">2800.</span><span class="p">,</span> <span class="mf">11000.001</span><span class="p">,</span> <span class="mf">50.</span><span class="p">),</span> <span class="n">ftr</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s">&#39;cubic&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="n">_interp1d</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">2800.</span><span class="p">,</span> <span class="mf">11000.001</span><span class="p">,</span> <span class="mf">100.</span><span class="p">),</span> <span class="n">ftr</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s">&#39;cubic&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">star</span> <span class="ow">in</span> <span class="n">stars</span><span class="p">:</span>

            <span class="c"># Open file with flux for star model (genfromtxt allows skip lines in both header and footer)</span>
            <span class="n">fspec</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">unpack</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">skip_header</span><span class="o">=</span><span class="mi">330</span><span class="p">,</span> <span class="n">skip_footer</span><span class="o">=</span><span class="mi">2800</span><span class="p">)</span>

            <span class="c"># Mount the array for star spectrum</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="k">if</span> <span class="n">fspec</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">lbds</span><span class="p">:</span>
                    <span class="n">spec</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="p">[</span><span class="n">fspec</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]])</span>

            <span class="c"># Interpolate the star spectrum</span>
<span class="c">#            spec = _interp1d(fspec[0], fspec[1], kind=&#39;cubic&#39;)</span>
            <span class="n">stype</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

            <span class="c"># read the color index</span>
            <span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="n">dstars</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">di</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">stype</span><span class="p">:</span>
                    <span class="n">bv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">di</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">ub</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">di</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">di</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">break</span>

            <span class="c"># Convolute all the curves in the response function</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lbds</span><span class="p">)):</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="p">[</span><span class="n">lbds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">spec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">tr</span><span class="p">(</span><span class="n">lbds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">qe</span><span class="p">(</span><span class="n">lbds</span><span class="p">[</span><span class="n">i</span><span class="p">])])</span>

            <span class="c"># Integrate reponse*lambda and response to compute lambda_eff</span>
            <span class="n">l_on</span> <span class="o">=</span> <span class="n">_simps</span><span class="p">(</span><span class="n">lbds</span><span class="o">*</span><span class="n">lbds</span><span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">lbds</span><span class="p">)</span>
            <span class="n">l_under</span> <span class="o">=</span> <span class="n">_simps</span><span class="p">(</span><span class="n">lbds</span><span class="o">*</span><span class="n">resp</span><span class="p">,</span> <span class="n">lbds</span><span class="p">)</span>
            <span class="n">leff</span> <span class="o">=</span> <span class="n">l_on</span><span class="o">/</span><span class="n">l_under</span>

            <span class="n">line</span> <span class="o">=</span> <span class="s">&#39;{0:5s} {1:&gt;6s} {2:&gt;7.3f} {3:&gt;7.3f} {4:&gt;10.3f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span><span class="n">stype</span><span class="p">,</span><span class="n">ub</span><span class="p">,</span><span class="n">bv</span><span class="p">,</span><span class="n">leff</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;leff_stars_{0}.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ccdn</span><span class="p">),</span> <span class="s">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f0</span><span class="p">:</span>
                <span class="n">f0</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">_plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">axes</span><span class="p">()</span>
                <span class="n">_plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">r&#39;$\lambda\ (\AA)$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">_plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">r&#39;Curves&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lbds</span><span class="p">,</span><span class="n">resp</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;Combined&#39;</span><span class="p">)</span>
                <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lbds</span><span class="p">,</span><span class="n">spec</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">spec</span><span class="p">),</span> <span class="s">&#39;r-.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;{0} spec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stype</span><span class="p">))</span>
                <span class="n">tr2</span> <span class="o">=</span> <span class="p">[</span><span class="n">tr</span><span class="p">(</span><span class="n">lbd</span><span class="p">)</span> <span class="k">for</span> <span class="n">lbd</span> <span class="ow">in</span> <span class="n">lbds</span><span class="p">]</span>
                <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lbds</span><span class="p">,</span><span class="n">tr2</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">tr2</span><span class="p">),</span> <span class="s">&#39;g--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;Transm&#39;</span><span class="p">)</span>
                <span class="n">qe2</span> <span class="o">=</span> <span class="p">[</span><span class="n">qe</span><span class="p">(</span><span class="n">lbd</span><span class="p">)</span> <span class="k">for</span> <span class="n">lbd</span> <span class="ow">in</span> <span class="n">lbds</span><span class="p">]</span>
                <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lbds</span><span class="p">,</span><span class="n">qe2</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">qe2</span><span class="p">),</span> <span class="s">&#39;b--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;QE&#39;</span><span class="p">)</span>

                <span class="n">_plt</span><span class="o">.</span><span class="n">autoscale</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">_plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">1.1</span><span class="p">])</span>
                <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">leff</span><span class="p">,</span><span class="n">leff</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">1.1</span><span class="p">],</span> <span class="s">&#39;k--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">r&#39;$\lambda_{eff}$&#39;</span><span class="p">)</span>
                <span class="n">_plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;size&#39;</span><span class="p">:</span><span class="n">fonts</span><span class="p">[</span><span class="mi">3</span><span class="p">]})</span>

                <span class="c"># Setting sizes</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

                <span class="n">_plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}_{1}_{2}.{3}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stype</span><span class="p">,</span> <span class="n">ccdn</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">extens</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s">&#39;tight&#39;</span><span class="p">)</span>



    <span class="c"># Once concluded, we need compute lambda_eff as function of u-b and b-v</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\n\n</span><span class="s"># GENERAL ADJUST</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">leffs</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;leff_stars_{0}.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ccdn</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
        
        <span class="n">ub</span><span class="p">,</span> <span class="n">bv</span><span class="p">,</span> <span class="n">leff</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">leffs</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="c"># Excluding &#39;M&#39; type because it is problematic, due to the molecular lines</span>
            <span class="k">if</span> <span class="n">leffs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">filt</span> <span class="ow">and</span> <span class="n">leffs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;M&#39;</span><span class="p">:</span>
                <span class="n">ub</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ub</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">leffs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">])])</span>
                <span class="n">bv</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bv</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">leffs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">])])</span>
                <span class="n">leff</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">leff</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">leffs</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">i</span><span class="p">])])</span>

        <span class="n">_plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">axes</span><span class="p">()</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">r&#39;Color&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">r&#39;$\lambda_{eff}\ (\AA)$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bv</span><span class="p">,</span> <span class="n">leff</span><span class="p">,</span> <span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s">&#39;grey&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;B-V&#39;</span><span class="p">)</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ub</span><span class="p">,</span> <span class="n">leff</span><span class="p">,</span> <span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;U-B&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filt</span> <span class="o">==</span> <span class="s">&#39;u&#39;</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">ub</span>
            <span class="n">colorstr</span> <span class="o">=</span> <span class="s">&#39;U-B&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">bv</span>
            <span class="n">colorstr</span> <span class="o">=</span> <span class="s">&#39;B-V&#39;</span>

        <span class="c"># Fit the lambdas/colors</span>
        <span class="n">param</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">_curve_fit</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">l0</span><span class="p">,</span><span class="n">k1</span><span class="p">,</span><span class="n">k2</span><span class="p">,</span><span class="n">k3</span><span class="p">:</span> <span class="n">l0</span> <span class="o">+</span> <span class="n">k1</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">k2</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">k3</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">3</span><span class="p">),</span> <span class="n">color</span><span class="p">,</span> <span class="n">leff</span><span class="p">)</span>
        <span class="n">sparam</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span><span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]),</span> <span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">3</span><span class="p">])])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span> 
        <span class="n">y</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">_plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;{0} fit&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">colorstr</span><span class="p">))</span>

        <span class="n">_plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;size&#39;</span><span class="p">:</span><span class="n">fonts</span><span class="p">[</span><span class="mi">3</span><span class="p">]})</span>

        <span class="c"># Setting sizes</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
            <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fonts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;{0:5s} {1:&gt;8s} {2:&gt;10.2f} {3:&gt;8.2f} {4:&gt;8.2f} {5:&gt;7.2f} {6:&gt;7.2f} {7:&gt;7.2f}&#39;</span> <span class="o">+</span>\
                <span class="s">&#39;{8:&gt;7.2f} {9:&gt;7.2f}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span><span class="n">colorstr</span><span class="p">,</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">param</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>\
                         <span class="n">sparam</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">sparam</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sparam</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">sparam</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;leff_{0}.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ccdn</span><span class="p">),</span> <span class="s">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f0</span><span class="p">:</span>
            <span class="n">f0</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">_plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;leff_{0}_{1}.{2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ccdn</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">extens</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s">&#39;tight&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span>



</div>
<div class="viewcode-block" id="lbds"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.lbds">[docs]</a><span class="k">def</span> <span class="nf">lbds</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">ccdn</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span> <span class="n">skiperror</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the lambda_eff in angstrom for star with</span>
<span class="sd">    color index &#39;color&#39;, in filter &#39;filt&#39;, CCD &#39;ccdn&#39;</span>
<span class="sd">    and airmass &#39;airmass&#39;. The default airmass is 1.3</span>
<span class="sd">    for an average value.</span>

<span class="sd">    If skiperror==True, tries to use lambda_eff as the value</span>
<span class="sd">    from phc.lbds[] in case of missing information for</span>
<span class="sd">    &#39;filt&#39; or &#39;ccd&#39;.</span>

<span class="sd">    CAUTION:</span>
<span class="sd">    If filt==&#39;u&#39;, the color must be U-B</span>
<span class="sd">       Otherwise, the color must be B-V</span>

<span class="sd">    FORMULAS:</span>
<span class="sd">      - Atm. reddening:   redn = 2.5*_np.log10(_np.e)*</span>
<span class="sd">                                    *airmass*(taub-tauv)</span>
<span class="sd">      - Redd. color:  color_av = color + redn</span>
<span class="sd">      - lambda_eff:      l_eff = l0 + k1*color_av +</span>
<span class="sd">                                    + k2*(color_av**2) +</span>
<span class="sd">                                    + k3*(color_av**3)</span>

<span class="sd">       where tauu, taub, tau are the optical deepth of</span>
<span class="sd">       atmosphere (values used from Kepler de Oliveira</span>
<span class="sd">       et al, Astronomia e Astrofisica).</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s">&#39;{0}/filters/leff.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hdtpath</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

    <span class="c"># Optical deepth according to Kepler de Oliveira et al (Astronomia</span>
    <span class="c"># e Astrofisica), for altitude above 2000m</span>
    <span class="n">tauu</span><span class="o">=</span><span class="mf">1.36</span>
    <span class="n">taub</span><span class="o">=</span><span class="mf">0.52</span>
    <span class="n">tauv</span><span class="o">=</span><span class="mf">0.37</span>

    <span class="k">if</span> <span class="n">filt</span><span class="o">==</span><span class="s">&#39;u&#39;</span><span class="p">:</span>
        <span class="n">redn</span> <span class="o">=</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">e</span><span class="p">)</span><span class="o">*</span><span class="n">airmass</span><span class="o">*</span><span class="p">(</span><span class="n">tauu</span><span class="o">-</span><span class="n">taub</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">redn</span> <span class="o">=</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">e</span><span class="p">)</span><span class="o">*</span><span class="n">airmass</span><span class="o">*</span><span class="p">(</span><span class="n">taub</span><span class="o">-</span><span class="n">tauv</span><span class="p">)</span>

    <span class="n">l0</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">filt</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">ccdn</span><span class="p">:</span>
            <span class="n">l0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">k1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">k2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
            <span class="n">k3</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">l0</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">skiperror</span><span class="p">:</span>
            <span class="n">leff</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">lbds</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;# ERROR: parameters to calculate lambda_eff in filter {0} and CCD {1} not found.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span><span class="n">ccdn</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">color</span> <span class="o">+</span> <span class="n">redn</span>
        <span class="n">leff</span> <span class="o">=</span> <span class="n">l0</span> <span class="o">+</span> <span class="n">k1</span><span class="o">*</span><span class="n">color</span> <span class="o">+</span> <span class="n">k2</span><span class="o">*</span><span class="p">(</span><span class="n">color</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">k3</span><span class="o">*</span><span class="p">(</span><span class="n">color</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">leff</span>



<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">#################################################</span>
<span class="c">### MAIN ###</span></div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">pass</span>





<div class="viewcode-block" id="fitMCMCline"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.fitMCMCline">[docs]</a><span class="k">def</span> <span class="nf">fitMCMCline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">star</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">plot_adj</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> \
                                            <span class="n">n_burnin</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">n_mcmc</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> \
                                    <span class="n">n_walkers</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">thet_ran</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">180.</span><span class="p">],</span> \
                                    <span class="n">b_ran</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">Pb_ran</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> \
                                   <span class="n">Yb_ran</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">Vb_ran</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">extens</span><span class="o">=</span><span class="s">&#39;pdf&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit a line using Markov Chain Monte Carlo for data</span>
<span class="sd">        with both x and y errors and with bad points</span>
<span class="sd">        from emcee code.</span>
<span class="sd">        </span>
<span class="sd">        The model is tha sum of two models:</span>
<span class="sd">        a) a line model for the good points, y = ax + b, with</span>
<span class="sd">        data displaced ortogonally by a gaussian diplacentment</span>
<span class="sd">        (covariance is suposed null!);</span>
<span class="sd">        b) a gaussian distribution orthogonal to the line for</span>
<span class="sd">        the bad points with amplitude, mean and variance equal</span>
<span class="sd">        to Pb, Yb and Vb (see Hoog, Bovy and Lang,</span>
<span class="sd">        ``Data analysis recipes: Fitting a model to data&#39;&#39;)</span>

<span class="sd">        The MCMC does a ``mixture&#39;&#39; among both model for each</span>
<span class="sd">        point. So, it is not needed know about the bad and</span>
<span class="sd">        good points necessairly! The five parameters to be</span>
<span class="sd">        found are theta=arctan(a), b, Pb, Yb and Vb.</span>


<span class="sd">      INPUT:</span>
<span class="sd">        </span>
<span class="sd">      x/y/sx/sy: array/list with the data</span>
<span class="sd">           star: star name to be printed in the graph and</span>
<span class="sd">                 its filename. If it&#39;s a void str &#39;&#39;, this</span>
<span class="sd">                 routine give a random number to prevent</span>
<span class="sd">                 overwriting data.</span>
<span class="sd">         margin: marginalize the corner graphs over Pb,</span>
<span class="sd">                 Yb, Vb (generating the graph only for</span>
<span class="sd">                 theta and b)?</span>
<span class="sd">       plot_adj: show a plot of data+fit?</span>
<span class="sd">            fig: Figure to append the plots for data+fit.</span>
<span class="sd">                 If None, a new figure is generated.</span>
<span class="sd">             ax: Axes, as like fig above.</span>
<span class="sd">       n_burnin: number of iterations for burning-in</span>
<span class="sd">         n_mcmc: number of iterations to run emcee</span>
<span class="sd">      n_walkers: number of walkers to map the posterior</span>
<span class="sd">                 probabilities.</span>
<span class="sd">       thet_ran: [thet_min, thet_max]</span>
<span class="sd">          b_ran: [b_min, b_max]</span>
<span class="sd">         Pb_ran: [Pb_min, Pb_max], with Pb_min &gt;= 0</span>
<span class="sd">         Yb_ran: [Yb_min, Yb_max]</span>
<span class="sd">         Vb_ran: [Vb_min, Vb_max], with Vb_min &gt;= 0</span>
<span class="sd">         extens: extension for the graph file</span>


<span class="sd">      OUTPUT:</span>

<span class="sd">         theta_fit: [theta, theta_+, theta_-], the theta value</span>
<span class="sd">                    and its errors (at right and left from it).</span>
<span class="sd">                    theta is the median of distribution</span>
<span class="sd">                    probability and theta_+, theta_- are the</span>
<span class="sd">                    range within which there are 68.3% of the</span>
<span class="sd">                    points in such distribution.</span>
<span class="sd">      b*cos(theta): Idem, for b*cos(theta).</span>
<span class="sd">                Pb: Idem, for Pb.</span>
<span class="sd">                Yb: Idem, for Yb.</span>
<span class="sd">                Vb: Idem, for Vb.</span>
<span class="sd">              fig1: Figure pointer to the corner graph ([]</span>
<span class="sd">                    if show==False).</span>
<span class="sd">              fig2: Figure pointer to the data+fit graph ([]</span>
<span class="sd">                    if plot_adj==False).</span>
<span class="sd">        </span>

<span class="sd">      FORMULAS:</span>

<span class="sd">        Supposing i as each data point, the log of Likelihood</span>
<span class="sd">        function (L) takes form:</span>

<span class="sd">          log(L) = sum(log(p_good_i+p_bad_i))</span>

<span class="sd">        with</span>

<span class="sd">          p_good_i = (1-Pb)/sqrt(2*pi*var_i)*</span>
<span class="sd">                                exp(-0.5*(disp_i**2/var_i)),</span>

<span class="sd">           p_bad_i = Pb/sqrt(2*pi*(Vb+var)*</span>
<span class="sd">                            exp(-0.5*(disp_i-Yb)**2)/(Vb+var_i))</span>

<span class="sd">        where disp_i is the total projection of the (x_i,y_i)</span>
<span class="sd">        values over the line and var_i, the projected variance:</span>

<span class="sd">          disp_i = v*Z_i -b cos(thet)</span>
<span class="sd">           var_i = v*S_i*v</span>

<span class="sd">        with</span>
<span class="sd">        </span>
<span class="sd">            v = (-sin(theta), cos(theta)) (versor orthogonal</span>
<span class="sd">                                                 to the line)</span>
<span class="sd">          Z_i = (x_i, y_i)    (data point)</span>
<span class="sd">          S_i = | sx_i^2  sxy_i^2| = |sx_i^2     0 | = (covariance </span>
<span class="sd">                |syx_i^2   sy_i^2|   | 0     sy_i^2|       matrix)</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">emcee</span>
    <span class="kn">import</span> <span class="nn">triangle.nov</span>
    <span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">MaxNLocator</span>


    <span class="k">def</span> <span class="nf">lnprob</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">sxx</span><span class="p">,</span> <span class="n">syy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the log of posterior probability (p_pos) in</span>
<span class="sd">        bayesian statistics for the parameters &#39;params&#39; and the</span>
<span class="sd">        data poits xx, yy, sxx and syy.</span>

<span class="sd">        p_pos = L*p_prior (unless by a normalization constant),</span>
<span class="sd">        where L is the likelihood function and p_prior is the</span>
<span class="sd">        prior probability function.</span>


<span class="sd">        a) Likelihood</span>
<span class="sd">        </span>
<span class="sd">        In our case, for gaussian and independent uncertaities,</span>
<span class="sd">        in both x and y axes and with bad points:</span>

<span class="sd">        log(L) = sum(log(p_good_i+p_bad_i))</span>

<span class="sd">        with</span>

<span class="sd">        p_good_i = (1-Pb)/sqrt(2*pi*var_i)*exp(-0.5*(disp_i**2/var_i)),</span>
<span class="sd">        p_bad_i = Pb/sqrt(2*pi*(Vb+var)*exp(-0.5*(disp_i-Yb)**2)/(Vb+var_i))</span>

<span class="sd">        where disp_i is the total projection of the (x_i,y_i) values</span>
<span class="sd">        over the line and var_i, the projected variance; Pb, Yb, Vb are</span>
<span class="sd">        the gaussian model for the bad points - the amplitude, mean and</span>
<span class="sd">        variance (see Hoog, Bovy and Lang, ``Data analysis recipes:</span>
<span class="sd">        Fitting a model to data&#39;&#39;)</span>

<span class="sd">        Taking the model for the line y = ax + b, where a = tan(thet),</span>
<span class="sd">        let</span>

<span class="sd">        v = (-sin(thet), cos(thet)) (versor orthogonal to the line)</span>
<span class="sd">        Z_i = (x_i, y_i)</span>
<span class="sd">        S_i = | sx_i^2   sxy_i^2|  (covariance matrix)</span>
<span class="sd">              |syx_i^2    sy_i^2|</span>

<span class="sd">        The formulas for disp_i and var_i are:</span>
<span class="sd">        </span>
<span class="sd">        disp_i = v*Z_i -b cos(thet)</span>
<span class="sd">        var_i = v*S_i*v</span>


<span class="sd">        b) p_prior</span>
<span class="sd">        </span>
<span class="sd">        Now, p_prior = constant for &#39;params&#39; values inside the</span>
<span class="sd">        range defined by &#39;intervalos&#39;; otherwise, it is 0.</span>
<span class="sd">        That is the only determination that we can do.</span>

<span class="sd">        So, p_pos = log(L) or -inf case &#39;params&#39; are out from</span>
<span class="sd">        the allowed range.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">thet</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Pb</span><span class="p">,</span> <span class="n">Yb</span><span class="p">,</span> <span class="n">Vb</span> <span class="o">=</span> <span class="n">params</span>
        <span class="n">b0</span> <span class="o">=</span> <span class="n">b</span><span class="o">/</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thet</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>

        <span class="c"># Set prior ln prob</span>
        <span class="n">lnprior</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">interv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">intervalos</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">interv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">interv</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">lnprior</span> <span class="o">=</span> <span class="o">-</span><span class="n">_np</span><span class="o">.</span><span class="n">inf</span>

        <span class="c"># Return posterior prob</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lnprior</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">_np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sin</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thet</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
            <span class="n">cos</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thet</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
<span class="c">#            cov = sin*cos*(b0**2)</span>
            <span class="n">disp</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">sin</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">cos</span> <span class="o">-</span> <span class="n">b</span>
<span class="c">#            var = (1-cov)*(sin*sxx)**2 + (1-1/cov)*(cos*syy)**2</span>
            <span class="c"># Projected variance WITHOUT covariance terms</span>
            <span class="n">var</span> <span class="o">=</span> <span class="p">(</span><span class="n">sin</span><span class="o">*</span><span class="n">sxx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">cos</span><span class="o">*</span><span class="n">syy</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

            <span class="n">prob_good</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pb</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">var</span><span class="p">))</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">disp</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">var</span><span class="p">))</span>
            <span class="n">prob_bad</span> <span class="o">=</span> <span class="n">Pb</span><span class="o">/</span><span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Vb</span><span class="o">+</span><span class="n">var</span><span class="p">))</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">disp</span><span class="o">-</span><span class="n">Yb</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">Vb</span><span class="o">+</span><span class="n">var</span><span class="p">))</span>
<span class="c">#            print &#39;-&#39;*40</span>
<span class="c">#            print prob_good, prob_bad, disp, var#, cov</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prob_good</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">prob_good</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">prob_bad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="o">-</span><span class="n">_np</span><span class="o">.</span><span class="n">inf</span>
            
            <span class="k">return</span> <span class="n">lnprior</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prob_good</span> <span class="o">+</span> <span class="n">prob_bad</span><span class="p">))</span>



    <span class="k">def</span> <span class="nf">run_emcee</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span> <span class="n">p0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run emcee.</span>

<span class="sd">        p0 is the initial positions for the walkers</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Burning-in ...&quot;</span><span class="p">)</span>
        <span class="n">pos</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">n_burnin</span><span class="p">)</span>
        <span class="n">sampler</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Running MCMC ...&quot;</span><span class="p">)</span>
        <span class="n">pos</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">n_mcmc</span><span class="p">,</span> <span class="n">rstate0</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>

        <span class="c">#~ Print out the mean acceptance fraction. </span>
        <span class="n">af</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">acceptance_fraction</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Mean acceptance fraction:&quot;</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">af</span><span class="p">))</span>

        <span class="c"># Compute the results using all interval</span>
        <span class="n">fig1</span><span class="p">,</span> <span class="n">thet_mcmc</span><span class="p">,</span> <span class="n">b_mcmc</span><span class="p">,</span> <span class="n">Pb_mcmc</span><span class="p">,</span> <span class="n">Yb_mcmc</span><span class="p">,</span> <span class="n">Vb_mcmc</span> <span class="o">=</span> <span class="n">gen_results</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span> <span class="n">intervalos</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># Plot convergence map</span>
        <span class="n">plot_conv</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span> <span class="p">[</span><span class="n">thet_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Pb_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Yb_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Vb_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="k">if</span> <span class="n">plot_adj</span><span class="p">:</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">xerr</span><span class="o">=</span><span class="n">sx</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">sy</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">xadj</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">yadj</span> <span class="o">=</span> <span class="n">podr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xadj</span><span class="o">+</span><span class="n">podr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xadj</span><span class="p">,</span> <span class="n">yadj</span><span class="p">,</span> <span class="s">&#39;-.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;dimgray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;odr&#39;</span><span class="p">)</span>

            <span class="n">xadj</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">b0</span> <span class="o">=</span> <span class="n">b_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thet_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
            <span class="n">a0</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">thet_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
            <span class="n">yadj</span> <span class="o">=</span> <span class="n">a0</span><span class="o">*</span><span class="n">xadj</span><span class="o">+</span><span class="n">b0</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xadj</span><span class="p">,</span> <span class="n">yadj</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;dimgray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;mcmc&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">)</span>
            <span class="n">fig2</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c"># NEW: Requests if the user want to use some specific interval</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">while</span> <span class="n">opt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">,</span><span class="s">&#39;n&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Do you want to select specific ranges to compute the values?&#39;</span><span class="p">)</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;(y/n): &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">):</span>

            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">ranges</span> <span class="o">=</span> <span class="p">[[],[],[],[],[]]</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dictvar</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">etr</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;{0}: specify in format `{0}_min,{0}_max`: &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
    <span class="c">#                        p_int = [float(ei)-params_fit[0] for ei in petr.split(&#39;,&#39;)]</span>
                            <span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">ei</span><span class="p">)</span> <span class="k">for</span> <span class="n">ei</span> <span class="ow">in</span> <span class="n">etr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)]</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                                    <span class="k">break</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Error: {0}_max must be greather than {0}_min!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Invalid input!&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Invalid input!&#39;</span><span class="p">)</span>

                <span class="n">opt</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="k">while</span> <span class="n">opt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">,</span><span class="s">&#39;n&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Is it correct?&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dictvar</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39;              {0}_min,{0}_max: {1},{2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>

                    <span class="n">opt</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;(y/n): &#39;</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">break</span>

            <span class="n">_plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig1</span><span class="p">)</span>
            <span class="n">fig1</span><span class="p">,</span> <span class="n">thet_mcmc</span><span class="p">,</span> <span class="n">b_mcmc</span><span class="p">,</span> <span class="n">Pb_mcmc</span><span class="p">,</span> <span class="n">Yb_mcmc</span><span class="p">,</span> <span class="n">Vb_mcmc</span> <span class="o">=</span> <span class="n">gen_results</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span> <span class="n">ranges</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c">#        else:</span>
<span class="c">#            _plt.close(fig2)</span>


        <span class="k">return</span> <span class="n">fig1</span><span class="p">,</span> <span class="n">thet_mcmc</span><span class="p">,</span> <span class="n">b_mcmc</span><span class="p">,</span> <span class="n">Pb_mcmc</span><span class="p">,</span> <span class="n">Yb_mcmc</span><span class="p">,</span> <span class="n">Vb_mcmc</span><span class="p">,</span> <span class="n">opt</span>



    <span class="k">def</span> <span class="nf">gen_results</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span> <span class="n">ranges</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="c"># Read the sampler</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">chain</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndim</span><span class="p">))</span>
        <span class="n">samples_new</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ndim</span><span class="p">])</span>

        <span class="c"># Filtering &#39;samples&#39; array</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Please wait, computing values from samples...&#39;</span><span class="p">)</span>
        <span class="n">new</span><span class="o">=</span><span class="bp">False</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rang</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ranges</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">intervalos</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">rang</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">intervalos</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">rang</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">new</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">new</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
                <span class="n">ver</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">elem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">elem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">ver</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">ver</span><span class="p">:</span>
                    <span class="n">samples_new</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">samples_new</span><span class="p">,</span> <span class="n">elem</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">samples_new</span> <span class="o">=</span> <span class="n">samples</span>

        <span class="c"># Ploting corner graph</span>
        <span class="n">fig1</span> <span class="o">=</span> <span class="n">triangle</span><span class="o">.</span><span class="n">nov</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span><span class="n">samples_new</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">star</span><span class="p">,</span> \
<span class="c">#                            truths=[p_mcmc[0], l_mcmc[0]], \</span>
<span class="c">#                            extents=[(p_range[0],l_range[0]),(p_range[1],l_range[1])], \</span>
                             <span class="n">quantiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.16075</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.83925</span><span class="p">],</span> \
                             <span class="n">labels</span><span class="o">=</span><span class="n">dictvar</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> \
                             <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">fig1</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}_correl.{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star</span><span class="p">,</span><span class="n">extens</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">fig1</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">margin</span><span class="p">:</span>
            <span class="c"># Ploting corner graph</span>
            <span class="n">fig3</span> <span class="o">=</span> <span class="n">triangle</span><span class="o">.</span><span class="n">nov</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span><span class="n">samples_new</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="n">star</span><span class="p">,</span> \
<span class="c">#                            truths=[p_mcmc[0], l_mcmc[0]], \</span>
<span class="c">#                            extents=[(p_range[0],l_range[0]),(p_range[1],l_range[1])], \</span>
                             <span class="n">quantiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.16075</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.83925</span><span class="p">],</span> \
                             <span class="n">labels</span><span class="o">=</span><span class="n">dictvar</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> \
                             <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">fig3</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}_correl_m.{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star</span><span class="p">,</span><span class="n">extens</span><span class="p">))</span>
        
        <span class="c"># Computing the medians and errors according to the range from median</span>
        <span class="c"># inside which there are 68.3% of the data</span>
        <span class="n">thet_mcmc</span><span class="p">,</span> <span class="n">b_mcmc</span><span class="p">,</span> <span class="n">Pb_mcmc</span><span class="p">,</span> <span class="n">Yb_mcmc</span><span class="p">,</span> <span class="n">Vb_mcmc</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                                <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">samples_new</span><span class="p">,</span> <span class="p">[</span><span class="mf">16.075</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mf">83.925</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>

        <span class="c">#~ Print the output</span>
        <span class="sd">&quot;&quot;&quot; TBD &quot;&quot;&quot;</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="mi">55</span><span class="o">*</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;  2) MCMC best values  (y = tan(theta)*x + b*cos(theta)):&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="mi">55</span><span class="o">*</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;          theta = {0:9.4f}  +{1:.4f}  -{2:.4f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">thet_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">thet_mcmc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">thet_mcmc</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;   b*cos(theta) = {0:9.4f}  +{1:.4f}  -{2:.4f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b_mcmc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">b_mcmc</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;             Pb = {0:9.4f}  +{1:.4f}  -{2:.4f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Pb_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Pb_mcmc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Pb_mcmc</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;             Yb = {0:9.4f}  +{1:.4f}  -{2:.4f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Yb_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Yb_mcmc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Yb_mcmc</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;             Vb = {0:9.4f}  +{1:.4f}  -{2:.4f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Vb_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Vb_mcmc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Vb_mcmc</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
<span class="c">#        print &#39;reduced chi2 = {0:.4f}&#39;.format(chi)</span>
        <span class="k">print</span><span class="p">(</span><span class="mi">55</span><span class="o">*</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">fig1</span><span class="p">,</span> <span class="n">thet_mcmc</span><span class="p">,</span> <span class="n">b_mcmc</span><span class="p">,</span> <span class="n">Pb_mcmc</span><span class="p">,</span> <span class="n">Yb_mcmc</span><span class="p">,</span> <span class="n">Vb_mcmc</span>

    

    <span class="k">def</span> <span class="nf">plot_conv</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot convergence map. &#39;param&#39; are the values to be highlighted</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fig4</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ndim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">chain</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;#888888&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">dictvar</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&quot;Step number&quot;</span><span class="p">)</span>

        <span class="n">fig4</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">h_pad</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">fig4</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;{0}_conv.{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star</span><span class="p">,</span><span class="n">extens</span><span class="p">))</span>

        <span class="k">return</span>



    <span class="k">def</span> <span class="nf">fitodr</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit by Least Squares</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Fit the simple least squares (only considering y errors) to find</span>
        <span class="c"># initial parameters to the next adjust</span>
        <span class="n">param0</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">_curve_fit</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">:</span> <span class="n">a</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sy</span><span class="p">)</span>
<span class="c">#        sparam0 = [_np.sqrt(cov[0][0]), _np.sqrt(cov[1][1])]</span>
<span class="c">#        tht0 = _np.arctan(param0[0])*180/_np.pi</span>
<span class="c">#        stht0 = (180*sparam0[0])/(_np.pi*(param0[0]**2+1))</span>

        <span class="c"># Fit by the total least squares method (orthogonal distance regression) with clipping</span>
        <span class="n">param</span><span class="p">,</span> <span class="n">sparam</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">niter</span><span class="p">,</span><span class="n">bolfilt</span> <span class="o">=</span> <span class="n">_phc</span><span class="o">.</span><span class="n">fit_linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">param0</span><span class="o">=</span><span class="n">param0</span><span class="p">,</span>
                                                                        <span class="n">clip</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">tht</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span>
        <span class="k">if</span> <span class="n">tht</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tht</span> <span class="o">+=</span> <span class="mf">180.</span>
        <span class="k">elif</span> <span class="n">tht</span> <span class="o">&gt;=</span> <span class="mi">180</span><span class="p">:</span>
            <span class="n">tht</span> <span class="o">-=</span> <span class="mi">180</span>
        <span class="n">stht</span> <span class="o">=</span> <span class="p">(</span><span class="mi">180</span><span class="o">*</span><span class="n">sparam</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">nn</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">bolfilt</span><span class="p">)</span>

        <span class="c"># Calculate the reduced chi-squared</span>
        <span class="k">if</span> <span class="n">nn</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">rchi2</span> <span class="o">=</span> <span class="n">chi2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">nn</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rchi2</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># Print informations</span>
        <span class="k">print</span><span class="p">(</span><span class="mi">55</span><span class="o">*</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;  1) Total least squares fit  (y = a*x+b):&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="mi">55</span><span class="o">*</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;             a = {0:.3f} +- {1:.3f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sparam</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;             b = {0:.3f} +- {1:.3f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sparam</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;         theta = {0:.2f} +- {1:.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tht</span><span class="p">,</span> <span class="n">stht</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;             N = {0:d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nn</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;             red chi^2 = {0:2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rchi2</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="mi">55</span><span class="o">*</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">param</span><span class="p">,</span> <span class="n">sparam</span>




    <span class="c"># Dictionary for the graph labels</span>
    <span class="n">dictvar</span> <span class="o">=</span>      <span class="p">[[</span><span class="s">&#39;theta&#39;</span><span class="p">,</span>
              <span class="s">&#39;b*cos(theta)&#39;</span><span class="p">,</span>
                       <span class="s">&#39;P_b&#39;</span><span class="p">,</span>
                       <span class="s">&#39;Y_b&#39;</span><span class="p">,</span>
                       <span class="s">&#39;V_b&#39;</span><span class="p">],</span>
                  <span class="p">[</span><span class="s">r&#39;$\theta$&#39;</span><span class="p">,</span>
          <span class="s">r&#39;$b\,\cos \theta $&#39;</span><span class="p">,</span>
                      <span class="s">r&#39;$P_b$&#39;</span><span class="p">,</span>
                      <span class="s">r&#39;$Y_b$&#39;</span><span class="p">,</span>
                      <span class="s">r&#39;$V_b$&#39;</span><span class="p">]]</span>


<span class="c">#    try:</span>
<span class="c">#        _plt.close(fig2)</span>
<span class="c">#    except:</span>
<span class="c">#        pass</span>
<span class="c">#    x = _np.array([201., 244., 47., 287., 203., 58., 210., 202., 198., 158., 165., 201., 157., 131., 166., 160., 186., 125., 218., 146.])</span>
<span class="c">#    y = _np.array([592., 401., 583., 402., 495., 173., 479., 504., 510., 416., 393., 442., 317., 311., 400., 337., 423., 334., 533., 344.])</span>
<span class="c">#    sx = _np.array([9.,4.,11.,7.,5.,9.,4.,4.,11.,7.,5.,5.,5.,6.,6.,5.,9.,8.,6.,5.])</span>
<span class="c">#    sy = _np.array([61.,25.,38.,15.,21.,15.,27.,14.,30.,16.,14.,25.,52.,16.,34.,31.,42.,26.,16.,22.])</span>

    <span class="c"># thet, b, Pb, Yb, Vb</span>

    <span class="c"># Setting parameters and limits</span>
    <span class="n">intervalos</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">thet_ran</span><span class="p">,</span> <span class="n">b_ran</span><span class="p">,</span> <span class="n">Pb_ran</span><span class="p">,</span> <span class="n">Yb_ran</span><span class="p">,</span> <span class="n">Vb_ran</span><span class="p">])</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="c"># Converting lists to np.array</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">sx</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">sx</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sx</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">sy</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">sy</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sy</span><span class="p">)</span>

    <span class="c"># Fit by Least Squares</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">podr</span><span class="p">,</span> <span class="n">spodr</span> <span class="o">=</span> <span class="n">fitodr</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">plot_adj</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ax</span><span class="o">==</span><span class="bp">None</span> <span class="ow">or</span> <span class="n">fig</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">fig2</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">_plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig2</span> <span class="o">=</span> <span class="n">fig</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span>

    <span class="c"># If &#39;star&#39; was not specified, generate a random number to append to the graph name to be saved</span>
    <span class="k">if</span> <span class="n">star</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="n">star</span> <span class="o">=</span> <span class="s">&#39;rand&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">10000</span><span class="p">))</span>

    <span class="c"># Define random values to be used as priori numbers within the interval</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n_walkers</span><span class="p">)]</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
        <span class="n">p0</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">intervalos</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">p0</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">intervalos</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">intervalos</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="c"># Initialize the sampler and run mcmc</span>
    <span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span><span class="n">n_walkers</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">lnprob</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">],</span> <span class="n">a</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="c">#, threads=2)</span>
    <span class="n">fig1</span><span class="p">,</span> <span class="n">thet_mcmc</span><span class="p">,</span> <span class="n">b_mcmc</span><span class="p">,</span> <span class="n">Pb_mcmc</span><span class="p">,</span> <span class="n">Yb_mcmc</span><span class="p">,</span> <span class="n">Vb_mcmc</span><span class="p">,</span> <span class="n">opt</span> <span class="o">=</span> <span class="n">run_emcee</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span> <span class="n">p0</span><span class="p">)</span>


    <span class="c"># Plot only if plot_adj==True or a new computation was done</span>
    <span class="k">if</span> <span class="n">plot_adj</span> <span class="ow">and</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">):</span>

        <span class="n">xadj</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">b0</span> <span class="o">=</span> <span class="n">b_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">_np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thet_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
        <span class="n">a0</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">thet_mcmc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
        <span class="n">yadj</span> <span class="o">=</span> <span class="n">a0</span><span class="o">*</span><span class="n">xadj</span><span class="o">+</span><span class="n">b0</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xadj</span><span class="p">,</span> <span class="n">yadj</span><span class="p">,</span> <span class="s">&#39;--&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;dimgray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;mcmc_new&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">)</span>
        <span class="n">fig2</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">plot_adj</span><span class="p">:</span>
        <span class="n">fig2</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">return</span> <span class="n">thet_mcmc</span><span class="p">,</span> <span class="n">b_mcmc</span><span class="p">,</span> <span class="n">Pb_mcmc</span><span class="p">,</span> <span class="n">Yb_mcmc</span><span class="p">,</span> <span class="n">Vb_mcmc</span><span class="p">,</span> <span class="n">fig1</span><span class="p">,</span> <span class="n">fig2</span>

</div>
<div class="viewcode-block" id="loadpol"><a class="viewcode-back" href="../../poltools.html#pyhdust.poltools.loadpol">[docs]</a><span class="k">def</span> <span class="nf">loadpol</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Load polarization txt file. &quot;&quot;&quot;</span>
    <span class="n">dtb</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">dtb</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">fromarrays</span><span class="p">(</span><span class="n">dtb</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">names</span><span class="o">=</span><span class="s">&#39;MJD,night,filt,</span><span class="se">\</span>
<span class="s">    calc,stdstars,dth,devdth,P,Q,U,th,sigP,sigth&#39;</span><span class="p">,</span> <span class="n">formats</span><span class="o">=</span><span class="s">&#39;f8,{0},{0},f8,{0},</span><span class="se">\</span>
<span class="s">    f8,f8,f8,f8,f8,f8,f8,f8&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtb</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dtb</span>

</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Python tools for the BeACoN group Beta documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../pyhdust.html" >pyhdust</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015-2016, D. Moser.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>